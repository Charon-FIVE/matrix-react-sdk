"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.KeyBindingsManager = void 0;
exports.getKeyBindingsManager = getKeyBindingsManager;
exports.isKeyComboMatch = isKeyComboMatch;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _KeyBindingsDefaults = require("./KeyBindingsDefaults");

var _Keyboard = require("./Keyboard");

/*
Copyright 2021 Clemens Zeidler
Copyright 2022 Å imon Brandner <simon.bra.ag@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Helper method to check if a KeyboardEvent matches a KeyCombo
 *
 * Note, this method is only exported for testing.
 */
function isKeyComboMatch(ev, combo, onMac) {
  if (combo.key !== undefined) {
    // When shift is pressed, letters are returned as upper case chars. In this case do a lower case comparison.
    // This works for letter combos such as shift + U as well for none letter combos such as shift + Escape.
    // If shift is not pressed, the toLowerCase conversion can be avoided.
    if (ev.shiftKey) {
      if (ev.key.toLowerCase() !== combo.key.toLowerCase()) {
        return false;
      }
    } else if (ev.key !== combo.key) {
      return false;
    }
  }

  const comboCtrl = combo.ctrlKey ?? false;
  const comboAlt = combo.altKey ?? false;
  const comboShift = combo.shiftKey ?? false;
  const comboMeta = combo.metaKey ?? false; // Tests mock events may keep the modifiers undefined; convert them to booleans

  const evCtrl = ev.ctrlKey ?? false;
  const evAlt = ev.altKey ?? false;
  const evShift = ev.shiftKey ?? false;
  const evMeta = ev.metaKey ?? false; // When ctrlOrCmd is set, the keys need do evaluated differently on PC and Mac

  if (combo.ctrlOrCmdKey) {
    if (onMac) {
      if (!evMeta || evCtrl !== comboCtrl || evAlt !== comboAlt || evShift !== comboShift) {
        return false;
      }
    } else {
      if (!evCtrl || evMeta !== comboMeta || evAlt !== comboAlt || evShift !== comboShift) {
        return false;
      }
    }

    return true;
  }

  if (evMeta !== comboMeta || evCtrl !== comboCtrl || evAlt !== comboAlt || evShift !== comboShift) {
    return false;
  }

  return true;
}

class KeyBindingsManager {
  constructor() {
    (0, _defineProperty2.default)(this, "bindingsProviders", [_KeyBindingsDefaults.defaultBindingsProvider]);
  }

  /**
   * Finds a matching KeyAction for a given KeyboardEvent
   */
  getAction(getters, ev) {
    for (const getter of getters) {
      const bindings = getter();
      const binding = bindings.find(it => isKeyComboMatch(ev, it.keyCombo, _Keyboard.IS_MAC));

      if (binding) {
        return binding.action;
      }
    }

    return undefined;
  }

  getMessageComposerAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getMessageComposerBindings), ev);
  }

  getAutocompleteAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getAutocompleteBindings), ev);
  }

  getRoomListAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getRoomListBindings), ev);
  }

  getRoomAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getRoomBindings), ev);
  }

  getNavigationAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getNavigationBindings), ev);
  }

  getAccessibilityAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getAccessibilityBindings), ev);
  }

  getCallAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getCallBindings), ev);
  }

  getLabsAction(ev) {
    return this.getAction(this.bindingsProviders.map(it => it.getLabsBindings), ev);
  }

}

exports.KeyBindingsManager = KeyBindingsManager;
const manager = new KeyBindingsManager();

function getKeyBindingsManager() {
  return manager;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpc0tleUNvbWJvTWF0Y2giLCJldiIsImNvbWJvIiwib25NYWMiLCJrZXkiLCJ1bmRlZmluZWQiLCJzaGlmdEtleSIsInRvTG93ZXJDYXNlIiwiY29tYm9DdHJsIiwiY3RybEtleSIsImNvbWJvQWx0IiwiYWx0S2V5IiwiY29tYm9TaGlmdCIsImNvbWJvTWV0YSIsIm1ldGFLZXkiLCJldkN0cmwiLCJldkFsdCIsImV2U2hpZnQiLCJldk1ldGEiLCJjdHJsT3JDbWRLZXkiLCJLZXlCaW5kaW5nc01hbmFnZXIiLCJkZWZhdWx0QmluZGluZ3NQcm92aWRlciIsImdldEFjdGlvbiIsImdldHRlcnMiLCJnZXR0ZXIiLCJiaW5kaW5ncyIsImJpbmRpbmciLCJmaW5kIiwiaXQiLCJrZXlDb21ibyIsIklTX01BQyIsImFjdGlvbiIsImdldE1lc3NhZ2VDb21wb3NlckFjdGlvbiIsImJpbmRpbmdzUHJvdmlkZXJzIiwibWFwIiwiZ2V0TWVzc2FnZUNvbXBvc2VyQmluZGluZ3MiLCJnZXRBdXRvY29tcGxldGVBY3Rpb24iLCJnZXRBdXRvY29tcGxldGVCaW5kaW5ncyIsImdldFJvb21MaXN0QWN0aW9uIiwiZ2V0Um9vbUxpc3RCaW5kaW5ncyIsImdldFJvb21BY3Rpb24iLCJnZXRSb29tQmluZGluZ3MiLCJnZXROYXZpZ2F0aW9uQWN0aW9uIiwiZ2V0TmF2aWdhdGlvbkJpbmRpbmdzIiwiZ2V0QWNjZXNzaWJpbGl0eUFjdGlvbiIsImdldEFjY2Vzc2liaWxpdHlCaW5kaW5ncyIsImdldENhbGxBY3Rpb24iLCJnZXRDYWxsQmluZGluZ3MiLCJnZXRMYWJzQWN0aW9uIiwiZ2V0TGFic0JpbmRpbmdzIiwibWFuYWdlciIsImdldEtleUJpbmRpbmdzTWFuYWdlciJdLCJzb3VyY2VzIjpbIi4uL3NyYy9LZXlCaW5kaW5nc01hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIENsZW1lbnMgWmVpZGxlclxuQ29weXJpZ2h0IDIwMjIgxaBpbW9uIEJyYW5kbmVyIDxzaW1vbi5icmEuYWdAZ21haWwuY29tPlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IEtleUJpbmRpbmdBY3Rpb24gfSBmcm9tIFwiLi9hY2Nlc3NpYmlsaXR5L0tleWJvYXJkU2hvcnRjdXRzXCI7XG5pbXBvcnQgeyBkZWZhdWx0QmluZGluZ3NQcm92aWRlciB9IGZyb20gJy4vS2V5QmluZGluZ3NEZWZhdWx0cyc7XG5pbXBvcnQgeyBJU19NQUMgfSBmcm9tICcuL0tleWJvYXJkJztcblxuLyoqXG4gKiBSZXByZXNlbnQgYSBrZXkgY29tYmluYXRpb24uXG4gKlxuICogVGhlIGNvbWJvIGlzIGV2YWx1YXRlZCBzdHJpY3RseSwgaS5lLiB0aGUgS2V5Ym9hcmRFdmVudCBtdXN0IG1hdGNoIGV4YWN0bHkgd2hhdCBpcyBzcGVjaWZpZWQgaW4gdGhlIEtleUNvbWJvLlxuICovXG5leHBvcnQgdHlwZSBLZXlDb21ibyA9IHtcbiAgICBrZXk/OiBzdHJpbmc7XG5cbiAgICAvKiogT24gUEM6IGN0cmwgaXMgcHJlc3NlZDsgb24gTWFjOiBtZXRhIGlzIHByZXNzZWQgKi9cbiAgICBjdHJsT3JDbWRLZXk/OiBib29sZWFuO1xuXG4gICAgYWx0S2V5PzogYm9vbGVhbjtcbiAgICBjdHJsS2V5PzogYm9vbGVhbjtcbiAgICBtZXRhS2V5PzogYm9vbGVhbjtcbiAgICBzaGlmdEtleT86IGJvb2xlYW47XG59O1xuXG5leHBvcnQgdHlwZSBLZXlCaW5kaW5nID0ge1xuICAgIGFjdGlvbjogS2V5QmluZGluZ0FjdGlvbjtcbiAgICBrZXlDb21ibzogS2V5Q29tYm87XG59O1xuXG4vKipcbiAqIEhlbHBlciBtZXRob2QgdG8gY2hlY2sgaWYgYSBLZXlib2FyZEV2ZW50IG1hdGNoZXMgYSBLZXlDb21ib1xuICpcbiAqIE5vdGUsIHRoaXMgbWV0aG9kIGlzIG9ubHkgZXhwb3J0ZWQgZm9yIHRlc3RpbmcuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0tleUNvbWJvTWF0Y2goZXY6IEtleWJvYXJkRXZlbnQgfCBSZWFjdC5LZXlib2FyZEV2ZW50LCBjb21ibzogS2V5Q29tYm8sIG9uTWFjOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgaWYgKGNvbWJvLmtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIFdoZW4gc2hpZnQgaXMgcHJlc3NlZCwgbGV0dGVycyBhcmUgcmV0dXJuZWQgYXMgdXBwZXIgY2FzZSBjaGFycy4gSW4gdGhpcyBjYXNlIGRvIGEgbG93ZXIgY2FzZSBjb21wYXJpc29uLlxuICAgICAgICAvLyBUaGlzIHdvcmtzIGZvciBsZXR0ZXIgY29tYm9zIHN1Y2ggYXMgc2hpZnQgKyBVIGFzIHdlbGwgZm9yIG5vbmUgbGV0dGVyIGNvbWJvcyBzdWNoIGFzIHNoaWZ0ICsgRXNjYXBlLlxuICAgICAgICAvLyBJZiBzaGlmdCBpcyBub3QgcHJlc3NlZCwgdGhlIHRvTG93ZXJDYXNlIGNvbnZlcnNpb24gY2FuIGJlIGF2b2lkZWQuXG4gICAgICAgIGlmIChldi5zaGlmdEtleSkge1xuICAgICAgICAgICAgaWYgKGV2LmtleS50b0xvd2VyQ2FzZSgpICE9PSBjb21iby5rZXkudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChldi5rZXkgIT09IGNvbWJvLmtleSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY29tYm9DdHJsID0gY29tYm8uY3RybEtleSA/PyBmYWxzZTtcbiAgICBjb25zdCBjb21ib0FsdCA9IGNvbWJvLmFsdEtleSA/PyBmYWxzZTtcbiAgICBjb25zdCBjb21ib1NoaWZ0ID0gY29tYm8uc2hpZnRLZXkgPz8gZmFsc2U7XG4gICAgY29uc3QgY29tYm9NZXRhID0gY29tYm8ubWV0YUtleSA/PyBmYWxzZTtcbiAgICAvLyBUZXN0cyBtb2NrIGV2ZW50cyBtYXkga2VlcCB0aGUgbW9kaWZpZXJzIHVuZGVmaW5lZDsgY29udmVydCB0aGVtIHRvIGJvb2xlYW5zXG4gICAgY29uc3QgZXZDdHJsID0gZXYuY3RybEtleSA/PyBmYWxzZTtcbiAgICBjb25zdCBldkFsdCA9IGV2LmFsdEtleSA/PyBmYWxzZTtcbiAgICBjb25zdCBldlNoaWZ0ID0gZXYuc2hpZnRLZXkgPz8gZmFsc2U7XG4gICAgY29uc3QgZXZNZXRhID0gZXYubWV0YUtleSA/PyBmYWxzZTtcbiAgICAvLyBXaGVuIGN0cmxPckNtZCBpcyBzZXQsIHRoZSBrZXlzIG5lZWQgZG8gZXZhbHVhdGVkIGRpZmZlcmVudGx5IG9uIFBDIGFuZCBNYWNcbiAgICBpZiAoY29tYm8uY3RybE9yQ21kS2V5KSB7XG4gICAgICAgIGlmIChvbk1hYykge1xuICAgICAgICAgICAgaWYgKCFldk1ldGFcbiAgICAgICAgICAgICAgICB8fCBldkN0cmwgIT09IGNvbWJvQ3RybFxuICAgICAgICAgICAgICAgIHx8IGV2QWx0ICE9PSBjb21ib0FsdFxuICAgICAgICAgICAgICAgIHx8IGV2U2hpZnQgIT09IGNvbWJvU2hpZnQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIWV2Q3RybFxuICAgICAgICAgICAgICAgIHx8IGV2TWV0YSAhPT0gY29tYm9NZXRhXG4gICAgICAgICAgICAgICAgfHwgZXZBbHQgIT09IGNvbWJvQWx0XG4gICAgICAgICAgICAgICAgfHwgZXZTaGlmdCAhPT0gY29tYm9TaGlmdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAoZXZNZXRhICE9PSBjb21ib01ldGFcbiAgICAgICAgfHwgZXZDdHJsICE9PSBjb21ib0N0cmxcbiAgICAgICAgfHwgZXZBbHQgIT09IGNvbWJvQWx0XG4gICAgICAgIHx8IGV2U2hpZnQgIT09IGNvbWJvU2hpZnQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgdHlwZSBLZXlCaW5kaW5nR2V0dGVyID0gKCkgPT4gS2V5QmluZGluZ1tdO1xuXG5leHBvcnQgaW50ZXJmYWNlIElLZXlCaW5kaW5nc1Byb3ZpZGVyIHtcbiAgICBba2V5OiBzdHJpbmddOiBLZXlCaW5kaW5nR2V0dGVyO1xufVxuXG5leHBvcnQgY2xhc3MgS2V5QmluZGluZ3NNYW5hZ2VyIHtcbiAgICAvKipcbiAgICAgKiBMaXN0IG9mIGtleSBiaW5kaW5ncyBwcm92aWRlcnMuXG4gICAgICpcbiAgICAgKiBLZXkgYmluZGluZ3MgZnJvbSB0aGUgZmlyc3QgcHJvdmlkZXIocykgaW4gdGhlIGxpc3Qgd2lsbCBoYXZlIHByZWNlZGVuY2Ugb3ZlciBrZXkgYmluZGluZ3MgZnJvbSBsYXRlciBwcm92aWRlcnMuXG4gICAgICpcbiAgICAgKiBUbyBvdmVyd3JpdGUgdGhlIGRlZmF1bHQga2V5IGJpbmRpbmdzIGFkZCBhIG5ldyBwcm92aWRlcnMgYmVmb3JlIHRoZSBkZWZhdWx0IHByb3ZpZGVyLCBlLmcuIGEgcHJvdmlkZXIgZm9yXG4gICAgICogY3VzdG9taXplZCBrZXkgYmluZGluZ3MuXG4gICAgICovXG4gICAgYmluZGluZ3NQcm92aWRlcnM6IElLZXlCaW5kaW5nc1Byb3ZpZGVyW10gPSBbXG4gICAgICAgIGRlZmF1bHRCaW5kaW5nc1Byb3ZpZGVyLFxuICAgIF07XG5cbiAgICAvKipcbiAgICAgKiBGaW5kcyBhIG1hdGNoaW5nIEtleUFjdGlvbiBmb3IgYSBnaXZlbiBLZXlib2FyZEV2ZW50XG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRBY3Rpb24oXG4gICAgICAgIGdldHRlcnM6IEtleUJpbmRpbmdHZXR0ZXJbXSxcbiAgICAgICAgZXY6IEtleWJvYXJkRXZlbnQgfCBSZWFjdC5LZXlib2FyZEV2ZW50LFxuICAgICk6IEtleUJpbmRpbmdBY3Rpb24gfCB1bmRlZmluZWQge1xuICAgICAgICBmb3IgKGNvbnN0IGdldHRlciBvZiBnZXR0ZXJzKSB7XG4gICAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGdldHRlcigpO1xuICAgICAgICAgICAgY29uc3QgYmluZGluZyA9IGJpbmRpbmdzLmZpbmQoaXQgPT4gaXNLZXlDb21ib01hdGNoKGV2LCBpdC5rZXlDb21ibywgSVNfTUFDKSk7XG4gICAgICAgICAgICBpZiAoYmluZGluZykge1xuICAgICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nLmFjdGlvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGdldE1lc3NhZ2VDb21wb3NlckFjdGlvbihldjogS2V5Ym9hcmRFdmVudCB8IFJlYWN0LktleWJvYXJkRXZlbnQpOiBLZXlCaW5kaW5nQWN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWN0aW9uKHRoaXMuYmluZGluZ3NQcm92aWRlcnMubWFwKGl0ID0+IGl0LmdldE1lc3NhZ2VDb21wb3NlckJpbmRpbmdzKSwgZXYpO1xuICAgIH1cblxuICAgIGdldEF1dG9jb21wbGV0ZUFjdGlvbihldjogS2V5Ym9hcmRFdmVudCB8IFJlYWN0LktleWJvYXJkRXZlbnQpOiBLZXlCaW5kaW5nQWN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWN0aW9uKHRoaXMuYmluZGluZ3NQcm92aWRlcnMubWFwKGl0ID0+IGl0LmdldEF1dG9jb21wbGV0ZUJpbmRpbmdzKSwgZXYpO1xuICAgIH1cblxuICAgIGdldFJvb21MaXN0QWN0aW9uKGV2OiBLZXlib2FyZEV2ZW50IHwgUmVhY3QuS2V5Ym9hcmRFdmVudCk6IEtleUJpbmRpbmdBY3Rpb24gfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRBY3Rpb24odGhpcy5iaW5kaW5nc1Byb3ZpZGVycy5tYXAoaXQgPT4gaXQuZ2V0Um9vbUxpc3RCaW5kaW5ncyksIGV2KTtcbiAgICB9XG5cbiAgICBnZXRSb29tQWN0aW9uKGV2OiBLZXlib2FyZEV2ZW50IHwgUmVhY3QuS2V5Ym9hcmRFdmVudCk6IEtleUJpbmRpbmdBY3Rpb24gfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRBY3Rpb24odGhpcy5iaW5kaW5nc1Byb3ZpZGVycy5tYXAoaXQgPT4gaXQuZ2V0Um9vbUJpbmRpbmdzKSwgZXYpO1xuICAgIH1cblxuICAgIGdldE5hdmlnYXRpb25BY3Rpb24oZXY6IEtleWJvYXJkRXZlbnQgfCBSZWFjdC5LZXlib2FyZEV2ZW50KTogS2V5QmluZGluZ0FjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEFjdGlvbih0aGlzLmJpbmRpbmdzUHJvdmlkZXJzLm1hcChpdCA9PiBpdC5nZXROYXZpZ2F0aW9uQmluZGluZ3MpLCBldik7XG4gICAgfVxuXG4gICAgZ2V0QWNjZXNzaWJpbGl0eUFjdGlvbihldjogS2V5Ym9hcmRFdmVudCB8IFJlYWN0LktleWJvYXJkRXZlbnQpOiBLZXlCaW5kaW5nQWN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWN0aW9uKHRoaXMuYmluZGluZ3NQcm92aWRlcnMubWFwKGl0ID0+IGl0LmdldEFjY2Vzc2liaWxpdHlCaW5kaW5ncyksIGV2KTtcbiAgICB9XG5cbiAgICBnZXRDYWxsQWN0aW9uKGV2OiBLZXlib2FyZEV2ZW50IHwgUmVhY3QuS2V5Ym9hcmRFdmVudCk6IEtleUJpbmRpbmdBY3Rpb24gfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRBY3Rpb24odGhpcy5iaW5kaW5nc1Byb3ZpZGVycy5tYXAoaXQgPT4gaXQuZ2V0Q2FsbEJpbmRpbmdzKSwgZXYpO1xuICAgIH1cblxuICAgIGdldExhYnNBY3Rpb24oZXY6IEtleWJvYXJkRXZlbnQgfCBSZWFjdC5LZXlib2FyZEV2ZW50KTogS2V5QmluZGluZ0FjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEFjdGlvbih0aGlzLmJpbmRpbmdzUHJvdmlkZXJzLm1hcChpdCA9PiBpdC5nZXRMYWJzQmluZGluZ3MpLCBldik7XG4gICAgfVxufVxuXG5jb25zdCBtYW5hZ2VyID0gbmV3IEtleUJpbmRpbmdzTWFuYWdlcigpO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0S2V5QmluZGluZ3NNYW5hZ2VyKCk6IEtleUJpbmRpbmdzTWFuYWdlciB7XG4gICAgcmV0dXJuIG1hbmFnZXI7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFrQkE7O0FBQ0E7O0FBbkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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