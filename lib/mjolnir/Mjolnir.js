"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Mjolnir = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _partials = require("matrix-js-sdk/src/@types/partials");

var _logger = require("matrix-js-sdk/src/logger");

var _roomState = require("matrix-js-sdk/src/models/room-state");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _BanList = require("./BanList");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _languageHandler = require("../languageHandler");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _SettingLevel = require("../settings/SettingLevel");

var _actions = require("../dispatcher/actions");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// TODO: Move this and related files to the js-sdk or something once finalized.
class Mjolnir {
  constructor() {
    (0, _defineProperty2.default)(this, "_lists", []);
    (0, _defineProperty2.default)(this, "_roomIds", []);
    (0, _defineProperty2.default)(this, "mjolnirWatchRef", null);
    (0, _defineProperty2.default)(this, "dispatcherRef", null);
    (0, _defineProperty2.default)(this, "onAction", payload => {
      if (payload['action'] === 'setup_mjolnir') {
        _logger.logger.log("Setting up Mjolnir: after sync");

        this.setup();
      }
    });
    (0, _defineProperty2.default)(this, "onEvent", event => {
      if (!_MatrixClientPeg.MatrixClientPeg.get()) return;
      if (!this._roomIds.includes(event.getRoomId())) return;
      if (!_BanList.ALL_RULE_TYPES.includes(event.getType())) return;
      this.updateLists(this._roomIds);
    });
  }

  get roomIds() {
    return this._roomIds;
  }

  get lists() {
    return this._lists;
  }

  start() {
    this.mjolnirWatchRef = _SettingsStore.default.watchSetting("mjolnirRooms", null, this.onListsChanged.bind(this));
    this.dispatcherRef = _dispatcher.default.register(this.onAction);

    _dispatcher.default.dispatch({
      action: _actions.Action.DoAfterSyncPrepared,
      deferred_action: {
        action: 'setup_mjolnir'
      }
    });
  }

  setup() {
    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;
    this.updateLists(_SettingsStore.default.getValue("mjolnirRooms"));

    _MatrixClientPeg.MatrixClientPeg.get().on(_roomState.RoomStateEvent.Events, this.onEvent);
  }

  stop() {
    if (this.mjolnirWatchRef) {
      _SettingsStore.default.unwatchSetting(this.mjolnirWatchRef);

      this.mjolnirWatchRef = null;
    }

    if (this.dispatcherRef) {
      _dispatcher.default.unregister(this.dispatcherRef);

      this.dispatcherRef = null;
    }

    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;

    _MatrixClientPeg.MatrixClientPeg.get().removeListener(_roomState.RoomStateEvent.Events, this.onEvent);
  }

  async getOrCreatePersonalList() {
    let personalRoomId = _SettingsStore.default.getValue("mjolnirPersonalRoom");

    if (!personalRoomId) {
      const resp = await _MatrixClientPeg.MatrixClientPeg.get().createRoom({
        name: (0, _languageHandler._t)("My Ban List"),
        topic: (0, _languageHandler._t)("This is your list of users/servers you have blocked - don't leave the room!"),
        preset: _partials.Preset.PrivateChat
      });
      personalRoomId = resp['room_id'];
      await _SettingsStore.default.setValue("mjolnirPersonalRoom", null, _SettingLevel.SettingLevel.ACCOUNT, personalRoomId);
      await _SettingsStore.default.setValue("mjolnirRooms", null, _SettingLevel.SettingLevel.ACCOUNT, [personalRoomId, ...this._roomIds]);
    }

    if (!personalRoomId) {
      throw new Error("Error finding a room ID to use");
    }

    let list = this._lists.find(b => b.roomId === personalRoomId);

    if (!list) list = new _BanList.BanList(personalRoomId); // we don't append the list to the tracked rooms because it should already be there.
    // we're just trying to get the caller some utility access to the list

    return list;
  } // get without creating the list


  getPersonalList() {
    const personalRoomId = _SettingsStore.default.getValue("mjolnirPersonalRoom");

    if (!personalRoomId) return null;

    let list = this._lists.find(b => b.roomId === personalRoomId);

    if (!list) list = new _BanList.BanList(personalRoomId); // we don't append the list to the tracked rooms because it should already be there.
    // we're just trying to get the caller some utility access to the list

    return list;
  }

  async subscribeToList(roomId) {
    const roomIds = [...this._roomIds, roomId];
    await _SettingsStore.default.setValue("mjolnirRooms", null, _SettingLevel.SettingLevel.ACCOUNT, roomIds);

    this._lists.push(new _BanList.BanList(roomId));
  }

  async unsubscribeFromList(roomId) {
    const roomIds = this._roomIds.filter(r => r !== roomId);

    await _SettingsStore.default.setValue("mjolnirRooms", null, _SettingLevel.SettingLevel.ACCOUNT, roomIds);
    this._lists = this._lists.filter(b => b.roomId !== roomId);
  }

  onListsChanged(settingName, roomId, atLevel, newValue) {
    // We know that ban lists are only recorded at one level so we don't need to re-eval them
    this.updateLists(newValue);
  }

  updateLists(listRoomIds) {
    if (!_MatrixClientPeg.MatrixClientPeg.get()) return;

    _logger.logger.log("Updating Mjolnir ban lists to: " + listRoomIds);

    this._lists = [];
    this._roomIds = listRoomIds || [];
    if (!listRoomIds) return;

    for (const roomId of listRoomIds) {
      // Creating the list updates it
      this._lists.push(new _BanList.BanList(roomId));
    }
  }

  isServerBanned(serverName) {
    for (const list of this._lists) {
      for (const rule of list.serverRules) {
        if (rule.isMatch(serverName)) {
          return true;
        }
      }
    }

    return false;
  }

  isUserBanned(userId) {
    for (const list of this._lists) {
      for (const rule of list.userRules) {
        if (rule.isMatch(userId)) {
          return true;
        }
      }
    }

    return false;
  }

  static sharedInstance() {
    if (!Mjolnir.instance) {
      Mjolnir.instance = new Mjolnir();
    }

    return Mjolnir.instance;
  }

}

exports.Mjolnir = Mjolnir;
(0, _defineProperty2.default)(Mjolnir, "instance", null);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNam9sbmlyIiwicGF5bG9hZCIsImxvZ2dlciIsImxvZyIsInNldHVwIiwiZXZlbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJfcm9vbUlkcyIsImluY2x1ZGVzIiwiZ2V0Um9vbUlkIiwiQUxMX1JVTEVfVFlQRVMiLCJnZXRUeXBlIiwidXBkYXRlTGlzdHMiLCJyb29tSWRzIiwibGlzdHMiLCJfbGlzdHMiLCJzdGFydCIsIm1qb2xuaXJXYXRjaFJlZiIsIlNldHRpbmdzU3RvcmUiLCJ3YXRjaFNldHRpbmciLCJvbkxpc3RzQ2hhbmdlZCIsImJpbmQiLCJkaXNwYXRjaGVyUmVmIiwiZGlzIiwicmVnaXN0ZXIiLCJvbkFjdGlvbiIsImRpc3BhdGNoIiwiYWN0aW9uIiwiQWN0aW9uIiwiRG9BZnRlclN5bmNQcmVwYXJlZCIsImRlZmVycmVkX2FjdGlvbiIsImdldFZhbHVlIiwib24iLCJSb29tU3RhdGVFdmVudCIsIkV2ZW50cyIsIm9uRXZlbnQiLCJzdG9wIiwidW53YXRjaFNldHRpbmciLCJ1bnJlZ2lzdGVyIiwicmVtb3ZlTGlzdGVuZXIiLCJnZXRPckNyZWF0ZVBlcnNvbmFsTGlzdCIsInBlcnNvbmFsUm9vbUlkIiwicmVzcCIsImNyZWF0ZVJvb20iLCJuYW1lIiwiX3QiLCJ0b3BpYyIsInByZXNldCIsIlByZXNldCIsIlByaXZhdGVDaGF0Iiwic2V0VmFsdWUiLCJTZXR0aW5nTGV2ZWwiLCJBQ0NPVU5UIiwiRXJyb3IiLCJsaXN0IiwiZmluZCIsImIiLCJyb29tSWQiLCJCYW5MaXN0IiwiZ2V0UGVyc29uYWxMaXN0Iiwic3Vic2NyaWJlVG9MaXN0IiwicHVzaCIsInVuc3Vic2NyaWJlRnJvbUxpc3QiLCJmaWx0ZXIiLCJyIiwic2V0dGluZ05hbWUiLCJhdExldmVsIiwibmV3VmFsdWUiLCJsaXN0Um9vbUlkcyIsImlzU2VydmVyQmFubmVkIiwic2VydmVyTmFtZSIsInJ1bGUiLCJzZXJ2ZXJSdWxlcyIsImlzTWF0Y2giLCJpc1VzZXJCYW5uZWQiLCJ1c2VySWQiLCJ1c2VyUnVsZXMiLCJzaGFyZWRJbnN0YW5jZSIsImluc3RhbmNlIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL21qb2xuaXIvTWpvbG5pci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFByZXNldCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvcGFydGlhbHNcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcbmltcG9ydCB7IFJvb21TdGF0ZUV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tLXN0YXRlXCI7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IEFMTF9SVUxFX1RZUEVTLCBCYW5MaXN0IH0gZnJvbSBcIi4vQmFuTGlzdFwiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4uL3NldHRpbmdzL1NldHRpbmdzU3RvcmVcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBTZXR0aW5nTGV2ZWwgfSBmcm9tIFwiLi4vc2V0dGluZ3MvU2V0dGluZ0xldmVsXCI7XG5pbXBvcnQgeyBBY3Rpb25QYXlsb2FkIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvcGF5bG9hZHNcIjtcbmltcG9ydCB7IERvQWZ0ZXJTeW5jUHJlcGFyZWRQYXlsb2FkIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvcGF5bG9hZHMvRG9BZnRlclN5bmNQcmVwYXJlZFBheWxvYWRcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcblxuLy8gVE9ETzogTW92ZSB0aGlzIGFuZCByZWxhdGVkIGZpbGVzIHRvIHRoZSBqcy1zZGsgb3Igc29tZXRoaW5nIG9uY2UgZmluYWxpemVkLlxuXG5leHBvcnQgY2xhc3MgTWpvbG5pciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IE1qb2xuaXIgPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBfbGlzdHM6IEJhbkxpc3RbXSA9IFtdOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICAgIHByaXZhdGUgX3Jvb21JZHM6IHN0cmluZ1tdID0gW107IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uXG4gICAgcHJpdmF0ZSBtam9sbmlyV2F0Y2hSZWY6IHN0cmluZyA9IG51bGw7XG4gICAgcHJpdmF0ZSBkaXNwYXRjaGVyUmVmOiBzdHJpbmcgPSBudWxsO1xuXG4gICAgZ2V0IHJvb21JZHMoKTogc3RyaW5nW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5fcm9vbUlkcztcbiAgICB9XG5cbiAgICBnZXQgbGlzdHMoKTogQmFuTGlzdFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RzO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLm1qb2xuaXJXYXRjaFJlZiA9IFNldHRpbmdzU3RvcmUud2F0Y2hTZXR0aW5nKFwibWpvbG5pclJvb21zXCIsIG51bGwsIHRoaXMub25MaXN0c0NoYW5nZWQuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gZGlzLnJlZ2lzdGVyKHRoaXMub25BY3Rpb24pO1xuICAgICAgICBkaXMuZGlzcGF0Y2g8RG9BZnRlclN5bmNQcmVwYXJlZFBheWxvYWQ8QWN0aW9uUGF5bG9hZD4+KHtcbiAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLkRvQWZ0ZXJTeW5jUHJlcGFyZWQsXG4gICAgICAgICAgICBkZWZlcnJlZF9hY3Rpb246IHsgYWN0aW9uOiAnc2V0dXBfbWpvbG5pcicgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkFjdGlvbiA9IChwYXlsb2FkOiBBY3Rpb25QYXlsb2FkKSA9PiB7XG4gICAgICAgIGlmIChwYXlsb2FkWydhY3Rpb24nXSA9PT0gJ3NldHVwX21qb2xuaXInKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKFwiU2V0dGluZyB1cCBNam9sbmlyOiBhZnRlciBzeW5jXCIpO1xuICAgICAgICAgICAgdGhpcy5zZXR1cCgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHNldHVwKCkge1xuICAgICAgICBpZiAoIU1hdHJpeENsaWVudFBlZy5nZXQoKSkgcmV0dXJuO1xuICAgICAgICB0aGlzLnVwZGF0ZUxpc3RzKFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJtam9sbmlyUm9vbXNcIikpO1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkub24oUm9vbVN0YXRlRXZlbnQuRXZlbnRzLCB0aGlzLm9uRXZlbnQpO1xuICAgIH1cblxuICAgIHN0b3AoKSB7XG4gICAgICAgIGlmICh0aGlzLm1qb2xuaXJXYXRjaFJlZikge1xuICAgICAgICAgICAgU2V0dGluZ3NTdG9yZS51bndhdGNoU2V0dGluZyh0aGlzLm1qb2xuaXJXYXRjaFJlZik7XG4gICAgICAgICAgICB0aGlzLm1qb2xuaXJXYXRjaFJlZiA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5kaXNwYXRjaGVyUmVmKSB7XG4gICAgICAgICAgICBkaXMudW5yZWdpc3Rlcih0aGlzLmRpc3BhdGNoZXJSZWYpO1xuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghTWF0cml4Q2xpZW50UGVnLmdldCgpKSByZXR1cm47XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5yZW1vdmVMaXN0ZW5lcihSb29tU3RhdGVFdmVudC5FdmVudHMsIHRoaXMub25FdmVudCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0T3JDcmVhdGVQZXJzb25hbExpc3QoKTogUHJvbWlzZTxCYW5MaXN0PiB7XG4gICAgICAgIGxldCBwZXJzb25hbFJvb21JZCA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJtam9sbmlyUGVyc29uYWxSb29tXCIpO1xuICAgICAgICBpZiAoIXBlcnNvbmFsUm9vbUlkKSB7XG4gICAgICAgICAgICBjb25zdCByZXNwID0gYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLmNyZWF0ZVJvb20oe1xuICAgICAgICAgICAgICAgIG5hbWU6IF90KFwiTXkgQmFuIExpc3RcIiksXG4gICAgICAgICAgICAgICAgdG9waWM6IF90KFwiVGhpcyBpcyB5b3VyIGxpc3Qgb2YgdXNlcnMvc2VydmVycyB5b3UgaGF2ZSBibG9ja2VkIC0gZG9uJ3QgbGVhdmUgdGhlIHJvb20hXCIpLFxuICAgICAgICAgICAgICAgIHByZXNldDogUHJlc2V0LlByaXZhdGVDaGF0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBwZXJzb25hbFJvb21JZCA9IHJlc3BbJ3Jvb21faWQnXTtcbiAgICAgICAgICAgIGF3YWl0IFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXG4gICAgICAgICAgICAgICAgXCJtam9sbmlyUGVyc29uYWxSb29tXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCBwZXJzb25hbFJvb21JZCk7XG4gICAgICAgICAgICBhd2FpdCBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFxuICAgICAgICAgICAgICAgIFwibWpvbG5pclJvb21zXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCBbcGVyc29uYWxSb29tSWQsIC4uLnRoaXMuX3Jvb21JZHNdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXBlcnNvbmFsUm9vbUlkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciBmaW5kaW5nIGEgcm9vbSBJRCB0byB1c2VcIik7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbGlzdCA9IHRoaXMuX2xpc3RzLmZpbmQoYiA9PiBiLnJvb21JZCA9PT0gcGVyc29uYWxSb29tSWQpO1xuICAgICAgICBpZiAoIWxpc3QpIGxpc3QgPSBuZXcgQmFuTGlzdChwZXJzb25hbFJvb21JZCk7XG4gICAgICAgIC8vIHdlIGRvbid0IGFwcGVuZCB0aGUgbGlzdCB0byB0aGUgdHJhY2tlZCByb29tcyBiZWNhdXNlIGl0IHNob3VsZCBhbHJlYWR5IGJlIHRoZXJlLlxuICAgICAgICAvLyB3ZSdyZSBqdXN0IHRyeWluZyB0byBnZXQgdGhlIGNhbGxlciBzb21lIHV0aWxpdHkgYWNjZXNzIHRvIHRoZSBsaXN0XG5cbiAgICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgfVxuXG4gICAgLy8gZ2V0IHdpdGhvdXQgY3JlYXRpbmcgdGhlIGxpc3RcbiAgICBnZXRQZXJzb25hbExpc3QoKTogQmFuTGlzdCB7XG4gICAgICAgIGNvbnN0IHBlcnNvbmFsUm9vbUlkID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcIm1qb2xuaXJQZXJzb25hbFJvb21cIik7XG4gICAgICAgIGlmICghcGVyc29uYWxSb29tSWQpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGxldCBsaXN0ID0gdGhpcy5fbGlzdHMuZmluZChiID0+IGIucm9vbUlkID09PSBwZXJzb25hbFJvb21JZCk7XG4gICAgICAgIGlmICghbGlzdCkgbGlzdCA9IG5ldyBCYW5MaXN0KHBlcnNvbmFsUm9vbUlkKTtcbiAgICAgICAgLy8gd2UgZG9uJ3QgYXBwZW5kIHRoZSBsaXN0IHRvIHRoZSB0cmFja2VkIHJvb21zIGJlY2F1c2UgaXQgc2hvdWxkIGFscmVhZHkgYmUgdGhlcmUuXG4gICAgICAgIC8vIHdlJ3JlIGp1c3QgdHJ5aW5nIHRvIGdldCB0aGUgY2FsbGVyIHNvbWUgdXRpbGl0eSBhY2Nlc3MgdG8gdGhlIGxpc3RcblxuICAgICAgICByZXR1cm4gbGlzdDtcbiAgICB9XG5cbiAgICBhc3luYyBzdWJzY3JpYmVUb0xpc3Qocm9vbUlkOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qgcm9vbUlkcyA9IFsuLi50aGlzLl9yb29tSWRzLCByb29tSWRdO1xuICAgICAgICBhd2FpdCBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwibWpvbG5pclJvb21zXCIsIG51bGwsIFNldHRpbmdMZXZlbC5BQ0NPVU5ULCByb29tSWRzKTtcbiAgICAgICAgdGhpcy5fbGlzdHMucHVzaChuZXcgQmFuTGlzdChyb29tSWQpKTtcbiAgICB9XG5cbiAgICBhc3luYyB1bnN1YnNjcmliZUZyb21MaXN0KHJvb21JZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHJvb21JZHMgPSB0aGlzLl9yb29tSWRzLmZpbHRlcihyID0+IHIgIT09IHJvb21JZCk7XG4gICAgICAgIGF3YWl0IFNldHRpbmdzU3RvcmUuc2V0VmFsdWUoXCJtam9sbmlyUm9vbXNcIiwgbnVsbCwgU2V0dGluZ0xldmVsLkFDQ09VTlQsIHJvb21JZHMpO1xuICAgICAgICB0aGlzLl9saXN0cyA9IHRoaXMuX2xpc3RzLmZpbHRlcihiID0+IGIucm9vbUlkICE9PSByb29tSWQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25FdmVudCA9IChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKCFNYXRyaXhDbGllbnRQZWcuZ2V0KCkpIHJldHVybjtcbiAgICAgICAgaWYgKCF0aGlzLl9yb29tSWRzLmluY2x1ZGVzKGV2ZW50LmdldFJvb21JZCgpKSkgcmV0dXJuO1xuICAgICAgICBpZiAoIUFMTF9SVUxFX1RZUEVTLmluY2x1ZGVzKGV2ZW50LmdldFR5cGUoKSkpIHJldHVybjtcblxuICAgICAgICB0aGlzLnVwZGF0ZUxpc3RzKHRoaXMuX3Jvb21JZHMpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uTGlzdHNDaGFuZ2VkKHNldHRpbmdOYW1lOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCBhdExldmVsOiBTZXR0aW5nTGV2ZWwsIG5ld1ZhbHVlOiBzdHJpbmdbXSkge1xuICAgICAgICAvLyBXZSBrbm93IHRoYXQgYmFuIGxpc3RzIGFyZSBvbmx5IHJlY29yZGVkIGF0IG9uZSBsZXZlbCBzbyB3ZSBkb24ndCBuZWVkIHRvIHJlLWV2YWwgdGhlbVxuICAgICAgICB0aGlzLnVwZGF0ZUxpc3RzKG5ld1ZhbHVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUxpc3RzKGxpc3RSb29tSWRzOiBzdHJpbmdbXSkge1xuICAgICAgICBpZiAoIU1hdHJpeENsaWVudFBlZy5nZXQoKSkgcmV0dXJuO1xuXG4gICAgICAgIGxvZ2dlci5sb2coXCJVcGRhdGluZyBNam9sbmlyIGJhbiBsaXN0cyB0bzogXCIgKyBsaXN0Um9vbUlkcyk7XG4gICAgICAgIHRoaXMuX2xpc3RzID0gW107XG4gICAgICAgIHRoaXMuX3Jvb21JZHMgPSBsaXN0Um9vbUlkcyB8fCBbXTtcbiAgICAgICAgaWYgKCFsaXN0Um9vbUlkcykgcmV0dXJuO1xuXG4gICAgICAgIGZvciAoY29uc3Qgcm9vbUlkIG9mIGxpc3RSb29tSWRzKSB7XG4gICAgICAgICAgICAvLyBDcmVhdGluZyB0aGUgbGlzdCB1cGRhdGVzIGl0XG4gICAgICAgICAgICB0aGlzLl9saXN0cy5wdXNoKG5ldyBCYW5MaXN0KHJvb21JZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaXNTZXJ2ZXJCYW5uZWQoc2VydmVyTmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGZvciAoY29uc3QgbGlzdCBvZiB0aGlzLl9saXN0cykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBydWxlIG9mIGxpc3Quc2VydmVyUnVsZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAocnVsZS5pc01hdGNoKHNlcnZlck5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaXNVc2VyQmFubmVkKHVzZXJJZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGZvciAoY29uc3QgbGlzdCBvZiB0aGlzLl9saXN0cykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBydWxlIG9mIGxpc3QudXNlclJ1bGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJ1bGUuaXNNYXRjaCh1c2VySWQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgc3RhdGljIHNoYXJlZEluc3RhbmNlKCk6IE1qb2xuaXIge1xuICAgICAgICBpZiAoIU1qb2xuaXIuaW5zdGFuY2UpIHtcbiAgICAgICAgICAgIE1qb2xuaXIuaW5zdGFuY2UgPSBuZXcgTWpvbG5pcigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBNam9sbmlyLmluc3RhbmNlO1xuICAgIH1cbn1cblxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUE3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBaUJBO0FBRU8sTUFBTUEsT0FBTixDQUFjO0VBQUE7SUFBQSw4Q0FHVyxFQUhYO0lBQUEsZ0RBSVksRUFKWjtJQUFBLHVEQUtpQixJQUxqQjtJQUFBLHFEQU1lLElBTmY7SUFBQSxnREEwQkdDLE9BQUQsSUFBNEI7TUFDM0MsSUFBSUEsT0FBTyxDQUFDLFFBQUQsQ0FBUCxLQUFzQixlQUExQixFQUEyQztRQUN2Q0MsY0FBQSxDQUFPQyxHQUFQLENBQVcsZ0NBQVg7O1FBQ0EsS0FBS0MsS0FBTDtNQUNIO0lBQ0osQ0EvQmdCO0lBQUEsK0NBeUdFQyxLQUFELElBQXdCO01BQ3RDLElBQUksQ0FBQ0MsZ0NBQUEsQ0FBZ0JDLEdBQWhCLEVBQUwsRUFBNEI7TUFDNUIsSUFBSSxDQUFDLEtBQUtDLFFBQUwsQ0FBY0MsUUFBZCxDQUF1QkosS0FBSyxDQUFDSyxTQUFOLEVBQXZCLENBQUwsRUFBZ0Q7TUFDaEQsSUFBSSxDQUFDQyx1QkFBQSxDQUFlRixRQUFmLENBQXdCSixLQUFLLENBQUNPLE9BQU4sRUFBeEIsQ0FBTCxFQUErQztNQUUvQyxLQUFLQyxXQUFMLENBQWlCLEtBQUtMLFFBQXRCO0lBQ0gsQ0EvR2dCO0VBQUE7O0VBUU4sSUFBUE0sT0FBTyxHQUFhO0lBQ3BCLE9BQU8sS0FB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