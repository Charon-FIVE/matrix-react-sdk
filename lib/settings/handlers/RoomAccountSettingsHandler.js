"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _room = require("matrix-js-sdk/src/models/room");

var _utils = require("matrix-js-sdk/src/utils");

var _MatrixClientBackedSettingsHandler = _interopRequireDefault(require("./MatrixClientBackedSettingsHandler"));

var _objects = require("../../utils/objects");

var _SettingLevel = require("../SettingLevel");

/*
Copyright 2017 Travis Ralston
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const ALLOWED_WIDGETS_EVENT_TYPE = "im.vector.setting.allowed_widgets";
const DEFAULT_SETTINGS_EVENT_TYPE = "im.vector.web.settings";
/**
 * Gets and sets settings at the "room-account" level for the current user.
 */

class RoomAccountSettingsHandler extends _MatrixClientBackedSettingsHandler.default {
  constructor(watchers) {
    super();
    this.watchers = watchers;
    (0, _defineProperty2.default)(this, "onAccountData", (event, room, prevEvent) => {
      const roomId = room.roomId;

      if (event.getType() === "org.matrix.room.preview_urls") {
        let val = event.getContent()['disable'];

        if (typeof val !== "boolean") {
          val = null;
        } else {
          val = !val;
        }

        this.watchers.notifyUpdate("urlPreviewsEnabled", roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, val);
      } else if (event.getType() === DEFAULT_SETTINGS_EVENT_TYPE) {
        // Figure out what changed and fire those updates
        const prevContent = prevEvent ? prevEvent.getContent() : {};
        const changedSettings = (0, _objects.objectKeyChanges)(prevContent, event.getContent());

        for (const settingName of changedSettings) {
          const val = event.getContent()[settingName];
          this.watchers.notifyUpdate(settingName, roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, val);
        }
      } else if (event.getType() === ALLOWED_WIDGETS_EVENT_TYPE) {
        this.watchers.notifyUpdate("allowedWidgets", roomId, _SettingLevel.SettingLevel.ROOM_ACCOUNT, event.getContent());
      }
    });
  }

  initMatrixClient(oldClient, newClient) {
    if (oldClient) {
      oldClient.removeListener(_room.RoomEvent.AccountData, this.onAccountData);
    }

    newClient.on(_room.RoomEvent.AccountData, this.onAccountData);
  }

  getValue(settingName, roomId) {
    // Special case URL previews
    if (settingName === "urlPreviewsEnabled") {
      const content = this.getSettings(roomId, "org.matrix.room.preview_urls") || {}; // Check to make sure that we actually got a boolean

      if (typeof content['disable'] !== "boolean") return null;
      return !content['disable'];
    } // Special case allowed widgets


    if (settingName === "allowedWidgets") {
      return this.getSettings(roomId, ALLOWED_WIDGETS_EVENT_TYPE);
    }

    const settings = this.getSettings(roomId) || {};
    return settings[settingName];
  } // helper function to send room account data then await it being echoed back


  async setRoomAccountData(roomId, eventType, field, value) {
    let content;

    if (field === null) {
      content = value;
    } else {
      content = this.getSettings(roomId, eventType) || {};
      content[field] = value;
    }

    await this.client.setRoomAccountData(roomId, eventType, content);
    const deferred = (0, _utils.defer)();

    const handler = (event, room) => {
      if (room.roomId !== roomId || event.getType() !== eventType) return;
      if (field !== null && event.getContent()[field] !== value) return;
      this.client.off(_room.RoomEvent.AccountData, handler);
      deferred.resolve();
    };

    this.client.on(_room.RoomEvent.AccountData, handler);
    await deferred.promise;
  }

  setValue(settingName, roomId, newValue) {
    switch (settingName) {
      // Special case URL previews
      case "urlPreviewsEnabled":
        return this.setRoomAccountData(roomId, "org.matrix.room.preview_urls", "disable", !newValue);
      // Special case allowed widgets

      case "allowedWidgets":
        return this.setRoomAccountData(roomId, ALLOWED_WIDGETS_EVENT_TYPE, null, newValue);

      default:
        return this.setRoomAccountData(roomId, DEFAULT_SETTINGS_EVENT_TYPE, settingName, newValue);
    }
  }

  canSetValue(settingName, roomId) {
    // If they have the room, they can set their own account data
    return !!this.client.getRoom(roomId);
  }

  isSupported() {
    return this.client && !this.client.isGuest();
  }

  getSettings(roomId) {
    let eventType = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : DEFAULT_SETTINGS_EVENT_TYPE;
    // TODO: [TS] Type return
    const event = this.client.getRoom(roomId)?.getAccountData(eventType);
    if (!event || !event.getContent()) return null;
    return (0, _objects.objectClone)(event.getContent()); // clone to prevent mutation
  }

}

exports.default = RoomAccountSettingsHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBTExPV0VEX1dJREdFVFNfRVZFTlRfVFlQRSIsIkRFRkFVTFRfU0VUVElOR1NfRVZFTlRfVFlQRSIsIlJvb21BY2NvdW50U2V0dGluZ3NIYW5kbGVyIiwiTWF0cml4Q2xpZW50QmFja2VkU2V0dGluZ3NIYW5kbGVyIiwiY29uc3RydWN0b3IiLCJ3YXRjaGVycyIsImV2ZW50Iiwicm9vbSIsInByZXZFdmVudCIsInJvb21JZCIsImdldFR5cGUiLCJ2YWwiLCJnZXRDb250ZW50Iiwibm90aWZ5VXBkYXRlIiwiU2V0dGluZ0xldmVsIiwiUk9PTV9BQ0NPVU5UIiwicHJldkNvbnRlbnQiLCJjaGFuZ2VkU2V0dGluZ3MiLCJvYmplY3RLZXlDaGFuZ2VzIiwic2V0dGluZ05hbWUiLCJpbml0TWF0cml4Q2xpZW50Iiwib2xkQ2xpZW50IiwibmV3Q2xpZW50IiwicmVtb3ZlTGlzdGVuZXIiLCJSb29tRXZlbnQiLCJBY2NvdW50RGF0YSIsIm9uQWNjb3VudERhdGEiLCJvbiIsImdldFZhbHVlIiwiY29udGVudCIsImdldFNldHRpbmdzIiwic2V0dGluZ3MiLCJzZXRSb29tQWNjb3VudERhdGEiLCJldmVudFR5cGUiLCJmaWVsZCIsInZhbHVlIiwiY2xpZW50IiwiZGVmZXJyZWQiLCJkZWZlciIsImhhbmRsZXIiLCJvZmYiLCJyZXNvbHZlIiwicHJvbWlzZSIsInNldFZhbHVlIiwibmV3VmFsdWUiLCJjYW5TZXRWYWx1ZSIsImdldFJvb20iLCJpc1N1cHBvcnRlZCIsImlzR3Vlc3QiLCJnZXRBY2NvdW50RGF0YSIsIm9iamVjdENsb25lIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NldHRpbmdzL2hhbmRsZXJzL1Jvb21BY2NvdW50U2V0dGluZ3NIYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNyBUcmF2aXMgUmFsc3RvblxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY2xpZW50XCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFJvb20sIFJvb21FdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgZGVmZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvdXRpbHNcIjtcblxuaW1wb3J0IE1hdHJpeENsaWVudEJhY2tlZFNldHRpbmdzSGFuZGxlciBmcm9tIFwiLi9NYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXJcIjtcbmltcG9ydCB7IG9iamVjdENsb25lLCBvYmplY3RLZXlDaGFuZ2VzIH0gZnJvbSBcIi4uLy4uL3V0aWxzL29iamVjdHNcIjtcbmltcG9ydCB7IFNldHRpbmdMZXZlbCB9IGZyb20gXCIuLi9TZXR0aW5nTGV2ZWxcIjtcbmltcG9ydCB7IFdhdGNoTWFuYWdlciB9IGZyb20gXCIuLi9XYXRjaE1hbmFnZXJcIjtcblxuY29uc3QgQUxMT1dFRF9XSURHRVRTX0VWRU5UX1RZUEUgPSBcImltLnZlY3Rvci5zZXR0aW5nLmFsbG93ZWRfd2lkZ2V0c1wiO1xuY29uc3QgREVGQVVMVF9TRVRUSU5HU19FVkVOVF9UWVBFID0gXCJpbS52ZWN0b3Iud2ViLnNldHRpbmdzXCI7XG5cbi8qKlxuICogR2V0cyBhbmQgc2V0cyBzZXR0aW5ncyBhdCB0aGUgXCJyb29tLWFjY291bnRcIiBsZXZlbCBmb3IgdGhlIGN1cnJlbnQgdXNlci5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUm9vbUFjY291bnRTZXR0aW5nc0hhbmRsZXIgZXh0ZW5kcyBNYXRyaXhDbGllbnRCYWNrZWRTZXR0aW5nc0hhbmRsZXIge1xuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSB3YXRjaGVyczogV2F0Y2hNYW5hZ2VyKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGluaXRNYXRyaXhDbGllbnQob2xkQ2xpZW50OiBNYXRyaXhDbGllbnQsIG5ld0NsaWVudDogTWF0cml4Q2xpZW50KSB7XG4gICAgICAgIGlmIChvbGRDbGllbnQpIHtcbiAgICAgICAgICAgIG9sZENsaWVudC5yZW1vdmVMaXN0ZW5lcihSb29tRXZlbnQuQWNjb3VudERhdGEsIHRoaXMub25BY2NvdW50RGF0YSk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdDbGllbnQub24oUm9vbUV2ZW50LkFjY291bnREYXRhLCB0aGlzLm9uQWNjb3VudERhdGEpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25BY2NvdW50RGF0YSA9IChldmVudDogTWF0cml4RXZlbnQsIHJvb206IFJvb20sIHByZXZFdmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gcm9vbS5yb29tSWQ7XG5cbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJvcmcubWF0cml4LnJvb20ucHJldmlld191cmxzXCIpIHtcbiAgICAgICAgICAgIGxldCB2YWwgPSBldmVudC5nZXRDb250ZW50KClbJ2Rpc2FibGUnXTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgKHZhbCkgIT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgICAgICAgICAgdmFsID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsID0gIXZhbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5ub3RpZnlVcGRhdGUoXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIiwgcm9vbUlkLCBTZXR0aW5nTGV2ZWwuUk9PTV9BQ0NPVU5ULCB2YWwpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gREVGQVVMVF9TRVRUSU5HU19FVkVOVF9UWVBFKSB7XG4gICAgICAgICAgICAvLyBGaWd1cmUgb3V0IHdoYXQgY2hhbmdlZCBhbmQgZmlyZSB0aG9zZSB1cGRhdGVzXG4gICAgICAgICAgICBjb25zdCBwcmV2Q29udGVudCA9IHByZXZFdmVudCA/IHByZXZFdmVudC5nZXRDb250ZW50KCkgOiB7fTtcbiAgICAgICAgICAgIGNvbnN0IGNoYW5nZWRTZXR0aW5ncyA9IG9iamVjdEtleUNoYW5nZXM8UmVjb3JkPHN0cmluZywgYW55Pj4ocHJldkNvbnRlbnQsIGV2ZW50LmdldENvbnRlbnQoKSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNldHRpbmdOYW1lIG9mIGNoYW5nZWRTZXR0aW5ncykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGV2ZW50LmdldENvbnRlbnQoKVtzZXR0aW5nTmFtZV07XG4gICAgICAgICAgICAgICAgdGhpcy53YXRjaGVycy5ub3RpZnlVcGRhdGUoc2V0dGluZ05hbWUsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgdmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5nZXRUeXBlKCkgPT09IEFMTE9XRURfV0lER0VUU19FVkVOVF9UWVBFKSB7XG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLm5vdGlmeVVwZGF0ZShcImFsbG93ZWRXaWRnZXRzXCIsIHJvb21JZCwgU2V0dGluZ0xldmVsLlJPT01fQUNDT1VOVCwgZXZlbnQuZ2V0Q29udGVudCgpKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgZ2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICAvLyBTcGVjaWFsIGNhc2UgVVJMIHByZXZpZXdzXG4gICAgICAgIGlmIChzZXR0aW5nTmFtZSA9PT0gXCJ1cmxQcmV2aWV3c0VuYWJsZWRcIikge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkLCBcIm9yZy5tYXRyaXgucm9vbS5wcmV2aWV3X3VybHNcIikgfHwge307XG5cbiAgICAgICAgICAgIC8vIENoZWNrIHRvIG1ha2Ugc3VyZSB0aGF0IHdlIGFjdHVhbGx5IGdvdCBhIGJvb2xlYW5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgKGNvbnRlbnRbJ2Rpc2FibGUnXSkgIT09IFwiYm9vbGVhblwiKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiAhY29udGVudFsnZGlzYWJsZSddO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGFsbG93ZWQgd2lkZ2V0c1xuICAgICAgICBpZiAoc2V0dGluZ05hbWUgPT09IFwiYWxsb3dlZFdpZGdldHNcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkLCBBTExPV0VEX1dJREdFVFNfRVZFTlRfVFlQRSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkKSB8fCB7fTtcbiAgICAgICAgcmV0dXJuIHNldHRpbmdzW3NldHRpbmdOYW1lXTtcbiAgICB9XG5cbiAgICAvLyBoZWxwZXIgZnVuY3Rpb24gdG8gc2VuZCByb29tIGFjY291bnQgZGF0YSB0aGVuIGF3YWl0IGl0IGJlaW5nIGVjaG9lZCBiYWNrXG4gICAgcHJpdmF0ZSBhc3luYyBzZXRSb29tQWNjb3VudERhdGEoXG4gICAgICAgIHJvb21JZDogc3RyaW5nLFxuICAgICAgICBldmVudFR5cGU6IHN0cmluZyxcbiAgICAgICAgZmllbGQ6IHN0cmluZyB8IG51bGwsXG4gICAgICAgIHZhbHVlOiBhbnksXG4gICAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxldCBjb250ZW50OiBSZXR1cm5UeXBlPFJvb21BY2NvdW50U2V0dGluZ3NIYW5kbGVyW1wiZ2V0U2V0dGluZ3NcIl0+O1xuXG4gICAgICAgIGlmIChmaWVsZCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgY29udGVudCA9IHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udGVudCA9IHRoaXMuZ2V0U2V0dGluZ3Mocm9vbUlkLCBldmVudFR5cGUpIHx8IHt9O1xuICAgICAgICAgICAgY29udGVudFtmaWVsZF0gPSB2YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNldFJvb21BY2NvdW50RGF0YShyb29tSWQsIGV2ZW50VHlwZSwgY29udGVudCk7XG5cbiAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcjx2b2lkPigpO1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gKGV2ZW50OiBNYXRyaXhFdmVudCwgcm9vbTogUm9vbSkgPT4ge1xuICAgICAgICAgICAgaWYgKHJvb20ucm9vbUlkICE9PSByb29tSWQgfHwgZXZlbnQuZ2V0VHlwZSgpICE9PSBldmVudFR5cGUpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChmaWVsZCAhPT0gbnVsbCAmJiBldmVudC5nZXRDb250ZW50KClbZmllbGRdICE9PSB2YWx1ZSkgcmV0dXJuO1xuICAgICAgICAgICAgdGhpcy5jbGllbnQub2ZmKFJvb21FdmVudC5BY2NvdW50RGF0YSwgaGFuZGxlcik7XG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuY2xpZW50Lm9uKFJvb21FdmVudC5BY2NvdW50RGF0YSwgaGFuZGxlcik7XG5cbiAgICAgICAgYXdhaXQgZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcsIG5ld1ZhbHVlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgc3dpdGNoIChzZXR0aW5nTmFtZSkge1xuICAgICAgICAgICAgLy8gU3BlY2lhbCBjYXNlIFVSTCBwcmV2aWV3c1xuICAgICAgICAgICAgY2FzZSBcInVybFByZXZpZXdzRW5hYmxlZFwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFJvb21BY2NvdW50RGF0YShyb29tSWQsIFwib3JnLm1hdHJpeC5yb29tLnByZXZpZXdfdXJsc1wiLCBcImRpc2FibGVcIiwgIW5ld1ZhbHVlKTtcblxuICAgICAgICAgICAgLy8gU3BlY2lhbCBjYXNlIGFsbG93ZWQgd2lkZ2V0c1xuICAgICAgICAgICAgY2FzZSBcImFsbG93ZWRXaWRnZXRzXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0Um9vbUFjY291bnREYXRhKHJvb21JZCwgQUxMT1dFRF9XSURHRVRTX0VWRU5UX1RZUEUsIG51bGwsIG5ld1ZhbHVlKTtcblxuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRSb29tQWNjb3VudERhdGEocm9vbUlkLCBERUZBVUxUX1NFVFRJTkdTX0VWRU5UX1RZUEUsIHNldHRpbmdOYW1lLCBuZXdWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY2FuU2V0VmFsdWUoc2V0dGluZ05hbWU6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgLy8gSWYgdGhleSBoYXZlIHRoZSByb29tLCB0aGV5IGNhbiBzZXQgdGhlaXIgb3duIGFjY291bnQgZGF0YVxuICAgICAgICByZXR1cm4gISF0aGlzLmNsaWVudC5nZXRSb29tKHJvb21JZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzU3VwcG9ydGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQgJiYgIXRoaXMuY2xpZW50LmlzR3Vlc3QoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNldHRpbmdzKHJvb21JZDogc3RyaW5nLCBldmVudFR5cGUgPSBERUZBVUxUX1NFVFRJTkdTX0VWRU5UX1RZUEUpOiBhbnkgeyAvLyBUT0RPOiBbVFNdIFR5cGUgcmV0dXJuXG4gICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpcy5jbGllbnQuZ2V0Um9vbShyb29tSWQpPy5nZXRBY2NvdW50RGF0YShldmVudFR5cGUpO1xuICAgICAgICBpZiAoIWV2ZW50IHx8ICFldmVudC5nZXRDb250ZW50KCkpIHJldHVybiBudWxsO1xuICAgICAgICByZXR1cm4gb2JqZWN0Q2xvbmUoZXZlbnQuZ2V0Q29udGVudCgpKTsgLy8gY2xvbmUgdG8gcHJldmVudCBtdXRhdGlvblxuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBeEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBWUEsTUFBTUEsMEJBQTBCLEdBQUcsbUNBQW5DO0FBQ0EsTUFBTUMsMkJB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