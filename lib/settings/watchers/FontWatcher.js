"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FontWatcher = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _SettingsStore = _interopRequireDefault(require("../SettingsStore"));

var _units = require("../../utils/units");

var _actions = require("../../dispatcher/actions");

var _SettingLevel = require("../SettingLevel");

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class FontWatcher {
  // Externally we tell the user the font is size 15. Internally we use 10.
  constructor() {
    (0, _defineProperty2.default)(this, "dispatcherRef", void 0);
    (0, _defineProperty2.default)(this, "onAction", payload => {
      if (payload.action === _actions.Action.UpdateFontSize) {
        this.setRootFontSize(payload.size);
      } else if (payload.action === _actions.Action.UpdateSystemFont) {
        this.setSystemFont(payload);
      } else if (payload.action === _actions.Action.OnLoggedOut) {
        // Clear font overrides when logging out
        this.setRootFontSize(FontWatcher.DEFAULT_SIZE);
        this.setSystemFont({
          useSystemFont: false,
          font: ""
        });
      } else if (payload.action === _actions.Action.OnLoggedIn) {
        // Font size can be saved on the account, so grab value when logging in
        this.updateFont();
      }
    });
    (0, _defineProperty2.default)(this, "setRootFontSize", size => {
      const fontSize = Math.max(Math.min(FontWatcher.MAX_SIZE, size), FontWatcher.MIN_SIZE);

      if (fontSize !== size) {
        _SettingsStore.default.setValue("baseFontSize", null, _SettingLevel.SettingLevel.DEVICE, fontSize);
      }

      document.querySelector(":root").style.fontSize = (0, _units.toPx)(fontSize);
    });
    (0, _defineProperty2.default)(this, "setSystemFont", _ref => {
      let {
        useSystemFont,
        font
      } = _ref;

      if (useSystemFont) {
        // Make sure that fonts with spaces in their names get interpreted properly
        document.body.style.fontFamily = font.split(',').map(font => {
          font = font.trim();

          if (!font.startsWith('"') && !font.endsWith('"')) {
            font = `"${font}"`;
          }

          return font;
        }).join(',');
      } else {
        document.body.style.fontFamily = "";
      }
    });
    this.dispatcherRef = null;
  }

  start() {
    this.updateFont();
    this.dispatcherRef = _dispatcher.default.register(this.onAction);
  }

  stop() {
    _dispatcher.default.unregister(this.dispatcherRef);
  }

  updateFont() {
    this.setRootFontSize(_SettingsStore.default.getValue("baseFontSize"));
    this.setSystemFont({
      useSystemFont: _SettingsStore.default.getValue("useSystemFont"),
      font: _SettingsStore.default.getValue("systemFont")
    });
  }

}

exports.FontWatcher = FontWatcher;
(0, _defineProperty2.default)(FontWatcher, "MIN_SIZE", 8);
(0, _defineProperty2.default)(FontWatcher, "DEFAULT_SIZE", 10);
(0, _defineProperty2.default)(FontWatcher, "MAX_SIZE", 15);
(0, _defineProperty2.default)(FontWatcher, "SIZE_DIFF", 5);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJGb250V2F0Y2hlciIsImNvbnN0cnVjdG9yIiwicGF5bG9hZCIsImFjdGlvbiIsIkFjdGlvbiIsIlVwZGF0ZUZvbnRTaXplIiwic2V0Um9vdEZvbnRTaXplIiwic2l6ZSIsIlVwZGF0ZVN5c3RlbUZvbnQiLCJzZXRTeXN0ZW1Gb250IiwiT25Mb2dnZWRPdXQiLCJERUZBVUxUX1NJWkUiLCJ1c2VTeXN0ZW1Gb250IiwiZm9udCIsIk9uTG9nZ2VkSW4iLCJ1cGRhdGVGb250IiwiZm9udFNpemUiLCJNYXRoIiwibWF4IiwibWluIiwiTUFYX1NJWkUiLCJNSU5fU0laRSIsIlNldHRpbmdzU3RvcmUiLCJzZXRWYWx1ZSIsIlNldHRpbmdMZXZlbCIsIkRFVklDRSIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsInN0eWxlIiwidG9QeCIsImJvZHkiLCJmb250RmFtaWx5Iiwic3BsaXQiLCJtYXAiLCJ0cmltIiwic3RhcnRzV2l0aCIsImVuZHNXaXRoIiwiam9pbiIsImRpc3BhdGNoZXJSZWYiLCJzdGFydCIsImRpcyIsInJlZ2lzdGVyIiwib25BY3Rpb24iLCJzdG9wIiwidW5yZWdpc3RlciIsImdldFZhbHVlIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NldHRpbmdzL3dhdGNoZXJzL0ZvbnRXYXRjaGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBkaXMgZnJvbSAnLi4vLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gJy4uL1NldHRpbmdzU3RvcmUnO1xuaW1wb3J0IElXYXRjaGVyIGZyb20gXCIuL1dhdGNoZXJcIjtcbmltcG9ydCB7IHRvUHggfSBmcm9tICcuLi8uLi91dGlscy91bml0cyc7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuLi8uLi9kaXNwYXRjaGVyL2FjdGlvbnMnO1xuaW1wb3J0IHsgU2V0dGluZ0xldmVsIH0gZnJvbSBcIi4uL1NldHRpbmdMZXZlbFwiO1xuaW1wb3J0IHsgVXBkYXRlU3lzdGVtRm9udFBheWxvYWQgfSBmcm9tIFwiLi4vLi4vZGlzcGF0Y2hlci9wYXlsb2Fkcy9VcGRhdGVTeXN0ZW1Gb250UGF5bG9hZFwiO1xuaW1wb3J0IHsgQWN0aW9uUGF5bG9hZCB9IGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzXCI7XG5cbmV4cG9ydCBjbGFzcyBGb250V2F0Y2hlciBpbXBsZW1lbnRzIElXYXRjaGVyIHtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IE1JTl9TSVpFID0gODtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfU0laRSA9IDEwO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgTUFYX1NJWkUgPSAxNTtcbiAgICAvLyBFeHRlcm5hbGx5IHdlIHRlbGwgdGhlIHVzZXIgdGhlIGZvbnQgaXMgc2l6ZSAxNS4gSW50ZXJuYWxseSB3ZSB1c2UgMTAuXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBTSVpFX0RJRkYgPSA1O1xuXG4gICAgcHJpdmF0ZSBkaXNwYXRjaGVyUmVmOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyUmVmID0gbnVsbDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhcnQoKSB7XG4gICAgICAgIHRoaXMudXBkYXRlRm9udCgpO1xuICAgICAgICB0aGlzLmRpc3BhdGNoZXJSZWYgPSBkaXMucmVnaXN0ZXIodGhpcy5vbkFjdGlvbik7XG4gICAgfVxuXG4gICAgcHVibGljIHN0b3AoKSB7XG4gICAgICAgIGRpcy51bnJlZ2lzdGVyKHRoaXMuZGlzcGF0Y2hlclJlZik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVGb250KCkge1xuICAgICAgICB0aGlzLnNldFJvb3RGb250U2l6ZShTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwiYmFzZUZvbnRTaXplXCIpKTtcbiAgICAgICAgdGhpcy5zZXRTeXN0ZW1Gb250KHtcbiAgICAgICAgICAgIHVzZVN5c3RlbUZvbnQ6IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJ1c2VTeXN0ZW1Gb250XCIpLFxuICAgICAgICAgICAgZm9udDogU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcInN5c3RlbUZvbnRcIiksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25BY3Rpb24gPSAocGF5bG9hZDogQWN0aW9uUGF5bG9hZCkgPT4ge1xuICAgICAgICBpZiAocGF5bG9hZC5hY3Rpb24gPT09IEFjdGlvbi5VcGRhdGVGb250U2l6ZSkge1xuICAgICAgICAgICAgdGhpcy5zZXRSb290Rm9udFNpemUocGF5bG9hZC5zaXplKTtcbiAgICAgICAgfSBlbHNlIGlmIChwYXlsb2FkLmFjdGlvbiA9PT0gQWN0aW9uLlVwZGF0ZVN5c3RlbUZvbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3lzdGVtRm9udChwYXlsb2FkIGFzIFVwZGF0ZVN5c3RlbUZvbnRQYXlsb2FkKTtcbiAgICAgICAgfSBlbHNlIGlmIChwYXlsb2FkLmFjdGlvbiA9PT0gQWN0aW9uLk9uTG9nZ2VkT3V0KSB7XG4gICAgICAgICAgICAvLyBDbGVhciBmb250IG92ZXJyaWRlcyB3aGVuIGxvZ2dpbmcgb3V0XG4gICAgICAgICAgICB0aGlzLnNldFJvb3RGb250U2l6ZShGb250V2F0Y2hlci5ERUZBVUxUX1NJWkUpO1xuICAgICAgICAgICAgdGhpcy5zZXRTeXN0ZW1Gb250KHtcbiAgICAgICAgICAgICAgICB1c2VTeXN0ZW1Gb250OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBmb250OiBcIlwiLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAocGF5bG9hZC5hY3Rpb24gPT09IEFjdGlvbi5PbkxvZ2dlZEluKSB7XG4gICAgICAgICAgICAvLyBGb250IHNpemUgY2FuIGJlIHNhdmVkIG9uIHRoZSBhY2NvdW50LCBzbyBncmFiIHZhbHVlIHdoZW4gbG9nZ2luZyBpblxuICAgICAgICAgICAgdGhpcy51cGRhdGVGb250KCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBzZXRSb290Rm9udFNpemUgPSAoc2l6ZTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGZvbnRTaXplID0gTWF0aC5tYXgoTWF0aC5taW4oRm9udFdhdGNoZXIuTUFYX1NJWkUsIHNpemUpLCBGb250V2F0Y2hlci5NSU5fU0laRSk7XG5cbiAgICAgICAgaWYgKGZvbnRTaXplICE9PSBzaXplKSB7XG4gICAgICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwiYmFzZUZvbnRTaXplXCIsIG51bGwsIFNldHRpbmdMZXZlbC5ERVZJQ0UsIGZvbnRTaXplKTtcbiAgICAgICAgfVxuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yPEhUTUxFbGVtZW50PihcIjpyb290XCIpLnN0eWxlLmZvbnRTaXplID0gdG9QeChmb250U2l6ZSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgc2V0U3lzdGVtRm9udCA9ICh7IHVzZVN5c3RlbUZvbnQsIGZvbnQgfTogUGljazxVcGRhdGVTeXN0ZW1Gb250UGF5bG9hZCwgXCJ1c2VTeXN0ZW1Gb250XCIgfCBcImZvbnRcIj4pID0+IHtcbiAgICAgICAgaWYgKHVzZVN5c3RlbUZvbnQpIHtcbiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IGZvbnRzIHdpdGggc3BhY2VzIGluIHRoZWlyIG5hbWVzIGdldCBpbnRlcnByZXRlZCBwcm9wZXJseVxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5mb250RmFtaWx5ID0gZm9udFxuICAgICAgICAgICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgICAgICAgICAgLm1hcChmb250ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZm9udCA9IGZvbnQudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWZvbnQuc3RhcnRzV2l0aCgnXCInKSAmJiAhZm9udC5lbmRzV2l0aCgnXCInKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9udCA9IGBcIiR7Zm9udH1cImA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvbnQ7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuam9pbignLCcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5mb250RmFtaWx5ID0gXCJcIjtcbiAgICAgICAgfVxuICAgIH07XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQXJCQTtBQUNBO0FBQ0E7QUFDQTtB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