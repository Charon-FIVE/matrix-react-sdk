"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WidgetPermissionStore = exports.OIDCState = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _matrixWidgetApi = require("matrix-widget-api");

var _SettingsStore = _interopRequireDefault(require("../../settings/SettingsStore"));

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _SettingLevel = require("../../settings/SettingLevel");

/*
 * Copyright 2020 The Matrix.org Foundation C.I.C.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
let OIDCState;
exports.OIDCState = OIDCState;

(function (OIDCState) {
  OIDCState[OIDCState["Allowed"] = 0] = "Allowed";
  OIDCState[OIDCState["Denied"] = 1] = "Denied";
  OIDCState[OIDCState["Unknown"] = 2] = "Unknown";
})(OIDCState || (exports.OIDCState = OIDCState = {}));

class WidgetPermissionStore {
  constructor() {}

  static get instance() {
    if (!WidgetPermissionStore.internalInstance) {
      WidgetPermissionStore.internalInstance = new WidgetPermissionStore();
    }

    return WidgetPermissionStore.internalInstance;
  } // TODO (all functions here): Merge widgetKind with the widget definition


  packSettingKey(widget, kind, roomId) {
    let location = roomId;

    if (kind !== _matrixWidgetApi.WidgetKind.Room) {
      location = _MatrixClientPeg.MatrixClientPeg.get().getUserId();
    }

    if (kind === _matrixWidgetApi.WidgetKind.Modal) {
      location = '*MODAL*-' + location; // to guarantee differentiation from whatever spawned it
    }

    if (!location) {
      throw new Error("Failed to determine a location to check the widget's OIDC state with");
    }

    return encodeURIComponent(`${location}::${widget.templateUrl}`);
  }

  getOIDCState(widget, kind, roomId) {
    const settingsKey = this.packSettingKey(widget, kind, roomId);

    const settings = _SettingsStore.default.getValue("widgetOpenIDPermissions");

    if (settings?.deny?.includes(settingsKey)) {
      return OIDCState.Denied;
    }

    if (settings?.allow?.includes(settingsKey)) {
      return OIDCState.Allowed;
    }

    return OIDCState.Unknown;
  }

  setOIDCState(widget, kind, roomId, newState) {
    const settingsKey = this.packSettingKey(widget, kind, roomId);

    const currentValues = _SettingsStore.default.getValue("widgetOpenIDPermissions");

    if (!currentValues.allow) currentValues.allow = [];
    if (!currentValues.deny) currentValues.deny = [];

    if (newState === OIDCState.Allowed) {
      currentValues.allow.push(settingsKey);
    } else if (newState === OIDCState.Denied) {
      currentValues.deny.push(settingsKey);
    } else {
      currentValues.allow = currentValues.allow.filter(c => c !== settingsKey);
      currentValues.deny = currentValues.deny.filter(c => c !== settingsKey);
    }

    _SettingsStore.default.setValue("widgetOpenIDPermissions", null, _SettingLevel.SettingLevel.DEVICE, currentValues);
  }

}

exports.WidgetPermissionStore = WidgetPermissionStore;
(0, _defineProperty2.default)(WidgetPermissionStore, "internalInstance", void 0);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPSURDU3RhdGUiLCJXaWRnZXRQZXJtaXNzaW9uU3RvcmUiLCJjb25zdHJ1Y3RvciIsImluc3RhbmNlIiwiaW50ZXJuYWxJbnN0YW5jZSIsInBhY2tTZXR0aW5nS2V5Iiwid2lkZ2V0Iiwia2luZCIsInJvb21JZCIsImxvY2F0aW9uIiwiV2lkZ2V0S2luZCIsIlJvb20iLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJnZXRVc2VySWQiLCJNb2RhbCIsIkVycm9yIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwidGVtcGxhdGVVcmwiLCJnZXRPSURDU3RhdGUiLCJzZXR0aW5nc0tleSIsInNldHRpbmdzIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiZGVueSIsImluY2x1ZGVzIiwiRGVuaWVkIiwiYWxsb3ciLCJBbGxvd2VkIiwiVW5rbm93biIsInNldE9JRENTdGF0ZSIsIm5ld1N0YXRlIiwiY3VycmVudFZhbHVlcyIsInB1c2giLCJmaWx0ZXIiLCJjIiwic2V0VmFsdWUiLCJTZXR0aW5nTGV2ZWwiLCJERVZJQ0UiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmVzL3dpZGdldHMvV2lkZ2V0UGVybWlzc2lvblN0b3JlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgV2lkZ2V0LCBXaWRnZXRLaW5kIH0gZnJvbSBcIm1hdHJpeC13aWRnZXQtYXBpXCI7XG5cbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi8uLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tIFwiLi4vLi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgeyBTZXR0aW5nTGV2ZWwgfSBmcm9tIFwiLi4vLi4vc2V0dGluZ3MvU2V0dGluZ0xldmVsXCI7XG5cbmV4cG9ydCBlbnVtIE9JRENTdGF0ZSB7XG4gICAgQWxsb3dlZCwgLy8gdXNlciBoYXMgc2V0IHRoZSByZW1lbWJlcmVkIHZhbHVlIGFzIGFsbG93ZWRcbiAgICBEZW5pZWQsIC8vIHVzZXIgaGFzIHNldCB0aGUgcmVtZW1iZXJlZCB2YWx1ZSBhcyBkaXNhbGxvd2VkXG4gICAgVW5rbm93biwgLy8gdXNlciBoYXMgbm90IHNldCBhIHJlbWVtYmVyZWQgdmFsdWVcbn1cblxuZXhwb3J0IGNsYXNzIFdpZGdldFBlcm1pc3Npb25TdG9yZSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW50ZXJuYWxJbnN0YW5jZTogV2lkZ2V0UGVybWlzc2lvblN0b3JlO1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldCBpbnN0YW5jZSgpOiBXaWRnZXRQZXJtaXNzaW9uU3RvcmUge1xuICAgICAgICBpZiAoIVdpZGdldFBlcm1pc3Npb25TdG9yZS5pbnRlcm5hbEluc3RhbmNlKSB7XG4gICAgICAgICAgICBXaWRnZXRQZXJtaXNzaW9uU3RvcmUuaW50ZXJuYWxJbnN0YW5jZSA9IG5ldyBXaWRnZXRQZXJtaXNzaW9uU3RvcmUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gV2lkZ2V0UGVybWlzc2lvblN0b3JlLmludGVybmFsSW5zdGFuY2U7XG4gICAgfVxuXG4gICAgLy8gVE9ETyAoYWxsIGZ1bmN0aW9ucyBoZXJlKTogTWVyZ2Ugd2lkZ2V0S2luZCB3aXRoIHRoZSB3aWRnZXQgZGVmaW5pdGlvblxuXG4gICAgcHJpdmF0ZSBwYWNrU2V0dGluZ0tleSh3aWRnZXQ6IFdpZGdldCwga2luZDogV2lkZ2V0S2luZCwgcm9vbUlkPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGxvY2F0aW9uID0gcm9vbUlkO1xuICAgICAgICBpZiAoa2luZCAhPT0gV2lkZ2V0S2luZC5Sb29tKSB7XG4gICAgICAgICAgICBsb2NhdGlvbiA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VySWQoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoa2luZCA9PT0gV2lkZ2V0S2luZC5Nb2RhbCkge1xuICAgICAgICAgICAgbG9jYXRpb24gPSAnKk1PREFMKi0nICsgbG9jYXRpb247IC8vIHRvIGd1YXJhbnRlZSBkaWZmZXJlbnRpYXRpb24gZnJvbSB3aGF0ZXZlciBzcGF3bmVkIGl0XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFsb2NhdGlvbikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIGRldGVybWluZSBhIGxvY2F0aW9uIHRvIGNoZWNrIHRoZSB3aWRnZXQncyBPSURDIHN0YXRlIHdpdGhcIik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KGAke2xvY2F0aW9ufTo6JHt3aWRnZXQudGVtcGxhdGVVcmx9YCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldE9JRENTdGF0ZSh3aWRnZXQ6IFdpZGdldCwga2luZDogV2lkZ2V0S2luZCwgcm9vbUlkPzogc3RyaW5nKTogT0lEQ1N0YXRlIHtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3NLZXkgPSB0aGlzLnBhY2tTZXR0aW5nS2V5KHdpZGdldCwga2luZCwgcm9vbUlkKTtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBTZXR0aW5nc1N0b3JlLmdldFZhbHVlKFwid2lkZ2V0T3BlbklEUGVybWlzc2lvbnNcIik7XG4gICAgICAgIGlmIChzZXR0aW5ncz8uZGVueT8uaW5jbHVkZXMoc2V0dGluZ3NLZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gT0lEQ1N0YXRlLkRlbmllZDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2V0dGluZ3M/LmFsbG93Py5pbmNsdWRlcyhzZXR0aW5nc0tleSkpIHtcbiAgICAgICAgICAgIHJldHVybiBPSURDU3RhdGUuQWxsb3dlZDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gT0lEQ1N0YXRlLlVua25vd247XG4gICAgfVxuXG4gICAgcHVibGljIHNldE9JRENTdGF0ZSh3aWRnZXQ6IFdpZGdldCwga2luZDogV2lkZ2V0S2luZCwgcm9vbUlkOiBzdHJpbmcsIG5ld1N0YXRlOiBPSURDU3RhdGUpIHtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3NLZXkgPSB0aGlzLnBhY2tTZXR0aW5nS2V5KHdpZGdldCwga2luZCwgcm9vbUlkKTtcblxuICAgICAgICBjb25zdCBjdXJyZW50VmFsdWVzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcIndpZGdldE9wZW5JRFBlcm1pc3Npb25zXCIpO1xuICAgICAgICBpZiAoIWN1cnJlbnRWYWx1ZXMuYWxsb3cpIGN1cnJlbnRWYWx1ZXMuYWxsb3cgPSBbXTtcbiAgICAgICAgaWYgKCFjdXJyZW50VmFsdWVzLmRlbnkpIGN1cnJlbnRWYWx1ZXMuZGVueSA9IFtdO1xuXG4gICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gT0lEQ1N0YXRlLkFsbG93ZWQpIHtcbiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZXMuYWxsb3cucHVzaChzZXR0aW5nc0tleSk7XG4gICAgICAgIH0gZWxzZSBpZiAobmV3U3RhdGUgPT09IE9JRENTdGF0ZS5EZW5pZWQpIHtcbiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZXMuZGVueS5wdXNoKHNldHRpbmdzS2V5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZXMuYWxsb3cgPSBjdXJyZW50VmFsdWVzLmFsbG93LmZpbHRlcihjID0+IGMgIT09IHNldHRpbmdzS2V5KTtcbiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZXMuZGVueSA9IGN1cnJlbnRWYWx1ZXMuZGVueS5maWx0ZXIoYyA9PiBjICE9PSBzZXR0aW5nc0tleSk7XG4gICAgICAgIH1cblxuICAgICAgICBTZXR0aW5nc1N0b3JlLnNldFZhbHVlKFwid2lkZ2V0T3BlbklEUGVybWlzc2lvbnNcIiwgbnVsbCwgU2V0dGluZ0xldmVsLkRFVklDRSwgY3VycmVudFZhbHVlcyk7XG4gICAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFwQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0lBUVlBLFM7OztXQUFBQSxTO0VBQUFBLFMsQ0FBQUEsUztFQUFBQSxTLENBQUFBLFM7RUFBQUEsUyxDQUFBQSxTO0dBQUFBLFMseUJBQUFBLFM7O0FBTUwsTUFBTUMscUJBQU4sQ0FBNEI7RUFHdkJDLFdBQVcsR0FBRyxDQUNyQjs7RUFFeUIsV0FBUkMsUUFBUSxHQUEwQjtJQUNoRCxJQUFJLENBQUNGLHFCQUFxQixDQUFDRyxnQkFBM0IsRUFBNkM7TUFDekNILHFCQUFx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