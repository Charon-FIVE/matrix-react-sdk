"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _matrix = require("matrix-js-sdk/src/matrix");

var _utils = require("matrix-js-sdk/src/utils");

var _SdkConfig = _interopRequireDefault(require("../SdkConfig"));

var _submitRageshake = _interopRequireDefault(require("../rageshake/submit-rageshake"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _AsyncStoreWithClient = require("./AsyncStoreWithClient");

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _actions = require("../dispatcher/actions");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

// Minimum interval of 1 minute between reports
const RAGESHAKE_INTERVAL = 60000; // Before rageshaking, wait 5 seconds and see if the message has successfully decrypted

const GRACE_PERIOD = 5000; // Event type for to-device messages requesting sender auto-rageshakes

const AUTO_RS_REQUEST = "im.vector.auto_rs_request";

/**
 * Watches for decryption errors to auto-report if the relevant lab is
 * enabled, and keeps track of session IDs that have already been
 * reported.
 */
class AutoRageshakeStore extends _AsyncStoreWithClient.AsyncStoreWithClient {
  constructor() {
    super(_dispatcher.default, {
      reportedSessionIds: new Set(),
      lastRageshakeTime: 0,
      initialSyncCompleted: false
    });
    this.onDecryptionAttempt = this.onDecryptionAttempt.bind(this);
    this.onDeviceMessage = this.onDeviceMessage.bind(this);
    this.onSyncStateChange = this.onSyncStateChange.bind(this);
  }

  static get instance() {
    return AutoRageshakeStore.internalInstance;
  }

  async onAction(payload) {
    switch (payload.action) {
      case _actions.Action.ReportKeyBackupNotEnabled:
        this.onReportKeyBackupNotEnabled();
    }
  }

  async onReady() {
    if (!_SettingsStore.default.getValue("automaticDecryptionErrorReporting")) return;

    if (this.matrixClient) {
      this.matrixClient.on(_matrix.MatrixEventEvent.Decrypted, this.onDecryptionAttempt);
      this.matrixClient.on(_matrix.ClientEvent.ToDeviceEvent, this.onDeviceMessage);
      this.matrixClient.on(_matrix.ClientEvent.Sync, this.onSyncStateChange);
    }
  }

  async onNotReady() {
    if (this.matrixClient) {
      this.matrixClient.removeListener(_matrix.ClientEvent.ToDeviceEvent, this.onDeviceMessage);
      this.matrixClient.removeListener(_matrix.MatrixEventEvent.Decrypted, this.onDecryptionAttempt);
      this.matrixClient.removeListener(_matrix.ClientEvent.Sync, this.onSyncStateChange);
    }
  }

  async onDecryptionAttempt(ev) {
    if (!this.state.initialSyncCompleted) {
      return;
    }

    const wireContent = ev.getWireContent();
    const sessionId = wireContent.session_id;

    if (ev.isDecryptionFailure() && !this.state.reportedSessionIds.has(sessionId)) {
      await (0, _utils.sleep)(GRACE_PERIOD);

      if (!ev.isDecryptionFailure()) {
        return;
      }

      const newReportedSessionIds = new Set(this.state.reportedSessionIds);
      await this.updateState({
        reportedSessionIds: newReportedSessionIds.add(sessionId)
      });
      const now = new Date().getTime();

      if (now - this.state.lastRageshakeTime < RAGESHAKE_INTERVAL) {
        return;
      }

      await this.updateState({
        lastRageshakeTime: now
      });
      const eventInfo = {
        "event_id": ev.getId(),
        "room_id": ev.getRoomId(),
        "session_id": sessionId,
        "device_id": wireContent.device_id,
        "user_id": ev.getSender(),
        "sender_key": wireContent.sender_key
      };
      const rageshakeURL = await (0, _submitRageshake.default)(_SdkConfig.default.get().bug_report_endpoint_url, {
        userText: "Auto-reporting decryption error (recipient)",
        sendLogs: true,
        labels: ["Z-UISI", "web", "uisi-recipient"],
        customApp: _SdkConfig.default.get().uisi_autorageshake_app,
        customFields: {
          "auto_uisi": JSON.stringify(eventInfo)
        }
      });

      const messageContent = _objectSpread(_objectSpread({}, eventInfo), {}, {
        "recipient_rageshake": rageshakeURL
      });

      this.matrixClient.sendToDevice(AUTO_RS_REQUEST, {
        [messageContent.user_id]: {
          [messageContent.device_id]: messageContent
        }
      });
    }
  }

  async onSyncStateChange(_state, _prevState, data) {
    if (!this.state.initialSyncCompleted) {
      await this.updateState({
        initialSyncCompleted: !!data.nextSyncToken
      });
    }
  }

  async onDeviceMessage(ev) {
    if (ev.getType() !== AUTO_RS_REQUEST) return;
    const messageContent = ev.getContent();
    const recipientRageshake = messageContent["recipient_rageshake"] || "";
    const now = new Date().getTime();

    if (now - this.state.lastRageshakeTime > RAGESHAKE_INTERVAL) {
      await this.updateState({
        lastRageshakeTime: now
      });
      await (0, _submitRageshake.default)(_SdkConfig.default.get().bug_report_endpoint_url, {
        userText: `Auto-reporting decryption error (sender)\nRecipient rageshake: ${recipientRageshake}`,
        sendLogs: true,
        labels: ["Z-UISI", "web", "uisi-sender"],
        customApp: _SdkConfig.default.get().uisi_autorageshake_app,
        customFields: {
          "recipient_rageshake": recipientRageshake,
          "auto_uisi": JSON.stringify(messageContent)
        }
      });
    }
  }

  async onReportKeyBackupNotEnabled() {
    if (!_SettingsStore.default.getValue("automaticKeyBackNotEnabledReporting")) return;
    await (0, _submitRageshake.default)(_SdkConfig.default.get().bug_report_endpoint_url, {
      userText: `Auto-reporting key backup not enabled`,
      sendLogs: true,
      labels: ["web", _actions.Action.ReportKeyBackupNotEnabled]
    });
  }

}

exports.default = AutoRageshakeStore;
(0, _defineProperty2.default)(AutoRageshakeStore, "internalInstance", (() => {
  const instance = new AutoRageshakeStore();
  instance.start();
  return instance;
})());
window.mxAutoRageshakeStore = AutoRageshakeStore.instance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSQUdFU0hBS0VfSU5URVJWQUwiLCJHUkFDRV9QRVJJT0QiLCJBVVRPX1JTX1JFUVVFU1QiLCJBdXRvUmFnZXNoYWtlU3RvcmUiLCJBc3luY1N0b3JlV2l0aENsaWVudCIsImNvbnN0cnVjdG9yIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJyZXBvcnRlZFNlc3Npb25JZHMiLCJTZXQiLCJsYXN0UmFnZXNoYWtlVGltZSIsImluaXRpYWxTeW5jQ29tcGxldGVkIiwib25EZWNyeXB0aW9uQXR0ZW1wdCIsImJpbmQiLCJvbkRldmljZU1lc3NhZ2UiLCJvblN5bmNTdGF0ZUNoYW5nZSIsImluc3RhbmNlIiwiaW50ZXJuYWxJbnN0YW5jZSIsIm9uQWN0aW9uIiwicGF5bG9hZCIsImFjdGlvbiIsIkFjdGlvbiIsIlJlcG9ydEtleUJhY2t1cE5vdEVuYWJsZWQiLCJvblJlcG9ydEtleUJhY2t1cE5vdEVuYWJsZWQiLCJvblJlYWR5IiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwibWF0cml4Q2xpZW50Iiwib24iLCJNYXRyaXhFdmVudEV2ZW50IiwiRGVjcnlwdGVkIiwiQ2xpZW50RXZlbnQiLCJUb0RldmljZUV2ZW50IiwiU3luYyIsIm9uTm90UmVhZHkiLCJyZW1vdmVMaXN0ZW5lciIsImV2Iiwic3RhdGUiLCJ3aXJlQ29udGVudCIsImdldFdpcmVDb250ZW50Iiwic2Vzc2lvbklkIiwic2Vzc2lvbl9pZCIsImlzRGVjcnlwdGlvbkZhaWx1cmUiLCJoYXMiLCJzbGVlcCIsIm5ld1JlcG9ydGVkU2Vzc2lvbklkcyIsInVwZGF0ZVN0YXRlIiwiYWRkIiwibm93IiwiRGF0ZSIsImdldFRpbWUiLCJldmVudEluZm8iLCJnZXRJZCIsImdldFJvb21JZCIsImRldmljZV9pZCIsImdldFNlbmRlciIsInNlbmRlcl9rZXkiLCJyYWdlc2hha2VVUkwiLCJzZW5kQnVnUmVwb3J0IiwiU2RrQ29uZmlnIiwiZ2V0IiwiYnVnX3JlcG9ydF9lbmRwb2ludF91cmwiLCJ1c2VyVGV4dCIsInNlbmRMb2dzIiwibGFiZWxzIiwiY3VzdG9tQXBwIiwidWlzaV9hdXRvcmFnZXNoYWtlX2FwcCIsImN1c3RvbUZpZWxkcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdlQ29udGVudCIsInNlbmRUb0RldmljZSIsInVzZXJfaWQiLCJfc3RhdGUiLCJfcHJldlN0YXRlIiwiZGF0YSIsIm5leHRTeW5jVG9rZW4iLCJnZXRUeXBlIiwiZ2V0Q29udGVudCIsInJlY2lwaWVudFJhZ2VzaGFrZSIsInN0YXJ0Iiwid2luZG93IiwibXhBdXRvUmFnZXNoYWtlU3RvcmUiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvcmVzL0F1dG9SYWdlc2hha2VTdG9yZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjIgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBDbGllbnRFdmVudCwgTWF0cml4RXZlbnQsIE1hdHJpeEV2ZW50RXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbWF0cml4XCI7XG5pbXBvcnQgeyBzbGVlcCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy91dGlsc1wiO1xuaW1wb3J0IHsgSVN5bmNTdGF0ZURhdGEsIFN5bmNTdGF0ZSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9zeW5jXCI7XG5cbmltcG9ydCBTZGtDb25maWcgZnJvbSAnLi4vU2RrQ29uZmlnJztcbmltcG9ydCBzZW5kQnVnUmVwb3J0IGZyb20gJy4uL3JhZ2VzaGFrZS9zdWJtaXQtcmFnZXNoYWtlJztcbmltcG9ydCBkZWZhdWx0RGlzcGF0Y2hlciBmcm9tICcuLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXInO1xuaW1wb3J0IHsgQXN5bmNTdG9yZVdpdGhDbGllbnQgfSBmcm9tICcuL0FzeW5jU3RvcmVXaXRoQ2xpZW50JztcbmltcG9ydCB7IEFjdGlvblBheWxvYWQgfSBmcm9tICcuLi9kaXNwYXRjaGVyL3BheWxvYWRzJztcbmltcG9ydCBTZXR0aW5nc1N0b3JlIGZyb20gXCIuLi9zZXR0aW5ncy9TZXR0aW5nc1N0b3JlXCI7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tIFwiLi4vZGlzcGF0Y2hlci9hY3Rpb25zXCI7XG5cbi8vIE1pbmltdW0gaW50ZXJ2YWwgb2YgMSBtaW51dGUgYmV0d2VlbiByZXBvcnRzXG5jb25zdCBSQUdFU0hBS0VfSU5URVJWQUwgPSA2MDAwMDtcbi8vIEJlZm9yZSByYWdlc2hha2luZywgd2FpdCA1IHNlY29uZHMgYW5kIHNlZSBpZiB0aGUgbWVzc2FnZSBoYXMgc3VjY2Vzc2Z1bGx5IGRlY3J5cHRlZFxuY29uc3QgR1JBQ0VfUEVSSU9EID0gNTAwMDtcbi8vIEV2ZW50IHR5cGUgZm9yIHRvLWRldmljZSBtZXNzYWdlcyByZXF1ZXN0aW5nIHNlbmRlciBhdXRvLXJhZ2VzaGFrZXNcbmNvbnN0IEFVVE9fUlNfUkVRVUVTVCA9IFwiaW0udmVjdG9yLmF1dG9fcnNfcmVxdWVzdFwiO1xuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICByZXBvcnRlZFNlc3Npb25JZHM6IFNldDxzdHJpbmc+O1xuICAgIGxhc3RSYWdlc2hha2VUaW1lOiBudW1iZXI7XG4gICAgaW5pdGlhbFN5bmNDb21wbGV0ZWQ6IGJvb2xlYW47XG59XG5cbi8qKlxuICogV2F0Y2hlcyBmb3IgZGVjcnlwdGlvbiBlcnJvcnMgdG8gYXV0by1yZXBvcnQgaWYgdGhlIHJlbGV2YW50IGxhYiBpc1xuICogZW5hYmxlZCwgYW5kIGtlZXBzIHRyYWNrIG9mIHNlc3Npb24gSURzIHRoYXQgaGF2ZSBhbHJlYWR5IGJlZW5cbiAqIHJlcG9ydGVkLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRvUmFnZXNoYWtlU3RvcmUgZXh0ZW5kcyBBc3luY1N0b3JlV2l0aENsaWVudDxJU3RhdGU+IHtcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBpbnRlcm5hbEluc3RhbmNlID0gKCgpID0+IHtcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgQXV0b1JhZ2VzaGFrZVN0b3JlKCk7XG4gICAgICAgIGluc3RhbmNlLnN0YXJ0KCk7XG4gICAgICAgIHJldHVybiBpbnN0YW5jZTtcbiAgICB9KSgpO1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoZGVmYXVsdERpc3BhdGNoZXIsIHtcbiAgICAgICAgICAgIHJlcG9ydGVkU2Vzc2lvbklkczogbmV3IFNldDxzdHJpbmc+KCksXG4gICAgICAgICAgICBsYXN0UmFnZXNoYWtlVGltZTogMCxcbiAgICAgICAgICAgIGluaXRpYWxTeW5jQ29tcGxldGVkOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMub25EZWNyeXB0aW9uQXR0ZW1wdCA9IHRoaXMub25EZWNyeXB0aW9uQXR0ZW1wdC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uRGV2aWNlTWVzc2FnZSA9IHRoaXMub25EZXZpY2VNZXNzYWdlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMub25TeW5jU3RhdGVDaGFuZ2UgPSB0aGlzLm9uU3luY1N0YXRlQ2hhbmdlLmJpbmQodGhpcyk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgaW5zdGFuY2UoKTogQXV0b1JhZ2VzaGFrZVN0b3JlIHtcbiAgICAgICAgcmV0dXJuIEF1dG9SYWdlc2hha2VTdG9yZS5pbnRlcm5hbEluc3RhbmNlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvbkFjdGlvbihwYXlsb2FkOiBBY3Rpb25QYXlsb2FkKSB7XG4gICAgICAgIHN3aXRjaCAocGF5bG9hZC5hY3Rpb24pIHtcbiAgICAgICAgICAgIGNhc2UgQWN0aW9uLlJlcG9ydEtleUJhY2t1cE5vdEVuYWJsZWQ6XG4gICAgICAgICAgICAgICAgdGhpcy5vblJlcG9ydEtleUJhY2t1cE5vdEVuYWJsZWQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvblJlYWR5KCkge1xuICAgICAgICBpZiAoIVNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhdXRvbWF0aWNEZWNyeXB0aW9uRXJyb3JSZXBvcnRpbmdcIikpIHJldHVybjtcblxuICAgICAgICBpZiAodGhpcy5tYXRyaXhDbGllbnQpIHtcbiAgICAgICAgICAgIHRoaXMubWF0cml4Q2xpZW50Lm9uKE1hdHJpeEV2ZW50RXZlbnQuRGVjcnlwdGVkLCB0aGlzLm9uRGVjcnlwdGlvbkF0dGVtcHQpO1xuICAgICAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQub24oQ2xpZW50RXZlbnQuVG9EZXZpY2VFdmVudCwgdGhpcy5vbkRldmljZU1lc3NhZ2UpO1xuICAgICAgICAgICAgdGhpcy5tYXRyaXhDbGllbnQub24oQ2xpZW50RXZlbnQuU3luYywgdGhpcy5vblN5bmNTdGF0ZUNoYW5nZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgb25Ob3RSZWFkeSgpIHtcbiAgICAgICAgaWYgKHRoaXMubWF0cml4Q2xpZW50KSB7XG4gICAgICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5yZW1vdmVMaXN0ZW5lcihDbGllbnRFdmVudC5Ub0RldmljZUV2ZW50LCB0aGlzLm9uRGV2aWNlTWVzc2FnZSk7XG4gICAgICAgICAgICB0aGlzLm1hdHJpeENsaWVudC5yZW1vdmVMaXN0ZW5lcihNYXRyaXhFdmVudEV2ZW50LkRlY3J5cHRlZCwgdGhpcy5vbkRlY3J5cHRpb25BdHRlbXB0KTtcbiAgICAgICAgICAgIHRoaXMubWF0cml4Q2xpZW50LnJlbW92ZUxpc3RlbmVyKENsaWVudEV2ZW50LlN5bmMsIHRoaXMub25TeW5jU3RhdGVDaGFuZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBvbkRlY3J5cHRpb25BdHRlbXB0KGV2OiBNYXRyaXhFdmVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGUuaW5pdGlhbFN5bmNDb21wbGV0ZWQpIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgY29uc3Qgd2lyZUNvbnRlbnQgPSBldi5nZXRXaXJlQ29udGVudCgpO1xuICAgICAgICBjb25zdCBzZXNzaW9uSWQgPSB3aXJlQ29udGVudC5zZXNzaW9uX2lkO1xuICAgICAgICBpZiAoZXYuaXNEZWNyeXB0aW9uRmFpbHVyZSgpICYmICF0aGlzLnN0YXRlLnJlcG9ydGVkU2Vzc2lvbklkcy5oYXMoc2Vzc2lvbklkKSkge1xuICAgICAgICAgICAgYXdhaXQgc2xlZXAoR1JBQ0VfUEVSSU9EKTtcbiAgICAgICAgICAgIGlmICghZXYuaXNEZWNyeXB0aW9uRmFpbHVyZSgpKSB7IHJldHVybjsgfVxuXG4gICAgICAgICAgICBjb25zdCBuZXdSZXBvcnRlZFNlc3Npb25JZHMgPSBuZXcgU2V0KHRoaXMuc3RhdGUucmVwb3J0ZWRTZXNzaW9uSWRzKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU3RhdGUoeyByZXBvcnRlZFNlc3Npb25JZHM6IG5ld1JlcG9ydGVkU2Vzc2lvbklkcy5hZGQoc2Vzc2lvbklkKSB9KTtcblxuICAgICAgICAgICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICBpZiAobm93IC0gdGhpcy5zdGF0ZS5sYXN0UmFnZXNoYWtlVGltZSA8IFJBR0VTSEFLRV9JTlRFUlZBTCkgeyByZXR1cm47IH1cblxuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0ZSh7IGxhc3RSYWdlc2hha2VUaW1lOiBub3cgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGV2ZW50SW5mbyA9IHtcbiAgICAgICAgICAgICAgICBcImV2ZW50X2lkXCI6IGV2LmdldElkKCksXG4gICAgICAgICAgICAgICAgXCJyb29tX2lkXCI6IGV2LmdldFJvb21JZCgpLFxuICAgICAgICAgICAgICAgIFwic2Vzc2lvbl9pZFwiOiBzZXNzaW9uSWQsXG4gICAgICAgICAgICAgICAgXCJkZXZpY2VfaWRcIjogd2lyZUNvbnRlbnQuZGV2aWNlX2lkLFxuICAgICAgICAgICAgICAgIFwidXNlcl9pZFwiOiBldi5nZXRTZW5kZXIoKSxcbiAgICAgICAgICAgICAgICBcInNlbmRlcl9rZXlcIjogd2lyZUNvbnRlbnQuc2VuZGVyX2tleSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IHJhZ2VzaGFrZVVSTCA9IGF3YWl0IHNlbmRCdWdSZXBvcnQoU2RrQ29uZmlnLmdldCgpLmJ1Z19yZXBvcnRfZW5kcG9pbnRfdXJsLCB7XG4gICAgICAgICAgICAgICAgdXNlclRleHQ6IFwiQXV0by1yZXBvcnRpbmcgZGVjcnlwdGlvbiBlcnJvciAocmVjaXBpZW50KVwiLFxuICAgICAgICAgICAgICAgIHNlbmRMb2dzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhYmVsczogW1wiWi1VSVNJXCIsIFwid2ViXCIsIFwidWlzaS1yZWNpcGllbnRcIl0sXG4gICAgICAgICAgICAgICAgY3VzdG9tQXBwOiBTZGtDb25maWcuZ2V0KCkudWlzaV9hdXRvcmFnZXNoYWtlX2FwcCxcbiAgICAgICAgICAgICAgICBjdXN0b21GaWVsZHM6IHsgXCJhdXRvX3Vpc2lcIjogSlNPTi5zdHJpbmdpZnkoZXZlbnRJbmZvKSB9LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VDb250ZW50ID0ge1xuICAgICAgICAgICAgICAgIC4uLmV2ZW50SW5mbyxcbiAgICAgICAgICAgICAgICBcInJlY2lwaWVudF9yYWdlc2hha2VcIjogcmFnZXNoYWtlVVJMLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMubWF0cml4Q2xpZW50LnNlbmRUb0RldmljZShcbiAgICAgICAgICAgICAgICBBVVRPX1JTX1JFUVVFU1QsXG4gICAgICAgICAgICAgICAgeyBbbWVzc2FnZUNvbnRlbnQudXNlcl9pZF06IHsgW21lc3NhZ2VDb250ZW50LmRldmljZV9pZF06IG1lc3NhZ2VDb250ZW50IH0gfSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIG9uU3luY1N0YXRlQ2hhbmdlKF9zdGF0ZTogU3luY1N0YXRlLCBfcHJldlN0YXRlOiBTeW5jU3RhdGUsIGRhdGE6IElTeW5jU3RhdGVEYXRhKSB7XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZS5pbml0aWFsU3luY0NvbXBsZXRlZCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0ZSh7IGluaXRpYWxTeW5jQ29tcGxldGVkOiAhIWRhdGEubmV4dFN5bmNUb2tlbiB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgb25EZXZpY2VNZXNzYWdlKGV2OiBNYXRyaXhFdmVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoZXYuZ2V0VHlwZSgpICE9PSBBVVRPX1JTX1JFUVVFU1QpIHJldHVybjtcbiAgICAgICAgY29uc3QgbWVzc2FnZUNvbnRlbnQgPSBldi5nZXRDb250ZW50KCk7XG4gICAgICAgIGNvbnN0IHJlY2lwaWVudFJhZ2VzaGFrZSA9IG1lc3NhZ2VDb250ZW50W1wicmVjaXBpZW50X3JhZ2VzaGFrZVwiXSB8fCBcIlwiO1xuICAgICAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgaWYgKG5vdyAtIHRoaXMuc3RhdGUubGFzdFJhZ2VzaGFrZVRpbWUgPiBSQUdFU0hBS0VfSU5URVJWQUwpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU3RhdGUoeyBsYXN0UmFnZXNoYWtlVGltZTogbm93IH0pO1xuICAgICAgICAgICAgYXdhaXQgc2VuZEJ1Z1JlcG9ydChTZGtDb25maWcuZ2V0KCkuYnVnX3JlcG9ydF9lbmRwb2ludF91cmwsIHtcbiAgICAgICAgICAgICAgICB1c2VyVGV4dDogYEF1dG8tcmVwb3J0aW5nIGRlY3J5cHRpb24gZXJyb3IgKHNlbmRlcilcXG5SZWNpcGllbnQgcmFnZXNoYWtlOiAke3JlY2lwaWVudFJhZ2VzaGFrZX1gLFxuICAgICAgICAgICAgICAgIHNlbmRMb2dzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxhYmVsczogW1wiWi1VSVNJXCIsIFwid2ViXCIsIFwidWlzaS1zZW5kZXJcIl0sXG4gICAgICAgICAgICAgICAgY3VzdG9tQXBwOiBTZGtDb25maWcuZ2V0KCkudWlzaV9hdXRvcmFnZXNoYWtlX2FwcCxcbiAgICAgICAgICAgICAgICBjdXN0b21GaWVsZHM6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJyZWNpcGllbnRfcmFnZXNoYWtlXCI6IHJlY2lwaWVudFJhZ2VzaGFrZSxcbiAgICAgICAgICAgICAgICAgICAgXCJhdXRvX3Vpc2lcIjogSlNPTi5zdHJpbmdpZnkobWVzc2FnZUNvbnRlbnQpLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgb25SZXBvcnRLZXlCYWNrdXBOb3RFbmFibGVkKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIVNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhdXRvbWF0aWNLZXlCYWNrTm90RW5hYmxlZFJlcG9ydGluZ1wiKSkgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHNlbmRCdWdSZXBvcnQoU2RrQ29uZmlnLmdldCgpLmJ1Z19yZXBvcnRfZW5kcG9pbnRfdXJsLCB7XG4gICAgICAgICAgICB1c2VyVGV4dDogYEF1dG8tcmVwb3J0aW5nIGtleSBiYWNrdXAgbm90IGVuYWJsZWRgLFxuICAgICAgICAgICAgc2VuZExvZ3M6IHRydWUsXG4gICAgICAgICAgICBsYWJlbHM6IFtcIndlYlwiLCBBY3Rpb24uUmVwb3J0S2V5QmFja3VwTm90RW5hYmxlZF0sXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxud2luZG93Lm14QXV0b1JhZ2VzaGFrZVN0b3JlID0gQXV0b1JhZ2VzaGFrZVN0b3JlLmluc3RhbmNlO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7Ozs7O0FBRUE7QUFDQSxNQUFNQSxrQkFBa0IsR0FBRyxLQUEzQixDLENBQ0E7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQXJCLEMsQ0FDQTs7QUFDQSxNQUFNQyxlQUFlLEdBQUcsMkJBQXhCOztBQVFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDZSxNQUFNQyxrQkFBTixTQUFpQ0MsMENBQWpDLENBQThEO0VBT2pFQyxXQUFXLEdBQUc7SUFDbEIsTUFBTUMsbUJBQU4sRUFBeUI7TUFDckJDLGtCQUFrQixFQUFFLElBQUlDLEdBQUosRUFEQztNQUVyQkMsaUJBQWlCLEVBQUUsQ0FGRTtNQUdyQkMsb0JBQW9CLEVBQUU7SUFIRCxDQUF6QjtJQUtBLEtBQUtDLG1CQUFMLEdBQTJCLEtBQUtBLG1CQUFMLENBQXlCQyxJQUF6QixDQUE4QixJQUE5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