"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ActiveWidgetStoreEvent = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _events = _interopRequireDefault(require("events"));

var _matrix = require("matrix-js-sdk/src/matrix");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _WidgetUtils = _interopRequireDefault(require("../utils/WidgetUtils"));

var _WidgetMessagingStore = require("./widgets/WidgetMessagingStore");

/*
Copyright 2018 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
let ActiveWidgetStoreEvent;
/**
 * Stores information about the widgets active in the app right now:
 *  * What widget is set to remain always-on-screen, if any
 *    Only one widget may be 'always on screen' at any one time.
 *  * Reference counts to keep track of whether a widget is kept docked or alive
 *    by any components
 */

exports.ActiveWidgetStoreEvent = ActiveWidgetStoreEvent;

(function (ActiveWidgetStoreEvent) {
  ActiveWidgetStoreEvent["Persistence"] = "persistence";
  ActiveWidgetStoreEvent["Dock"] = "dock";
  ActiveWidgetStoreEvent["Undock"] = "undock";
})(ActiveWidgetStoreEvent || (exports.ActiveWidgetStoreEvent = ActiveWidgetStoreEvent = {}));

class ActiveWidgetStore extends _events.default {
  constructor() {
    super(...arguments);
    (0, _defineProperty2.default)(this, "persistentWidgetId", void 0);
    (0, _defineProperty2.default)(this, "persistentRoomId", void 0);
    (0, _defineProperty2.default)(this, "dockedWidgetsByUid", new Map());
    (0, _defineProperty2.default)(this, "onRoomStateEvents", (ev, _ref) => {
      let {
        roomId
      } = _ref;

      // XXX: This listens for state events in order to remove the active widget.
      // Everything else relies on views listening for events and calling setters
      // on this class which is terrible. This store should just listen for events
      // and keep itself up to date.
      // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)
      if (ev.getType() === "im.vector.modular.widgets") {
        this.destroyPersistentWidget(ev.getStateKey(), roomId);
      }
    });
  }

  static get instance() {
    if (!ActiveWidgetStore.internalInstance) {
      ActiveWidgetStore.internalInstance = new ActiveWidgetStore();
    }

    return ActiveWidgetStore.internalInstance;
  }

  start() {
    _MatrixClientPeg.MatrixClientPeg.get().on(_matrix.RoomStateEvent.Events, this.onRoomStateEvents);
  }

  stop() {
    _MatrixClientPeg.MatrixClientPeg.get()?.removeListener(_matrix.RoomStateEvent.Events, this.onRoomStateEvents);
  }

  destroyPersistentWidget(widgetId, roomId) {
    if (!this.getWidgetPersistence(widgetId, roomId)) return;

    _WidgetMessagingStore.WidgetMessagingStore.instance.stopMessagingByUid(_WidgetUtils.default.calcWidgetUid(widgetId, roomId));

    this.setWidgetPersistence(widgetId, roomId, false);
  }

  setWidgetPersistence(widgetId, roomId, val) {
    const isPersisted = this.getWidgetPersistence(widgetId, roomId);

    if (isPersisted && !val) {
      this.persistentWidgetId = null;
      this.persistentRoomId = null;
    } else if (!isPersisted && val) {
      this.persistentWidgetId = widgetId;
      this.persistentRoomId = roomId;
    }

    this.emit(ActiveWidgetStoreEvent.Persistence);
  }

  getWidgetPersistence(widgetId, roomId) {
    return this.persistentWidgetId === widgetId && this.persistentRoomId === roomId;
  }

  getPersistentWidgetId() {
    return this.persistentWidgetId;
  }

  getPersistentRoomId() {
    return this.persistentRoomId;
  } // Registers the given widget as being docked somewhere in the UI (not a PiP),
  // to allow its lifecycle to be tracked.


  dockWidget(widgetId, roomId) {
    const uid = _WidgetUtils.default.calcWidgetUid(widgetId, roomId);

    const refs = this.dockedWidgetsByUid.get(uid) ?? 0;
    this.dockedWidgetsByUid.set(uid, refs + 1);
    if (refs === 0) this.emit(ActiveWidgetStoreEvent.Dock);
  }

  undockWidget(widgetId, roomId) {
    const uid = _WidgetUtils.default.calcWidgetUid(widgetId, roomId);

    const refs = this.dockedWidgetsByUid.get(uid);
    if (refs) this.dockedWidgetsByUid.set(uid, refs - 1);
    if (refs === 1) this.emit(ActiveWidgetStoreEvent.Undock);
  } // Determines whether the given widget is docked anywhere in the UI (not a PiP)


  isDocked(widgetId, roomId) {
    const uid = _WidgetUtils.default.calcWidgetUid(widgetId, roomId);

    const refs = this.dockedWidgetsByUid.get(uid) ?? 0;
    return refs > 0;
  } // Determines whether the given widget is being kept alive in the UI, including PiPs


  isLive(widgetId, roomId) {
    return this.isDocked(widgetId, roomId) || this.getWidgetPersistence(widgetId, roomId);
  }

}

exports.default = ActiveWidgetStore;
(0, _defineProperty2.default)(ActiveWidgetStore, "internalInstance", void 0);
window.mxActiveWidgetStore = ActiveWidgetStore.instance;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBY3RpdmVXaWRnZXRTdG9yZUV2ZW50IiwiQWN0aXZlV2lkZ2V0U3RvcmUiLCJFdmVudEVtaXR0ZXIiLCJNYXAiLCJldiIsInJvb21JZCIsImdldFR5cGUiLCJkZXN0cm95UGVyc2lzdGVudFdpZGdldCIsImdldFN0YXRlS2V5IiwiaW5zdGFuY2UiLCJpbnRlcm5hbEluc3RhbmNlIiwic3RhcnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJvbiIsIlJvb21TdGF0ZUV2ZW50IiwiRXZlbnRzIiwib25Sb29tU3RhdGVFdmVudHMiLCJzdG9wIiwicmVtb3ZlTGlzdGVuZXIiLCJ3aWRnZXRJZCIsImdldFdpZGdldFBlcnNpc3RlbmNlIiwiV2lkZ2V0TWVzc2FnaW5nU3RvcmUiLCJzdG9wTWVzc2FnaW5nQnlVaWQiLCJXaWRnZXRVdGlscyIsImNhbGNXaWRnZXRVaWQiLCJzZXRXaWRnZXRQZXJzaXN0ZW5jZSIsInZhbCIsImlzUGVyc2lzdGVkIiwicGVyc2lzdGVudFdpZGdldElkIiwicGVyc2lzdGVudFJvb21JZCIsImVtaXQiLCJQZXJzaXN0ZW5jZSIsImdldFBlcnNpc3RlbnRXaWRnZXRJZCIsImdldFBlcnNpc3RlbnRSb29tSWQiLCJkb2NrV2lkZ2V0IiwidWlkIiwicmVmcyIsImRvY2tlZFdpZGdldHNCeVVpZCIsInNldCIsIkRvY2siLCJ1bmRvY2tXaWRnZXQiLCJVbmRvY2siLCJpc0RvY2tlZCIsImlzTGl2ZSIsIndpbmRvdyIsIm14QWN0aXZlV2lkZ2V0U3RvcmUiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RvcmVzL0FjdGl2ZVdpZGdldFN0b3JlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IE1hdHJpeEV2ZW50LCBSb29tU3RhdGVFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tYXRyaXhcIjtcbmltcG9ydCB7IFJvb21TdGF0ZSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbS1zdGF0ZVwiO1xuXG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IFdpZGdldFV0aWxzIGZyb20gXCIuLi91dGlscy9XaWRnZXRVdGlsc1wiO1xuaW1wb3J0IHsgV2lkZ2V0TWVzc2FnaW5nU3RvcmUgfSBmcm9tIFwiLi93aWRnZXRzL1dpZGdldE1lc3NhZ2luZ1N0b3JlXCI7XG5cbmV4cG9ydCBlbnVtIEFjdGl2ZVdpZGdldFN0b3JlRXZlbnQge1xuICAgIC8vIEluZGljYXRlcyBhIGNoYW5nZSBpbiB0aGUgY3VycmVudGx5IHBlcnNpc3RlbnQgd2lkZ2V0XG4gICAgUGVyc2lzdGVuY2UgPSBcInBlcnNpc3RlbmNlXCIsXG4gICAgLy8gSW5kaWNhdGUgY2hhbmdlcyBpbiB0aGUgY3VycmVudGx5IGRvY2tlZCB3aWRnZXRzXG4gICAgRG9jayA9IFwiZG9ja1wiLFxuICAgIFVuZG9jayA9IFwidW5kb2NrXCIsXG59XG5cbi8qKlxuICogU3RvcmVzIGluZm9ybWF0aW9uIGFib3V0IHRoZSB3aWRnZXRzIGFjdGl2ZSBpbiB0aGUgYXBwIHJpZ2h0IG5vdzpcbiAqICAqIFdoYXQgd2lkZ2V0IGlzIHNldCB0byByZW1haW4gYWx3YXlzLW9uLXNjcmVlbiwgaWYgYW55XG4gKiAgICBPbmx5IG9uZSB3aWRnZXQgbWF5IGJlICdhbHdheXMgb24gc2NyZWVuJyBhdCBhbnkgb25lIHRpbWUuXG4gKiAgKiBSZWZlcmVuY2UgY291bnRzIHRvIGtlZXAgdHJhY2sgb2Ygd2hldGhlciBhIHdpZGdldCBpcyBrZXB0IGRvY2tlZCBvciBhbGl2ZVxuICogICAgYnkgYW55IGNvbXBvbmVudHNcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWN0aXZlV2lkZ2V0U3RvcmUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIHByaXZhdGUgc3RhdGljIGludGVybmFsSW5zdGFuY2U6IEFjdGl2ZVdpZGdldFN0b3JlO1xuICAgIHByaXZhdGUgcGVyc2lzdGVudFdpZGdldElkOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBwZXJzaXN0ZW50Um9vbUlkOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBkb2NrZWRXaWRnZXRzQnlVaWQgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyPigpO1xuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgaW5zdGFuY2UoKTogQWN0aXZlV2lkZ2V0U3RvcmUge1xuICAgICAgICBpZiAoIUFjdGl2ZVdpZGdldFN0b3JlLmludGVybmFsSW5zdGFuY2UpIHtcbiAgICAgICAgICAgIEFjdGl2ZVdpZGdldFN0b3JlLmludGVybmFsSW5zdGFuY2UgPSBuZXcgQWN0aXZlV2lkZ2V0U3RvcmUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gQWN0aXZlV2lkZ2V0U3RvcmUuaW50ZXJuYWxJbnN0YW5jZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhcnQoKTogdm9pZCB7XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vbihSb29tU3RhdGVFdmVudC5FdmVudHMsIHRoaXMub25Sb29tU3RhdGVFdmVudHMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdG9wKCk6IHZvaWQge1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCk/LnJlbW92ZUxpc3RlbmVyKFJvb21TdGF0ZUV2ZW50LkV2ZW50cywgdGhpcy5vblJvb21TdGF0ZUV2ZW50cyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblJvb21TdGF0ZUV2ZW50cyA9IChldjogTWF0cml4RXZlbnQsIHsgcm9vbUlkIH06IFJvb21TdGF0ZSk6IHZvaWQgPT4ge1xuICAgICAgICAvLyBYWFg6IFRoaXMgbGlzdGVucyBmb3Igc3RhdGUgZXZlbnRzIGluIG9yZGVyIHRvIHJlbW92ZSB0aGUgYWN0aXZlIHdpZGdldC5cbiAgICAgICAgLy8gRXZlcnl0aGluZyBlbHNlIHJlbGllcyBvbiB2aWV3cyBsaXN0ZW5pbmcgZm9yIGV2ZW50cyBhbmQgY2FsbGluZyBzZXR0ZXJzXG4gICAgICAgIC8vIG9uIHRoaXMgY2xhc3Mgd2hpY2ggaXMgdGVycmlibGUuIFRoaXMgc3RvcmUgc2hvdWxkIGp1c3QgbGlzdGVuIGZvciBldmVudHNcbiAgICAgICAgLy8gYW5kIGtlZXAgaXRzZWxmIHVwIHRvIGRhdGUuXG4gICAgICAgIC8vIFRPRE86IEVuYWJsZSBzdXBwb3J0IGZvciBtLndpZGdldCBldmVudCB0eXBlIChodHRwczovL2dpdGh1Yi5jb20vdmVjdG9yLWltL2VsZW1lbnQtd2ViL2lzc3Vlcy8xMzExMSlcbiAgICAgICAgaWYgKGV2LmdldFR5cGUoKSA9PT0gXCJpbS52ZWN0b3IubW9kdWxhci53aWRnZXRzXCIpIHtcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveVBlcnNpc3RlbnRXaWRnZXQoZXYuZ2V0U3RhdGVLZXkoKSwgcm9vbUlkKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwdWJsaWMgZGVzdHJveVBlcnNpc3RlbnRXaWRnZXQod2lkZ2V0SWQ6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmdldFdpZGdldFBlcnNpc3RlbmNlKHdpZGdldElkLCByb29tSWQpKSByZXR1cm47XG4gICAgICAgIFdpZGdldE1lc3NhZ2luZ1N0b3JlLmluc3RhbmNlLnN0b3BNZXNzYWdpbmdCeVVpZChXaWRnZXRVdGlscy5jYWxjV2lkZ2V0VWlkKHdpZGdldElkLCByb29tSWQpKTtcbiAgICAgICAgdGhpcy5zZXRXaWRnZXRQZXJzaXN0ZW5jZSh3aWRnZXRJZCwgcm9vbUlkLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFdpZGdldFBlcnNpc3RlbmNlKHdpZGdldElkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCB2YWw6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaXNQZXJzaXN0ZWQgPSB0aGlzLmdldFdpZGdldFBlcnNpc3RlbmNlKHdpZGdldElkLCByb29tSWQpO1xuXG4gICAgICAgIGlmIChpc1BlcnNpc3RlZCAmJiAhdmFsKSB7XG4gICAgICAgICAgICB0aGlzLnBlcnNpc3RlbnRXaWRnZXRJZCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLnBlcnNpc3RlbnRSb29tSWQgPSBudWxsO1xuICAgICAgICB9IGVsc2UgaWYgKCFpc1BlcnNpc3RlZCAmJiB2YWwpIHtcbiAgICAgICAgICAgIHRoaXMucGVyc2lzdGVudFdpZGdldElkID0gd2lkZ2V0SWQ7XG4gICAgICAgICAgICB0aGlzLnBlcnNpc3RlbnRSb29tSWQgPSByb29tSWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbWl0KEFjdGl2ZVdpZGdldFN0b3JlRXZlbnQuUGVyc2lzdGVuY2UpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRXaWRnZXRQZXJzaXN0ZW5jZSh3aWRnZXRJZDogc3RyaW5nLCByb29tSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wZXJzaXN0ZW50V2lkZ2V0SWQgPT09IHdpZGdldElkICYmIHRoaXMucGVyc2lzdGVudFJvb21JZCA9PT0gcm9vbUlkO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRQZXJzaXN0ZW50V2lkZ2V0SWQoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGVyc2lzdGVudFdpZGdldElkO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRQZXJzaXN0ZW50Um9vbUlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcnNpc3RlbnRSb29tSWQ7XG4gICAgfVxuXG4gICAgLy8gUmVnaXN0ZXJzIHRoZSBnaXZlbiB3aWRnZXQgYXMgYmVpbmcgZG9ja2VkIHNvbWV3aGVyZSBpbiB0aGUgVUkgKG5vdCBhIFBpUCksXG4gICAgLy8gdG8gYWxsb3cgaXRzIGxpZmVjeWNsZSB0byBiZSB0cmFja2VkLlxuICAgIHB1YmxpYyBkb2NrV2lkZ2V0KHdpZGdldElkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHVpZCA9IFdpZGdldFV0aWxzLmNhbGNXaWRnZXRVaWQod2lkZ2V0SWQsIHJvb21JZCk7XG4gICAgICAgIGNvbnN0IHJlZnMgPSB0aGlzLmRvY2tlZFdpZGdldHNCeVVpZC5nZXQodWlkKSA/PyAwO1xuICAgICAgICB0aGlzLmRvY2tlZFdpZGdldHNCeVVpZC5zZXQodWlkLCByZWZzICsgMSk7XG4gICAgICAgIGlmIChyZWZzID09PSAwKSB0aGlzLmVtaXQoQWN0aXZlV2lkZ2V0U3RvcmVFdmVudC5Eb2NrKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdW5kb2NrV2lkZ2V0KHdpZGdldElkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHVpZCA9IFdpZGdldFV0aWxzLmNhbGNXaWRnZXRVaWQod2lkZ2V0SWQsIHJvb21JZCk7XG4gICAgICAgIGNvbnN0IHJlZnMgPSB0aGlzLmRvY2tlZFdpZGdldHNCeVVpZC5nZXQodWlkKTtcbiAgICAgICAgaWYgKHJlZnMpIHRoaXMuZG9ja2VkV2lkZ2V0c0J5VWlkLnNldCh1aWQsIHJlZnMgLSAxKTtcbiAgICAgICAgaWYgKHJlZnMgPT09IDEpIHRoaXMuZW1pdChBY3RpdmVXaWRnZXRTdG9yZUV2ZW50LlVuZG9jayk7XG4gICAgfVxuXG4gICAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBnaXZlbiB3aWRnZXQgaXMgZG9ja2VkIGFueXdoZXJlIGluIHRoZSBVSSAobm90IGEgUGlQKVxuICAgIHB1YmxpYyBpc0RvY2tlZCh3aWRnZXRJZDogc3RyaW5nLCByb29tSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCB1aWQgPSBXaWRnZXRVdGlscy5jYWxjV2lkZ2V0VWlkKHdpZGdldElkLCByb29tSWQpO1xuICAgICAgICBjb25zdCByZWZzID0gdGhpcy5kb2NrZWRXaWRnZXRzQnlVaWQuZ2V0KHVpZCkgPz8gMDtcbiAgICAgICAgcmV0dXJuIHJlZnMgPiAwO1xuICAgIH1cblxuICAgIC8vIERldGVybWluZXMgd2hldGhlciB0aGUgZ2l2ZW4gd2lkZ2V0IGlzIGJlaW5nIGtlcHQgYWxpdmUgaW4gdGhlIFVJLCBpbmNsdWRpbmcgUGlQc1xuICAgIHB1YmxpYyBpc0xpdmUod2lkZ2V0SWQ6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNEb2NrZWQod2lkZ2V0SWQsIHJvb21JZCkgfHwgdGhpcy5nZXRXaWRnZXRQZXJzaXN0ZW5jZSh3aWRnZXRJZCwgcm9vbUlkKTtcbiAgICB9XG59XG5cbndpbmRvdy5teEFjdGl2ZVdpZGdldFN0b3JlID0gQWN0aXZlV2lkZ2V0U3RvcmUuaW5zdGFuY2U7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBZ0JB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