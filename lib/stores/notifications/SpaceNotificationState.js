"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SpaceNotificationState = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _NotificationColor = require("./NotificationColor");

var _arrays = require("../../utils/arrays");

var _NotificationState = require("./NotificationState");

var _models = require("../room-list/models");

var _RoomListStore = _interopRequireDefault(require("../room-list/RoomListStore"));

/*
Copyright 2021 - 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class SpaceNotificationState extends _NotificationState.NotificationState {
  // exposed only for tests
  constructor(getRoomFn) {
    super();
    this.getRoomFn = getRoomFn;
    (0, _defineProperty2.default)(this, "rooms", []);
    (0, _defineProperty2.default)(this, "states", {});
    (0, _defineProperty2.default)(this, "onRoomNotificationStateUpdate", () => {
      this.calculateTotalState();
    });
  }

  get symbol() {
    return this._color === _NotificationColor.NotificationColor.Unsent ? "!" : null;
  }

  setRooms(rooms) {
    const oldRooms = this.rooms;
    const diff = (0, _arrays.arrayDiff)(oldRooms, rooms);
    this.rooms = rooms;

    for (const oldRoom of diff.removed) {
      const state = this.states[oldRoom.roomId];
      if (!state) continue; // We likely just didn't have a badge (race condition)

      delete this.states[oldRoom.roomId];
      state.off(_NotificationState.NotificationStateEvents.Update, this.onRoomNotificationStateUpdate);
    }

    for (const newRoom of diff.added) {
      const state = this.getRoomFn(newRoom);
      state.on(_NotificationState.NotificationStateEvents.Update, this.onRoomNotificationStateUpdate);
      this.states[newRoom.roomId] = state;
    }

    this.calculateTotalState();
  }

  getFirstRoomWithNotifications() {
    return Object.values(this.states).find(state => state.color >= this.color)?.room.roomId;
  }

  destroy() {
    super.destroy();

    for (const state of Object.values(this.states)) {
      state.off(_NotificationState.NotificationStateEvents.Update, this.onRoomNotificationStateUpdate);
    }

    this.states = {};
  }

  calculateTotalState() {
    const snapshot = this.snapshot();
    this._count = 0;
    this._color = _NotificationColor.NotificationColor.None;

    for (const [roomId, state] of Object.entries(this.states)) {
      const roomTags = _RoomListStore.default.instance.getTagsForRoom(this.rooms.find(r => r.roomId === roomId)); // We ignore unreads in LowPriority rooms, see https://github.com/vector-im/element-web/issues/16836


      if (roomTags.includes(_models.DefaultTagID.LowPriority) && state.color === _NotificationColor.NotificationColor.Bold) continue;
      this._count += state.count;
      this._color = Math.max(this.color, state.color);
    } // finally, publish an update if needed


    this.emitIfUpdated(snapshot);
  }

}

exports.SpaceNotificationState = SpaceNotificationState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTcGFjZU5vdGlmaWNhdGlvblN0YXRlIiwiTm90aWZpY2F0aW9uU3RhdGUiLCJjb25zdHJ1Y3RvciIsImdldFJvb21GbiIsImNhbGN1bGF0ZVRvdGFsU3RhdGUiLCJzeW1ib2wiLCJfY29sb3IiLCJOb3RpZmljYXRpb25Db2xvciIsIlVuc2VudCIsInNldFJvb21zIiwicm9vbXMiLCJvbGRSb29tcyIsImRpZmYiLCJhcnJheURpZmYiLCJvbGRSb29tIiwicmVtb3ZlZCIsInN0YXRlIiwic3RhdGVzIiwicm9vbUlkIiwib2ZmIiwiTm90aWZpY2F0aW9uU3RhdGVFdmVudHMiLCJVcGRhdGUiLCJvblJvb21Ob3RpZmljYXRpb25TdGF0ZVVwZGF0ZSIsIm5ld1Jvb20iLCJhZGRlZCIsIm9uIiwiZ2V0Rmlyc3RSb29tV2l0aE5vdGlmaWNhdGlvbnMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJmaW5kIiwiY29sb3IiLCJyb29tIiwiZGVzdHJveSIsInNuYXBzaG90IiwiX2NvdW50IiwiTm9uZSIsImVudHJpZXMiLCJyb29tVGFncyIsIlJvb21MaXN0U3RvcmUiLCJpbnN0YW5jZSIsImdldFRhZ3NGb3JSb29tIiwiciIsImluY2x1ZGVzIiwiRGVmYXVsdFRhZ0lEIiwiTG93UHJpb3JpdHkiLCJCb2xkIiwiY291bnQiLCJNYXRoIiwibWF4IiwiZW1pdElmVXBkYXRlZCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZXMvbm90aWZpY2F0aW9ucy9TcGFjZU5vdGlmaWNhdGlvblN0YXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSAtIDIwMjIgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5cbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbG9yIH0gZnJvbSBcIi4vTm90aWZpY2F0aW9uQ29sb3JcIjtcbmltcG9ydCB7IGFycmF5RGlmZiB9IGZyb20gXCIuLi8uLi91dGlscy9hcnJheXNcIjtcbmltcG9ydCB7IFJvb21Ob3RpZmljYXRpb25TdGF0ZSB9IGZyb20gXCIuL1Jvb21Ob3RpZmljYXRpb25TdGF0ZVwiO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uU3RhdGUsIE5vdGlmaWNhdGlvblN0YXRlRXZlbnRzIH0gZnJvbSBcIi4vTm90aWZpY2F0aW9uU3RhdGVcIjtcbmltcG9ydCB7IEZldGNoUm9vbUZuIH0gZnJvbSBcIi4vTGlzdE5vdGlmaWNhdGlvblN0YXRlXCI7XG5pbXBvcnQgeyBEZWZhdWx0VGFnSUQgfSBmcm9tIFwiLi4vcm9vbS1saXN0L21vZGVsc1wiO1xuaW1wb3J0IFJvb21MaXN0U3RvcmUgZnJvbSBcIi4uL3Jvb20tbGlzdC9Sb29tTGlzdFN0b3JlXCI7XG5cbmV4cG9ydCBjbGFzcyBTcGFjZU5vdGlmaWNhdGlvblN0YXRlIGV4dGVuZHMgTm90aWZpY2F0aW9uU3RhdGUge1xuICAgIHB1YmxpYyByb29tczogUm9vbVtdID0gW107IC8vIGV4cG9zZWQgb25seSBmb3IgdGVzdHNcbiAgICBwcml2YXRlIHN0YXRlczogeyBbc3BhY2VJZDogc3RyaW5nXTogUm9vbU5vdGlmaWNhdGlvblN0YXRlIH0gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZ2V0Um9vbUZuOiBGZXRjaFJvb21Gbikge1xuICAgICAgICBzdXBlcigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc3ltYm9sKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jb2xvciA9PT0gTm90aWZpY2F0aW9uQ29sb3IuVW5zZW50ID8gXCIhXCIgOiBudWxsO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRSb29tcyhyb29tczogUm9vbVtdKSB7XG4gICAgICAgIGNvbnN0IG9sZFJvb21zID0gdGhpcy5yb29tcztcbiAgICAgICAgY29uc3QgZGlmZiA9IGFycmF5RGlmZihvbGRSb29tcywgcm9vbXMpO1xuICAgICAgICB0aGlzLnJvb21zID0gcm9vbXM7XG4gICAgICAgIGZvciAoY29uc3Qgb2xkUm9vbSBvZiBkaWZmLnJlbW92ZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZXNbb2xkUm9vbS5yb29tSWRdO1xuICAgICAgICAgICAgaWYgKCFzdGF0ZSkgY29udGludWU7IC8vIFdlIGxpa2VseSBqdXN0IGRpZG4ndCBoYXZlIGEgYmFkZ2UgKHJhY2UgY29uZGl0aW9uKVxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuc3RhdGVzW29sZFJvb20ucm9vbUlkXTtcbiAgICAgICAgICAgIHN0YXRlLm9mZihOb3RpZmljYXRpb25TdGF0ZUV2ZW50cy5VcGRhdGUsIHRoaXMub25Sb29tTm90aWZpY2F0aW9uU3RhdGVVcGRhdGUpO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgbmV3Um9vbSBvZiBkaWZmLmFkZGVkKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0Um9vbUZuKG5ld1Jvb20pO1xuICAgICAgICAgICAgc3RhdGUub24oTm90aWZpY2F0aW9uU3RhdGVFdmVudHMuVXBkYXRlLCB0aGlzLm9uUm9vbU5vdGlmaWNhdGlvblN0YXRlVXBkYXRlKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGVzW25ld1Jvb20ucm9vbUlkXSA9IHN0YXRlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jYWxjdWxhdGVUb3RhbFN0YXRlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEZpcnN0Um9vbVdpdGhOb3RpZmljYXRpb25zKCkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLnN0YXRlcykuZmluZChzdGF0ZSA9PiBzdGF0ZS5jb2xvciA+PSB0aGlzLmNvbG9yKT8ucm9vbS5yb29tSWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgICAgIHN1cGVyLmRlc3Ryb3koKTtcbiAgICAgICAgZm9yIChjb25zdCBzdGF0ZSBvZiBPYmplY3QudmFsdWVzKHRoaXMuc3RhdGVzKSkge1xuICAgICAgICAgICAgc3RhdGUub2ZmKE5vdGlmaWNhdGlvblN0YXRlRXZlbnRzLlVwZGF0ZSwgdGhpcy5vblJvb21Ob3RpZmljYXRpb25TdGF0ZVVwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdGF0ZXMgPSB7fTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uUm9vbU5vdGlmaWNhdGlvblN0YXRlVXBkYXRlID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZVRvdGFsU3RhdGUoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVUb3RhbFN0YXRlKCkge1xuICAgICAgICBjb25zdCBzbmFwc2hvdCA9IHRoaXMuc25hcHNob3QoKTtcblxuICAgICAgICB0aGlzLl9jb3VudCA9IDA7XG4gICAgICAgIHRoaXMuX2NvbG9yID0gTm90aWZpY2F0aW9uQ29sb3IuTm9uZTtcbiAgICAgICAgZm9yIChjb25zdCBbcm9vbUlkLCBzdGF0ZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5zdGF0ZXMpKSB7XG4gICAgICAgICAgICBjb25zdCByb29tVGFncyA9IFJvb21MaXN0U3RvcmUuaW5zdGFuY2UuZ2V0VGFnc0ZvclJvb20odGhpcy5yb29tcy5maW5kKHIgPT4gci5yb29tSWQgPT09IHJvb21JZCkpO1xuXG4gICAgICAgICAgICAvLyBXZSBpZ25vcmUgdW5yZWFkcyBpbiBMb3dQcmlvcml0eSByb29tcywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS92ZWN0b3ItaW0vZWxlbWVudC13ZWIvaXNzdWVzLzE2ODM2XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgcm9vbVRhZ3MuaW5jbHVkZXMoRGVmYXVsdFRhZ0lELkxvd1ByaW9yaXR5KSAmJlxuICAgICAgICAgICAgICAgIHN0YXRlLmNvbG9yID09PSBOb3RpZmljYXRpb25Db2xvci5Cb2xkXG4gICAgICAgICAgICApIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICB0aGlzLl9jb3VudCArPSBzdGF0ZS5jb3VudDtcbiAgICAgICAgICAgIHRoaXMuX2NvbG9yID0gTWF0aC5tYXgodGhpcy5jb2xvciwgc3RhdGUuY29sb3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZmluYWxseSwgcHVibGlzaCBhbiB1cGRhdGUgaWYgbmVlZGVkXG4gICAgICAgIHRoaXMuZW1pdElmVXBkYXRlZChzbmFwc2hvdCk7XG4gICAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWtCQTs7QUFDQTs7QUFFQTs7QUFFQTs7QUFDQTs7QUF4QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBWU8sTUFBTUEsc0JBQU4sU0FBcUNDLG9DQUFyQyxD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