"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RoomNotificationState = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _event = require("matrix-js-sdk/src/models/event");

var _room = require("matrix-js-sdk/src/models/room");

var _client = require("matrix-js-sdk/src/client");

var _NotificationColor = require("./NotificationColor");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _membership = require("../../utils/membership");

var _readReceipts = require("../../utils/read-receipts");

var RoomNotifs = _interopRequireWildcard(require("../../RoomNotifs"));

var Unread = _interopRequireWildcard(require("../../Unread"));

var _NotificationState = require("./NotificationState");

var _RoomStatusBar = require("../../components/structures/RoomStatusBar");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class RoomNotificationState extends _NotificationState.NotificationState {
  constructor(room, threadsState) {
    super();
    this.room = room;
    this.threadsState = threadsState;
    (0, _defineProperty2.default)(this, "handleThreadsUpdate", () => {
      this.updateNotificationState();
    });
    (0, _defineProperty2.default)(this, "handleLocalEchoUpdated", () => {
      this.updateNotificationState();
    });
    (0, _defineProperty2.default)(this, "handleReadReceipt", (event, room) => {
      if (!(0, _readReceipts.readReceiptChangeIsFor)(event, _MatrixClientPeg.MatrixClientPeg.get())) return; // not our own - ignore

      if (room.roomId !== this.room.roomId) return; // not for us - ignore

      this.updateNotificationState();
    });
    (0, _defineProperty2.default)(this, "handleMembershipUpdate", () => {
      this.updateNotificationState();
    });
    (0, _defineProperty2.default)(this, "onEventDecrypted", event => {
      if (event.getRoomId() !== this.room.roomId) return; // ignore - not for us or notifications timeline

      this.updateNotificationState();
    });
    (0, _defineProperty2.default)(this, "handleRoomEventUpdate", (event, room) => {
      if (room?.roomId !== this.room.roomId) return; // ignore - not for us or notifications timeline

      this.updateNotificationState();
    });
    (0, _defineProperty2.default)(this, "handleAccountDataUpdate", ev => {
      if (ev.getType() === "m.push_rules") {
        this.updateNotificationState();
      }
    });
    this.room.on(_room.RoomEvent.Receipt, this.handleReadReceipt);
    this.room.on(_room.RoomEvent.Timeline, this.handleRoomEventUpdate);
    this.room.on(_room.RoomEvent.Redaction, this.handleRoomEventUpdate);
    this.room.on(_room.RoomEvent.MyMembership, this.handleMembershipUpdate);
    this.room.on(_room.RoomEvent.LocalEchoUpdated, this.handleLocalEchoUpdated);

    if (threadsState) {
      threadsState.on(_NotificationState.NotificationStateEvents.Update, this.handleThreadsUpdate);
    }

    _MatrixClientPeg.MatrixClientPeg.get().on(_event.MatrixEventEvent.Decrypted, this.onEventDecrypted);

    _MatrixClientPeg.MatrixClientPeg.get().on(_client.ClientEvent.AccountData, this.handleAccountDataUpdate);

    this.updateNotificationState();
  }

  get roomIsInvite() {
    return (0, _membership.getEffectiveMembership)(this.room.getMyMembership()) === _membership.EffectiveMembership.Invite;
  }

  destroy() {
    super.destroy();
    this.room.removeListener(_room.RoomEvent.Receipt, this.handleReadReceipt);
    this.room.removeListener(_room.RoomEvent.Timeline, this.handleRoomEventUpdate);
    this.room.removeListener(_room.RoomEvent.Redaction, this.handleRoomEventUpdate);
    this.room.removeListener(_room.RoomEvent.MyMembership, this.handleMembershipUpdate);
    this.room.removeListener(_room.RoomEvent.LocalEchoUpdated, this.handleLocalEchoUpdated);

    if (this.threadsState) {
      this.threadsState.removeListener(_NotificationState.NotificationStateEvents.Update, this.handleThreadsUpdate);
    }

    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener(_event.MatrixEventEvent.Decrypted, this.onEventDecrypted);

      _MatrixClientPeg.MatrixClientPeg.get().removeListener(_client.ClientEvent.AccountData, this.handleAccountDataUpdate);
    }
  }

  updateNotificationState() {
    const snapshot = this.snapshot();

    if ((0, _RoomStatusBar.getUnsentMessages)(this.room).length > 0) {
      // When there are unsent messages we show a red `!`
      this._color = _NotificationColor.NotificationColor.Unsent;
      this._symbol = "!";
      this._count = 1; // not used, technically
    } else if (RoomNotifs.getRoomNotifsState(this.room.roomId) === RoomNotifs.RoomNotifState.Mute) {
      // When muted we suppress all notification states, even if we have context on them.
      this._color = _NotificationColor.NotificationColor.None;
      this._symbol = null;
      this._count = 0;
    } else if (this.roomIsInvite) {
      this._color = _NotificationColor.NotificationColor.Red;
      this._symbol = "!";
      this._count = 1; // not used, technically
    } else {
      const redNotifs = RoomNotifs.getUnreadNotificationCount(this.room, _room.NotificationCountType.Highlight);
      const greyNotifs = RoomNotifs.getUnreadNotificationCount(this.room, _room.NotificationCountType.Total); // For a 'true count' we pick the grey notifications first because they include the
      // red notifications. If we don't have a grey count for some reason we use the red
      // count. If that count is broken for some reason, assume zero. This avoids us showing
      // a badge for 'NaN' (which formats as 'NaNB' for NaN Billion).

      const trueCount = greyNotifs ? greyNotifs : redNotifs ? redNotifs : 0; // Note: we only set the symbol if we have an actual count. We don't want to show
      // zero on badges.

      if (redNotifs > 0) {
        this._color = _NotificationColor.NotificationColor.Red;
        this._count = trueCount;
        this._symbol = null; // symbol calculated by component
      } else if (greyNotifs > 0) {
        this._color = _NotificationColor.NotificationColor.Grey;
        this._count = trueCount;
        this._symbol = null; // symbol calculated by component
      } else {
        // We don't have any notified messages, but we might have unread messages. Let's
        // find out.
        const hasUnread = Unread.doesRoomHaveUnreadMessages(this.room);

        if (hasUnread) {
          this._color = _NotificationColor.NotificationColor.Bold;
        } else {
          this._color = _NotificationColor.NotificationColor.None;
        } // no symbol or count for this state


        this._count = 0;
        this._symbol = null;
      }
    } // finally, publish an update if needed


    this.emitIfUpdated(snapshot);
  }

}

exports.RoomNotificationState = RoomNotificationState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSb29tTm90aWZpY2F0aW9uU3RhdGUiLCJOb3RpZmljYXRpb25TdGF0ZSIsImNvbnN0cnVjdG9yIiwicm9vbSIsInRocmVhZHNTdGF0ZSIsInVwZGF0ZU5vdGlmaWNhdGlvblN0YXRlIiwiZXZlbnQiLCJyZWFkUmVjZWlwdENoYW5nZUlzRm9yIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwicm9vbUlkIiwiZ2V0Um9vbUlkIiwiZXYiLCJnZXRUeXBlIiwib24iLCJSb29tRXZlbnQiLCJSZWNlaXB0IiwiaGFuZGxlUmVhZFJlY2VpcHQiLCJUaW1lbGluZSIsImhhbmRsZVJvb21FdmVudFVwZGF0ZSIsIlJlZGFjdGlvbiIsIk15TWVtYmVyc2hpcCIsImhhbmRsZU1lbWJlcnNoaXBVcGRhdGUiLCJMb2NhbEVjaG9VcGRhdGVkIiwiaGFuZGxlTG9jYWxFY2hvVXBkYXRlZCIsIk5vdGlmaWNhdGlvblN0YXRlRXZlbnRzIiwiVXBkYXRlIiwiaGFuZGxlVGhyZWFkc1VwZGF0ZSIsIk1hdHJpeEV2ZW50RXZlbnQiLCJEZWNyeXB0ZWQiLCJvbkV2ZW50RGVjcnlwdGVkIiwiQ2xpZW50RXZlbnQiLCJBY2NvdW50RGF0YSIsImhhbmRsZUFjY291bnREYXRhVXBkYXRlIiwicm9vbUlzSW52aXRlIiwiZ2V0RWZmZWN0aXZlTWVtYmVyc2hpcCIsImdldE15TWVtYmVyc2hpcCIsIkVmZmVjdGl2ZU1lbWJlcnNoaXAiLCJJbnZpdGUiLCJkZXN0cm95IiwicmVtb3ZlTGlzdGVuZXIiLCJzbmFwc2hvdCIsImdldFVuc2VudE1lc3NhZ2VzIiwibGVuZ3RoIiwiX2NvbG9yIiwiTm90aWZpY2F0aW9uQ29sb3IiLCJVbnNlbnQiLCJfc3ltYm9sIiwiX2NvdW50IiwiUm9vbU5vdGlmcyIsImdldFJvb21Ob3RpZnNTdGF0ZSIsIlJvb21Ob3RpZlN0YXRlIiwiTXV0ZSIsIk5vbmUiLCJSZWQiLCJyZWROb3RpZnMiLCJnZXRVbnJlYWROb3RpZmljYXRpb25Db3VudCIsIk5vdGlmaWNhdGlvbkNvdW50VHlwZSIsIkhpZ2hsaWdodCIsImdyZXlOb3RpZnMiLCJUb3RhbCIsInRydWVDb3VudCIsIkdyZXkiLCJoYXNVbnJlYWQiLCJVbnJlYWQiLCJkb2VzUm9vbUhhdmVVbnJlYWRNZXNzYWdlcyIsIkJvbGQiLCJlbWl0SWZVcGRhdGVkIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3N0b3Jlcy9ub3RpZmljYXRpb25zL1Jvb21Ob3RpZmljYXRpb25TdGF0ZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhFdmVudCwgTWF0cml4RXZlbnRFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvdW50VHlwZSwgUm9vbSwgUm9vbUV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBDbGllbnRFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcblxuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29sb3IgfSBmcm9tIFwiLi9Ob3RpZmljYXRpb25Db2xvclwiO1xuaW1wb3J0IHsgSURlc3Ryb3lhYmxlIH0gZnJvbSBcIi4uLy4uL3V0aWxzL0lEZXN0cm95YWJsZVwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgRWZmZWN0aXZlTWVtYmVyc2hpcCwgZ2V0RWZmZWN0aXZlTWVtYmVyc2hpcCB9IGZyb20gXCIuLi8uLi91dGlscy9tZW1iZXJzaGlwXCI7XG5pbXBvcnQgeyByZWFkUmVjZWlwdENoYW5nZUlzRm9yIH0gZnJvbSBcIi4uLy4uL3V0aWxzL3JlYWQtcmVjZWlwdHNcIjtcbmltcG9ydCAqIGFzIFJvb21Ob3RpZnMgZnJvbSAnLi4vLi4vUm9vbU5vdGlmcyc7XG5pbXBvcnQgKiBhcyBVbnJlYWQgZnJvbSAnLi4vLi4vVW5yZWFkJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblN0YXRlLCBOb3RpZmljYXRpb25TdGF0ZUV2ZW50cyB9IGZyb20gXCIuL05vdGlmaWNhdGlvblN0YXRlXCI7XG5pbXBvcnQgeyBnZXRVbnNlbnRNZXNzYWdlcyB9IGZyb20gXCIuLi8uLi9jb21wb25lbnRzL3N0cnVjdHVyZXMvUm9vbVN0YXR1c0JhclwiO1xuaW1wb3J0IHsgVGhyZWFkc1Jvb21Ob3RpZmljYXRpb25TdGF0ZSB9IGZyb20gXCIuL1RocmVhZHNSb29tTm90aWZpY2F0aW9uU3RhdGVcIjtcblxuZXhwb3J0IGNsYXNzIFJvb21Ob3RpZmljYXRpb25TdGF0ZSBleHRlbmRzIE5vdGlmaWNhdGlvblN0YXRlIGltcGxlbWVudHMgSURlc3Ryb3lhYmxlIHtcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgcm9vbTogUm9vbSwgcHJpdmF0ZSByZWFkb25seSB0aHJlYWRzU3RhdGU/OiBUaHJlYWRzUm9vbU5vdGlmaWNhdGlvblN0YXRlKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMucm9vbS5vbihSb29tRXZlbnQuUmVjZWlwdCwgdGhpcy5oYW5kbGVSZWFkUmVjZWlwdCk7XG4gICAgICAgIHRoaXMucm9vbS5vbihSb29tRXZlbnQuVGltZWxpbmUsIHRoaXMuaGFuZGxlUm9vbUV2ZW50VXBkYXRlKTtcbiAgICAgICAgdGhpcy5yb29tLm9uKFJvb21FdmVudC5SZWRhY3Rpb24sIHRoaXMuaGFuZGxlUm9vbUV2ZW50VXBkYXRlKTtcbiAgICAgICAgdGhpcy5yb29tLm9uKFJvb21FdmVudC5NeU1lbWJlcnNoaXAsIHRoaXMuaGFuZGxlTWVtYmVyc2hpcFVwZGF0ZSk7XG4gICAgICAgIHRoaXMucm9vbS5vbihSb29tRXZlbnQuTG9jYWxFY2hvVXBkYXRlZCwgdGhpcy5oYW5kbGVMb2NhbEVjaG9VcGRhdGVkKTtcbiAgICAgICAgaWYgKHRocmVhZHNTdGF0ZSkge1xuICAgICAgICAgICAgdGhyZWFkc1N0YXRlLm9uKE5vdGlmaWNhdGlvblN0YXRlRXZlbnRzLlVwZGF0ZSwgdGhpcy5oYW5kbGVUaHJlYWRzVXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkub24oTWF0cml4RXZlbnRFdmVudC5EZWNyeXB0ZWQsIHRoaXMub25FdmVudERlY3J5cHRlZCk7XG4gICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5vbihDbGllbnRFdmVudC5BY2NvdW50RGF0YSwgdGhpcy5oYW5kbGVBY2NvdW50RGF0YVVwZGF0ZSk7XG4gICAgICAgIHRoaXMudXBkYXRlTm90aWZpY2F0aW9uU3RhdGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCByb29tSXNJbnZpdGUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBnZXRFZmZlY3RpdmVNZW1iZXJzaGlwKHRoaXMucm9vbS5nZXRNeU1lbWJlcnNoaXAoKSkgPT09IEVmZmVjdGl2ZU1lbWJlcnNoaXAuSW52aXRlO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZXN0cm95KCk6IHZvaWQge1xuICAgICAgICBzdXBlci5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMucm9vbS5yZW1vdmVMaXN0ZW5lcihSb29tRXZlbnQuUmVjZWlwdCwgdGhpcy5oYW5kbGVSZWFkUmVjZWlwdCk7XG4gICAgICAgIHRoaXMucm9vbS5yZW1vdmVMaXN0ZW5lcihSb29tRXZlbnQuVGltZWxpbmUsIHRoaXMuaGFuZGxlUm9vbUV2ZW50VXBkYXRlKTtcbiAgICAgICAgdGhpcy5yb29tLnJlbW92ZUxpc3RlbmVyKFJvb21FdmVudC5SZWRhY3Rpb24sIHRoaXMuaGFuZGxlUm9vbUV2ZW50VXBkYXRlKTtcbiAgICAgICAgdGhpcy5yb29tLnJlbW92ZUxpc3RlbmVyKFJvb21FdmVudC5NeU1lbWJlcnNoaXAsIHRoaXMuaGFuZGxlTWVtYmVyc2hpcFVwZGF0ZSk7XG4gICAgICAgIHRoaXMucm9vbS5yZW1vdmVMaXN0ZW5lcihSb29tRXZlbnQuTG9jYWxFY2hvVXBkYXRlZCwgdGhpcy5oYW5kbGVMb2NhbEVjaG9VcGRhdGVkKTtcbiAgICAgICAgaWYgKHRoaXMudGhyZWFkc1N0YXRlKSB7XG4gICAgICAgICAgICB0aGlzLnRocmVhZHNTdGF0ZS5yZW1vdmVMaXN0ZW5lcihOb3RpZmljYXRpb25TdGF0ZUV2ZW50cy5VcGRhdGUsIHRoaXMuaGFuZGxlVGhyZWFkc1VwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKE1hdHJpeENsaWVudFBlZy5nZXQoKSkge1xuICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnJlbW92ZUxpc3RlbmVyKE1hdHJpeEV2ZW50RXZlbnQuRGVjcnlwdGVkLCB0aGlzLm9uRXZlbnREZWNyeXB0ZWQpO1xuICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnJlbW92ZUxpc3RlbmVyKENsaWVudEV2ZW50LkFjY291bnREYXRhLCB0aGlzLmhhbmRsZUFjY291bnREYXRhVXBkYXRlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlVGhyZWFkc1VwZGF0ZSA9ICgpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVOb3RpZmljYXRpb25TdGF0ZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGhhbmRsZUxvY2FsRWNob1VwZGF0ZWQgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlTm90aWZpY2F0aW9uU3RhdGUoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBoYW5kbGVSZWFkUmVjZWlwdCA9IChldmVudDogTWF0cml4RXZlbnQsIHJvb206IFJvb20pID0+IHtcbiAgICAgICAgaWYgKCFyZWFkUmVjZWlwdENoYW5nZUlzRm9yKGV2ZW50LCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkpKSByZXR1cm47IC8vIG5vdCBvdXIgb3duIC0gaWdub3JlXG4gICAgICAgIGlmIChyb29tLnJvb21JZCAhPT0gdGhpcy5yb29tLnJvb21JZCkgcmV0dXJuOyAvLyBub3QgZm9yIHVzIC0gaWdub3JlXG4gICAgICAgIHRoaXMudXBkYXRlTm90aWZpY2F0aW9uU3RhdGUoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBoYW5kbGVNZW1iZXJzaGlwVXBkYXRlID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZU5vdGlmaWNhdGlvblN0YXRlKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25FdmVudERlY3J5cHRlZCA9IChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmdldFJvb21JZCgpICE9PSB0aGlzLnJvb20ucm9vbUlkKSByZXR1cm47IC8vIGlnbm9yZSAtIG5vdCBmb3IgdXMgb3Igbm90aWZpY2F0aW9ucyB0aW1lbGluZVxuXG4gICAgICAgIHRoaXMudXBkYXRlTm90aWZpY2F0aW9uU3RhdGUoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBoYW5kbGVSb29tRXZlbnRVcGRhdGUgPSAoZXZlbnQ6IE1hdHJpeEV2ZW50LCByb29tOiBSb29tIHwgbnVsbCkgPT4ge1xuICAgICAgICBpZiAocm9vbT8ucm9vbUlkICE9PSB0aGlzLnJvb20ucm9vbUlkKSByZXR1cm47IC8vIGlnbm9yZSAtIG5vdCBmb3IgdXMgb3Igbm90aWZpY2F0aW9ucyB0aW1lbGluZVxuXG4gICAgICAgIHRoaXMudXBkYXRlTm90aWZpY2F0aW9uU3RhdGUoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBoYW5kbGVBY2NvdW50RGF0YVVwZGF0ZSA9IChldjogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2LmdldFR5cGUoKSA9PT0gXCJtLnB1c2hfcnVsZXNcIikge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVOb3RpZmljYXRpb25TdGF0ZSgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgdXBkYXRlTm90aWZpY2F0aW9uU3RhdGUoKSB7XG4gICAgICAgIGNvbnN0IHNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdCgpO1xuXG4gICAgICAgIGlmIChnZXRVbnNlbnRNZXNzYWdlcyh0aGlzLnJvb20pLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8vIFdoZW4gdGhlcmUgYXJlIHVuc2VudCBtZXNzYWdlcyB3ZSBzaG93IGEgcmVkIGAhYFxuICAgICAgICAgICAgdGhpcy5fY29sb3IgPSBOb3RpZmljYXRpb25Db2xvci5VbnNlbnQ7XG4gICAgICAgICAgICB0aGlzLl9zeW1ib2wgPSBcIiFcIjtcbiAgICAgICAgICAgIHRoaXMuX2NvdW50ID0gMTsgLy8gbm90IHVzZWQsIHRlY2huaWNhbGx5XG4gICAgICAgIH0gZWxzZSBpZiAoUm9vbU5vdGlmcy5nZXRSb29tTm90aWZzU3RhdGUodGhpcy5yb29tLnJvb21JZCkgPT09IFJvb21Ob3RpZnMuUm9vbU5vdGlmU3RhdGUuTXV0ZSkge1xuICAgICAgICAgICAgLy8gV2hlbiBtdXRlZCB3ZSBzdXBwcmVzcyBhbGwgbm90aWZpY2F0aW9uIHN0YXRlcywgZXZlbiBpZiB3ZSBoYXZlIGNvbnRleHQgb24gdGhlbS5cbiAgICAgICAgICAgIHRoaXMuX2NvbG9yID0gTm90aWZpY2F0aW9uQ29sb3IuTm9uZTtcbiAgICAgICAgICAgIHRoaXMuX3N5bWJvbCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLl9jb3VudCA9IDA7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5yb29tSXNJbnZpdGUpIHtcbiAgICAgICAgICAgIHRoaXMuX2NvbG9yID0gTm90aWZpY2F0aW9uQ29sb3IuUmVkO1xuICAgICAgICAgICAgdGhpcy5fc3ltYm9sID0gXCIhXCI7XG4gICAgICAgICAgICB0aGlzLl9jb3VudCA9IDE7IC8vIG5vdCB1c2VkLCB0ZWNobmljYWxseVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcmVkTm90aWZzID0gUm9vbU5vdGlmcy5nZXRVbnJlYWROb3RpZmljYXRpb25Db3VudCh0aGlzLnJvb20sIE5vdGlmaWNhdGlvbkNvdW50VHlwZS5IaWdobGlnaHQpO1xuICAgICAgICAgICAgY29uc3QgZ3JleU5vdGlmcyA9IFJvb21Ob3RpZnMuZ2V0VW5yZWFkTm90aWZpY2F0aW9uQ291bnQodGhpcy5yb29tLCBOb3RpZmljYXRpb25Db3VudFR5cGUuVG90YWwpO1xuXG4gICAgICAgICAgICAvLyBGb3IgYSAndHJ1ZSBjb3VudCcgd2UgcGljayB0aGUgZ3JleSBub3RpZmljYXRpb25zIGZpcnN0IGJlY2F1c2UgdGhleSBpbmNsdWRlIHRoZVxuICAgICAgICAgICAgLy8gcmVkIG5vdGlmaWNhdGlvbnMuIElmIHdlIGRvbid0IGhhdmUgYSBncmV5IGNvdW50IGZvciBzb21lIHJlYXNvbiB3ZSB1c2UgdGhlIHJlZFxuICAgICAgICAgICAgLy8gY291bnQuIElmIHRoYXQgY291bnQgaXMgYnJva2VuIGZvciBzb21lIHJlYXNvbiwgYXNzdW1lIHplcm8uIFRoaXMgYXZvaWRzIHVzIHNob3dpbmdcbiAgICAgICAgICAgIC8vIGEgYmFkZ2UgZm9yICdOYU4nICh3aGljaCBmb3JtYXRzIGFzICdOYU5CJyBmb3IgTmFOIEJpbGxpb24pLlxuICAgICAgICAgICAgY29uc3QgdHJ1ZUNvdW50ID0gZ3JleU5vdGlmcyA/IGdyZXlOb3RpZnMgOiAocmVkTm90aWZzID8gcmVkTm90aWZzIDogMCk7XG5cbiAgICAgICAgICAgIC8vIE5vdGU6IHdlIG9ubHkgc2V0IHRoZSBzeW1ib2wgaWYgd2UgaGF2ZSBhbiBhY3R1YWwgY291bnQuIFdlIGRvbid0IHdhbnQgdG8gc2hvd1xuICAgICAgICAgICAgLy8gemVybyBvbiBiYWRnZXMuXG5cbiAgICAgICAgICAgIGlmIChyZWROb3RpZnMgPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY29sb3IgPSBOb3RpZmljYXRpb25Db2xvci5SZWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5fY291bnQgPSB0cnVlQ291bnQ7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3ltYm9sID0gbnVsbDsgLy8gc3ltYm9sIGNhbGN1bGF0ZWQgYnkgY29tcG9uZW50XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGdyZXlOb3RpZnMgPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fY29sb3IgPSBOb3RpZmljYXRpb25Db2xvci5HcmV5O1xuICAgICAgICAgICAgICAgIHRoaXMuX2NvdW50ID0gdHJ1ZUNvdW50O1xuICAgICAgICAgICAgICAgIHRoaXMuX3N5bWJvbCA9IG51bGw7IC8vIHN5bWJvbCBjYWxjdWxhdGVkIGJ5IGNvbXBvbmVudFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBXZSBkb24ndCBoYXZlIGFueSBub3RpZmllZCBtZXNzYWdlcywgYnV0IHdlIG1pZ2h0IGhhdmUgdW5yZWFkIG1lc3NhZ2VzLiBMZXQnc1xuICAgICAgICAgICAgICAgIC8vIGZpbmQgb3V0LlxuICAgICAgICAgICAgICAgIGNvbnN0IGhhc1VucmVhZCA9IFVucmVhZC5kb2VzUm9vbUhhdmVVbnJlYWRNZXNzYWdlcyh0aGlzLnJvb20pO1xuICAgICAgICAgICAgICAgIGlmIChoYXNVbnJlYWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29sb3IgPSBOb3RpZmljYXRpb25Db2xvci5Cb2xkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbG9yID0gTm90aWZpY2F0aW9uQ29sb3IuTm9uZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBubyBzeW1ib2wgb3IgY291bnQgZm9yIHRoaXMgc3RhdGVcbiAgICAgICAgICAgICAgICB0aGlzLl9jb3VudCA9IDA7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3ltYm9sID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGZpbmFsbHksIHB1Ymxpc2ggYW4gdXBkYXRlIGlmIG5lZWRlZFxuICAgICAgICB0aGlzLmVtaXRJZlVwZGF0ZWQoc25hcHNob3QpO1xuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQTVCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFpQk8sTUFBTUEscUJBQU4sU0FBb0NDLG9DQUFwQyxDQUE4RTtFQUNqRkMsV0FBVyxDQUFpQkMsSUFBakIsRUFBOENDLFlBQTlDLEVBQTJGO0lBQ2xHO0lBRGtHLEtBQTFFRCxJQUEwRSxHQUExRUEsSUFBMEU7SUFBQSxLQUE3Q0MsWUFBNkMsR0FBN0NBLFlBQTZDO0lBQUEsMkRBbUN4RSxNQUFNO01BQ2hDLEtBQUtDLHVCQUFMO0lBQ0gsQ0FyQ3FH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