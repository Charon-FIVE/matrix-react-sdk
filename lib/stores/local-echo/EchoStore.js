"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.EchoStore = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _RoomEchoChamber = require("./RoomEchoChamber");

var _RoomEchoContext = require("./RoomEchoContext");

var _AsyncStoreWithClient = require("../AsyncStoreWithClient");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _EchoContext = require("./EchoContext");

var _NonUrgentToastStore = _interopRequireDefault(require("../NonUrgentToastStore"));

var _NonUrgentEchoFailureToast = _interopRequireDefault(require("../../components/views/toasts/NonUrgentEchoFailureToast"));

/*
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const roomContextKey = room => `room-${room.roomId}`;

class EchoStore extends _AsyncStoreWithClient.AsyncStoreWithClient {
  constructor() {
    super(_dispatcher.default);
    (0, _defineProperty2.default)(this, "caches", new Map());
  }

  static get instance() {
    if (!this._instance) {
      this._instance = new EchoStore();

      this._instance.start();
    }

    return this._instance;
  }

  get contexts() {
    return Array.from(this.caches.values()).map(e => e.context);
  }

  getOrCreateChamberForRoom(room) {
    if (this.caches.has(roomContextKey(room))) {
      return this.caches.get(roomContextKey(room));
    }

    const context = new _RoomEchoContext.RoomEchoContext(room);
    context.whenAnything(() => this.checkContexts());
    const echo = new _RoomEchoChamber.RoomEchoChamber(context);
    echo.setClient(this.matrixClient);
    this.caches.set(roomContextKey(room), echo);
    return echo;
  }

  async checkContexts() {
    let hasOrHadError = false;

    for (const echo of this.caches.values()) {
      hasOrHadError = echo.context.state === _EchoContext.ContextTransactionState.PendingErrors;
      if (hasOrHadError) break;
    }

    if (hasOrHadError && !this.state.toastRef) {
      const ref = _NonUrgentToastStore.default.instance.addToast(_NonUrgentEchoFailureToast.default);

      await this.updateState({
        toastRef: ref
      });
    } else if (!hasOrHadError && this.state.toastRef) {
      _NonUrgentToastStore.default.instance.removeToast(this.state.toastRef);

      await this.updateState({
        toastRef: null
      });
    }
  }

  async onReady() {
    if (!this.caches) return; // can only happen during initialization

    for (const echo of this.caches.values()) {
      echo.setClient(this.matrixClient);
    }
  }

  async onNotReady() {
    for (const echo of this.caches.values()) {
      echo.setClient(null);
    }
  }

  async onAction(payload) {}

}

exports.EchoStore = EchoStore;
(0, _defineProperty2.default)(EchoStore, "_instance", void 0);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyb29tQ29udGV4dEtleSIsInJvb20iLCJyb29tSWQiLCJFY2hvU3RvcmUiLCJBc3luY1N0b3JlV2l0aENsaWVudCIsImNvbnN0cnVjdG9yIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJNYXAiLCJpbnN0YW5jZSIsIl9pbnN0YW5jZSIsInN0YXJ0IiwiY29udGV4dHMiLCJBcnJheSIsImZyb20iLCJjYWNoZXMiLCJ2YWx1ZXMiLCJtYXAiLCJlIiwiY29udGV4dCIsImdldE9yQ3JlYXRlQ2hhbWJlckZvclJvb20iLCJoYXMiLCJnZXQiLCJSb29tRWNob0NvbnRleHQiLCJ3aGVuQW55dGhpbmciLCJjaGVja0NvbnRleHRzIiwiZWNobyIsIlJvb21FY2hvQ2hhbWJlciIsInNldENsaWVudCIsIm1hdHJpeENsaWVudCIsInNldCIsImhhc09ySGFkRXJyb3IiLCJzdGF0ZSIsIkNvbnRleHRUcmFuc2FjdGlvblN0YXRlIiwiUGVuZGluZ0Vycm9ycyIsInRvYXN0UmVmIiwicmVmIiwiTm9uVXJnZW50VG9hc3RTdG9yZSIsImFkZFRvYXN0IiwiTm9uVXJnZW50RWNob0ZhaWx1cmVUb2FzdCIsInVwZGF0ZVN0YXRlIiwicmVtb3ZlVG9hc3QiLCJvblJlYWR5Iiwib25Ob3RSZWFkeSIsIm9uQWN0aW9uIiwicGF5bG9hZCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZXMvbG9jYWwtZWNoby9FY2hvU3RvcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIwIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5cbmltcG9ydCB7IEdlbmVyaWNFY2hvQ2hhbWJlciB9IGZyb20gXCIuL0dlbmVyaWNFY2hvQ2hhbWJlclwiO1xuaW1wb3J0IHsgUm9vbUVjaG9DaGFtYmVyIH0gZnJvbSBcIi4vUm9vbUVjaG9DaGFtYmVyXCI7XG5pbXBvcnQgeyBSb29tRWNob0NvbnRleHQgfSBmcm9tIFwiLi9Sb29tRWNob0NvbnRleHRcIjtcbmltcG9ydCB7IEFzeW5jU3RvcmVXaXRoQ2xpZW50IH0gZnJvbSBcIi4uL0FzeW5jU3RvcmVXaXRoQ2xpZW50XCI7XG5pbXBvcnQgZGVmYXVsdERpc3BhdGNoZXIgZnJvbSBcIi4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgQWN0aW9uUGF5bG9hZCB9IGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL3BheWxvYWRzXCI7XG5pbXBvcnQgeyBDb250ZXh0VHJhbnNhY3Rpb25TdGF0ZSwgRWNob0NvbnRleHQgfSBmcm9tIFwiLi9FY2hvQ29udGV4dFwiO1xuaW1wb3J0IE5vblVyZ2VudFRvYXN0U3RvcmUsIHsgVG9hc3RSZWZlcmVuY2UgfSBmcm9tIFwiLi4vTm9uVXJnZW50VG9hc3RTdG9yZVwiO1xuaW1wb3J0IE5vblVyZ2VudEVjaG9GYWlsdXJlVG9hc3QgZnJvbSBcIi4uLy4uL2NvbXBvbmVudHMvdmlld3MvdG9hc3RzL05vblVyZ2VudEVjaG9GYWlsdXJlVG9hc3RcIjtcblxuaW50ZXJmYWNlIElTdGF0ZSB7XG4gICAgdG9hc3RSZWY6IFRvYXN0UmVmZXJlbmNlO1xufVxuXG50eXBlIENvbnRleHRLZXkgPSBzdHJpbmc7XG5cbmNvbnN0IHJvb21Db250ZXh0S2V5ID0gKHJvb206IFJvb20pOiBDb250ZXh0S2V5ID0+IGByb29tLSR7cm9vbS5yb29tSWR9YDtcblxuZXhwb3J0IGNsYXNzIEVjaG9TdG9yZSBleHRlbmRzIEFzeW5jU3RvcmVXaXRoQ2xpZW50PElTdGF0ZT4ge1xuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogRWNob1N0b3JlO1xuXG4gICAgcHJpdmF0ZSBjYWNoZXMgPSBuZXcgTWFwPENvbnRleHRLZXksIEdlbmVyaWNFY2hvQ2hhbWJlcjxhbnksIGFueSwgYW55Pj4oKTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcihkZWZhdWx0RGlzcGF0Y2hlcik7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgaW5zdGFuY2UoKTogRWNob1N0b3JlIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbnN0YW5jZSkge1xuICAgICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBuZXcgRWNob1N0b3JlKCk7XG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZS5zdGFydCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGNvbnRleHRzKCk6IEVjaG9Db250ZXh0W10ge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmNhY2hlcy52YWx1ZXMoKSkubWFwKGUgPT4gZS5jb250ZXh0KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0T3JDcmVhdGVDaGFtYmVyRm9yUm9vbShyb29tOiBSb29tKTogUm9vbUVjaG9DaGFtYmVyIHtcbiAgICAgICAgaWYgKHRoaXMuY2FjaGVzLmhhcyhyb29tQ29udGV4dEtleShyb29tKSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlcy5nZXQocm9vbUNvbnRleHRLZXkocm9vbSkpIGFzIFJvb21FY2hvQ2hhbWJlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSBuZXcgUm9vbUVjaG9Db250ZXh0KHJvb20pO1xuICAgICAgICBjb250ZXh0LndoZW5Bbnl0aGluZygoKSA9PiB0aGlzLmNoZWNrQ29udGV4dHMoKSk7XG5cbiAgICAgICAgY29uc3QgZWNobyA9IG5ldyBSb29tRWNob0NoYW1iZXIoY29udGV4dCk7XG4gICAgICAgIGVjaG8uc2V0Q2xpZW50KHRoaXMubWF0cml4Q2xpZW50KTtcbiAgICAgICAgdGhpcy5jYWNoZXMuc2V0KHJvb21Db250ZXh0S2V5KHJvb20pLCBlY2hvKTtcblxuICAgICAgICByZXR1cm4gZWNobztcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGNoZWNrQ29udGV4dHMoKSB7XG4gICAgICAgIGxldCBoYXNPckhhZEVycm9yID0gZmFsc2U7XG4gICAgICAgIGZvciAoY29uc3QgZWNobyBvZiB0aGlzLmNhY2hlcy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgaGFzT3JIYWRFcnJvciA9IGVjaG8uY29udGV4dC5zdGF0ZSA9PT0gQ29udGV4dFRyYW5zYWN0aW9uU3RhdGUuUGVuZGluZ0Vycm9ycztcbiAgICAgICAgICAgIGlmIChoYXNPckhhZEVycm9yKSBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNPckhhZEVycm9yICYmICF0aGlzLnN0YXRlLnRvYXN0UmVmKSB7XG4gICAgICAgICAgICBjb25zdCByZWYgPSBOb25VcmdlbnRUb2FzdFN0b3JlLmluc3RhbmNlLmFkZFRvYXN0KE5vblVyZ2VudEVjaG9GYWlsdXJlVG9hc3QpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0ZSh7IHRvYXN0UmVmOiByZWYgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoIWhhc09ySGFkRXJyb3IgJiYgdGhpcy5zdGF0ZS50b2FzdFJlZikge1xuICAgICAgICAgICAgTm9uVXJnZW50VG9hc3RTdG9yZS5pbnN0YW5jZS5yZW1vdmVUb2FzdCh0aGlzLnN0YXRlLnRvYXN0UmVmKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU3RhdGUoeyB0b2FzdFJlZjogbnVsbCB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvblJlYWR5KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICghdGhpcy5jYWNoZXMpIHJldHVybjsgLy8gY2FuIG9ubHkgaGFwcGVuIGR1cmluZyBpbml0aWFsaXphdGlvblxuICAgICAgICBmb3IgKGNvbnN0IGVjaG8gb2YgdGhpcy5jYWNoZXMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIGVjaG8uc2V0Q2xpZW50KHRoaXMubWF0cml4Q2xpZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBvbk5vdFJlYWR5KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGZvciAoY29uc3QgZWNobyBvZiB0aGlzLmNhY2hlcy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgZWNoby5zZXRDbGllbnQobnVsbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgb25BY3Rpb24ocGF5bG9hZDogQWN0aW9uUGF5bG9hZCk6IFByb21pc2U8dm9pZD4ge1xuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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