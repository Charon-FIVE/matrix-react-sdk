"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.inviteMultipleToRoom = inviteMultipleToRoom;
exports.inviteUsersToRoom = inviteUsersToRoom;
exports.isValid3pidInvite = isValid3pidInvite;
exports.showAnyInviteErrors = showAnyInviteErrors;
exports.showRoomInviteDialog = showRoomInviteDialog;
exports.showStartChatInviteDialog = showStartChatInviteDialog;

var _react = _interopRequireDefault(require("react"));

var _logger = require("matrix-js-sdk/src/logger");

var _event = require("matrix-js-sdk/src/@types/event");

var _MatrixClientPeg = require("./MatrixClientPeg");

var _MultiInviter = _interopRequireDefault(require("./utils/MultiInviter"));

var _Modal = _interopRequireDefault(require("./Modal"));

var _languageHandler = require("./languageHandler");

var _InviteDialog = _interopRequireDefault(require("./components/views/dialogs/InviteDialog"));

var _BaseAvatar = _interopRequireDefault(require("./components/views/avatars/BaseAvatar"));

var _Media = require("./customisations/Media");

var _ErrorDialog = _interopRequireDefault(require("./components/views/dialogs/ErrorDialog"));

var _InviteDialogTypes = require("./components/views/dialogs/InviteDialogTypes");

/*
Copyright 2016 - 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Invites multiple addresses to a room
 * Simpler interface to utils/MultiInviter but with
 * no option to cancel.
 *
 * @param {string} roomId The ID of the room to invite to
 * @param {string[]} addresses Array of strings of addresses to invite. May be matrix IDs or 3pids.
 * @param {boolean} sendSharedHistoryKeys whether to share e2ee keys with the invitees if applicable.
 * @param {function} progressCallback optional callback, fired after each invite.
 * @returns {Promise} Promise
 */
function inviteMultipleToRoom(roomId, addresses) {
  let sendSharedHistoryKeys = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
  let progressCallback = arguments.length > 3 ? arguments[3] : undefined;
  const inviter = new _MultiInviter.default(roomId, progressCallback);
  return inviter.invite(addresses, undefined, sendSharedHistoryKeys).then(states => Promise.resolve({
    states,
    inviter
  }));
}

function showStartChatInviteDialog() {
  let initialText = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "";

  // This dialog handles the room creation internally - we don't need to worry about it.
  _Modal.default.createDialog(_InviteDialog.default, {
    kind: _InviteDialogTypes.KIND_DM,
    initialText
  },
  /*className=*/
  "mx_InviteDialog_flexWrapper",
  /*isPriority=*/
  false,
  /*isStatic=*/
  true);
}

function showRoomInviteDialog(roomId) {
  let initialText = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";

  // This dialog handles the room creation internally - we don't need to worry about it.
  _Modal.default.createDialog(_InviteDialog.default, {
    kind: _InviteDialogTypes.KIND_INVITE,
    initialText,
    roomId
  },
  /*className=*/
  "mx_InviteDialog_flexWrapper",
  /*isPriority=*/
  false,
  /*isStatic=*/
  true);
}
/**
 * Checks if the given MatrixEvent is a valid 3rd party user invite.
 * @param {MatrixEvent} event The event to check
 * @returns {boolean} True if valid, false otherwise
 */


function isValid3pidInvite(event) {
  if (!event || event.getType() !== _event.EventType.RoomThirdPartyInvite) return false; // any events without these keys are not valid 3pid invites, so we ignore them

  const requiredKeys = ['key_validity_url', 'public_key', 'display_name'];

  if (requiredKeys.some(key => !event.getContent()[key])) {
    return false;
  } // Valid enough by our standards


  return true;
}

function inviteUsersToRoom(roomId, userIds) {
  let sendSharedHistoryKeys = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
  let progressCallback = arguments.length > 3 ? arguments[3] : undefined;
  return inviteMultipleToRoom(roomId, userIds, sendSharedHistoryKeys, progressCallback).then(result => {
    const room = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId);

    showAnyInviteErrors(result.states, room, result.inviter);
  }).catch(err => {
    _logger.logger.error(err.stack);

    _Modal.default.createDialog(_ErrorDialog.default, {
      title: (0, _languageHandler._t)("Failed to invite"),
      description: err && err.message ? err.message : (0, _languageHandler._t)("Operation failed")
    });
  });
}

function showAnyInviteErrors(states, room, inviter, userMap) {
  // Show user any errors
  const failedUsers = Object.keys(states).filter(a => states[a] === 'error');

  if (failedUsers.length === 1 && inviter.fatal) {
    // Just get the first message because there was a fatal problem on the first
    // user. This usually means that no other users were attempted, making it
    // pointless for us to list who failed exactly.
    _Modal.default.createDialog(_ErrorDialog.default, {
      title: (0, _languageHandler._t)("Failed to invite users to %(roomName)s", {
        roomName: room.name
      }),
      description: inviter.getErrorText(failedUsers[0])
    });

    return false;
  } else {
    const errorList = [];

    for (const addr of failedUsers) {
      if (states[addr] === "error") {
        const reason = inviter.getErrorText(addr);
        errorList.push(addr + ": " + reason);
      }
    }

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (errorList.length > 0) {
      // React 16 doesn't let us use `errorList.join(<br />)` anymore, so this is our solution
      const description = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_InviteDialog_multiInviterError"
      }, /*#__PURE__*/_react.default.createElement("h4", null, (0, _languageHandler._t)("We sent the others, but the below people couldn't be invited to <RoomName/>", {}, {
        RoomName: () => /*#__PURE__*/_react.default.createElement("b", null, room.name)
      })), /*#__PURE__*/_react.default.createElement("div", null, failedUsers.map(addr => {
        const user = userMap?.get(addr) || cli.getUser(addr);
        const name = user.name || user.rawDisplayName;
        const avatarUrl = user.getMxcAvatarUrl?.() || user.avatarUrl;
        return /*#__PURE__*/_react.default.createElement("div", {
          key: addr,
          className: "mx_InviteDialog_tile mx_InviteDialog_tile--inviterError"
        }, /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_InviteDialog_tile_avatarStack"
        }, /*#__PURE__*/_react.default.createElement(_BaseAvatar.default, {
          url: avatarUrl ? (0, _Media.mediaFromMxc)(avatarUrl).getSquareThumbnailHttp(24) : null,
          name: name,
          idName: user.userId,
          width: 36,
          height: 36
        })), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_InviteDialog_tile_nameStack"
        }, /*#__PURE__*/_react.default.createElement("span", {
          className: "mx_InviteDialog_tile_nameStack_name"
        }, name), /*#__PURE__*/_react.default.createElement("span", {
          className: "mx_InviteDialog_tile_nameStack_userId"
        }, user.userId)), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_InviteDialog_tile--inviterError_errorText"
        }, inviter.getErrorText(addr)));
      })));

      _Modal.default.createDialog(_ErrorDialog.default, {
        title: (0, _languageHandler._t)("Some invites couldn't be sent"),
        description
      });

      return false;
    }
  }

  return true;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpbnZpdGVNdWx0aXBsZVRvUm9vbSIsInJvb21JZCIsImFkZHJlc3NlcyIsInNlbmRTaGFyZWRIaXN0b3J5S2V5cyIsInByb2dyZXNzQ2FsbGJhY2siLCJpbnZpdGVyIiwiTXVsdGlJbnZpdGVyIiwiaW52aXRlIiwidW5kZWZpbmVkIiwidGhlbiIsInN0YXRlcyIsIlByb21pc2UiLCJyZXNvbHZlIiwic2hvd1N0YXJ0Q2hhdEludml0ZURpYWxvZyIsImluaXRpYWxUZXh0IiwiTW9kYWwiLCJjcmVhdGVEaWFsb2ciLCJJbnZpdGVEaWFsb2ciLCJraW5kIiwiS0lORF9ETSIsInNob3dSb29tSW52aXRlRGlhbG9nIiwiS0lORF9JTlZJVEUiLCJpc1ZhbGlkM3BpZEludml0ZSIsImV2ZW50IiwiZ2V0VHlwZSIsIkV2ZW50VHlwZSIsIlJvb21UaGlyZFBhcnR5SW52aXRlIiwicmVxdWlyZWRLZXlzIiwic29tZSIsImtleSIsImdldENvbnRlbnQiLCJpbnZpdGVVc2Vyc1RvUm9vbSIsInVzZXJJZHMiLCJyZXN1bHQiLCJyb29tIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0IiwiZ2V0Um9vbSIsInNob3dBbnlJbnZpdGVFcnJvcnMiLCJjYXRjaCIsImVyciIsImxvZ2dlciIsImVycm9yIiwic3RhY2siLCJFcnJvckRpYWxvZyIsInRpdGxlIiwiX3QiLCJkZXNjcmlwdGlvbiIsIm1lc3NhZ2UiLCJ1c2VyTWFwIiwiZmFpbGVkVXNlcnMiLCJPYmplY3QiLCJrZXlzIiwiZmlsdGVyIiwiYSIsImxlbmd0aCIsImZhdGFsIiwicm9vbU5hbWUiLCJuYW1lIiwiZ2V0RXJyb3JUZXh0IiwiZXJyb3JMaXN0IiwiYWRkciIsInJlYXNvbiIsInB1c2giLCJjbGkiLCJSb29tTmFtZSIsIm1hcCIsInVzZXIiLCJnZXRVc2VyIiwicmF3RGlzcGxheU5hbWUiLCJhdmF0YXJVcmwiLCJnZXRNeGNBdmF0YXJVcmwiLCJtZWRpYUZyb21NeGMiLCJnZXRTcXVhcmVUaHVtYm5haWxIdHRwIiwidXNlcklkIl0sInNvdXJjZXMiOlsiLi4vc3JjL1Jvb21JbnZpdGUudHN4Il0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNiAtIDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFVzZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3VzZXJcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcbmltcG9ydCB7IEV2ZW50VHlwZSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvZXZlbnRcIjtcblxuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IE11bHRpSW52aXRlciwgeyBDb21wbGV0aW9uU3RhdGVzIH0gZnJvbSAnLi91dGlscy9NdWx0aUludml0ZXInO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4vTW9kYWwnO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgSW52aXRlRGlhbG9nIGZyb20gXCIuL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9JbnZpdGVEaWFsb2dcIjtcbmltcG9ydCBCYXNlQXZhdGFyIGZyb20gXCIuL2NvbXBvbmVudHMvdmlld3MvYXZhdGFycy9CYXNlQXZhdGFyXCI7XG5pbXBvcnQgeyBtZWRpYUZyb21NeGMgfSBmcm9tIFwiLi9jdXN0b21pc2F0aW9ucy9NZWRpYVwiO1xuaW1wb3J0IEVycm9yRGlhbG9nIGZyb20gXCIuL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuaW1wb3J0IHsgS0lORF9ETSwgS0lORF9JTlZJVEUgfSBmcm9tIFwiLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSW52aXRlRGlhbG9nVHlwZXNcIjtcbmltcG9ydCB7IE1lbWJlciB9IGZyb20gXCIuL3V0aWxzL2RpcmVjdC1tZXNzYWdlc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIElJbnZpdGVSZXN1bHQge1xuICAgIHN0YXRlczogQ29tcGxldGlvblN0YXRlcztcbiAgICBpbnZpdGVyOiBNdWx0aUludml0ZXI7XG59XG5cbi8qKlxuICogSW52aXRlcyBtdWx0aXBsZSBhZGRyZXNzZXMgdG8gYSByb29tXG4gKiBTaW1wbGVyIGludGVyZmFjZSB0byB1dGlscy9NdWx0aUludml0ZXIgYnV0IHdpdGhcbiAqIG5vIG9wdGlvbiB0byBjYW5jZWwuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJvb21JZCBUaGUgSUQgb2YgdGhlIHJvb20gdG8gaW52aXRlIHRvXG4gKiBAcGFyYW0ge3N0cmluZ1tdfSBhZGRyZXNzZXMgQXJyYXkgb2Ygc3RyaW5ncyBvZiBhZGRyZXNzZXMgdG8gaW52aXRlLiBNYXkgYmUgbWF0cml4IElEcyBvciAzcGlkcy5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gc2VuZFNoYXJlZEhpc3RvcnlLZXlzIHdoZXRoZXIgdG8gc2hhcmUgZTJlZSBrZXlzIHdpdGggdGhlIGludml0ZWVzIGlmIGFwcGxpY2FibGUuXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBwcm9ncmVzc0NhbGxiYWNrIG9wdGlvbmFsIGNhbGxiYWNrLCBmaXJlZCBhZnRlciBlYWNoIGludml0ZS5cbiAqIEByZXR1cm5zIHtQcm9taXNlfSBQcm9taXNlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbnZpdGVNdWx0aXBsZVRvUm9vbShcbiAgICByb29tSWQ6IHN0cmluZyxcbiAgICBhZGRyZXNzZXM6IHN0cmluZ1tdLFxuICAgIHNlbmRTaGFyZWRIaXN0b3J5S2V5cyA9IGZhbHNlLFxuICAgIHByb2dyZXNzQ2FsbGJhY2s/OiAoKSA9PiB2b2lkLFxuKTogUHJvbWlzZTxJSW52aXRlUmVzdWx0PiB7XG4gICAgY29uc3QgaW52aXRlciA9IG5ldyBNdWx0aUludml0ZXIocm9vbUlkLCBwcm9ncmVzc0NhbGxiYWNrKTtcbiAgICByZXR1cm4gaW52aXRlci5pbnZpdGUoYWRkcmVzc2VzLCB1bmRlZmluZWQsIHNlbmRTaGFyZWRIaXN0b3J5S2V5cylcbiAgICAgICAgLnRoZW4oc3RhdGVzID0+IFByb21pc2UucmVzb2x2ZSh7IHN0YXRlcywgaW52aXRlciB9KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzaG93U3RhcnRDaGF0SW52aXRlRGlhbG9nKGluaXRpYWxUZXh0ID0gXCJcIik6IHZvaWQge1xuICAgIC8vIFRoaXMgZGlhbG9nIGhhbmRsZXMgdGhlIHJvb20gY3JlYXRpb24gaW50ZXJuYWxseSAtIHdlIGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuXG4gICAgTW9kYWwuY3JlYXRlRGlhbG9nKFxuICAgICAgICBJbnZpdGVEaWFsb2csIHsga2luZDogS0lORF9ETSwgaW5pdGlhbFRleHQgfSxcbiAgICAgICAgLypjbGFzc05hbWU9Ki9cIm14X0ludml0ZURpYWxvZ19mbGV4V3JhcHBlclwiLCAvKmlzUHJpb3JpdHk9Ki9mYWxzZSwgLyppc1N0YXRpYz0qL3RydWUsXG4gICAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNob3dSb29tSW52aXRlRGlhbG9nKHJvb21JZDogc3RyaW5nLCBpbml0aWFsVGV4dCA9IFwiXCIpOiB2b2lkIHtcbiAgICAvLyBUaGlzIGRpYWxvZyBoYW5kbGVzIHRoZSByb29tIGNyZWF0aW9uIGludGVybmFsbHkgLSB3ZSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IGl0LlxuICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhcbiAgICAgICAgSW52aXRlRGlhbG9nLCB7XG4gICAgICAgICAgICBraW5kOiBLSU5EX0lOVklURSxcbiAgICAgICAgICAgIGluaXRpYWxUZXh0LFxuICAgICAgICAgICAgcm9vbUlkLFxuICAgICAgICB9LFxuICAgICAgICAvKmNsYXNzTmFtZT0qL1wibXhfSW52aXRlRGlhbG9nX2ZsZXhXcmFwcGVyXCIsIC8qaXNQcmlvcml0eT0qL2ZhbHNlLCAvKmlzU3RhdGljPSovdHJ1ZSxcbiAgICApO1xufVxuXG4vKipcbiAqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gTWF0cml4RXZlbnQgaXMgYSB2YWxpZCAzcmQgcGFydHkgdXNlciBpbnZpdGUuXG4gKiBAcGFyYW0ge01hdHJpeEV2ZW50fSBldmVudCBUaGUgZXZlbnQgdG8gY2hlY2tcbiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIHZhbGlkLCBmYWxzZSBvdGhlcndpc2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzVmFsaWQzcGlkSW52aXRlKGV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4ge1xuICAgIGlmICghZXZlbnQgfHwgZXZlbnQuZ2V0VHlwZSgpICE9PSBFdmVudFR5cGUuUm9vbVRoaXJkUGFydHlJbnZpdGUpIHJldHVybiBmYWxzZTtcblxuICAgIC8vIGFueSBldmVudHMgd2l0aG91dCB0aGVzZSBrZXlzIGFyZSBub3QgdmFsaWQgM3BpZCBpbnZpdGVzLCBzbyB3ZSBpZ25vcmUgdGhlbVxuICAgIGNvbnN0IHJlcXVpcmVkS2V5cyA9IFsna2V5X3ZhbGlkaXR5X3VybCcsICdwdWJsaWNfa2V5JywgJ2Rpc3BsYXlfbmFtZSddO1xuICAgIGlmIChyZXF1aXJlZEtleXMuc29tZShrZXkgPT4gIWV2ZW50LmdldENvbnRlbnQoKVtrZXldKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVmFsaWQgZW5vdWdoIGJ5IG91ciBzdGFuZGFyZHNcbiAgICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGludml0ZVVzZXJzVG9Sb29tKFxuICAgIHJvb21JZDogc3RyaW5nLFxuICAgIHVzZXJJZHM6IHN0cmluZ1tdLFxuICAgIHNlbmRTaGFyZWRIaXN0b3J5S2V5cyA9IGZhbHNlLFxuICAgIHByb2dyZXNzQ2FsbGJhY2s/OiAoKSA9PiB2b2lkLFxuKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIGludml0ZU11bHRpcGxlVG9Sb29tKHJvb21JZCwgdXNlcklkcywgc2VuZFNoYXJlZEhpc3RvcnlLZXlzLCBwcm9ncmVzc0NhbGxiYWNrKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgY29uc3Qgcm9vbSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRSb29tKHJvb21JZCk7XG4gICAgICAgIHNob3dBbnlJbnZpdGVFcnJvcnMocmVzdWx0LnN0YXRlcywgcm9vbSwgcmVzdWx0Lmludml0ZXIpO1xuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKGVyci5zdGFjayk7XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgdGl0bGU6IF90KFwiRmFpbGVkIHRvIGludml0ZVwiKSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAoKGVyciAmJiBlcnIubWVzc2FnZSkgPyBlcnIubWVzc2FnZSA6IF90KFwiT3BlcmF0aW9uIGZhaWxlZFwiKSksXG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2hvd0FueUludml0ZUVycm9ycyhcbiAgICBzdGF0ZXM6IENvbXBsZXRpb25TdGF0ZXMsXG4gICAgcm9vbTogUm9vbSxcbiAgICBpbnZpdGVyOiBNdWx0aUludml0ZXIsXG4gICAgdXNlck1hcD86IE1hcDxzdHJpbmcsIE1lbWJlcj4sXG4pOiBib29sZWFuIHtcbiAgICAvLyBTaG93IHVzZXIgYW55IGVycm9yc1xuICAgIGNvbnN0IGZhaWxlZFVzZXJzID0gT2JqZWN0LmtleXMoc3RhdGVzKS5maWx0ZXIoYSA9PiBzdGF0ZXNbYV0gPT09ICdlcnJvcicpO1xuICAgIGlmIChmYWlsZWRVc2Vycy5sZW5ndGggPT09IDEgJiYgaW52aXRlci5mYXRhbCkge1xuICAgICAgICAvLyBKdXN0IGdldCB0aGUgZmlyc3QgbWVzc2FnZSBiZWNhdXNlIHRoZXJlIHdhcyBhIGZhdGFsIHByb2JsZW0gb24gdGhlIGZpcnN0XG4gICAgICAgIC8vIHVzZXIuIFRoaXMgdXN1YWxseSBtZWFucyB0aGF0IG5vIG90aGVyIHVzZXJzIHdlcmUgYXR0ZW1wdGVkLCBtYWtpbmcgaXRcbiAgICAgICAgLy8gcG9pbnRsZXNzIGZvciB1cyB0byBsaXN0IHdobyBmYWlsZWQgZXhhY3RseS5cbiAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICB0aXRsZTogX3QoXCJGYWlsZWQgdG8gaW52aXRlIHVzZXJzIHRvICUocm9vbU5hbWUpc1wiLCB7IHJvb21OYW1lOiByb29tLm5hbWUgfSksXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogaW52aXRlci5nZXRFcnJvclRleHQoZmFpbGVkVXNlcnNbMF0pLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGVycm9yTGlzdCA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGFkZHIgb2YgZmFpbGVkVXNlcnMpIHtcbiAgICAgICAgICAgIGlmIChzdGF0ZXNbYWRkcl0gPT09IFwiZXJyb3JcIikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlYXNvbiA9IGludml0ZXIuZ2V0RXJyb3JUZXh0KGFkZHIpO1xuICAgICAgICAgICAgICAgIGVycm9yTGlzdC5wdXNoKGFkZHIgKyBcIjogXCIgKyByZWFzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICBpZiAoZXJyb3JMaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8vIFJlYWN0IDE2IGRvZXNuJ3QgbGV0IHVzIHVzZSBgZXJyb3JMaXN0LmpvaW4oPGJyIC8+KWAgYW55bW9yZSwgc28gdGhpcyBpcyBvdXIgc29sdXRpb25cbiAgICAgICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gPGRpdiBjbGFzc05hbWU9XCJteF9JbnZpdGVEaWFsb2dfbXVsdGlJbnZpdGVyRXJyb3JcIj5cbiAgICAgICAgICAgICAgICA8aDQ+eyBfdChcIldlIHNlbnQgdGhlIG90aGVycywgYnV0IHRoZSBiZWxvdyBwZW9wbGUgY291bGRuJ3QgYmUgaW52aXRlZCB0byA8Um9vbU5hbWUvPlwiLCB7fSwge1xuICAgICAgICAgICAgICAgICAgICBSb29tTmFtZTogKCkgPT4gPGI+eyByb29tLm5hbWUgfTwvYj4sXG4gICAgICAgICAgICAgICAgfSkgfTwvaDQ+XG4gICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgeyBmYWlsZWRVc2Vycy5tYXAoYWRkciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gdXNlck1hcD8uZ2V0KGFkZHIpIHx8IGNsaS5nZXRVc2VyKGFkZHIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9ICh1c2VyIGFzIE1lbWJlcikubmFtZSB8fCAodXNlciBhcyBVc2VyKS5yYXdEaXNwbGF5TmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF2YXRhclVybCA9ICh1c2VyIGFzIE1lbWJlcikuZ2V0TXhjQXZhdGFyVXJsPy4oKSB8fCAodXNlciBhcyBVc2VyKS5hdmF0YXJVcmw7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gPGRpdiBrZXk9e2FkZHJ9IGNsYXNzTmFtZT1cIm14X0ludml0ZURpYWxvZ190aWxlIG14X0ludml0ZURpYWxvZ190aWxlLS1pbnZpdGVyRXJyb3JcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0ludml0ZURpYWxvZ190aWxlX2F2YXRhclN0YWNrXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxCYXNlQXZhdGFyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw9e2F2YXRhclVybCA/IG1lZGlhRnJvbU14YyhhdmF0YXJVcmwpLmdldFNxdWFyZVRodW1ibmFpbEh0dHAoMjQpIDogbnVsbH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9e25hbWV9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZE5hbWU9e3VzZXIudXNlcklkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg9ezM2fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0PXszNn1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0ludml0ZURpYWxvZ190aWxlX25hbWVTdGFja1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9JbnZpdGVEaWFsb2dfdGlsZV9uYW1lU3RhY2tfbmFtZVwiPnsgbmFtZSB9PC9zcGFuPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9JbnZpdGVEaWFsb2dfdGlsZV9uYW1lU3RhY2tfdXNlcklkXCI+eyB1c2VyLnVzZXJJZCB9PC9zcGFuPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfSW52aXRlRGlhbG9nX3RpbGUtLWludml0ZXJFcnJvcl9lcnJvclRleHRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBpbnZpdGVyLmdldEVycm9yVGV4dChhZGRyKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgICAgICAgICAgICAgIH0pIH1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PjtcblxuICAgICAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKEVycm9yRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiU29tZSBpbnZpdGVzIGNvdWxkbid0IGJlIHNlbnRcIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xufVxu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