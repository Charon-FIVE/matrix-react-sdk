"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CARET_NODE_CHAR = void 0;
exports.isCaretNode = isCaretNode;
exports.needsCaretNodeAfter = needsCaretNodeAfter;
exports.needsCaretNodeBefore = needsCaretNodeBefore;
exports.renderModel = renderModel;

var _parts = require("./parts");

/*
Copyright 2019 New Vector Ltd
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function needsCaretNodeBefore(part, prevPart) {
  const isFirst = !prevPart || prevPart.type === _parts.Type.Newline;
  return !part.acceptsCaret && (isFirst || !prevPart.acceptsCaret);
}

function needsCaretNodeAfter(part, isLastOfLine) {
  return !part.acceptsCaret && isLastOfLine;
}

function insertAfter(node, nodeToInsert) {
  const next = node.nextSibling;

  if (next) {
    node.parentElement.insertBefore(nodeToInsert, next);
  } else {
    node.parentElement.appendChild(nodeToInsert);
  }
} // Use a BOM marker for caret nodes.
// On a first test, they seem to be filtered out when copying text out of the editor,
// but this could be platform dependent.
// As a precautionary measure, I chose the character that slate also uses.


const CARET_NODE_CHAR = "\ufeff"; // a caret node is a node that allows the caret to be placed
// where otherwise it wouldn't be possible
// (e.g. next to a pill span without adjacent text node)

exports.CARET_NODE_CHAR = CARET_NODE_CHAR;

function createCaretNode() {
  const span = document.createElement("span");
  span.className = "caretNode";
  span.appendChild(document.createTextNode(CARET_NODE_CHAR));
  return span;
}

function updateCaretNode(node) {
  // ensure the caret node contains only a zero-width space
  if (node.textContent !== CARET_NODE_CHAR) {
    node.textContent = CARET_NODE_CHAR;
  }
}

function isCaretNode(node) {
  return node && node.tagName === "SPAN" && node.className === "caretNode";
}

function removeNextSiblings(node) {
  if (!node) {
    return;
  }

  node = node.nextSibling;

  while (node) {
    const removeNode = node;
    node = node.nextSibling;
    removeNode.remove();
  }
}

function removeChildren(parent) {
  const firstChild = parent.firstChild;

  if (firstChild) {
    removeNextSiblings(firstChild);
    firstChild.remove();
  }
}

function reconcileLine(lineContainer, parts) {
  let currentNode;
  let prevPart;
  const lastPart = parts[parts.length - 1];

  for (const part of parts) {
    const isFirst = !prevPart;
    currentNode = isFirst ? lineContainer.firstChild : currentNode.nextSibling;

    if (needsCaretNodeBefore(part, prevPart)) {
      if (isCaretNode(currentNode)) {
        updateCaretNode(currentNode);
        currentNode = currentNode.nextSibling;
      } else {
        lineContainer.insertBefore(createCaretNode(), currentNode);
      }
    } // remove nodes until matching current part


    while (currentNode && !part.canUpdateDOMNode(currentNode)) {
      const nextNode = currentNode.nextSibling;
      lineContainer.removeChild(currentNode);
      currentNode = nextNode;
    } // update or insert node for current part


    if (currentNode && part) {
      part.updateDOMNode(currentNode);
    } else if (part) {
      currentNode = part.toDOMNode(); // hooks up nextSibling for next iteration

      lineContainer.appendChild(currentNode);
    }

    if (needsCaretNodeAfter(part, part === lastPart)) {
      if (isCaretNode(currentNode.nextSibling)) {
        currentNode = currentNode.nextSibling;
        updateCaretNode(currentNode);
      } else {
        const caretNode = createCaretNode();
        insertAfter(currentNode, caretNode);
        currentNode = caretNode;
      }
    }

    prevPart = part;
  }

  removeNextSiblings(currentNode);
}

function reconcileEmptyLine(lineContainer) {
  // empty div needs to have a BR in it to give it height
  let foundBR = false;
  let partNode = lineContainer.firstChild;

  while (partNode) {
    const nextNode = partNode.nextSibling;

    if (!foundBR && partNode.tagName === "BR") {
      foundBR = true;
    } else {
      partNode.remove();
    }

    partNode = nextNode;
  }

  if (!foundBR) {
    lineContainer.appendChild(document.createElement("br"));
  }
}

function renderModel(editor, model) {
  const lines = model.parts.reduce((linesArr, part) => {
    if (part.type === _parts.Type.Newline) {
      linesArr.push([]);
    } else {
      const lastLine = linesArr[linesArr.length - 1];
      lastLine.push(part);
    }

    return linesArr;
  }, [[]]);
  lines.forEach((parts, i) => {
    // find first (and remove anything else) div without className
    // (as browsers insert these in contenteditable) line container
    let lineContainer = editor.childNodes[i];

    while (lineContainer && (lineContainer.tagName !== "DIV" || !!lineContainer.className)) {
      editor.removeChild(lineContainer);
      lineContainer = editor.childNodes[i];
    }

    if (!lineContainer) {
      lineContainer = document.createElement("div");
      editor.appendChild(lineContainer);
    }

    if (parts.length) {
      reconcileLine(lineContainer, parts);
    } else {
      reconcileEmptyLine(lineContainer);
    }
  });

  if (lines.length) {
    removeNextSiblings(editor.children[lines.length - 1]);
  } else {
    removeChildren(editor);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJuZWVkc0NhcmV0Tm9kZUJlZm9yZSIsInBhcnQiLCJwcmV2UGFydCIsImlzRmlyc3QiLCJ0eXBlIiwiVHlwZSIsIk5ld2xpbmUiLCJhY2NlcHRzQ2FyZXQiLCJuZWVkc0NhcmV0Tm9kZUFmdGVyIiwiaXNMYXN0T2ZMaW5lIiwiaW5zZXJ0QWZ0ZXIiLCJub2RlIiwibm9kZVRvSW5zZXJ0IiwibmV4dCIsIm5leHRTaWJsaW5nIiwicGFyZW50RWxlbWVudCIsImluc2VydEJlZm9yZSIsImFwcGVuZENoaWxkIiwiQ0FSRVRfTk9ERV9DSEFSIiwiY3JlYXRlQ2FyZXROb2RlIiwic3BhbiIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTmFtZSIsImNyZWF0ZVRleHROb2RlIiwidXBkYXRlQ2FyZXROb2RlIiwidGV4dENvbnRlbnQiLCJpc0NhcmV0Tm9kZSIsInRhZ05hbWUiLCJyZW1vdmVOZXh0U2libGluZ3MiLCJyZW1vdmVOb2RlIiwicmVtb3ZlIiwicmVtb3ZlQ2hpbGRyZW4iLCJwYXJlbnQiLCJmaXJzdENoaWxkIiwicmVjb25jaWxlTGluZSIsImxpbmVDb250YWluZXIiLCJwYXJ0cyIsImN1cnJlbnROb2RlIiwibGFzdFBhcnQiLCJsZW5ndGgiLCJjYW5VcGRhdGVET01Ob2RlIiwibmV4dE5vZGUiLCJyZW1vdmVDaGlsZCIsInVwZGF0ZURPTU5vZGUiLCJ0b0RPTU5vZGUiLCJjYXJldE5vZGUiLCJyZWNvbmNpbGVFbXB0eUxpbmUiLCJmb3VuZEJSIiwicGFydE5vZGUiLCJyZW5kZXJNb2RlbCIsImVkaXRvciIsIm1vZGVsIiwibGluZXMiLCJyZWR1Y2UiLCJsaW5lc0FyciIsInB1c2giLCJsYXN0TGluZSIsImZvckVhY2giLCJpIiwiY2hpbGROb2RlcyIsImNoaWxkcmVuIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VkaXRvci9yZW5kZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE5ldyBWZWN0b3IgTHRkXG5Db3B5cmlnaHQgMjAxOSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IFBhcnQsIFR5cGUgfSBmcm9tIFwiLi9wYXJ0c1wiO1xuaW1wb3J0IEVkaXRvck1vZGVsIGZyb20gXCIuL21vZGVsXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBuZWVkc0NhcmV0Tm9kZUJlZm9yZShwYXJ0OiBQYXJ0LCBwcmV2UGFydDogUGFydCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGlzRmlyc3QgPSAhcHJldlBhcnQgfHwgcHJldlBhcnQudHlwZSA9PT0gVHlwZS5OZXdsaW5lO1xuICAgIHJldHVybiAhcGFydC5hY2NlcHRzQ2FyZXQgJiYgKGlzRmlyc3QgfHwgIXByZXZQYXJ0LmFjY2VwdHNDYXJldCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuZWVkc0NhcmV0Tm9kZUFmdGVyKHBhcnQ6IFBhcnQsIGlzTGFzdE9mTGluZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhcGFydC5hY2NlcHRzQ2FyZXQgJiYgaXNMYXN0T2ZMaW5lO1xufVxuXG5mdW5jdGlvbiBpbnNlcnRBZnRlcihub2RlOiBIVE1MRWxlbWVudCwgbm9kZVRvSW5zZXJ0OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgIGNvbnN0IG5leHQgPSBub2RlLm5leHRTaWJsaW5nO1xuICAgIGlmIChuZXh0KSB7XG4gICAgICAgIG5vZGUucGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZVRvSW5zZXJ0LCBuZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBub2RlLnBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQobm9kZVRvSW5zZXJ0KTtcbiAgICB9XG59XG5cbi8vIFVzZSBhIEJPTSBtYXJrZXIgZm9yIGNhcmV0IG5vZGVzLlxuLy8gT24gYSBmaXJzdCB0ZXN0LCB0aGV5IHNlZW0gdG8gYmUgZmlsdGVyZWQgb3V0IHdoZW4gY29weWluZyB0ZXh0IG91dCBvZiB0aGUgZWRpdG9yLFxuLy8gYnV0IHRoaXMgY291bGQgYmUgcGxhdGZvcm0gZGVwZW5kZW50LlxuLy8gQXMgYSBwcmVjYXV0aW9uYXJ5IG1lYXN1cmUsIEkgY2hvc2UgdGhlIGNoYXJhY3RlciB0aGF0IHNsYXRlIGFsc28gdXNlcy5cbmV4cG9ydCBjb25zdCBDQVJFVF9OT0RFX0NIQVIgPSBcIlxcdWZlZmZcIjtcbi8vIGEgY2FyZXQgbm9kZSBpcyBhIG5vZGUgdGhhdCBhbGxvd3MgdGhlIGNhcmV0IHRvIGJlIHBsYWNlZFxuLy8gd2hlcmUgb3RoZXJ3aXNlIGl0IHdvdWxkbid0IGJlIHBvc3NpYmxlXG4vLyAoZS5nLiBuZXh0IHRvIGEgcGlsbCBzcGFuIHdpdGhvdXQgYWRqYWNlbnQgdGV4dCBub2RlKVxuZnVuY3Rpb24gY3JlYXRlQ2FyZXROb2RlKCk6IEhUTUxFbGVtZW50IHtcbiAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG4gICAgc3Bhbi5jbGFzc05hbWUgPSBcImNhcmV0Tm9kZVwiO1xuICAgIHNwYW4uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoQ0FSRVRfTk9ERV9DSEFSKSk7XG4gICAgcmV0dXJuIHNwYW47XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUNhcmV0Tm9kZShub2RlOiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgIC8vIGVuc3VyZSB0aGUgY2FyZXQgbm9kZSBjb250YWlucyBvbmx5IGEgemVyby13aWR0aCBzcGFjZVxuICAgIGlmIChub2RlLnRleHRDb250ZW50ICE9PSBDQVJFVF9OT0RFX0NIQVIpIHtcbiAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IENBUkVUX05PREVfQ0hBUjtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NhcmV0Tm9kZShub2RlOiBIVE1MRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBub2RlICYmIG5vZGUudGFnTmFtZSA9PT0gXCJTUEFOXCIgJiYgbm9kZS5jbGFzc05hbWUgPT09IFwiY2FyZXROb2RlXCI7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZU5leHRTaWJsaW5ncyhub2RlOiBDaGlsZE5vZGUpOiB2b2lkIHtcbiAgICBpZiAoIW5vZGUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBub2RlID0gbm9kZS5uZXh0U2libGluZztcbiAgICB3aGlsZSAobm9kZSkge1xuICAgICAgICBjb25zdCByZW1vdmVOb2RlID0gbm9kZTtcbiAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgIHJlbW92ZU5vZGUucmVtb3ZlKCk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiByZW1vdmVDaGlsZHJlbihwYXJlbnQ6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgZmlyc3RDaGlsZCA9IHBhcmVudC5maXJzdENoaWxkO1xuICAgIGlmIChmaXJzdENoaWxkKSB7XG4gICAgICAgIHJlbW92ZU5leHRTaWJsaW5ncyhmaXJzdENoaWxkKTtcbiAgICAgICAgZmlyc3RDaGlsZC5yZW1vdmUoKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlY29uY2lsZUxpbmUobGluZUNvbnRhaW5lcjogQ2hpbGROb2RlLCBwYXJ0czogUGFydFtdKTogdm9pZCB7XG4gICAgbGV0IGN1cnJlbnROb2RlO1xuICAgIGxldCBwcmV2UGFydDtcbiAgICBjb25zdCBsYXN0UGFydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdO1xuXG4gICAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRzKSB7XG4gICAgICAgIGNvbnN0IGlzRmlyc3QgPSAhcHJldlBhcnQ7XG4gICAgICAgIGN1cnJlbnROb2RlID0gaXNGaXJzdCA/IGxpbmVDb250YWluZXIuZmlyc3RDaGlsZCA6IGN1cnJlbnROb2RlLm5leHRTaWJsaW5nO1xuXG4gICAgICAgIGlmIChuZWVkc0NhcmV0Tm9kZUJlZm9yZShwYXJ0LCBwcmV2UGFydCkpIHtcbiAgICAgICAgICAgIGlmIChpc0NhcmV0Tm9kZShjdXJyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVDYXJldE5vZGUoY3VycmVudE5vZGUpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxpbmVDb250YWluZXIuaW5zZXJ0QmVmb3JlKGNyZWF0ZUNhcmV0Tm9kZSgpLCBjdXJyZW50Tm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gcmVtb3ZlIG5vZGVzIHVudGlsIG1hdGNoaW5nIGN1cnJlbnQgcGFydFxuICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgJiYgIXBhcnQuY2FuVXBkYXRlRE9NTm9kZShjdXJyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgICBsaW5lQ29udGFpbmVyLnJlbW92ZUNoaWxkKGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgIGN1cnJlbnROb2RlID0gbmV4dE5vZGU7XG4gICAgICAgIH1cbiAgICAgICAgLy8gdXBkYXRlIG9yIGluc2VydCBub2RlIGZvciBjdXJyZW50IHBhcnRcbiAgICAgICAgaWYgKGN1cnJlbnROb2RlICYmIHBhcnQpIHtcbiAgICAgICAgICAgIHBhcnQudXBkYXRlRE9NTm9kZShjdXJyZW50Tm9kZSk7XG4gICAgICAgIH0gZWxzZSBpZiAocGFydCkge1xuICAgICAgICAgICAgY3VycmVudE5vZGUgPSBwYXJ0LnRvRE9NTm9kZSgpO1xuICAgICAgICAgICAgLy8gaG9va3MgdXAgbmV4dFNpYmxpbmcgZm9yIG5leHQgaXRlcmF0aW9uXG4gICAgICAgICAgICBsaW5lQ29udGFpbmVyLmFwcGVuZENoaWxkKGN1cnJlbnROb2RlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuZWVkc0NhcmV0Tm9kZUFmdGVyKHBhcnQsIHBhcnQgPT09IGxhc3RQYXJ0KSkge1xuICAgICAgICAgICAgaWYgKGlzQ2FyZXROb2RlKGN1cnJlbnROb2RlLm5leHRTaWJsaW5nKSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgICAgICAgdXBkYXRlQ2FyZXROb2RlKGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FyZXROb2RlID0gY3JlYXRlQ2FyZXROb2RlKCk7XG4gICAgICAgICAgICAgICAgaW5zZXJ0QWZ0ZXIoY3VycmVudE5vZGUsIGNhcmV0Tm9kZSk7XG4gICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjYXJldE5vZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBwcmV2UGFydCA9IHBhcnQ7XG4gICAgfVxuXG4gICAgcmVtb3ZlTmV4dFNpYmxpbmdzKGN1cnJlbnROb2RlKTtcbn1cblxuZnVuY3Rpb24gcmVjb25jaWxlRW1wdHlMaW5lKGxpbmVDb250YWluZXI6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgLy8gZW1wdHkgZGl2IG5lZWRzIHRvIGhhdmUgYSBCUiBpbiBpdCB0byBnaXZlIGl0IGhlaWdodFxuICAgIGxldCBmb3VuZEJSID0gZmFsc2U7XG4gICAgbGV0IHBhcnROb2RlID0gbGluZUNvbnRhaW5lci5maXJzdENoaWxkO1xuICAgIHdoaWxlIChwYXJ0Tm9kZSkge1xuICAgICAgICBjb25zdCBuZXh0Tm9kZSA9IHBhcnROb2RlLm5leHRTaWJsaW5nO1xuICAgICAgICBpZiAoIWZvdW5kQlIgJiYgKHBhcnROb2RlIGFzIEhUTUxFbGVtZW50KS50YWdOYW1lID09PSBcIkJSXCIpIHtcbiAgICAgICAgICAgIGZvdW5kQlIgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcGFydE5vZGUucmVtb3ZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcGFydE5vZGUgPSBuZXh0Tm9kZTtcbiAgICB9XG4gICAgaWYgKCFmb3VuZEJSKSB7XG4gICAgICAgIGxpbmVDb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImJyXCIpKTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJNb2RlbChlZGl0b3I6IEhUTUxEaXZFbGVtZW50LCBtb2RlbDogRWRpdG9yTW9kZWwpOiB2b2lkIHtcbiAgICBjb25zdCBsaW5lcyA9IG1vZGVsLnBhcnRzLnJlZHVjZSgobGluZXNBcnIsIHBhcnQpID0+IHtcbiAgICAgICAgaWYgKHBhcnQudHlwZSA9PT0gVHlwZS5OZXdsaW5lKSB7XG4gICAgICAgICAgICBsaW5lc0Fyci5wdXNoKFtdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RMaW5lID0gbGluZXNBcnJbbGluZXNBcnIubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBsYXN0TGluZS5wdXNoKHBhcnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsaW5lc0FycjtcbiAgICB9LCBbW11dKTtcbiAgICBsaW5lcy5mb3JFYWNoKChwYXJ0cywgaSkgPT4ge1xuICAgICAgICAvLyBmaW5kIGZpcnN0IChhbmQgcmVtb3ZlIGFueXRoaW5nIGVsc2UpIGRpdiB3aXRob3V0IGNsYXNzTmFtZVxuICAgICAgICAvLyAoYXMgYnJvd3NlcnMgaW5zZXJ0IHRoZXNlIGluIGNvbnRlbnRlZGl0YWJsZSkgbGluZSBjb250YWluZXJcbiAgICAgICAgbGV0IGxpbmVDb250YWluZXIgPSBlZGl0b3IuY2hpbGROb2Rlc1tpXTtcbiAgICAgICAgd2hpbGUgKGxpbmVDb250YWluZXIgJiYgKCg8RWxlbWVudD5saW5lQ29udGFpbmVyKS50YWdOYW1lICE9PSBcIkRJVlwiIHx8ICEhKDxFbGVtZW50PmxpbmVDb250YWluZXIpLmNsYXNzTmFtZSkpIHtcbiAgICAgICAgICAgIGVkaXRvci5yZW1vdmVDaGlsZChsaW5lQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGxpbmVDb250YWluZXIgPSBlZGl0b3IuY2hpbGROb2Rlc1tpXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWxpbmVDb250YWluZXIpIHtcbiAgICAgICAgICAgIGxpbmVDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgICAgICAgICAgZWRpdG9yLmFwcGVuZENoaWxkKGxpbmVDb250YWluZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmVjb25jaWxlTGluZShsaW5lQ29udGFpbmVyLCBwYXJ0cyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvbmNpbGVFbXB0eUxpbmUobGluZUNvbnRhaW5lciBhcyBIVE1MRWxlbWVudCk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAobGluZXMubGVuZ3RoKSB7XG4gICAgICAgIHJlbW92ZU5leHRTaWJsaW5ncyhlZGl0b3IuY2hpbGRyZW5bbGluZXMubGVuZ3RoIC0gMV0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlbW92ZUNoaWxkcmVuKGVkaXRvcik7XG4gICAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWlCQTs7QUFqQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFLTyxTQUFTQSxvQkFBVCxDQUE4QkMsSUFBOUIsRUFBMENDLFFBQTFDLEVBQW1FO0VBQ3RFLE1BQU1DLE9BQU8sR0FBRyxDQUFDRCxRQUFELElBQWFBLFFBQVEsQ0FBQ0UsSUFBVCxLQUFrQkMsV0FBQSxDQUFLQyxPQUFwRDtFQUNBLE9BQU8sQ0FBQ0wsSUFBSSxDQUFDTSxZQUFOLEtBQXVCSixPQUFPLElBQUksQ0FBQ0QsUUFBUSxDQUFDSyxZQUE1QyxDQUFQO0FBQ0g7O0FBRU0sU0FBU0MsbUJBQVQsQ0FBNkJQLElBQTdCLEVBQXlDUSxZQUF6QyxFQUF5RTtFQUM1RSxPQUFPLENBQUNSLElBQUksQ0FBQ00sWUFBTixJQUFzQkUsWUFBN0I7QUFDSDs7QUFFRCxTQUFTQyxXQUFULENBQXFCQyxJQUFyQixFQUF3Q0MsWUFBeEMsRUFBeUU7RUFDckUsTUFBTUMsSUFBSSxHQUFHRixJQUFJLENBQUNHLFdBQWxCOztFQUNBLElBQUlELElBQUosRUFBVTtJQUNORixJQUFJLENBQUNJLGFBQUwsQ0FBbUJDLFlBQW5CLENBQWdDSixZQUFoQyxFQUE4Q0MsSUFBOUM7RUFDSCxDQUZELE1BRU87SUFDSEYsSUFBSSxDQUFDSSxhQUFMLENBQW1CRSxXQUFuQixDQUErQkwsWUFBL0I7RUFDSDtBQUNKLEMsQ0FFRDtBQUNBO0FBQ0E7QUFDQTs7O0FBQ08sTUFBTU0sZUFBZSxHQUFHLFFBQXhCLEMsQ0FDUDtBQUNBO0FBQ0E7Ozs7QUFDQSxTQUFT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