"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DEFAULT_THEME = void 0;
exports.enumerateThemes = enumerateThemes;
exports.findHighContrastTheme = findHighContrastTheme;
exports.findNonHighContrastTheme = findNonHighContrastTheme;
exports.getCustomTheme = getCustomTheme;
exports.getOrderedThemes = getOrderedThemes;
exports.isHighContrastTheme = isHighContrastTheme;
exports.setTheme = setTheme;

var _languageHandler = require("./languageHandler");

var _SettingsStore = _interopRequireDefault(require("./settings/SettingsStore"));

var _ThemeWatcher = _interopRequireDefault(require("./settings/watchers/ThemeWatcher"));

var _strings = require("./utils/strings");

/*
Copyright 2019 Michael Telatynski <7t3chguy@gmail.com>
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const DEFAULT_THEME = "light";
exports.DEFAULT_THEME = DEFAULT_THEME;
const HIGH_CONTRAST_THEMES = {
  "light": "light-high-contrast"
};

/**
 * Given a non-high-contrast theme, find the corresponding high-contrast one
 * if it exists, or return undefined if not.
 */
function findHighContrastTheme(theme) {
  return HIGH_CONTRAST_THEMES[theme];
}
/**
 * Given a high-contrast theme, find the corresponding non-high-contrast one
 * if it exists, or return undefined if not.
 */


function findNonHighContrastTheme(hcTheme) {
  for (const theme in HIGH_CONTRAST_THEMES) {
    if (HIGH_CONTRAST_THEMES[theme] === hcTheme) {
      return theme;
    }
  }
}
/**
 * Decide whether the supplied theme is high contrast.
 */


function isHighContrastTheme(theme) {
  return Object.values(HIGH_CONTRAST_THEMES).includes(theme);
}

function enumerateThemes() {
  const BUILTIN_THEMES = {
    "light": (0, _languageHandler._t)("Light"),
    "light-high-contrast": (0, _languageHandler._t)("Light high contrast"),
    "dark": (0, _languageHandler._t)("Dark")
  };

  const customThemes = _SettingsStore.default.getValue("custom_themes");

  const customThemeNames = {};

  for (const {
    name
  } of customThemes) {
    customThemeNames[`custom-${name}`] = name;
  }

  return Object.assign({}, customThemeNames, BUILTIN_THEMES);
}

function getOrderedThemes() {
  const themes = Object.entries(enumerateThemes()).map(p => ({
    id: p[0],
    name: p[1]
  })) // convert pairs to objects for code readability
  .filter(p => !isHighContrastTheme(p.id));
  const builtInThemes = themes.filter(p => !p.id.startsWith("custom-"));
  const customThemes = themes.filter(p => !builtInThemes.includes(p)).sort((a, b) => (0, _strings.compare)(a.name, b.name));
  return [...builtInThemes, ...customThemes];
}

function clearCustomTheme() {
  // remove all css variables, we assume these are there because of the custom theme
  const inlineStyleProps = Object.values(document.body.style);

  for (const prop of inlineStyleProps) {
    if (prop.startsWith("--")) {
      document.body.style.removeProperty(prop);
    }
  }

  const customFontFaceStyle = document.querySelector("head > style[title='custom-theme-font-faces']");

  if (customFontFaceStyle) {
    customFontFaceStyle.remove();
  }
}

const allowedFontFaceProps = ["font-display", "font-family", "font-stretch", "font-style", "font-weight", "font-variant", "font-feature-settings", "font-variation-settings", "src", "unicode-range"];

function generateCustomFontFaceCSS(faces) {
  return faces.map(face => {
    const src = face.src && face.src.map(srcElement => {
      let format;

      if (srcElement.format) {
        format = `format("${srcElement.format}")`;
      }

      if (srcElement.url) {
        return `url("${srcElement.url}") ${format}`;
      } else if (srcElement.local) {
        return `local("${srcElement.local}") ${format}`;
      }

      return "";
    }).join(", ");
    const props = Object.keys(face).filter(prop => allowedFontFaceProps.includes(prop));
    const body = props.map(prop => {
      let value;

      if (prop === "src") {
        value = src;
      } else if (prop === "font-family") {
        value = `"${face[prop]}"`;
      } else {
        value = face[prop];
      }

      return `${prop}: ${value}`;
    }).join(";");
    return `@font-face {${body}}`;
  }).join("\n");
}

function setCustomThemeVars(customTheme) {
  const {
    style
  } = document.body;

  function setCSSColorVariable(name, hexColor) {
    let doPct = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;
    style.setProperty(`--${name}`, hexColor);

    if (doPct) {
      // uses #rrggbbaa to define the color with alpha values at 0%, 15% and 50%
      style.setProperty(`--${name}-0pct`, hexColor + "00");
      style.setProperty(`--${name}-15pct`, hexColor + "26");
      style.setProperty(`--${name}-50pct`, hexColor + "7F");
    }
  }

  if (customTheme.colors) {
    for (const [name, value] of Object.entries(customTheme.colors)) {
      if (Array.isArray(value)) {
        for (let i = 0; i < value.length; i += 1) {
          setCSSColorVariable(`${name}_${i}`, value[i], false);
        }
      } else {
        setCSSColorVariable(name, value);
      }
    }
  }

  if (customTheme.fonts) {
    const {
      fonts
    } = customTheme;

    if (fonts.faces) {
      const css = generateCustomFontFaceCSS(fonts.faces);
      const style = document.createElement("style");
      style.setAttribute("title", "custom-theme-font-faces");
      style.setAttribute("type", "text/css");
      style.appendChild(document.createTextNode(css));
      document.head.appendChild(style);
    }

    if (fonts.general) {
      style.setProperty("--font-family", fonts.general);
    }

    if (fonts.monospace) {
      style.setProperty("--font-family-monospace", fonts.monospace);
    }
  }
}

function getCustomTheme(themeName) {
  // set css variables
  const customThemes = _SettingsStore.default.getValue("custom_themes");

  if (!customThemes) {
    throw new Error(`No custom themes set, can't set custom theme "${themeName}"`);
  }

  const customTheme = customThemes.find(t => t.name === themeName);

  if (!customTheme) {
    const knownNames = customThemes.map(t => t.name).join(", ");
    throw new Error(`Can't find custom theme "${themeName}", only know ${knownNames}`);
  }

  return customTheme;
}
/**
 * Called whenever someone changes the theme
 * Async function that returns once the theme has been set
 * (ie. the CSS has been loaded)
 *
 * @param {string} theme new theme
 */


async function setTheme(theme) {
  if (!theme) {
    const themeWatcher = new _ThemeWatcher.default();
    theme = themeWatcher.getEffectiveTheme();
  }

  clearCustomTheme();
  let stylesheetName = theme;

  if (theme.startsWith("custom-")) {
    const customTheme = getCustomTheme(theme.slice(7));
    stylesheetName = customTheme.is_dark ? "dark-custom" : "light-custom";
    setCustomThemeVars(customTheme);
  } // look for the stylesheet elements.
  // styleElements is a map from style name to HTMLLinkElement.


  const styleElements = Object.create(null);
  const themes = Array.from(document.querySelectorAll('[data-mx-theme]'));
  themes.forEach(theme => {
    styleElements[theme.attributes['data-mx-theme'].value.toLowerCase()] = theme;
  });

  if (!(stylesheetName in styleElements)) {
    throw new Error("Unknown theme " + stylesheetName);
  } // disable all of them first, then enable the one we want. Chrome only
  // bothers to do an update on a true->false transition, so this ensures
  // that we get exactly one update, at the right time.
  //
  // ^ This comment was true when we used to use alternative stylesheets
  // for the CSS.  Nowadays we just set them all as disabled in index.html
  // and enable them as needed.  It might be cleaner to disable them all
  // at the same time to prevent loading two themes simultaneously and
  // having them interact badly... but this causes a flash of unstyled app
  // which is even uglier.  So we don't.


  styleElements[stylesheetName].disabled = false;
  return new Promise(resolve => {
    const switchTheme = function () {
      // we re-enable our theme here just in case we raced with another
      // theme set request as per https://github.com/vector-im/element-web/issues/5601.
      // We could alternatively lock or similar to stop the race, but
      // this is probably good enough for now.
      styleElements[stylesheetName].disabled = false;
      Object.values(styleElements).forEach(a => {
        if (a == styleElements[stylesheetName]) return;
        a.disabled = true;
      });
      const bodyStyles = global.getComputedStyle(document.body);

      if (bodyStyles.backgroundColor) {
        const metaElement = document.querySelector('meta[name="theme-color"]');
        metaElement.content = bodyStyles.backgroundColor;
      }

      resolve();
    }; // turns out that Firefox preloads the CSS for link elements with
    // the disabled attribute, but Chrome doesn't.


    let cssLoaded = false;

    styleElements[stylesheetName].onload = () => {
      switchTheme();
    };

    for (let i = 0; i < document.styleSheets.length; i++) {
      const ss = document.styleSheets[i];

      if (ss && ss.href === styleElements[stylesheetName].href) {
        cssLoaded = true;
        break;
      }
    }

    if (cssLoaded) {
      styleElements[stylesheetName].onload = undefined;
      switchTheme();
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJERUZBVUxUX1RIRU1FIiwiSElHSF9DT05UUkFTVF9USEVNRVMiLCJmaW5kSGlnaENvbnRyYXN0VGhlbWUiLCJ0aGVtZSIsImZpbmROb25IaWdoQ29udHJhc3RUaGVtZSIsImhjVGhlbWUiLCJpc0hpZ2hDb250cmFzdFRoZW1lIiwiT2JqZWN0IiwidmFsdWVzIiwiaW5jbHVkZXMiLCJlbnVtZXJhdGVUaGVtZXMiLCJCVUlMVElOX1RIRU1FUyIsIl90IiwiY3VzdG9tVGhlbWVzIiwiU2V0dGluZ3NTdG9yZSIsImdldFZhbHVlIiwiY3VzdG9tVGhlbWVOYW1lcyIsIm5hbWUiLCJhc3NpZ24iLCJnZXRPcmRlcmVkVGhlbWVzIiwidGhlbWVzIiwiZW50cmllcyIsIm1hcCIsInAiLCJpZCIsImZpbHRlciIsImJ1aWx0SW5UaGVtZXMiLCJzdGFydHNXaXRoIiwic29ydCIsImEiLCJiIiwiY29tcGFyZSIsImNsZWFyQ3VzdG9tVGhlbWUiLCJpbmxpbmVTdHlsZVByb3BzIiwiZG9jdW1lbnQiLCJib2R5Iiwic3R5bGUiLCJwcm9wIiwicmVtb3ZlUHJvcGVydHkiLCJjdXN0b21Gb250RmFjZVN0eWxlIiwicXVlcnlTZWxlY3RvciIsInJlbW92ZSIsImFsbG93ZWRGb250RmFjZVByb3BzIiwiZ2VuZXJhdGVDdXN0b21Gb250RmFjZUNTUyIsImZhY2VzIiwiZmFjZSIsInNyYyIsInNyY0VsZW1lbnQiLCJmb3JtYXQiLCJ1cmwiLCJsb2NhbCIsImpvaW4iLCJwcm9wcyIsImtleXMiLCJ2YWx1ZSIsInNldEN1c3RvbVRoZW1lVmFycyIsImN1c3RvbVRoZW1lIiwic2V0Q1NTQ29sb3JWYXJpYWJsZSIsImhleENvbG9yIiwiZG9QY3QiLCJzZXRQcm9wZXJ0eSIsImNvbG9ycyIsIkFycmF5IiwiaXNBcnJheSIsImkiLCJsZW5ndGgiLCJmb250cyIsImNzcyIsImNyZWF0ZUVsZW1lbnQiLCJzZXRBdHRyaWJ1dGUiLCJhcHBlbmRDaGlsZCIsImNyZWF0ZVRleHROb2RlIiwiaGVhZCIsImdlbmVyYWwiLCJtb25vc3BhY2UiLCJnZXRDdXN0b21UaGVtZSIsInRoZW1lTmFtZSIsIkVycm9yIiwiZmluZCIsInQiLCJrbm93bk5hbWVzIiwic2V0VGhlbWUiLCJ0aGVtZVdhdGNoZXIiLCJUaGVtZVdhdGNoZXIiLCJnZXRFZmZlY3RpdmVUaGVtZSIsInN0eWxlc2hlZXROYW1lIiwic2xpY2UiLCJpc19kYXJrIiwic3R5bGVFbGVtZW50cyIsImNyZWF0ZSIsImZyb20iLCJxdWVyeVNlbGVjdG9yQWxsIiwiZm9yRWFjaCIsImF0dHJpYnV0ZXMiLCJ0b0xvd2VyQ2FzZSIsImRpc2FibGVkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzd2l0Y2hUaGVtZSIsImJvZHlTdHlsZXMiLCJnbG9iYWwiLCJnZXRDb21wdXRlZFN0eWxlIiwiYmFja2dyb3VuZENvbG9yIiwibWV0YUVsZW1lbnQiLCJjb250ZW50IiwiY3NzTG9hZGVkIiwib25sb2FkIiwic3R5bGVTaGVldHMiLCJzcyIsImhyZWYiLCJ1bmRlZmluZWQiXSwic291cmNlcyI6WyIuLi9zcmMvdGhlbWUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE5IE1pY2hhZWwgVGVsYXR5bnNraSA8N3QzY2hndXlAZ21haWwuY29tPlxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IFNldHRpbmdzU3RvcmUgZnJvbSBcIi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IFRoZW1lV2F0Y2hlciBmcm9tIFwiLi9zZXR0aW5ncy93YXRjaGVycy9UaGVtZVdhdGNoZXJcIjtcbmltcG9ydCB7IGNvbXBhcmUgfSBmcm9tIFwiLi91dGlscy9zdHJpbmdzXCI7XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1RIRU1FID0gXCJsaWdodFwiO1xuY29uc3QgSElHSF9DT05UUkFTVF9USEVNRVMgPSB7XG4gICAgXCJsaWdodFwiOiBcImxpZ2h0LWhpZ2gtY29udHJhc3RcIixcbn07XG5cbmludGVyZmFjZSBJRm9udEZhY2VzIHtcbiAgICBzcmM6IHtcbiAgICAgICAgZm9ybWF0OiBzdHJpbmc7XG4gICAgICAgIHVybDogc3RyaW5nO1xuICAgICAgICBsb2NhbDogc3RyaW5nO1xuICAgIH1bXTtcbn1cblxuaW50ZXJmYWNlIElDdXN0b21UaGVtZSB7XG4gICAgY29sb3JzOiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICB9O1xuICAgIGZvbnRzOiB7XG4gICAgICAgIGZhY2VzOiBJRm9udEZhY2VzW107XG4gICAgICAgIGdlbmVyYWw6IHN0cmluZztcbiAgICAgICAgbW9ub3NwYWNlOiBzdHJpbmc7XG4gICAgfTtcbiAgICBpc19kYXJrPzogYm9vbGVhbjsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcbn1cblxuLyoqXG4gKiBHaXZlbiBhIG5vbi1oaWdoLWNvbnRyYXN0IHRoZW1lLCBmaW5kIHRoZSBjb3JyZXNwb25kaW5nIGhpZ2gtY29udHJhc3Qgb25lXG4gKiBpZiBpdCBleGlzdHMsIG9yIHJldHVybiB1bmRlZmluZWQgaWYgbm90LlxuICovXG5leHBvcnQgZnVuY3Rpb24gZmluZEhpZ2hDb250cmFzdFRoZW1lKHRoZW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gSElHSF9DT05UUkFTVF9USEVNRVNbdGhlbWVdO1xufVxuXG4vKipcbiAqIEdpdmVuIGEgaGlnaC1jb250cmFzdCB0aGVtZSwgZmluZCB0aGUgY29ycmVzcG9uZGluZyBub24taGlnaC1jb250cmFzdCBvbmVcbiAqIGlmIGl0IGV4aXN0cywgb3IgcmV0dXJuIHVuZGVmaW5lZCBpZiBub3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmaW5kTm9uSGlnaENvbnRyYXN0VGhlbWUoaGNUaGVtZTogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCB0aGVtZSBpbiBISUdIX0NPTlRSQVNUX1RIRU1FUykge1xuICAgICAgICBpZiAoSElHSF9DT05UUkFTVF9USEVNRVNbdGhlbWVdID09PSBoY1RoZW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhlbWU7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogRGVjaWRlIHdoZXRoZXIgdGhlIHN1cHBsaWVkIHRoZW1lIGlzIGhpZ2ggY29udHJhc3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0hpZ2hDb250cmFzdFRoZW1lKHRoZW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhISUdIX0NPTlRSQVNUX1RIRU1FUykuaW5jbHVkZXModGhlbWUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW51bWVyYXRlVGhlbWVzKCk6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9IHtcbiAgICBjb25zdCBCVUlMVElOX1RIRU1FUyA9IHtcbiAgICAgICAgXCJsaWdodFwiOiBfdChcIkxpZ2h0XCIpLFxuICAgICAgICBcImxpZ2h0LWhpZ2gtY29udHJhc3RcIjogX3QoXCJMaWdodCBoaWdoIGNvbnRyYXN0XCIpLFxuICAgICAgICBcImRhcmtcIjogX3QoXCJEYXJrXCIpLFxuICAgIH07XG4gICAgY29uc3QgY3VzdG9tVGhlbWVzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImN1c3RvbV90aGVtZXNcIik7XG4gICAgY29uc3QgY3VzdG9tVGhlbWVOYW1lcyA9IHt9O1xuICAgIGZvciAoY29uc3QgeyBuYW1lIH0gb2YgY3VzdG9tVGhlbWVzKSB7XG4gICAgICAgIGN1c3RvbVRoZW1lTmFtZXNbYGN1c3RvbS0ke25hbWV9YF0gPSBuYW1lO1xuICAgIH1cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgY3VzdG9tVGhlbWVOYW1lcywgQlVJTFRJTl9USEVNRVMpO1xufVxuXG5pbnRlcmZhY2UgSVRoZW1lIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9yZGVyZWRUaGVtZXMoKTogSVRoZW1lW10ge1xuICAgIGNvbnN0IHRoZW1lcyA9IE9iamVjdC5lbnRyaWVzKGVudW1lcmF0ZVRoZW1lcygpKVxuICAgICAgICAubWFwKHAgPT4gKHsgaWQ6IHBbMF0sIG5hbWU6IHBbMV0gfSkpIC8vIGNvbnZlcnQgcGFpcnMgdG8gb2JqZWN0cyBmb3IgY29kZSByZWFkYWJpbGl0eVxuICAgICAgICAuZmlsdGVyKHAgPT4gIWlzSGlnaENvbnRyYXN0VGhlbWUocC5pZCkpO1xuICAgIGNvbnN0IGJ1aWx0SW5UaGVtZXMgPSB0aGVtZXMuZmlsdGVyKHAgPT4gIXAuaWQuc3RhcnRzV2l0aChcImN1c3RvbS1cIikpO1xuICAgIGNvbnN0IGN1c3RvbVRoZW1lcyA9IHRoZW1lcy5maWx0ZXIocCA9PiAhYnVpbHRJblRoZW1lcy5pbmNsdWRlcyhwKSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IGNvbXBhcmUoYS5uYW1lLCBiLm5hbWUpKTtcbiAgICByZXR1cm4gWy4uLmJ1aWx0SW5UaGVtZXMsIC4uLmN1c3RvbVRoZW1lc107XG59XG5cbmZ1bmN0aW9uIGNsZWFyQ3VzdG9tVGhlbWUoKTogdm9pZCB7XG4gICAgLy8gcmVtb3ZlIGFsbCBjc3MgdmFyaWFibGVzLCB3ZSBhc3N1bWUgdGhlc2UgYXJlIHRoZXJlIGJlY2F1c2Ugb2YgdGhlIGN1c3RvbSB0aGVtZVxuICAgIGNvbnN0IGlubGluZVN0eWxlUHJvcHMgPSBPYmplY3QudmFsdWVzKGRvY3VtZW50LmJvZHkuc3R5bGUpO1xuICAgIGZvciAoY29uc3QgcHJvcCBvZiBpbmxpbmVTdHlsZVByb3BzKSB7XG4gICAgICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoXCItLVwiKSkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5yZW1vdmVQcm9wZXJ0eShwcm9wKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBjdXN0b21Gb250RmFjZVN0eWxlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImhlYWQgPiBzdHlsZVt0aXRsZT0nY3VzdG9tLXRoZW1lLWZvbnQtZmFjZXMnXVwiKTtcbiAgICBpZiAoY3VzdG9tRm9udEZhY2VTdHlsZSkge1xuICAgICAgICBjdXN0b21Gb250RmFjZVN0eWxlLnJlbW92ZSgpO1xuICAgIH1cbn1cblxuY29uc3QgYWxsb3dlZEZvbnRGYWNlUHJvcHMgPSBbXG4gICAgXCJmb250LWRpc3BsYXlcIixcbiAgICBcImZvbnQtZmFtaWx5XCIsXG4gICAgXCJmb250LXN0cmV0Y2hcIixcbiAgICBcImZvbnQtc3R5bGVcIixcbiAgICBcImZvbnQtd2VpZ2h0XCIsXG4gICAgXCJmb250LXZhcmlhbnRcIixcbiAgICBcImZvbnQtZmVhdHVyZS1zZXR0aW5nc1wiLFxuICAgIFwiZm9udC12YXJpYXRpb24tc2V0dGluZ3NcIixcbiAgICBcInNyY1wiLFxuICAgIFwidW5pY29kZS1yYW5nZVwiLFxuXTtcblxuZnVuY3Rpb24gZ2VuZXJhdGVDdXN0b21Gb250RmFjZUNTUyhmYWNlczogSUZvbnRGYWNlc1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gZmFjZXMubWFwKGZhY2UgPT4ge1xuICAgICAgICBjb25zdCBzcmMgPSBmYWNlLnNyYyAmJiBmYWNlLnNyYy5tYXAoc3JjRWxlbWVudCA9PiB7XG4gICAgICAgICAgICBsZXQgZm9ybWF0O1xuICAgICAgICAgICAgaWYgKHNyY0VsZW1lbnQuZm9ybWF0KSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gYGZvcm1hdChcIiR7c3JjRWxlbWVudC5mb3JtYXR9XCIpYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzcmNFbGVtZW50LnVybCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBgdXJsKFwiJHtzcmNFbGVtZW50LnVybH1cIikgJHtmb3JtYXR9YDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3JjRWxlbWVudC5sb2NhbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBgbG9jYWwoXCIke3NyY0VsZW1lbnQubG9jYWx9XCIpICR7Zm9ybWF0fWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgfSkuam9pbihcIiwgXCIpO1xuICAgICAgICBjb25zdCBwcm9wcyA9IE9iamVjdC5rZXlzKGZhY2UpLmZpbHRlcihwcm9wID0+IGFsbG93ZWRGb250RmFjZVByb3BzLmluY2x1ZGVzKHByb3ApKTtcbiAgICAgICAgY29uc3QgYm9keSA9IHByb3BzLm1hcChwcm9wID0+IHtcbiAgICAgICAgICAgIGxldCB2YWx1ZTtcbiAgICAgICAgICAgIGlmIChwcm9wID09PSBcInNyY1wiKSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBzcmM7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHByb3AgPT09IFwiZm9udC1mYW1pbHlcIikge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gYFwiJHtmYWNlW3Byb3BdfVwiYDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBmYWNlW3Byb3BdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGAke3Byb3B9OiAke3ZhbHVlfWA7XG4gICAgICAgIH0pLmpvaW4oXCI7XCIpO1xuICAgICAgICByZXR1cm4gYEBmb250LWZhY2UgeyR7Ym9keX19YDtcbiAgICB9KS5qb2luKFwiXFxuXCIpO1xufVxuXG5mdW5jdGlvbiBzZXRDdXN0b21UaGVtZVZhcnMoY3VzdG9tVGhlbWU6IElDdXN0b21UaGVtZSk6IHZvaWQge1xuICAgIGNvbnN0IHsgc3R5bGUgfSA9IGRvY3VtZW50LmJvZHk7XG5cbiAgICBmdW5jdGlvbiBzZXRDU1NDb2xvclZhcmlhYmxlKG5hbWUsIGhleENvbG9yLCBkb1BjdCA9IHRydWUpIHtcbiAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoYC0tJHtuYW1lfWAsIGhleENvbG9yKTtcbiAgICAgICAgaWYgKGRvUGN0KSB7XG4gICAgICAgICAgICAvLyB1c2VzICNycmdnYmJhYSB0byBkZWZpbmUgdGhlIGNvbG9yIHdpdGggYWxwaGEgdmFsdWVzIGF0IDAlLCAxNSUgYW5kIDUwJVxuICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoYC0tJHtuYW1lfS0wcGN0YCwgaGV4Q29sb3IgKyBcIjAwXCIpO1xuICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoYC0tJHtuYW1lfS0xNXBjdGAsIGhleENvbG9yICsgXCIyNlwiKTtcbiAgICAgICAgICAgIHN0eWxlLnNldFByb3BlcnR5KGAtLSR7bmFtZX0tNTBwY3RgLCBoZXhDb2xvciArIFwiN0ZcIik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY3VzdG9tVGhlbWUuY29sb3JzKSB7XG4gICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjdXN0b21UaGVtZS5jb2xvcnMpKSB7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldENTU0NvbG9yVmFyaWFibGUoYCR7bmFtZX1fJHtpfWAsIHZhbHVlW2ldLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZXRDU1NDb2xvclZhcmlhYmxlKG5hbWUsIHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoY3VzdG9tVGhlbWUuZm9udHMpIHtcbiAgICAgICAgY29uc3QgeyBmb250cyB9ID0gY3VzdG9tVGhlbWU7XG4gICAgICAgIGlmIChmb250cy5mYWNlcykge1xuICAgICAgICAgICAgY29uc3QgY3NzID0gZ2VuZXJhdGVDdXN0b21Gb250RmFjZUNTUyhmb250cy5mYWNlcyk7XG4gICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzdHlsZVwiKTtcbiAgICAgICAgICAgIHN0eWxlLnNldEF0dHJpYnV0ZShcInRpdGxlXCIsIFwiY3VzdG9tLXRoZW1lLWZvbnQtZmFjZXNcIik7XG4gICAgICAgICAgICBzdHlsZS5zZXRBdHRyaWJ1dGUoXCJ0eXBlXCIsIFwidGV4dC9jc3NcIik7XG4gICAgICAgICAgICBzdHlsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3MpKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmb250cy5nZW5lcmFsKSB7XG4gICAgICAgICAgICBzdHlsZS5zZXRQcm9wZXJ0eShcIi0tZm9udC1mYW1pbHlcIiwgZm9udHMuZ2VuZXJhbCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZvbnRzLm1vbm9zcGFjZSkge1xuICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoXCItLWZvbnQtZmFtaWx5LW1vbm9zcGFjZVwiLCBmb250cy5tb25vc3BhY2UpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q3VzdG9tVGhlbWUodGhlbWVOYW1lOiBzdHJpbmcpOiBJQ3VzdG9tVGhlbWUge1xuICAgIC8vIHNldCBjc3MgdmFyaWFibGVzXG4gICAgY29uc3QgY3VzdG9tVGhlbWVzID0gU2V0dGluZ3NTdG9yZS5nZXRWYWx1ZShcImN1c3RvbV90aGVtZXNcIik7XG4gICAgaWYgKCFjdXN0b21UaGVtZXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBjdXN0b20gdGhlbWVzIHNldCwgY2FuJ3Qgc2V0IGN1c3RvbSB0aGVtZSBcIiR7dGhlbWVOYW1lfVwiYCk7XG4gICAgfVxuICAgIGNvbnN0IGN1c3RvbVRoZW1lID0gY3VzdG9tVGhlbWVzLmZpbmQodCA9PiB0Lm5hbWUgPT09IHRoZW1lTmFtZSk7XG4gICAgaWYgKCFjdXN0b21UaGVtZSkge1xuICAgICAgICBjb25zdCBrbm93bk5hbWVzID0gY3VzdG9tVGhlbWVzLm1hcCh0ID0+IHQubmFtZSkuam9pbihcIiwgXCIpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGZpbmQgY3VzdG9tIHRoZW1lIFwiJHt0aGVtZU5hbWV9XCIsIG9ubHkga25vdyAke2tub3duTmFtZXN9YCk7XG4gICAgfVxuICAgIHJldHVybiBjdXN0b21UaGVtZTtcbn1cblxuLyoqXG4gKiBDYWxsZWQgd2hlbmV2ZXIgc29tZW9uZSBjaGFuZ2VzIHRoZSB0aGVtZVxuICogQXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIG9uY2UgdGhlIHRoZW1lIGhhcyBiZWVuIHNldFxuICogKGllLiB0aGUgQ1NTIGhhcyBiZWVuIGxvYWRlZClcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gdGhlbWUgbmV3IHRoZW1lXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXRUaGVtZSh0aGVtZT86IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhlbWUpIHtcbiAgICAgICAgY29uc3QgdGhlbWVXYXRjaGVyID0gbmV3IFRoZW1lV2F0Y2hlcigpO1xuICAgICAgICB0aGVtZSA9IHRoZW1lV2F0Y2hlci5nZXRFZmZlY3RpdmVUaGVtZSgpO1xuICAgIH1cbiAgICBjbGVhckN1c3RvbVRoZW1lKCk7XG4gICAgbGV0IHN0eWxlc2hlZXROYW1lID0gdGhlbWU7XG4gICAgaWYgKHRoZW1lLnN0YXJ0c1dpdGgoXCJjdXN0b20tXCIpKSB7XG4gICAgICAgIGNvbnN0IGN1c3RvbVRoZW1lID0gZ2V0Q3VzdG9tVGhlbWUodGhlbWUuc2xpY2UoNykpO1xuICAgICAgICBzdHlsZXNoZWV0TmFtZSA9IGN1c3RvbVRoZW1lLmlzX2RhcmsgPyBcImRhcmstY3VzdG9tXCIgOiBcImxpZ2h0LWN1c3RvbVwiO1xuICAgICAgICBzZXRDdXN0b21UaGVtZVZhcnMoY3VzdG9tVGhlbWUpO1xuICAgIH1cblxuICAgIC8vIGxvb2sgZm9yIHRoZSBzdHlsZXNoZWV0IGVsZW1lbnRzLlxuICAgIC8vIHN0eWxlRWxlbWVudHMgaXMgYSBtYXAgZnJvbSBzdHlsZSBuYW1lIHRvIEhUTUxMaW5rRWxlbWVudC5cbiAgICBjb25zdCBzdHlsZUVsZW1lbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBjb25zdCB0aGVtZXMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLW14LXRoZW1lXScpKTtcbiAgICB0aGVtZXMuZm9yRWFjaCh0aGVtZSA9PiB7XG4gICAgICAgIHN0eWxlRWxlbWVudHNbdGhlbWUuYXR0cmlidXRlc1snZGF0YS1teC10aGVtZSddLnZhbHVlLnRvTG93ZXJDYXNlKCldID0gdGhlbWU7XG4gICAgfSk7XG5cbiAgICBpZiAoIShzdHlsZXNoZWV0TmFtZSBpbiBzdHlsZUVsZW1lbnRzKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmtub3duIHRoZW1lIFwiICsgc3R5bGVzaGVldE5hbWUpO1xuICAgIH1cblxuICAgIC8vIGRpc2FibGUgYWxsIG9mIHRoZW0gZmlyc3QsIHRoZW4gZW5hYmxlIHRoZSBvbmUgd2Ugd2FudC4gQ2hyb21lIG9ubHlcbiAgICAvLyBib3RoZXJzIHRvIGRvIGFuIHVwZGF0ZSBvbiBhIHRydWUtPmZhbHNlIHRyYW5zaXRpb24sIHNvIHRoaXMgZW5zdXJlc1xuICAgIC8vIHRoYXQgd2UgZ2V0IGV4YWN0bHkgb25lIHVwZGF0ZSwgYXQgdGhlIHJpZ2h0IHRpbWUuXG4gICAgLy9cbiAgICAvLyBeIFRoaXMgY29tbWVudCB3YXMgdHJ1ZSB3aGVuIHdlIHVzZWQgdG8gdXNlIGFsdGVybmF0aXZlIHN0eWxlc2hlZXRzXG4gICAgLy8gZm9yIHRoZSBDU1MuICBOb3dhZGF5cyB3ZSBqdXN0IHNldCB0aGVtIGFsbCBhcyBkaXNhYmxlZCBpbiBpbmRleC5odG1sXG4gICAgLy8gYW5kIGVuYWJsZSB0aGVtIGFzIG5lZWRlZC4gIEl0IG1pZ2h0IGJlIGNsZWFuZXIgdG8gZGlzYWJsZSB0aGVtIGFsbFxuICAgIC8vIGF0IHRoZSBzYW1lIHRpbWUgdG8gcHJldmVudCBsb2FkaW5nIHR3byB0aGVtZXMgc2ltdWx0YW5lb3VzbHkgYW5kXG4gICAgLy8gaGF2aW5nIHRoZW0gaW50ZXJhY3QgYmFkbHkuLi4gYnV0IHRoaXMgY2F1c2VzIGEgZmxhc2ggb2YgdW5zdHlsZWQgYXBwXG4gICAgLy8gd2hpY2ggaXMgZXZlbiB1Z2xpZXIuICBTbyB3ZSBkb24ndC5cblxuICAgIHN0eWxlRWxlbWVudHNbc3R5bGVzaGVldE5hbWVdLmRpc2FibGVkID0gZmFsc2U7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgY29uc3Qgc3dpdGNoVGhlbWUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIC8vIHdlIHJlLWVuYWJsZSBvdXIgdGhlbWUgaGVyZSBqdXN0IGluIGNhc2Ugd2UgcmFjZWQgd2l0aCBhbm90aGVyXG4gICAgICAgICAgICAvLyB0aGVtZSBzZXQgcmVxdWVzdCBhcyBwZXIgaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9lbGVtZW50LXdlYi9pc3N1ZXMvNTYwMS5cbiAgICAgICAgICAgIC8vIFdlIGNvdWxkIGFsdGVybmF0aXZlbHkgbG9jayBvciBzaW1pbGFyIHRvIHN0b3AgdGhlIHJhY2UsIGJ1dFxuICAgICAgICAgICAgLy8gdGhpcyBpcyBwcm9iYWJseSBnb29kIGVub3VnaCBmb3Igbm93LlxuICAgICAgICAgICAgc3R5bGVFbGVtZW50c1tzdHlsZXNoZWV0TmFtZV0uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoc3R5bGVFbGVtZW50cykuZm9yRWFjaCgoYTogSFRNTFN0eWxlRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhID09IHN0eWxlRWxlbWVudHNbc3R5bGVzaGVldE5hbWVdKSByZXR1cm47XG4gICAgICAgICAgICAgICAgYS5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IGJvZHlTdHlsZXMgPSBnbG9iYWwuZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5ib2R5KTtcbiAgICAgICAgICAgIGlmIChib2R5U3R5bGVzLmJhY2tncm91bmRDb2xvcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFFbGVtZW50OiBIVE1MTWV0YUVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdtZXRhW25hbWU9XCJ0aGVtZS1jb2xvclwiXScpO1xuICAgICAgICAgICAgICAgIG1ldGFFbGVtZW50LmNvbnRlbnQgPSBib2R5U3R5bGVzLmJhY2tncm91bmRDb2xvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyB0dXJucyBvdXQgdGhhdCBGaXJlZm94IHByZWxvYWRzIHRoZSBDU1MgZm9yIGxpbmsgZWxlbWVudHMgd2l0aFxuICAgICAgICAvLyB0aGUgZGlzYWJsZWQgYXR0cmlidXRlLCBidXQgQ2hyb21lIGRvZXNuJ3QuXG5cbiAgICAgICAgbGV0IGNzc0xvYWRlZCA9IGZhbHNlO1xuXG4gICAgICAgIHN0eWxlRWxlbWVudHNbc3R5bGVzaGVldE5hbWVdLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICAgIHN3aXRjaFRoZW1lKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkb2N1bWVudC5zdHlsZVNoZWV0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3Qgc3MgPSBkb2N1bWVudC5zdHlsZVNoZWV0c1tpXTtcbiAgICAgICAgICAgIGlmIChzcyAmJiBzcy5ocmVmID09PSBzdHlsZUVsZW1lbnRzW3N0eWxlc2hlZXROYW1lXS5ocmVmKSB7XG4gICAgICAgICAgICAgICAgY3NzTG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjc3NMb2FkZWQpIHtcbiAgICAgICAgICAgIHN0eWxlRWxlbWVudHNbc3R5bGVzaGVldE5hbWVdLm9ubG9hZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHN3aXRjaFRoZW1lKCk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFwQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFPTyxNQUFNQSxhQUFhLEdBQUcsT0FBdEI7O0FBQ1AsTUFBTUMsb0JBQW9CLEdBQUc7RUFDekIsU0FBUztBQURnQixDQUE3Qjs7QUF3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDTyxTQUFTQyxxQkFBVCxDQUErQkMsS0FB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