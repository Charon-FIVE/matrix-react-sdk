"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.IdentityProviderBrand = void 0;
exports.sendLoginRequest = sendLoginRequest;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _matrix = require("matrix-js-sdk/src/matrix");

var _logger = require("matrix-js-sdk/src/logger");

var _Security = _interopRequireDefault(require("./customisations/Security"));

/*
Copyright 2015-2021 The Matrix.org Foundation C.I.C.
Copyright 2019 Michael Telatynski <7t3chguy@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// @ts-ignore - XXX: tsc doesn't like this: our js-sdk imports are complex so this isn't surprising
let IdentityProviderBrand;
exports.IdentityProviderBrand = IdentityProviderBrand;

(function (IdentityProviderBrand) {
  IdentityProviderBrand["Gitlab"] = "gitlab";
  IdentityProviderBrand["Github"] = "github";
  IdentityProviderBrand["Apple"] = "apple";
  IdentityProviderBrand["Google"] = "google";
  IdentityProviderBrand["Facebook"] = "facebook";
  IdentityProviderBrand["Twitter"] = "twitter";
})(IdentityProviderBrand || (exports.IdentityProviderBrand = IdentityProviderBrand = {}));

/* eslint-enable camelcase */
class Login {
  // TODO: Flows need a type in JS SDK
  constructor(hsUrl, isUrl, fallbackHsUrl, opts) {
    (0, _defineProperty2.default)(this, "hsUrl", void 0);
    (0, _defineProperty2.default)(this, "isUrl", void 0);
    (0, _defineProperty2.default)(this, "fallbackHsUrl", void 0);
    (0, _defineProperty2.default)(this, "flows", void 0);
    (0, _defineProperty2.default)(this, "defaultDeviceDisplayName", void 0);
    (0, _defineProperty2.default)(this, "tempClient", void 0);
    this.hsUrl = hsUrl;
    this.isUrl = isUrl;
    this.fallbackHsUrl = fallbackHsUrl;
    this.flows = [];
    this.defaultDeviceDisplayName = opts.defaultDeviceDisplayName;
    this.tempClient = null; // memoize
  }

  getHomeserverUrl() {
    return this.hsUrl;
  }

  getIdentityServerUrl() {
    return this.isUrl;
  }

  setHomeserverUrl(hsUrl) {
    this.tempClient = null; // clear memoization

    this.hsUrl = hsUrl;
  }

  setIdentityServerUrl(isUrl) {
    this.tempClient = null; // clear memoization

    this.isUrl = isUrl;
  }
  /**
   * Get a temporary MatrixClient, which can be used for login or register
   * requests.
   * @returns {MatrixClient}
   */


  createTemporaryClient() {
    if (this.tempClient) return this.tempClient; // use memoization

    return this.tempClient = (0, _matrix.createClient)({
      baseUrl: this.hsUrl,
      idBaseUrl: this.isUrl
    });
  }

  async getFlows() {
    const client = this.createTemporaryClient();
    const {
      flows
    } = await client.loginFlows();
    this.flows = flows;
    return this.flows;
  }

  loginViaPassword(username, phoneCountry, phoneNumber, password) {
    const isEmail = username.indexOf("@") > 0;
    let identifier;

    if (phoneCountry && phoneNumber) {
      identifier = {
        type: 'm.id.phone',
        country: phoneCountry,
        phone: phoneNumber,
        // XXX: Synapse historically wanted `number` and not `phone`
        number: phoneNumber
      };
    } else if (isEmail) {
      identifier = {
        type: 'm.id.thirdparty',
        medium: 'email',
        address: username
      };
    } else {
      identifier = {
        type: 'm.id.user',
        user: username
      };
    }

    const loginParams = {
      password,
      identifier,
      initial_device_display_name: this.defaultDeviceDisplayName
    };

    const tryFallbackHs = originalError => {
      return sendLoginRequest(this.fallbackHsUrl, this.isUrl, 'm.login.password', loginParams).catch(fallbackError => {
        _logger.logger.log("fallback HS login failed", fallbackError); // throw the original error


        throw originalError;
      });
    };

    let originalLoginError = null;
    return sendLoginRequest(this.hsUrl, this.isUrl, 'm.login.password', loginParams).catch(error => {
      originalLoginError = error;

      if (error.httpStatus === 403) {
        if (this.fallbackHsUrl) {
          return tryFallbackHs(originalLoginError);
        }
      }

      throw originalLoginError;
    }).catch(error => {
      _logger.logger.log("Login failed", error);

      throw error;
    });
  }

}
/**
 * Send a login request to the given server, and format the response
 * as a MatrixClientCreds
 *
 * @param {string} hsUrl   the base url of the Homeserver used to log in.
 * @param {string} isUrl   the base url of the default identity server
 * @param {string} loginType the type of login to do
 * @param {ILoginParams} loginParams the parameters for the login
 *
 * @returns {MatrixClientCreds}
 */


exports.default = Login;

async function sendLoginRequest(hsUrl, isUrl, loginType, loginParams) {
  const client = (0, _matrix.createClient)({
    baseUrl: hsUrl,
    idBaseUrl: isUrl
  });
  const data = await client.login(loginType, loginParams);
  const wellknown = data.well_known;

  if (wellknown) {
    if (wellknown["m.homeserver"] && wellknown["m.homeserver"]["base_url"]) {
      hsUrl = wellknown["m.homeserver"]["base_url"];

      _logger.logger.log(`Overrode homeserver setting with ${hsUrl} from login response`);
    }

    if (wellknown["m.identity_server"] && wellknown["m.identity_server"]["base_url"]) {
      // TODO: should we prompt here?
      isUrl = wellknown["m.identity_server"]["base_url"];

      _logger.logger.log(`Overrode IS setting with ${isUrl} from login response`);
    }
  }

  const creds = {
    homeserverUrl: hsUrl,
    identityServerUrl: isUrl,
    userId: data.user_id,
    deviceId: data.device_id,
    accessToken: data.access_token
  };
  _Security.default.examineLoginResponse?.(data, creds);
  return creds;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJJZGVudGl0eVByb3ZpZGVyQnJhbmQiLCJMb2dpbiIsImNvbnN0cnVjdG9yIiwiaHNVcmwiLCJpc1VybCIsImZhbGxiYWNrSHNVcmwiLCJvcHRzIiwiZmxvd3MiLCJkZWZhdWx0RGV2aWNlRGlzcGxheU5hbWUiLCJ0ZW1wQ2xpZW50IiwiZ2V0SG9tZXNlcnZlclVybCIsImdldElkZW50aXR5U2VydmVyVXJsIiwic2V0SG9tZXNlcnZlclVybCIsInNldElkZW50aXR5U2VydmVyVXJsIiwiY3JlYXRlVGVtcG9yYXJ5Q2xpZW50IiwiY3JlYXRlQ2xpZW50IiwiYmFzZVVybCIsImlkQmFzZVVybCIsImdldEZsb3dzIiwiY2xpZW50IiwibG9naW5GbG93cyIsImxvZ2luVmlhUGFzc3dvcmQiLCJ1c2VybmFtZSIsInBob25lQ291bnRyeSIsInBob25lTnVtYmVyIiwicGFzc3dvcmQiLCJpc0VtYWlsIiwiaW5kZXhPZiIsImlkZW50aWZpZXIiLCJ0eXBlIiwiY291bnRyeSIsInBob25lIiwibnVtYmVyIiwibWVkaXVtIiwiYWRkcmVzcyIsInVzZXIiLCJsb2dpblBhcmFtcyIsImluaXRpYWxfZGV2aWNlX2Rpc3BsYXlfbmFtZSIsInRyeUZhbGxiYWNrSHMiLCJvcmlnaW5hbEVycm9yIiwic2VuZExvZ2luUmVxdWVzdCIsImNhdGNoIiwiZmFsbGJhY2tFcnJvciIsImxvZ2dlciIsImxvZyIsIm9yaWdpbmFsTG9naW5FcnJvciIsImVycm9yIiwiaHR0cFN0YXR1cyIsImxvZ2luVHlwZSIsImRhdGEiLCJsb2dpbiIsIndlbGxrbm93biIsIndlbGxfa25vd24iLCJjcmVkcyIsImhvbWVzZXJ2ZXJVcmwiLCJpZGVudGl0eVNlcnZlclVybCIsInVzZXJJZCIsInVzZXJfaWQiLCJkZXZpY2VJZCIsImRldmljZV9pZCIsImFjY2Vzc1Rva2VuIiwiYWNjZXNzX3Rva2VuIiwiU2VjdXJpdHlDdXN0b21pc2F0aW9ucyIsImV4YW1pbmVMb2dpblJlc3BvbnNlIl0sInNvdXJjZXMiOlsiLi4vc3JjL0xvZ2luLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNS0yMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5Db3B5cmlnaHQgMjAxOSBNaWNoYWVsIFRlbGF0eW5za2kgPDd0M2NoZ3V5QGdtYWlsLmNvbT5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG4vLyBAdHMtaWdub3JlIC0gWFhYOiB0c2MgZG9lc24ndCBsaWtlIHRoaXM6IG91ciBqcy1zZGsgaW1wb3J0cyBhcmUgY29tcGxleCBzbyB0aGlzIGlzbid0IHN1cnByaXNpbmdcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tYXRyaXhcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW1wb3J0IHsgSU1hdHJpeENsaWVudENyZWRzIH0gZnJvbSBcIi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgU2VjdXJpdHlDdXN0b21pc2F0aW9ucyBmcm9tIFwiLi9jdXN0b21pc2F0aW9ucy9TZWN1cml0eVwiO1xuXG5pbnRlcmZhY2UgSUxvZ2luT3B0aW9ucyB7XG4gICAgZGVmYXVsdERldmljZURpc3BsYXlOYW1lPzogc3RyaW5nO1xufVxuXG4vLyBUT0RPOiBNb3ZlIHRoaXMgdG8gSlMgU0RLXG5pbnRlcmZhY2UgSVBhc3N3b3JkRmxvdyB7XG4gICAgdHlwZTogXCJtLmxvZ2luLnBhc3N3b3JkXCI7XG59XG5cbmV4cG9ydCBlbnVtIElkZW50aXR5UHJvdmlkZXJCcmFuZCB7XG4gICAgR2l0bGFiID0gXCJnaXRsYWJcIixcbiAgICBHaXRodWIgPSBcImdpdGh1YlwiLFxuICAgIEFwcGxlID0gXCJhcHBsZVwiLFxuICAgIEdvb2dsZSA9IFwiZ29vZ2xlXCIsXG4gICAgRmFjZWJvb2sgPSBcImZhY2Vib29rXCIsXG4gICAgVHdpdHRlciA9IFwidHdpdHRlclwiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElJZGVudGl0eVByb3ZpZGVyIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBpY29uPzogc3RyaW5nO1xuICAgIGJyYW5kPzogSWRlbnRpdHlQcm92aWRlckJyYW5kIHwgc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTU09GbG93IHtcbiAgICB0eXBlOiBcIm0ubG9naW4uc3NvXCIgfCBcIm0ubG9naW4uY2FzXCI7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuICAgIGlkZW50aXR5X3Byb3ZpZGVycz86IElJZGVudGl0eVByb3ZpZGVyW107XG59XG5cbmV4cG9ydCB0eXBlIExvZ2luRmxvdyA9IElTU09GbG93IHwgSVBhc3N3b3JkRmxvdztcblxuLy8gVE9ETzogTW92ZSB0aGlzIHRvIEpTIFNES1xuLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovXG5pbnRlcmZhY2UgSUxvZ2luUGFyYW1zIHtcbiAgICBpZGVudGlmaWVyPzogb2JqZWN0O1xuICAgIHBhc3N3b3JkPzogc3RyaW5nO1xuICAgIHRva2VuPzogc3RyaW5nO1xuICAgIGRldmljZV9pZD86IHN0cmluZztcbiAgICBpbml0aWFsX2RldmljZV9kaXNwbGF5X25hbWU/OiBzdHJpbmc7XG59XG4vKiBlc2xpbnQtZW5hYmxlIGNhbWVsY2FzZSAqL1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMb2dpbiB7XG4gICAgcHJpdmF0ZSBoc1VybDogc3RyaW5nO1xuICAgIHByaXZhdGUgaXNVcmw6IHN0cmluZztcbiAgICBwcml2YXRlIGZhbGxiYWNrSHNVcmw6IHN0cmluZztcbiAgICAvLyBUT0RPOiBGbG93cyBuZWVkIGEgdHlwZSBpbiBKUyBTREtcbiAgICBwcml2YXRlIGZsb3dzOiBBcnJheTxMb2dpbkZsb3c+O1xuICAgIHByaXZhdGUgZGVmYXVsdERldmljZURpc3BsYXlOYW1lOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSB0ZW1wQ2xpZW50OiBNYXRyaXhDbGllbnQ7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgaHNVcmw6IHN0cmluZyxcbiAgICAgICAgaXNVcmw6IHN0cmluZyxcbiAgICAgICAgZmFsbGJhY2tIc1VybD86IHN0cmluZyxcbiAgICAgICAgb3B0cz86IElMb2dpbk9wdGlvbnMsXG4gICAgKSB7XG4gICAgICAgIHRoaXMuaHNVcmwgPSBoc1VybDtcbiAgICAgICAgdGhpcy5pc1VybCA9IGlzVXJsO1xuICAgICAgICB0aGlzLmZhbGxiYWNrSHNVcmwgPSBmYWxsYmFja0hzVXJsO1xuICAgICAgICB0aGlzLmZsb3dzID0gW107XG4gICAgICAgIHRoaXMuZGVmYXVsdERldmljZURpc3BsYXlOYW1lID0gb3B0cy5kZWZhdWx0RGV2aWNlRGlzcGxheU5hbWU7XG4gICAgICAgIHRoaXMudGVtcENsaWVudCA9IG51bGw7IC8vIG1lbW9pemVcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0SG9tZXNlcnZlclVybCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5oc1VybDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0SWRlbnRpdHlTZXJ2ZXJVcmwoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNVcmw7XG4gICAgfVxuXG4gICAgcHVibGljIHNldEhvbWVzZXJ2ZXJVcmwoaHNVcmw6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnRlbXBDbGllbnQgPSBudWxsOyAvLyBjbGVhciBtZW1vaXphdGlvblxuICAgICAgICB0aGlzLmhzVXJsID0gaHNVcmw7XG4gICAgfVxuXG4gICAgcHVibGljIHNldElkZW50aXR5U2VydmVyVXJsKGlzVXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy50ZW1wQ2xpZW50ID0gbnVsbDsgLy8gY2xlYXIgbWVtb2l6YXRpb25cbiAgICAgICAgdGhpcy5pc1VybCA9IGlzVXJsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBhIHRlbXBvcmFyeSBNYXRyaXhDbGllbnQsIHdoaWNoIGNhbiBiZSB1c2VkIGZvciBsb2dpbiBvciByZWdpc3RlclxuICAgICAqIHJlcXVlc3RzLlxuICAgICAqIEByZXR1cm5zIHtNYXRyaXhDbGllbnR9XG4gICAgICovXG4gICAgcHVibGljIGNyZWF0ZVRlbXBvcmFyeUNsaWVudCgpOiBNYXRyaXhDbGllbnQge1xuICAgICAgICBpZiAodGhpcy50ZW1wQ2xpZW50KSByZXR1cm4gdGhpcy50ZW1wQ2xpZW50OyAvLyB1c2UgbWVtb2l6YXRpb25cbiAgICAgICAgcmV0dXJuIHRoaXMudGVtcENsaWVudCA9IGNyZWF0ZUNsaWVudCh7XG4gICAgICAgICAgICBiYXNlVXJsOiB0aGlzLmhzVXJsLFxuICAgICAgICAgICAgaWRCYXNlVXJsOiB0aGlzLmlzVXJsLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0Rmxvd3MoKTogUHJvbWlzZTxBcnJheTxMb2dpbkZsb3c+PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuY3JlYXRlVGVtcG9yYXJ5Q2xpZW50KCk7XG4gICAgICAgIGNvbnN0IHsgZmxvd3MgfSA9IGF3YWl0IGNsaWVudC5sb2dpbkZsb3dzKCk7XG4gICAgICAgIHRoaXMuZmxvd3MgPSBmbG93cztcbiAgICAgICAgcmV0dXJuIHRoaXMuZmxvd3M7XG4gICAgfVxuXG4gICAgcHVibGljIGxvZ2luVmlhUGFzc3dvcmQoXG4gICAgICAgIHVzZXJuYW1lOiBzdHJpbmcsXG4gICAgICAgIHBob25lQ291bnRyeTogc3RyaW5nLFxuICAgICAgICBwaG9uZU51bWJlcjogc3RyaW5nLFxuICAgICAgICBwYXNzd29yZDogc3RyaW5nLFxuICAgICk6IFByb21pc2U8SU1hdHJpeENsaWVudENyZWRzPiB7XG4gICAgICAgIGNvbnN0IGlzRW1haWwgPSB1c2VybmFtZS5pbmRleE9mKFwiQFwiKSA+IDA7XG5cbiAgICAgICAgbGV0IGlkZW50aWZpZXI7XG4gICAgICAgIGlmIChwaG9uZUNvdW50cnkgJiYgcGhvbmVOdW1iZXIpIHtcbiAgICAgICAgICAgIGlkZW50aWZpZXIgPSB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ20uaWQucGhvbmUnLFxuICAgICAgICAgICAgICAgIGNvdW50cnk6IHBob25lQ291bnRyeSxcbiAgICAgICAgICAgICAgICBwaG9uZTogcGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgLy8gWFhYOiBTeW5hcHNlIGhpc3RvcmljYWxseSB3YW50ZWQgYG51bWJlcmAgYW5kIG5vdCBgcGhvbmVgXG4gICAgICAgICAgICAgICAgbnVtYmVyOiBwaG9uZU51bWJlcixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSBpZiAoaXNFbWFpbCkge1xuICAgICAgICAgICAgaWRlbnRpZmllciA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnbS5pZC50aGlyZHBhcnR5JyxcbiAgICAgICAgICAgICAgICBtZWRpdW06ICdlbWFpbCcsXG4gICAgICAgICAgICAgICAgYWRkcmVzczogdXNlcm5hbWUsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWRlbnRpZmllciA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnbS5pZC51c2VyJyxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VybmFtZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsb2dpblBhcmFtcyA9IHtcbiAgICAgICAgICAgIHBhc3N3b3JkLFxuICAgICAgICAgICAgaWRlbnRpZmllcixcbiAgICAgICAgICAgIGluaXRpYWxfZGV2aWNlX2Rpc3BsYXlfbmFtZTogdGhpcy5kZWZhdWx0RGV2aWNlRGlzcGxheU5hbWUsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgdHJ5RmFsbGJhY2tIcyA9IChvcmlnaW5hbEVycm9yKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gc2VuZExvZ2luUmVxdWVzdChcbiAgICAgICAgICAgICAgICB0aGlzLmZhbGxiYWNrSHNVcmwsIHRoaXMuaXNVcmwsICdtLmxvZ2luLnBhc3N3b3JkJywgbG9naW5QYXJhbXMsXG4gICAgICAgICAgICApLmNhdGNoKChmYWxsYmFja0Vycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmxvZyhcImZhbGxiYWNrIEhTIGxvZ2luIGZhaWxlZFwiLCBmYWxsYmFja0Vycm9yKTtcbiAgICAgICAgICAgICAgICAvLyB0aHJvdyB0aGUgb3JpZ2luYWwgZXJyb3JcbiAgICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG9yaWdpbmFsTG9naW5FcnJvciA9IG51bGw7XG4gICAgICAgIHJldHVybiBzZW5kTG9naW5SZXF1ZXN0KFxuICAgICAgICAgICAgdGhpcy5oc1VybCwgdGhpcy5pc1VybCwgJ20ubG9naW4ucGFzc3dvcmQnLCBsb2dpblBhcmFtcyxcbiAgICAgICAgKS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIG9yaWdpbmFsTG9naW5FcnJvciA9IGVycm9yO1xuICAgICAgICAgICAgaWYgKGVycm9yLmh0dHBTdGF0dXMgPT09IDQwMykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmZhbGxiYWNrSHNVcmwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyeUZhbGxiYWNrSHMob3JpZ2luYWxMb2dpbkVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBvcmlnaW5hbExvZ2luRXJyb3I7XG4gICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIkxvZ2luIGZhaWxlZFwiLCBlcnJvcik7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG4vKipcbiAqIFNlbmQgYSBsb2dpbiByZXF1ZXN0IHRvIHRoZSBnaXZlbiBzZXJ2ZXIsIGFuZCBmb3JtYXQgdGhlIHJlc3BvbnNlXG4gKiBhcyBhIE1hdHJpeENsaWVudENyZWRzXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGhzVXJsICAgdGhlIGJhc2UgdXJsIG9mIHRoZSBIb21lc2VydmVyIHVzZWQgdG8gbG9nIGluLlxuICogQHBhcmFtIHtzdHJpbmd9IGlzVXJsICAgdGhlIGJhc2UgdXJsIG9mIHRoZSBkZWZhdWx0IGlkZW50aXR5IHNlcnZlclxuICogQHBhcmFtIHtzdHJpbmd9IGxvZ2luVHlwZSB0aGUgdHlwZSBvZiBsb2dpbiB0byBkb1xuICogQHBhcmFtIHtJTG9naW5QYXJhbXN9IGxvZ2luUGFyYW1zIHRoZSBwYXJhbWV0ZXJzIGZvciB0aGUgbG9naW5cbiAqXG4gKiBAcmV0dXJucyB7TWF0cml4Q2xpZW50Q3JlZHN9XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kTG9naW5SZXF1ZXN0KFxuICAgIGhzVXJsOiBzdHJpbmcsXG4gICAgaXNVcmw6IHN0cmluZyxcbiAgICBsb2dpblR5cGU6IHN0cmluZyxcbiAgICBsb2dpblBhcmFtczogSUxvZ2luUGFyYW1zLFxuKTogUHJvbWlzZTxJTWF0cml4Q2xpZW50Q3JlZHM+IHtcbiAgICBjb25zdCBjbGllbnQgPSBjcmVhdGVDbGllbnQoe1xuICAgICAgICBiYXNlVXJsOiBoc1VybCxcbiAgICAgICAgaWRCYXNlVXJsOiBpc1VybCxcbiAgICB9KTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBjbGllbnQubG9naW4obG9naW5UeXBlLCBsb2dpblBhcmFtcyk7XG5cbiAgICBjb25zdCB3ZWxsa25vd24gPSBkYXRhLndlbGxfa25vd247XG4gICAgaWYgKHdlbGxrbm93bikge1xuICAgICAgICBpZiAod2VsbGtub3duW1wibS5ob21lc2VydmVyXCJdICYmIHdlbGxrbm93bltcIm0uaG9tZXNlcnZlclwiXVtcImJhc2VfdXJsXCJdKSB7XG4gICAgICAgICAgICBoc1VybCA9IHdlbGxrbm93bltcIm0uaG9tZXNlcnZlclwiXVtcImJhc2VfdXJsXCJdO1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhgT3ZlcnJvZGUgaG9tZXNlcnZlciBzZXR0aW5nIHdpdGggJHtoc1VybH0gZnJvbSBsb2dpbiByZXNwb25zZWApO1xuICAgICAgICB9XG4gICAgICAgIGlmICh3ZWxsa25vd25bXCJtLmlkZW50aXR5X3NlcnZlclwiXSAmJiB3ZWxsa25vd25bXCJtLmlkZW50aXR5X3NlcnZlclwiXVtcImJhc2VfdXJsXCJdKSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBzaG91bGQgd2UgcHJvbXB0IGhlcmU/XG4gICAgICAgICAgICBpc1VybCA9IHdlbGxrbm93bltcIm0uaWRlbnRpdHlfc2VydmVyXCJdW1wiYmFzZV91cmxcIl07XG4gICAgICAgICAgICBsb2dnZXIubG9nKGBPdmVycm9kZSBJUyBzZXR0aW5nIHdpdGggJHtpc1VybH0gZnJvbSBsb2dpbiByZXNwb25zZWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY3JlZHM6IElNYXRyaXhDbGllbnRDcmVkcyA9IHtcbiAgICAgICAgaG9tZXNlcnZlclVybDogaHNVcmwsXG4gICAgICAgIGlkZW50aXR5U2VydmVyVXJsOiBpc1VybCxcbiAgICAgICAgdXNlcklkOiBkYXRhLnVzZXJfaWQsXG4gICAgICAgIGRldmljZUlkOiBkYXRhLmRldmljZV9pZCxcbiAgICAgICAgYWNjZXNzVG9rZW46IGRhdGEuYWNjZXNzX3Rva2VuLFxuICAgIH07XG5cbiAgICBTZWN1cml0eUN1c3RvbWlzYXRpb25zLmV4YW1pbmVMb2dpblJlc3BvbnNlPy4oZGF0YSwgY3JlZHMpO1xuXG4gICAgcmV0dXJuIGNyZWRzO1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFrQkE7O0FBRUE7O0FBR0E7O0FBdkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUE7SUFpQllBLHFCOzs7V0FBQUEscUI7RUFBQUEscUI7RUFBQUEscUI7RUFBQUEscUI7RUFBQUEscUI7RUFBQUEscUI7RUFBQUEscUI7R0FBQUEscUIscUNBQUFBLHFCOztBQWlDWjtBQUVlLE1BQU1DLEtBQU4sQ0FBWTtFQUl2QjtFQUtBQyxXQUFXLENBQ1BDLEtBRE8sRUFFUEMsS0FGTyxFQUdQQyxhQUhPLEVBSVBDLElBSk8sRUFLVDtJQUFBO0lBQUE7SUFBQTtJQUFBO0lBQUE7SUFBQTtJQUNFLEtBQUtILEtBQUwsR0FBYUEsS0FBYjtJQUNBLEtBQUtDLEtBQUwsR0FBYUEsS0FBYjtJQUNBLEtBQUtDLGFBQUwsR0FBcUJBLGFBQXJCO0lBQ0EsS0FBS0UsS0FBTCxHQUFhLEVBQWI7SUFDQSxLQUFLQyx3QkFB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