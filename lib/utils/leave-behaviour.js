"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.leaveRoomBehaviour = leaveRoomBehaviour;
exports.leaveSpace = void 0;

var _utils = require("matrix-js-sdk/src/utils");

var _react = _interopRequireDefault(require("react"));

var _eventStatus = require("matrix-js-sdk/src/models/event-status");

var _event = require("matrix-js-sdk/src/models/event");

var _Modal = _interopRequireDefault(require("../Modal"));

var _Spinner = _interopRequireDefault(require("../components/views/elements/Spinner"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _languageHandler = require("../languageHandler");

var _ErrorDialog = _interopRequireDefault(require("../components/views/dialogs/ErrorDialog"));

var _spaces = require("../stores/spaces");

var _SpaceStore = _interopRequireDefault(require("../stores/spaces/SpaceStore"));

var _RoomViewStore = require("../stores/RoomViewStore");

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _actions = require("../dispatcher/actions");

var _LeaveSpaceDialog = _interopRequireDefault(require("../components/views/dialogs/LeaveSpaceDialog"));

var _space = require("./space");

/*
Copyright 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
async function leaveRoomBehaviour(roomId) {
  let retry = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
  let spinner = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;
  let spinnerModal;

  if (spinner) {
    spinnerModal = _Modal.default.createDialog(_Spinner.default, null, 'mx_Dialog_spinner');
  }

  const cli = _MatrixClientPeg.MatrixClientPeg.get();

  let leavingAllVersions = true;
  const history = cli.getRoomUpgradeHistory(roomId);

  if (history && history.length > 0) {
    const currentRoom = history[history.length - 1];

    if (currentRoom.roomId !== roomId) {
      // The user is trying to leave an older version of the room. Let them through
      // without making them leave the current version of the room.
      leavingAllVersions = false;
    }
  }

  const room = cli.getRoom(roomId); // await any queued messages being sent so that they do not fail

  await Promise.all(room.getPendingEvents().filter(ev => {
    return [_eventStatus.EventStatus.QUEUED, _eventStatus.EventStatus.ENCRYPTING, _eventStatus.EventStatus.SENDING].includes(ev.status);
  }).map(ev => new Promise((resolve, reject) => {
    const handler = () => {
      if (ev.status === _eventStatus.EventStatus.NOT_SENT) {
        spinnerModal?.close();
        reject(ev.error);
      }

      if (!ev.status || ev.status === _eventStatus.EventStatus.SENT) {
        ev.off(_event.MatrixEventEvent.Status, handler);
        resolve();
      }
    };

    ev.on(_event.MatrixEventEvent.Status, handler);
  })));
  let results = {};

  if (!leavingAllVersions) {
    try {
      await cli.leave(roomId);
    } catch (e) {
      if (e?.data?.errcode) {
        const message = e.data.error || (0, _languageHandler._t)("Unexpected server error trying to leave the room");
        results[roomId] = Object.assign(new Error(message), {
          errcode: e.data.errcode,
          data: e.data
        });
      } else {
        results[roomId] = e || new Error("Failed to leave room for unknown causes");
      }
    }
  } else {
    results = await cli.leaveRoomChain(roomId, retry);
  }

  if (retry) {
    const limitExceededError = Object.values(results).find(e => e?.errcode === "M_LIMIT_EXCEEDED");

    if (limitExceededError) {
      await (0, _utils.sleep)(limitExceededError.data.retry_after_ms ?? 100);
      return leaveRoomBehaviour(roomId, false, false);
    }
  }

  spinnerModal?.close();
  const errors = Object.entries(results).filter(r => !!r[1]);

  if (errors.length > 0) {
    const messages = [];

    for (const roomErr of errors) {
      const err = roomErr[1]; // [0] is the roomId

      let message = (0, _languageHandler._t)("Unexpected server error trying to leave the room");

      if (err.errcode && err.message) {
        if (err.errcode === 'M_CANNOT_LEAVE_SERVER_NOTICE_ROOM') {
          _Modal.default.createDialog(_ErrorDialog.default, {
            title: (0, _languageHandler._t)("Can't leave Server Notices room"),
            description: (0, _languageHandler._t)("This room is used for important messages from the Homeserver, " + "so you cannot leave it.")
          });

          return;
        }

        message = results[roomId].message;
      }

      messages.push(message, /*#__PURE__*/_react.default.createElement('BR')); // createElement to avoid using a tsx file in utils
    }

    _Modal.default.createDialog(_ErrorDialog.default, {
      title: (0, _languageHandler._t)("Error leaving room"),
      description: messages
    });

    return;
  }

  if (!(0, _spaces.isMetaSpace)(_SpaceStore.default.instance.activeSpace) && _SpaceStore.default.instance.activeSpace !== roomId && _RoomViewStore.RoomViewStore.instance.getRoomId() === roomId) {
    _dispatcher.default.dispatch({
      action: _actions.Action.ViewRoom,
      room_id: _SpaceStore.default.instance.activeSpace,
      metricsTrigger: undefined // other

    });
  } else {
    _dispatcher.default.dispatch({
      action: _actions.Action.ViewHomePage
    });
  }
}

const leaveSpace = space => {
  _Modal.default.createDialog(_LeaveSpaceDialog.default, {
    space,
    onFinished: async (leave, rooms) => {
      if (!leave) return;
      await (0, _space.bulkSpaceBehaviour)(space, rooms, room => leaveRoomBehaviour(room.roomId));

      _dispatcher.default.dispatch({
        action: _actions.Action.AfterLeaveRoom,
        room_id: space.roomId
      });
    }
  }, "mx_LeaveSpaceDialog_wrapper");
};

exports.leaveSpace = leaveSpace;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJsZWF2ZVJvb21CZWhhdmlvdXIiLCJyb29tSWQiLCJyZXRyeSIsInNwaW5uZXIiLCJzcGlubmVyTW9kYWwiLCJNb2RhbCIsImNyZWF0ZURpYWxvZyIsIlNwaW5uZXIiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJsZWF2aW5nQWxsVmVyc2lvbnMiLCJoaXN0b3J5IiwiZ2V0Um9vbVVwZ3JhZGVIaXN0b3J5IiwibGVuZ3RoIiwiY3VycmVudFJvb20iLCJyb29tIiwiZ2V0Um9vbSIsIlByb21pc2UiLCJhbGwiLCJnZXRQZW5kaW5nRXZlbnRzIiwiZmlsdGVyIiwiZXYiLCJFdmVudFN0YXR1cyIsIlFVRVVFRCIsIkVOQ1JZUFRJTkciLCJTRU5ESU5HIiwiaW5jbHVkZXMiLCJzdGF0dXMiLCJtYXAiLCJyZXNvbHZlIiwicmVqZWN0IiwiaGFuZGxlciIsIk5PVF9TRU5UIiwiY2xvc2UiLCJlcnJvciIsIlNFTlQiLCJvZmYiLCJNYXRyaXhFdmVudEV2ZW50IiwiU3RhdHVzIiwib24iLCJyZXN1bHRzIiwibGVhdmUiLCJlIiwiZGF0YSIsImVycmNvZGUiLCJtZXNzYWdlIiwiX3QiLCJPYmplY3QiLCJhc3NpZ24iLCJFcnJvciIsImxlYXZlUm9vbUNoYWluIiwibGltaXRFeGNlZWRlZEVycm9yIiwidmFsdWVzIiwiZmluZCIsInNsZWVwIiwicmV0cnlfYWZ0ZXJfbXMiLCJlcnJvcnMiLCJlbnRyaWVzIiwiciIsIm1lc3NhZ2VzIiwicm9vbUVyciIsImVyciIsIkVycm9yRGlhbG9nIiwidGl0bGUiLCJkZXNjcmlwdGlvbiIsInB1c2giLCJSZWFjdCIsImNyZWF0ZUVsZW1lbnQiLCJpc01ldGFTcGFjZSIsIlNwYWNlU3RvcmUiLCJpbnN0YW5jZSIsImFjdGl2ZVNwYWNlIiwiUm9vbVZpZXdTdG9yZSIsImdldFJvb21JZCIsImRpcyIsImRpc3BhdGNoIiwiYWN0aW9uIiwiQWN0aW9uIiwiVmlld1Jvb20iLCJyb29tX2lkIiwibWV0cmljc1RyaWdnZXIiLCJ1bmRlZmluZWQiLCJWaWV3SG9tZVBhZ2UiLCJsZWF2ZVNwYWNlIiwic3BhY2UiLCJMZWF2ZVNwYWNlRGlhbG9nIiwib25GaW5pc2hlZCIsInJvb21zIiwiYnVsa1NwYWNlQmVoYXZpb3VyIiwiQWZ0ZXJMZWF2ZVJvb20iXSwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbHMvbGVhdmUtYmVoYXZpb3VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMiBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IHNsZWVwIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL3V0aWxzXCI7XG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBFdmVudFN0YXR1cyB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnQtc3RhdHVzXCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuXG5pbXBvcnQgTW9kYWwsIHsgSUhhbmRsZSB9IGZyb20gXCIuLi9Nb2RhbFwiO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgRXJyb3JEaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuaW1wb3J0IHsgaXNNZXRhU3BhY2UgfSBmcm9tIFwiLi4vc3RvcmVzL3NwYWNlc1wiO1xuaW1wb3J0IFNwYWNlU3RvcmUgZnJvbSBcIi4uL3N0b3Jlcy9zcGFjZXMvU3BhY2VTdG9yZVwiO1xuaW1wb3J0IHsgUm9vbVZpZXdTdG9yZSB9IGZyb20gXCIuLi9zdG9yZXMvUm9vbVZpZXdTdG9yZVwiO1xuaW1wb3J0IGRpcyBmcm9tIFwiLi4vZGlzcGF0Y2hlci9kaXNwYXRjaGVyXCI7XG5pbXBvcnQgeyBWaWV3Um9vbVBheWxvYWQgfSBmcm9tIFwiLi4vZGlzcGF0Y2hlci9wYXlsb2Fkcy9WaWV3Um9vbVBheWxvYWRcIjtcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL2FjdGlvbnNcIjtcbmltcG9ydCB7IFZpZXdIb21lUGFnZVBheWxvYWQgfSBmcm9tIFwiLi4vZGlzcGF0Y2hlci9wYXlsb2Fkcy9WaWV3SG9tZVBhZ2VQYXlsb2FkXCI7XG5pbXBvcnQgTGVhdmVTcGFjZURpYWxvZyBmcm9tIFwiLi4vY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0xlYXZlU3BhY2VEaWFsb2dcIjtcbmltcG9ydCB7IEFmdGVyTGVhdmVSb29tUGF5bG9hZCB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL3BheWxvYWRzL0FmdGVyTGVhdmVSb29tUGF5bG9hZFwiO1xuaW1wb3J0IHsgYnVsa1NwYWNlQmVoYXZpb3VyIH0gZnJvbSBcIi4vc3BhY2VcIjtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxlYXZlUm9vbUJlaGF2aW91cihyb29tSWQ6IHN0cmluZywgcmV0cnkgPSB0cnVlLCBzcGlubmVyID0gdHJ1ZSkge1xuICAgIGxldCBzcGlubmVyTW9kYWw6IElIYW5kbGU8YW55PjtcbiAgICBpZiAoc3Bpbm5lcikge1xuICAgICAgICBzcGlubmVyTW9kYWwgPSBNb2RhbC5jcmVhdGVEaWFsb2coU3Bpbm5lciwgbnVsbCwgJ214X0RpYWxvZ19zcGlubmVyJyk7XG4gICAgfVxuXG4gICAgY29uc3QgY2xpID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgIGxldCBsZWF2aW5nQWxsVmVyc2lvbnMgPSB0cnVlO1xuICAgIGNvbnN0IGhpc3RvcnkgPSBjbGkuZ2V0Um9vbVVwZ3JhZGVIaXN0b3J5KHJvb21JZCk7XG4gICAgaWYgKGhpc3RvcnkgJiYgaGlzdG9yeS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRSb29tID0gaGlzdG9yeVtoaXN0b3J5Lmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAoY3VycmVudFJvb20ucm9vbUlkICE9PSByb29tSWQpIHtcbiAgICAgICAgICAgIC8vIFRoZSB1c2VyIGlzIHRyeWluZyB0byBsZWF2ZSBhbiBvbGRlciB2ZXJzaW9uIG9mIHRoZSByb29tLiBMZXQgdGhlbSB0aHJvdWdoXG4gICAgICAgICAgICAvLyB3aXRob3V0IG1ha2luZyB0aGVtIGxlYXZlIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgdGhlIHJvb20uXG4gICAgICAgICAgICBsZWF2aW5nQWxsVmVyc2lvbnMgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHJvb20gPSBjbGkuZ2V0Um9vbShyb29tSWQpO1xuICAgIC8vIGF3YWl0IGFueSBxdWV1ZWQgbWVzc2FnZXMgYmVpbmcgc2VudCBzbyB0aGF0IHRoZXkgZG8gbm90IGZhaWxcbiAgICBhd2FpdCBQcm9taXNlLmFsbChyb29tLmdldFBlbmRpbmdFdmVudHMoKS5maWx0ZXIoZXYgPT4ge1xuICAgICAgICByZXR1cm4gW0V2ZW50U3RhdHVzLlFVRVVFRCwgRXZlbnRTdGF0dXMuRU5DUllQVElORywgRXZlbnRTdGF0dXMuU0VORElOR10uaW5jbHVkZXMoZXYuc3RhdHVzKTtcbiAgICB9KS5tYXAoZXYgPT4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBoYW5kbGVyID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGV2LnN0YXR1cyA9PT0gRXZlbnRTdGF0dXMuTk9UX1NFTlQpIHtcbiAgICAgICAgICAgICAgICBzcGlubmVyTW9kYWw/LmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGV2LmVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFldi5zdGF0dXMgfHwgZXYuc3RhdHVzID09PSBFdmVudFN0YXR1cy5TRU5UKSB7XG4gICAgICAgICAgICAgICAgZXYub2ZmKE1hdHJpeEV2ZW50RXZlbnQuU3RhdHVzLCBoYW5kbGVyKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgZXYub24oTWF0cml4RXZlbnRFdmVudC5TdGF0dXMsIGhhbmRsZXIpO1xuICAgIH0pKSk7XG5cbiAgICBsZXQgcmVzdWx0czogeyBbcm9vbUlkOiBzdHJpbmddOiBFcnJvciAmIHsgZXJyY29kZT86IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCBkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PiB9IH0gPSB7fTtcbiAgICBpZiAoIWxlYXZpbmdBbGxWZXJzaW9ucykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgY2xpLmxlYXZlKHJvb21JZCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmIChlPy5kYXRhPy5lcnJjb2RlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGUuZGF0YS5lcnJvciB8fCBfdChcIlVuZXhwZWN0ZWQgc2VydmVyIGVycm9yIHRyeWluZyB0byBsZWF2ZSB0aGUgcm9vbVwiKTtcbiAgICAgICAgICAgICAgICByZXN1bHRzW3Jvb21JZF0gPSBPYmplY3QuYXNzaWduKG5ldyBFcnJvcihtZXNzYWdlKSwgeyBlcnJjb2RlOiBlLmRhdGEuZXJyY29kZSwgZGF0YTogZS5kYXRhIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHRzW3Jvb21JZF0gPSBlIHx8IG5ldyBFcnJvcihcIkZhaWxlZCB0byBsZWF2ZSByb29tIGZvciB1bmtub3duIGNhdXNlc1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdHMgPSBhd2FpdCBjbGkubGVhdmVSb29tQ2hhaW4ocm9vbUlkLCByZXRyeSk7XG4gICAgfVxuXG4gICAgaWYgKHJldHJ5KSB7XG4gICAgICAgIGNvbnN0IGxpbWl0RXhjZWVkZWRFcnJvciA9IE9iamVjdC52YWx1ZXMocmVzdWx0cykuZmluZChlID0+IGU/LmVycmNvZGUgPT09IFwiTV9MSU1JVF9FWENFRURFRFwiKTtcbiAgICAgICAgaWYgKGxpbWl0RXhjZWVkZWRFcnJvcikge1xuICAgICAgICAgICAgYXdhaXQgc2xlZXAobGltaXRFeGNlZWRlZEVycm9yLmRhdGEucmV0cnlfYWZ0ZXJfbXMgPz8gMTAwKTtcbiAgICAgICAgICAgIHJldHVybiBsZWF2ZVJvb21CZWhhdmlvdXIocm9vbUlkLCBmYWxzZSwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3Bpbm5lck1vZGFsPy5jbG9zZSgpO1xuXG4gICAgY29uc3QgZXJyb3JzID0gT2JqZWN0LmVudHJpZXMocmVzdWx0cykuZmlsdGVyKHIgPT4gISFyWzFdKTtcbiAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCByb29tRXJyIG9mIGVycm9ycykge1xuICAgICAgICAgICAgY29uc3QgZXJyID0gcm9vbUVyclsxXTsgLy8gWzBdIGlzIHRoZSByb29tSWRcbiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gX3QoXCJVbmV4cGVjdGVkIHNlcnZlciBlcnJvciB0cnlpbmcgdG8gbGVhdmUgdGhlIHJvb21cIik7XG4gICAgICAgICAgICBpZiAoZXJyLmVycmNvZGUgJiYgZXJyLm1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLmVycmNvZGUgPT09ICdNX0NBTk5PVF9MRUFWRV9TRVJWRVJfTk9USUNFX1JPT00nKSB7XG4gICAgICAgICAgICAgICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiQ2FuJ3QgbGVhdmUgU2VydmVyIE5vdGljZXMgcm9vbVwiKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlRoaXMgcm9vbSBpcyB1c2VkIGZvciBpbXBvcnRhbnQgbWVzc2FnZXMgZnJvbSB0aGUgSG9tZXNlcnZlciwgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwic28geW91IGNhbm5vdCBsZWF2ZSBpdC5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSByZXN1bHRzW3Jvb21JZF0ubWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSwgUmVhY3QuY3JlYXRlRWxlbWVudCgnQlInKSk7IC8vIGNyZWF0ZUVsZW1lbnQgdG8gYXZvaWQgdXNpbmcgYSB0c3ggZmlsZSBpbiB1dGlsc1xuICAgICAgICB9XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgdGl0bGU6IF90KFwiRXJyb3IgbGVhdmluZyByb29tXCIpLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IG1lc3NhZ2VzLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghaXNNZXRhU3BhY2UoU3BhY2VTdG9yZS5pbnN0YW5jZS5hY3RpdmVTcGFjZSkgJiZcbiAgICAgICAgU3BhY2VTdG9yZS5pbnN0YW5jZS5hY3RpdmVTcGFjZSAhPT0gcm9vbUlkICYmXG4gICAgICAgIFJvb21WaWV3U3RvcmUuaW5zdGFuY2UuZ2V0Um9vbUlkKCkgPT09IHJvb21JZFxuICAgICkge1xuICAgICAgICBkaXMuZGlzcGF0Y2g8Vmlld1Jvb21QYXlsb2FkPih7XG4gICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5WaWV3Um9vbSxcbiAgICAgICAgICAgIHJvb21faWQ6IFNwYWNlU3RvcmUuaW5zdGFuY2UuYWN0aXZlU3BhY2UsXG4gICAgICAgICAgICBtZXRyaWNzVHJpZ2dlcjogdW5kZWZpbmVkLCAvLyBvdGhlclxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBkaXMuZGlzcGF0Y2g8Vmlld0hvbWVQYWdlUGF5bG9hZD4oeyBhY3Rpb246IEFjdGlvbi5WaWV3SG9tZVBhZ2UgfSk7XG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgbGVhdmVTcGFjZSA9IChzcGFjZTogUm9vbSkgPT4ge1xuICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhMZWF2ZVNwYWNlRGlhbG9nLCB7XG4gICAgICAgIHNwYWNlLFxuICAgICAgICBvbkZpbmlzaGVkOiBhc3luYyAobGVhdmU6IGJvb2xlYW4sIHJvb21zOiBSb29tW10pID0+IHtcbiAgICAgICAgICAgIGlmICghbGVhdmUpIHJldHVybjtcbiAgICAgICAgICAgIGF3YWl0IGJ1bGtTcGFjZUJlaGF2aW91cihzcGFjZSwgcm9vbXMsIHJvb20gPT4gbGVhdmVSb29tQmVoYXZpb3VyKHJvb20ucm9vbUlkKSk7XG5cbiAgICAgICAgICAgIGRpcy5kaXNwYXRjaDxBZnRlckxlYXZlUm9vbVBheWxvYWQ+KHtcbiAgICAgICAgICAgICAgICBhY3Rpb246IEFjdGlvbi5BZnRlckxlYXZlUm9vbSxcbiAgICAgICAgICAgICAgICByb29tX2lkOiBzcGFjZS5yb29tSWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICB9LCBcIm14X0xlYXZlU3BhY2VEaWFsb2dfd3JhcHBlclwiKTtcbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7O0FBcENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQXdCTyxlQUFlQSxrQkFBZixDQUFrQ0MsTUFBbEMsRUFBZ0Y7RUFBQSxJQUE5QkMsS0FBOEIsdUVBQXRCLElBQXNCO0VBQUEsSUFBaEJDLE9BQWdCLHVFQUFOLElBQU07RUFDbkYsSUFBSUMsWUFBSjs7RUFDQSxJQUFJRCxPQUFKLEVBQWE7SUFDVEMsWUFBWSxHQUFHQyxjQUFBLENBQU1DLFlBQU4sQ0FBbUJDLGdCQUFuQixFQUE0QixJQUE1QixFQUFrQyxtQkFBbEMsQ0FBZjtFQUNIOztFQUVELE1BQU1DLEdBQUcsR0FB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