"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _eventTimeline = require("matrix-js-sdk/src/models/event-timeline");

var _fileSaver = require("file-saver");

var _logger = require("matrix-js-sdk/src/logger");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _exportUtils = require("./exportUtils");

var _DecryptFile = require("../DecryptFile");

var _Media = require("../../customisations/Media");

var _DateUtils = require("../../DateUtils");

var _EventUtils = require("../EventUtils");

var _languageHandler = require("../../languageHandler");

var _SdkConfig = _interopRequireDefault(require("../../SdkConfig"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

class Exporter {
  constructor(room, exportType, exportOptions, setProgressText) {
    this.room = room;
    this.exportType = exportType;
    this.exportOptions = exportOptions;
    this.setProgressText = setProgressText;
    (0, _defineProperty2.default)(this, "files", []);
    (0, _defineProperty2.default)(this, "client", void 0);
    (0, _defineProperty2.default)(this, "cancelled", false);

    if (exportOptions.maxSize < 1 * 1024 * 1024 || // Less than 1 MB
    exportOptions.maxSize > 8000 * 1024 * 1024 || // More than 8 GB
    exportOptions.numberOfMessages > 10 ** 8) {
      throw new Error("Invalid export options");
    }

    this.client = _MatrixClientPeg.MatrixClientPeg.get();
    window.addEventListener("beforeunload", this.onBeforeUnload);
  }

  onBeforeUnload(e) {
    e.preventDefault();
    return e.returnValue = (0, _languageHandler._t)("Are you sure you want to exit during this export?");
  }

  updateProgress(progress) {
    let log = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
    let show = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;
    if (log) _logger.logger.log(progress);
    if (show) this.setProgressText(progress);
  }

  addFile(filePath, blob) {
    const file = {
      name: filePath,
      blob
    };
    this.files.push(file);
  }

  async downloadZIP() {
    const brand = _SdkConfig.default.get().brand;

    const filenameWithoutExt = `${brand} - Chat Export - ${(0, _DateUtils.formatFullDateNoDay)(new Date())}`;
    const filename = `${filenameWithoutExt}.zip`;
    const {
      default: JSZip
    } = await Promise.resolve().then(() => _interopRequireWildcard(require('jszip')));
    const zip = new JSZip(); // Create a writable stream to the directory

    if (!this.cancelled) this.updateProgress((0, _languageHandler._t)("Generating a ZIP"));else return this.cleanUp();

    for (const file of this.files) zip.file(filenameWithoutExt + "/" + file.name, file.blob);

    const content = await zip.generateAsync({
      type: "blob"
    });
    (0, _fileSaver.saveAs)(content, filename);
  }

  cleanUp() {
    _logger.logger.log("Cleaning up...");

    window.removeEventListener("beforeunload", this.onBeforeUnload);
    return "";
  }

  async cancelExport() {
    _logger.logger.log("Cancelling export...");

    this.cancelled = true;
  }

  downloadPlainText(fileName, text) {
    const content = new Blob([text], {
      type: "text/plain"
    });
    (0, _fileSaver.saveAs)(content, fileName);
  }

  setEventMetadata(event) {
    const roomState = this.client.getRoom(this.room.roomId).currentState;
    event.sender = roomState.getSentinelMember(event.getSender());

    if (event.getType() === "m.room.member") {
      event.target = roomState.getSentinelMember(event.getStateKey());
    }

    return event;
  }

  getLimit() {
    let limit;

    switch (this.exportType) {
      case _exportUtils.ExportType.LastNMessages:
        limit = this.exportOptions.numberOfMessages;
        break;

      case _exportUtils.ExportType.Timeline:
        limit = 40;
        break;

      default:
        limit = 10 ** 8;
    }

    return limit;
  }

  async getRequiredEvents() {
    const eventMapper = this.client.getEventMapper();
    let prevToken = null;
    let limit = this.getLimit();
    const events = [];

    while (limit) {
      const eventsPerCrawl = Math.min(limit, 1000);
      const res = await this.client.createMessagesRequest(this.room.roomId, prevToken, eventsPerCrawl, _eventTimeline.Direction.Backward);

      if (this.cancelled) {
        this.cleanUp();
        return [];
      }

      if (res.chunk.length === 0) break;
      limit -= res.chunk.length;
      const matrixEvents = res.chunk.map(eventMapper);

      for (const mxEv of matrixEvents) {
        // if (this.exportOptions.startDate && mxEv.getTs() < this.exportOptions.startDate) {
        //     // Once the last message received is older than the start date, we break out of both the loops
        //     limit = 0;
        //     break;
        // }
        events.push(mxEv);
      }

      if (this.exportType === _exportUtils.ExportType.LastNMessages) {
        this.updateProgress((0, _languageHandler._t)("Fetched %(count)s events out of %(total)s", {
          count: events.length,
          total: this.exportOptions.numberOfMessages
        }));
      } else {
        this.updateProgress((0, _languageHandler._t)("Fetched %(count)s events so far", {
          count: events.length
        }));
      }

      prevToken = res.end;
    } // Reverse the events so that we preserve the order


    for (let i = 0; i < Math.floor(events.length / 2); i++) {
      [events[i], events[events.length - i - 1]] = [events[events.length - i - 1], events[i]];
    }

    const decryptionPromises = events.filter(event => event.isEncrypted()).map(event => {
      return this.client.decryptEventIfNeeded(event, {
        isRetry: true,
        emit: false
      });
    }); // Wait for all the events to get decrypted.

    await Promise.all(decryptionPromises);

    for (let i = 0; i < events.length; i++) this.setEventMetadata(events[i]);

    return events;
  }

  async getMediaBlob(event) {
    let blob;

    try {
      const isEncrypted = event.isEncrypted();
      const content = event.getContent();
      const shouldDecrypt = isEncrypted && content.hasOwnProperty("file") && event.getType() !== "m.sticker";

      if (shouldDecrypt) {
        blob = await (0, _DecryptFile.decryptFile)(content.file);
      } else {
        const media = (0, _Media.mediaFromContent)(content);
        const image = await fetch(media.srcHttp);
        blob = await image.blob();
      }
    } catch (err) {
      _logger.logger.log("Error decrypting media");
    }

    return blob;
  }

  splitFileName(file) {
    const lastDot = file.lastIndexOf('.');
    if (lastDot === -1) return [file, ""];
    const fileName = file.slice(0, lastDot);
    const ext = file.slice(lastDot + 1);
    return [fileName, '.' + ext];
  }

  getFilePath(event) {
    const mediaType = event.getContent().msgtype;
    let fileDirectory;

    switch (mediaType) {
      case "m.image":
        fileDirectory = "images";
        break;

      case "m.video":
        fileDirectory = "videos";
        break;

      case "m.audio":
        fileDirectory = "audio";
        break;

      default:
        fileDirectory = event.getType() === "m.sticker" ? "stickers" : "files";
    }

    const fileDate = (0, _DateUtils.formatFullDateNoDay)(new Date(event.getTs()));
    let [fileName, fileExt] = this.splitFileName(event.getContent().body);
    if (event.getType() === "m.sticker") fileExt = ".png";
    if ((0, _EventUtils.isVoiceMessage)(event)) fileExt = ".ogg";
    return fileDirectory + "/" + fileName + '-' + fileDate + fileExt;
  }

  isReply(event) {
    const isEncrypted = event.isEncrypted(); // If encrypted, in_reply_to lies in event.event.content

    const content = isEncrypted ? event.event.content : event.getContent();
    const relatesTo = content["m.relates_to"];
    return !!(relatesTo && relatesTo["m.in_reply_to"]);
  }

  isAttachment(mxEv) {
    const attachmentTypes = ["m.sticker", "m.image", "m.file", "m.video", "m.audio"];
    return mxEv.getType() === attachmentTypes[0] || attachmentTypes.includes(mxEv.getContent().msgtype);
  }

}

exports.default = Exporter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFeHBvcnRlciIsImNvbnN0cnVjdG9yIiwicm9vbSIsImV4cG9ydFR5cGUiLCJleHBvcnRPcHRpb25zIiwic2V0UHJvZ3Jlc3NUZXh0IiwibWF4U2l6ZSIsIm51bWJlck9mTWVzc2FnZXMiLCJFcnJvciIsImNsaWVudCIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJvbkJlZm9yZVVubG9hZCIsImUiLCJwcmV2ZW50RGVmYXVsdCIsInJldHVyblZhbHVlIiwiX3QiLCJ1cGRhdGVQcm9ncmVzcyIsInByb2dyZXNzIiwibG9nIiwic2hvdyIsImxvZ2dlciIsImFkZEZpbGUiLCJmaWxlUGF0aCIsImJsb2IiLCJmaWxlIiwibmFtZSIsImZpbGVzIiwicHVzaCIsImRvd25sb2FkWklQIiwiYnJhbmQiLCJTZGtDb25maWciLCJmaWxlbmFtZVdpdGhvdXRFeHQiLCJmb3JtYXRGdWxsRGF0ZU5vRGF5IiwiRGF0ZSIsImZpbGVuYW1lIiwiZGVmYXVsdCIsIkpTWmlwIiwiemlwIiwiY2FuY2VsbGVkIiwiY2xlYW5VcCIsImNvbnRlbnQiLCJnZW5lcmF0ZUFzeW5jIiwidHlwZSIsInNhdmVBcyIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJjYW5jZWxFeHBvcnQiLCJkb3dubG9hZFBsYWluVGV4dCIsImZpbGVOYW1lIiwidGV4dCIsIkJsb2IiLCJzZXRFdmVudE1ldGFkYXRhIiwiZXZlbnQiLCJyb29tU3RhdGUiLCJnZXRSb29tIiwicm9vbUlkIiwiY3VycmVudFN0YXRlIiwic2VuZGVyIiwiZ2V0U2VudGluZWxNZW1iZXIiLCJnZXRTZW5kZXIiLCJnZXRUeXBlIiwidGFyZ2V0IiwiZ2V0U3RhdGVLZXkiLCJnZXRMaW1pdCIsImxpbWl0IiwiRXhwb3J0VHlwZSIsIkxhc3ROTWVzc2FnZXMiLCJUaW1lbGluZSIsImdldFJlcXVpcmVkRXZlbnRzIiwiZXZlbnRNYXBwZXIiLCJnZXRFdmVudE1hcHBlciIsInByZXZUb2tlbiIsImV2ZW50cyIsImV2ZW50c1BlckNyYXdsIiwiTWF0aCIsIm1pbiIsInJlcyIsImNyZWF0ZU1lc3NhZ2VzUmVxdWVzdCIsIkRpcmVjdGlvbiIsIkJhY2t3YXJkIiwiY2h1bmsiLCJsZW5ndGgiLCJtYXRyaXhFdmVudHMiLCJtYXAiLCJteEV2IiwiY291bnQiLCJ0b3RhbCIsImVuZCIsImkiLCJmbG9vciIsImRlY3J5cHRpb25Qcm9taXNlcyIsImZpbHRlciIsImlzRW5jcnlwdGVkIiwiZGVjcnlwdEV2ZW50SWZOZWVkZWQiLCJpc1JldHJ5IiwiZW1pdCIsIlByb21pc2UiLCJhbGwiLCJnZXRNZWRpYUJsb2IiLCJnZXRDb250ZW50Iiwic2hvdWxkRGVjcnlwdCIsImhhc093blByb3BlcnR5IiwiZGVjcnlwdEZpbGUiLCJtZWRpYSIsIm1lZGlhRnJvbUNvbnRlbnQiLCJpbWFnZSIsImZldGNoIiwic3JjSHR0cCIsImVyciIsInNwbGl0RmlsZU5hbWUiLCJsYXN0RG90IiwibGFzdEluZGV4T2YiLCJzbGljZSIsImV4dCIsImdldEZpbGVQYXRoIiwibWVkaWFUeXBlIiwibXNndHlwZSIsImZpbGVEaXJlY3RvcnkiLCJmaWxlRGF0ZSIsImdldFRzIiwiZmlsZUV4dCIsImJvZHkiLCJpc1ZvaWNlTWVzc2FnZSIsImlzUmVwbHkiLCJyZWxhdGVzVG8iLCJpc0F0dGFjaG1lbnQiLCJhdHRhY2htZW50VHlwZXMiLCJpbmNsdWRlcyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9leHBvcnRVdGlscy9FeHBvcnRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IERpcmVjdGlvbiB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnQtdGltZWxpbmVcIjtcbmltcG9ydCB7IHNhdmVBcyB9IGZyb20gXCJmaWxlLXNhdmVyXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi8uLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IEV4cG9ydFR5cGUsIElFeHBvcnRPcHRpb25zIH0gZnJvbSBcIi4vZXhwb3J0VXRpbHNcIjtcbmltcG9ydCB7IGRlY3J5cHRGaWxlIH0gZnJvbSBcIi4uL0RlY3J5cHRGaWxlXCI7XG5pbXBvcnQgeyBtZWRpYUZyb21Db250ZW50IH0gZnJvbSBcIi4uLy4uL2N1c3RvbWlzYXRpb25zL01lZGlhXCI7XG5pbXBvcnQgeyBmb3JtYXRGdWxsRGF0ZU5vRGF5IH0gZnJvbSBcIi4uLy4uL0RhdGVVdGlsc1wiO1xuaW1wb3J0IHsgaXNWb2ljZU1lc3NhZ2UgfSBmcm9tIFwiLi4vRXZlbnRVdGlsc1wiO1xuaW1wb3J0IHsgSU1lZGlhRXZlbnRDb250ZW50IH0gZnJvbSBcIi4uLy4uL2N1c3RvbWlzYXRpb25zL21vZGVscy9JTWVkaWFFdmVudENvbnRlbnRcIjtcbmltcG9ydCB7IF90IH0gZnJvbSBcIi4uLy4uL2xhbmd1YWdlSGFuZGxlclwiO1xuaW1wb3J0IFNka0NvbmZpZyBmcm9tIFwiLi4vLi4vU2RrQ29uZmlnXCI7XG5cbnR5cGUgQmxvYkZpbGUgPSB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGJsb2I6IEJsb2I7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhYnN0cmFjdCBjbGFzcyBFeHBvcnRlciB7XG4gICAgcHJvdGVjdGVkIGZpbGVzOiBCbG9iRmlsZVtdID0gW107XG4gICAgcHJvdGVjdGVkIGNsaWVudDogTWF0cml4Q2xpZW50O1xuICAgIHByb3RlY3RlZCBjYW5jZWxsZWQgPSBmYWxzZTtcblxuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIHJvb206IFJvb20sXG4gICAgICAgIHByb3RlY3RlZCBleHBvcnRUeXBlOiBFeHBvcnRUeXBlLFxuICAgICAgICBwcm90ZWN0ZWQgZXhwb3J0T3B0aW9uczogSUV4cG9ydE9wdGlvbnMsXG4gICAgICAgIHByb3RlY3RlZCBzZXRQcm9ncmVzc1RleHQ6IFJlYWN0LkRpc3BhdGNoPFJlYWN0LlNldFN0YXRlQWN0aW9uPHN0cmluZz4+LFxuICAgICkge1xuICAgICAgICBpZiAoZXhwb3J0T3B0aW9ucy5tYXhTaXplIDwgMSAqIDEwMjQgKiAxMDI0fHwgLy8gTGVzcyB0aGFuIDEgTUJcbiAgICAgICAgICAgIGV4cG9ydE9wdGlvbnMubWF4U2l6ZSA+IDgwMDAgKiAxMDI0ICogMTAyNCB8fCAvLyBNb3JlIHRoYW4gOCBHQlxuICAgICAgICAgICAgZXhwb3J0T3B0aW9ucy5udW1iZXJPZk1lc3NhZ2VzID4gMTAqKjhcbiAgICAgICAgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGV4cG9ydCBvcHRpb25zXCIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2xpZW50ID0gTWF0cml4Q2xpZW50UGVnLmdldCgpO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImJlZm9yZXVubG9hZFwiLCB0aGlzLm9uQmVmb3JlVW5sb2FkKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25CZWZvcmVVbmxvYWQoZTogQmVmb3JlVW5sb2FkRXZlbnQpOiBzdHJpbmcge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybiBlLnJldHVyblZhbHVlID0gX3QoXCJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZXhpdCBkdXJpbmcgdGhpcyBleHBvcnQ/XCIpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCB1cGRhdGVQcm9ncmVzcyhwcm9ncmVzczogc3RyaW5nLCBsb2cgPSB0cnVlLCBzaG93ID0gdHJ1ZSk6IHZvaWQge1xuICAgICAgICBpZiAobG9nKSBsb2dnZXIubG9nKHByb2dyZXNzKTtcbiAgICAgICAgaWYgKHNob3cpIHRoaXMuc2V0UHJvZ3Jlc3NUZXh0KHByb2dyZXNzKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYWRkRmlsZShmaWxlUGF0aDogc3RyaW5nLCBibG9iOiBCbG9iKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSB7XG4gICAgICAgICAgICBuYW1lOiBmaWxlUGF0aCxcbiAgICAgICAgICAgIGJsb2IsXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZmlsZXMucHVzaChmaWxlKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgZG93bmxvYWRaSVAoKTogUHJvbWlzZTxzdHJpbmcgfCB2b2lkPiB7XG4gICAgICAgIGNvbnN0IGJyYW5kID0gU2RrQ29uZmlnLmdldCgpLmJyYW5kO1xuICAgICAgICBjb25zdCBmaWxlbmFtZVdpdGhvdXRFeHQgPSBgJHticmFuZH0gLSBDaGF0IEV4cG9ydCAtICR7Zm9ybWF0RnVsbERhdGVOb0RheShuZXcgRGF0ZSgpKX1gO1xuICAgICAgICBjb25zdCBmaWxlbmFtZSA9IGAke2ZpbGVuYW1lV2l0aG91dEV4dH0uemlwYDtcbiAgICAgICAgY29uc3QgeyBkZWZhdWx0OiBKU1ppcCB9ID0gYXdhaXQgaW1wb3J0KCdqc3ppcCcpO1xuXG4gICAgICAgIGNvbnN0IHppcCA9IG5ldyBKU1ppcCgpO1xuICAgICAgICAvLyBDcmVhdGUgYSB3cml0YWJsZSBzdHJlYW0gdG8gdGhlIGRpcmVjdG9yeVxuICAgICAgICBpZiAoIXRoaXMuY2FuY2VsbGVkKSB0aGlzLnVwZGF0ZVByb2dyZXNzKF90KFwiR2VuZXJhdGluZyBhIFpJUFwiKSk7XG4gICAgICAgIGVsc2UgcmV0dXJuIHRoaXMuY2xlYW5VcCgpO1xuXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiB0aGlzLmZpbGVzKSB6aXAuZmlsZShmaWxlbmFtZVdpdGhvdXRFeHQgKyBcIi9cIiArIGZpbGUubmFtZSwgZmlsZS5ibG9iKTtcblxuICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgemlwLmdlbmVyYXRlQXN5bmMoeyB0eXBlOiBcImJsb2JcIiB9KTtcblxuICAgICAgICBzYXZlQXMoY29udGVudCwgZmlsZW5hbWUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjbGVhblVwKCk6IHN0cmluZyB7XG4gICAgICAgIGxvZ2dlci5sb2coXCJDbGVhbmluZyB1cC4uLlwiKTtcbiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJiZWZvcmV1bmxvYWRcIiwgdGhpcy5vbkJlZm9yZVVubG9hZCk7XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjYW5jZWxFeHBvcnQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxvZ2dlci5sb2coXCJDYW5jZWxsaW5nIGV4cG9ydC4uLlwiKTtcbiAgICAgICAgdGhpcy5jYW5jZWxsZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBkb3dubG9hZFBsYWluVGV4dChmaWxlTmFtZTogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgY29udGVudCA9IG5ldyBCbG9iKFt0ZXh0XSwgeyB0eXBlOiBcInRleHQvcGxhaW5cIiB9KTtcbiAgICAgICAgc2F2ZUFzKGNvbnRlbnQsIGZpbGVOYW1lKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2V0RXZlbnRNZXRhZGF0YShldmVudDogTWF0cml4RXZlbnQpOiBNYXRyaXhFdmVudCB7XG4gICAgICAgIGNvbnN0IHJvb21TdGF0ZSA9IHRoaXMuY2xpZW50LmdldFJvb20odGhpcy5yb29tLnJvb21JZCkuY3VycmVudFN0YXRlO1xuICAgICAgICBldmVudC5zZW5kZXIgPSByb29tU3RhdGUuZ2V0U2VudGluZWxNZW1iZXIoXG4gICAgICAgICAgICBldmVudC5nZXRTZW5kZXIoKSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJtLnJvb20ubWVtYmVyXCIpIHtcbiAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IHJvb21TdGF0ZS5nZXRTZW50aW5lbE1lbWJlcihcbiAgICAgICAgICAgICAgICBldmVudC5nZXRTdGF0ZUtleSgpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldExpbWl0KCk6IG51bWJlciB7XG4gICAgICAgIGxldCBsaW1pdDogbnVtYmVyO1xuICAgICAgICBzd2l0Y2ggKHRoaXMuZXhwb3J0VHlwZSkge1xuICAgICAgICAgICAgY2FzZSBFeHBvcnRUeXBlLkxhc3ROTWVzc2FnZXM6XG4gICAgICAgICAgICAgICAgbGltaXQgPSB0aGlzLmV4cG9ydE9wdGlvbnMubnVtYmVyT2ZNZXNzYWdlcztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRXhwb3J0VHlwZS5UaW1lbGluZTpcbiAgICAgICAgICAgICAgICBsaW1pdCA9IDQwO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBsaW1pdCA9IDEwKio4O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsaW1pdDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgZ2V0UmVxdWlyZWRFdmVudHMoKTogUHJvbWlzZTxNYXRyaXhFdmVudFtdPiB7XG4gICAgICAgIGNvbnN0IGV2ZW50TWFwcGVyID0gdGhpcy5jbGllbnQuZ2V0RXZlbnRNYXBwZXIoKTtcblxuICAgICAgICBsZXQgcHJldlRva2VuOiBzdHJpbmd8bnVsbCA9IG51bGw7XG4gICAgICAgIGxldCBsaW1pdCA9IHRoaXMuZ2V0TGltaXQoKTtcbiAgICAgICAgY29uc3QgZXZlbnRzOiBNYXRyaXhFdmVudFtdID0gW107XG5cbiAgICAgICAgd2hpbGUgKGxpbWl0KSB7XG4gICAgICAgICAgICBjb25zdCBldmVudHNQZXJDcmF3bCA9IE1hdGgubWluKGxpbWl0LCAxMDAwKTtcbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY2xpZW50LmNyZWF0ZU1lc3NhZ2VzUmVxdWVzdChcbiAgICAgICAgICAgICAgICB0aGlzLnJvb20ucm9vbUlkLFxuICAgICAgICAgICAgICAgIHByZXZUb2tlbixcbiAgICAgICAgICAgICAgICBldmVudHNQZXJDcmF3bCxcbiAgICAgICAgICAgICAgICBEaXJlY3Rpb24uQmFja3dhcmQsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFuVXAoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZXMuY2h1bmsubGVuZ3RoID09PSAwKSBicmVhaztcblxuICAgICAgICAgICAgbGltaXQgLT0gcmVzLmNodW5rLmxlbmd0aDtcblxuICAgICAgICAgICAgY29uc3QgbWF0cml4RXZlbnRzOiBNYXRyaXhFdmVudFtdID0gcmVzLmNodW5rLm1hcChldmVudE1hcHBlcik7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgbXhFdiBvZiBtYXRyaXhFdmVudHMpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5leHBvcnRPcHRpb25zLnN0YXJ0RGF0ZSAmJiBteEV2LmdldFRzKCkgPCB0aGlzLmV4cG9ydE9wdGlvbnMuc3RhcnREYXRlKSB7XG4gICAgICAgICAgICAgICAgLy8gICAgIC8vIE9uY2UgdGhlIGxhc3QgbWVzc2FnZSByZWNlaXZlZCBpcyBvbGRlciB0aGFuIHRoZSBzdGFydCBkYXRlLCB3ZSBicmVhayBvdXQgb2YgYm90aCB0aGUgbG9vcHNcbiAgICAgICAgICAgICAgICAvLyAgICAgbGltaXQgPSAwO1xuICAgICAgICAgICAgICAgIC8vICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgZXZlbnRzLnB1c2gobXhFdik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmV4cG9ydFR5cGUgPT09IEV4cG9ydFR5cGUuTGFzdE5NZXNzYWdlcykge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3MoX3QoXCJGZXRjaGVkICUoY291bnQpcyBldmVudHMgb3V0IG9mICUodG90YWwpc1wiLCB7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50OiBldmVudHMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICB0b3RhbDogdGhpcy5leHBvcnRPcHRpb25zLm51bWJlck9mTWVzc2FnZXMsXG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVByb2dyZXNzKF90KFwiRmV0Y2hlZCAlKGNvdW50KXMgZXZlbnRzIHNvIGZhclwiLCB7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50OiBldmVudHMubGVuZ3RoLFxuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcHJldlRva2VuID0gcmVzLmVuZDtcbiAgICAgICAgfVxuICAgICAgICAvLyBSZXZlcnNlIHRoZSBldmVudHMgc28gdGhhdCB3ZSBwcmVzZXJ2ZSB0aGUgb3JkZXJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNYXRoLmZsb29yKGV2ZW50cy5sZW5ndGgvMik7IGkrKykge1xuICAgICAgICAgICAgW2V2ZW50c1tpXSwgZXZlbnRzW2V2ZW50cy5sZW5ndGggLSBpIC0gMV1dID0gW2V2ZW50c1tldmVudHMubGVuZ3RoIC0gaSAtIDFdLCBldmVudHNbaV1dO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGVjcnlwdGlvblByb21pc2VzID0gZXZlbnRzXG4gICAgICAgICAgICAuZmlsdGVyKGV2ZW50ID0+IGV2ZW50LmlzRW5jcnlwdGVkKCkpXG4gICAgICAgICAgICAubWFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuZGVjcnlwdEV2ZW50SWZOZWVkZWQoZXZlbnQsIHtcbiAgICAgICAgICAgICAgICAgICAgaXNSZXRyeTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgZW1pdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAvLyBXYWl0IGZvciBhbGwgdGhlIGV2ZW50cyB0byBnZXQgZGVjcnlwdGVkLlxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChkZWNyeXB0aW9uUHJvbWlzZXMpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB0aGlzLnNldEV2ZW50TWV0YWRhdGEoZXZlbnRzW2ldKTtcblxuICAgICAgICByZXR1cm4gZXZlbnRzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhc3luYyBnZXRNZWRpYUJsb2IoZXZlbnQ6IE1hdHJpeEV2ZW50KTogUHJvbWlzZTxCbG9iPiB7XG4gICAgICAgIGxldCBibG9iOiBCbG9iO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaXNFbmNyeXB0ZWQgPSBldmVudC5pc0VuY3J5cHRlZCgpO1xuICAgICAgICAgICAgY29uc3QgY29udGVudDogSU1lZGlhRXZlbnRDb250ZW50ID0gZXZlbnQuZ2V0Q29udGVudCgpO1xuICAgICAgICAgICAgY29uc3Qgc2hvdWxkRGVjcnlwdCA9IGlzRW5jcnlwdGVkICYmIGNvbnRlbnQuaGFzT3duUHJvcGVydHkoXCJmaWxlXCIpICYmIGV2ZW50LmdldFR5cGUoKSAhPT0gXCJtLnN0aWNrZXJcIjtcbiAgICAgICAgICAgIGlmIChzaG91bGREZWNyeXB0KSB7XG4gICAgICAgICAgICAgICAgYmxvYiA9IGF3YWl0IGRlY3J5cHRGaWxlKGNvbnRlbnQuZmlsZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1lZGlhID0gbWVkaWFGcm9tQ29udGVudChjb250ZW50KTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbWFnZSA9IGF3YWl0IGZldGNoKG1lZGlhLnNyY0h0dHApO1xuICAgICAgICAgICAgICAgIGJsb2IgPSBhd2FpdCBpbWFnZS5ibG9iKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhcIkVycm9yIGRlY3J5cHRpbmcgbWVkaWFcIik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGJsb2I7XG4gICAgfVxuXG4gICAgcHVibGljIHNwbGl0RmlsZU5hbWUoZmlsZTogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBsYXN0RG90ID0gZmlsZS5sYXN0SW5kZXhPZignLicpO1xuICAgICAgICBpZiAobGFzdERvdCA9PT0gLTEpIHJldHVybiBbZmlsZSwgXCJcIl07XG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gZmlsZS5zbGljZSgwLCBsYXN0RG90KTtcbiAgICAgICAgY29uc3QgZXh0ID0gZmlsZS5zbGljZShsYXN0RG90ICsgMSk7XG4gICAgICAgIHJldHVybiBbZmlsZU5hbWUsICcuJyArIGV4dF07XG4gICAgfVxuXG4gICAgcHVibGljIGdldEZpbGVQYXRoKGV2ZW50OiBNYXRyaXhFdmVudCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IG1lZGlhVHlwZSA9IGV2ZW50LmdldENvbnRlbnQoKS5tc2d0eXBlO1xuICAgICAgICBsZXQgZmlsZURpcmVjdG9yeTogc3RyaW5nO1xuICAgICAgICBzd2l0Y2ggKG1lZGlhVHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcIm0uaW1hZ2VcIjpcbiAgICAgICAgICAgICAgICBmaWxlRGlyZWN0b3J5ID0gXCJpbWFnZXNcIjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJtLnZpZGVvXCI6XG4gICAgICAgICAgICAgICAgZmlsZURpcmVjdG9yeSA9IFwidmlkZW9zXCI7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwibS5hdWRpb1wiOlxuICAgICAgICAgICAgICAgIGZpbGVEaXJlY3RvcnkgPSBcImF1ZGlvXCI7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGZpbGVEaXJlY3RvcnkgPSBldmVudC5nZXRUeXBlKCkgPT09IFwibS5zdGlja2VyXCIgPyBcInN0aWNrZXJzXCIgOiBcImZpbGVzXCI7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZmlsZURhdGUgPSBmb3JtYXRGdWxsRGF0ZU5vRGF5KG5ldyBEYXRlKGV2ZW50LmdldFRzKCkpKTtcbiAgICAgICAgbGV0IFtmaWxlTmFtZSwgZmlsZUV4dF0gPSB0aGlzLnNwbGl0RmlsZU5hbWUoZXZlbnQuZ2V0Q29udGVudCgpLmJvZHkpO1xuXG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwibS5zdGlja2VyXCIpIGZpbGVFeHQgPSBcIi5wbmdcIjtcbiAgICAgICAgaWYgKGlzVm9pY2VNZXNzYWdlKGV2ZW50KSkgZmlsZUV4dCA9IFwiLm9nZ1wiO1xuXG4gICAgICAgIHJldHVybiBmaWxlRGlyZWN0b3J5ICsgXCIvXCIgKyBmaWxlTmFtZSArICctJyArIGZpbGVEYXRlICsgZmlsZUV4dDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaXNSZXBseShldmVudDogTWF0cml4RXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgaXNFbmNyeXB0ZWQgPSBldmVudC5pc0VuY3J5cHRlZCgpO1xuICAgICAgICAvLyBJZiBlbmNyeXB0ZWQsIGluX3JlcGx5X3RvIGxpZXMgaW4gZXZlbnQuZXZlbnQuY29udGVudFxuICAgICAgICBjb25zdCBjb250ZW50ID0gaXNFbmNyeXB0ZWQgPyBldmVudC5ldmVudC5jb250ZW50IDogZXZlbnQuZ2V0Q29udGVudCgpO1xuICAgICAgICBjb25zdCByZWxhdGVzVG8gPSBjb250ZW50W1wibS5yZWxhdGVzX3RvXCJdO1xuICAgICAgICByZXR1cm4gISEocmVsYXRlc1RvICYmIHJlbGF0ZXNUb1tcIm0uaW5fcmVwbHlfdG9cIl0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpc0F0dGFjaG1lbnQobXhFdjogTWF0cml4RXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgYXR0YWNobWVudFR5cGVzID0gW1wibS5zdGlja2VyXCIsIFwibS5pbWFnZVwiLCBcIm0uZmlsZVwiLCBcIm0udmlkZW9cIiwgXCJtLmF1ZGlvXCJdO1xuICAgICAgICByZXR1cm4gbXhFdi5nZXRUeXBlKCkgPT09IGF0dGFjaG1lbnRUeXBlc1swXSB8fCBhdHRhY2htZW50VHlwZXMuaW5jbHVkZXMobXhFdi5nZXRDb250ZW50KCkubXNndHlwZSk7XG4gICAgfVxuXG4gICAgYWJzdHJhY3QgZXhwb3J0KCk6IFByb21pc2U8dm9pZD47XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBbUJBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7Ozs7QUFPZSxNQUFlQSxRQUFmLENBQXdCO0VBS3pCQyxXQUFXLENBQ1BDLElBRE8sRUFFUEMsVUFGTyxFQUdQQyxhQUhPLEVBSVBDLGVBSk8sRUFLbkI7SUFBQSxLQUpZSCxJQUlaLEdBSllBLElBSVo7SUFBQSxLQUhZQyxVQUdaLEdBSFlBLFVBR1o7SUFBQSxLQUZZQyxhQUVaLEdBRllBLGFBRVo7SUFBQSxLQURZQyxlQUNaLEdBRFlBLGVBQ1o7SUFBQSw2Q0FUNEIsRUFTNUI7SUFBQTtJQUFBLGlEQVBvQixLQU9wQjs7SUFDRSxJQUFJRCxhQUFhLENBQUNFLE9BQWQsR0FBd0IsSUFBSSxJQUFKLEdBQVcsSUFBbkMsSUFBMEM7SUFDMUNGLGFBQWEsQ0FBQ0UsT0FBZCxHQUF3QixPQUFPLElBQVAsR0FBYyxJQUR0QyxJQUM4QztJQUM5Q0YsYUFBYSxDQUFDRyxnQkFBZCxHQUFpQyxNQUFJLENBRnpDLEVBR0U7TUFDRSxNQUFNLElBQUlDLEtBQUosQ0FBVSx3QkFBVixDQUFOO0lBQ0g7O0lBQ0QsS0FBS0MsTUFBTCxHQUFjQyxnQ0FBQSxDQUFnQkMsR0FBaEIsRUFBZDtJQUNBQyxNQUFNLENBQUNDLGdCQUFQLENBQXdCLGNBQXhCLEVBQXdDLEtBQUtDLGNBQTdDO0VBQ0g7O0VBRVNBLGNBQWMsQ0FBQ0MsQ0FBRCxFQUErQjtJQUNuREEsQ0FBQyxDQUFDQyxjQUFGO0lBQ0EsT0FBT0QsQ0FBQyxDQUFDRSxXQUFGLEdBQWdCLElB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