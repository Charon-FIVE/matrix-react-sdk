"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _exportCustomCSS = _interopRequireDefault(require("!!raw-loader!./exportCustomCSS.css"));

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const cssSelectorTextClassesRegex = /\.[\w-]+/g;

function mutateCssText(css) {
  // replace used fonts so that we don't have to bundle Inter & Inconsalata
  return css.replace(/font-family: ?(Inter|'Inter'|"Inter")/g, `font-family: -apple-system, BlinkMacSystemFont, avenir next,
            avenir, segoe ui, helvetica neue, helvetica, Ubuntu, roboto, noto, arial, sans-serif`).replace(/font-family: ?Inconsolata/g, "font-family: Menlo, Consolas, Monaco, Liberation Mono, Lucida Console, monospace");
}

function isLightTheme(sheet) {
  return sheet.ownerNode.dataset.mxTheme?.toLowerCase() === "light";
}

async function getRulesFromCssFile(path) {
  const doc = document.implementation.createHTMLDocument("");
  const styleElement = document.createElement("style");
  const res = await fetch(path);
  styleElement.textContent = await res.text(); // the style will only be parsed once it is added to a document

  doc.body.appendChild(styleElement);
  return styleElement.sheet;
} // naively culls unused css rules based on which classes are present in the html,
// doesn't cull rules which won't apply due to the full selector not matching but gets rid of a LOT of cruft anyway.


const getExportCSS = async usedClasses => {
  // only include bundle.css and the data-mx-theme=light styling
  const stylesheets = Array.from(document.styleSheets).filter(s => {
    return s.href?.endsWith("bundle.css") || isLightTheme(s);
  }); // If the light theme isn't loaded we will have to fetch & parse it manually

  if (!stylesheets.some(isLightTheme)) {
    const href = document.querySelector('link[rel="stylesheet"][href$="theme-light.css"]').href;
    stylesheets.push(await getRulesFromCssFile(href));
  }

  let css = "";

  for (const stylesheet of stylesheets) {
    for (const rule of stylesheet.cssRules) {
      if (rule instanceof CSSFontFaceRule) continue; // we don't want to bundle any fonts

      const selectorText = rule.selectorText; // only skip the rule if all branches (,) of the selector are redundant

      if (selectorText?.split(",").every(selector => {
        const classes = selector.match(cssSelectorTextClassesRegex);

        if (classes && !classes.every(c => usedClasses.has(c.substring(1)))) {
          return true; // signal as a redundant selector
        }
      })) {
        continue; // skip this rule as it is redundant
      }

      css += mutateCssText(rule.cssText) + "\n";
    }
  }

  return css + _exportCustomCSS.default;
};

var _default = getExportCSS;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjc3NTZWxlY3RvclRleHRDbGFzc2VzUmVnZXgiLCJtdXRhdGVDc3NUZXh0IiwiY3NzIiwicmVwbGFjZSIsImlzTGlnaHRUaGVtZSIsInNoZWV0Iiwib3duZXJOb2RlIiwiZGF0YXNldCIsIm14VGhlbWUiLCJ0b0xvd2VyQ2FzZSIsImdldFJ1bGVzRnJvbUNzc0ZpbGUiLCJwYXRoIiwiZG9jIiwiZG9jdW1lbnQiLCJpbXBsZW1lbnRhdGlvbiIsImNyZWF0ZUhUTUxEb2N1bWVudCIsInN0eWxlRWxlbWVudCIsImNyZWF0ZUVsZW1lbnQiLCJyZXMiLCJmZXRjaCIsInRleHRDb250ZW50IiwidGV4dCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsImdldEV4cG9ydENTUyIsInVzZWRDbGFzc2VzIiwic3R5bGVzaGVldHMiLCJBcnJheSIsImZyb20iLCJzdHlsZVNoZWV0cyIsImZpbHRlciIsInMiLCJocmVmIiwiZW5kc1dpdGgiLCJzb21lIiwicXVlcnlTZWxlY3RvciIsInB1c2giLCJzdHlsZXNoZWV0IiwicnVsZSIsImNzc1J1bGVzIiwiQ1NTRm9udEZhY2VSdWxlIiwic2VsZWN0b3JUZXh0Iiwic3BsaXQiLCJldmVyeSIsInNlbGVjdG9yIiwiY2xhc3NlcyIsIm1hdGNoIiwiYyIsImhhcyIsInN1YnN0cmluZyIsImNzc1RleHQiLCJjdXN0b21DU1MiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdXRpbHMvZXhwb3J0VXRpbHMvZXhwb3J0Q1NTLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IGN1c3RvbUNTUyBmcm9tIFwiISFyYXctbG9hZGVyIS4vZXhwb3J0Q3VzdG9tQ1NTLmNzc1wiO1xuXG5jb25zdCBjc3NTZWxlY3RvclRleHRDbGFzc2VzUmVnZXggPSAvXFwuW1xcdy1dKy9nO1xuXG5mdW5jdGlvbiBtdXRhdGVDc3NUZXh0KGNzczogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyByZXBsYWNlIHVzZWQgZm9udHMgc28gdGhhdCB3ZSBkb24ndCBoYXZlIHRvIGJ1bmRsZSBJbnRlciAmIEluY29uc2FsYXRhXG4gICAgcmV0dXJuIGNzc1xuICAgICAgICAucmVwbGFjZShcbiAgICAgICAgICAgIC9mb250LWZhbWlseTogPyhJbnRlcnwnSW50ZXInfFwiSW50ZXJcIikvZyxcbiAgICAgICAgICAgIGBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBhdmVuaXIgbmV4dCxcbiAgICAgICAgICAgIGF2ZW5pciwgc2Vnb2UgdWksIGhlbHZldGljYSBuZXVlLCBoZWx2ZXRpY2EsIFVidW50dSwgcm9ib3RvLCBub3RvLCBhcmlhbCwgc2Fucy1zZXJpZmAsXG4gICAgICAgIClcbiAgICAgICAgLnJlcGxhY2UoXG4gICAgICAgICAgICAvZm9udC1mYW1pbHk6ID9JbmNvbnNvbGF0YS9nLFxuICAgICAgICAgICAgXCJmb250LWZhbWlseTogTWVubG8sIENvbnNvbGFzLCBNb25hY28sIExpYmVyYXRpb24gTW9ubywgTHVjaWRhIENvbnNvbGUsIG1vbm9zcGFjZVwiLFxuICAgICAgICApO1xufVxuXG5mdW5jdGlvbiBpc0xpZ2h0VGhlbWUoc2hlZXQ6IENTU1N0eWxlU2hlZXQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKDxIVE1MU3R5bGVFbGVtZW50PnNoZWV0Lm93bmVyTm9kZSkuZGF0YXNldC5teFRoZW1lPy50b0xvd2VyQ2FzZSgpID09PSBcImxpZ2h0XCI7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJ1bGVzRnJvbUNzc0ZpbGUocGF0aDogc3RyaW5nKTogUHJvbWlzZTxDU1NTdHlsZVNoZWV0PiB7XG4gICAgY29uc3QgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KFwiXCIpO1xuICAgIGNvbnN0IHN0eWxlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzdHlsZVwiKTtcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHBhdGgpO1xuICAgIHN0eWxlRWxlbWVudC50ZXh0Q29udGVudCA9IGF3YWl0IHJlcy50ZXh0KCk7XG4gICAgLy8gdGhlIHN0eWxlIHdpbGwgb25seSBiZSBwYXJzZWQgb25jZSBpdCBpcyBhZGRlZCB0byBhIGRvY3VtZW50XG4gICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoc3R5bGVFbGVtZW50KTtcblxuICAgIHJldHVybiBzdHlsZUVsZW1lbnQuc2hlZXQ7XG59XG5cbi8vIG5haXZlbHkgY3VsbHMgdW51c2VkIGNzcyBydWxlcyBiYXNlZCBvbiB3aGljaCBjbGFzc2VzIGFyZSBwcmVzZW50IGluIHRoZSBodG1sLFxuLy8gZG9lc24ndCBjdWxsIHJ1bGVzIHdoaWNoIHdvbid0IGFwcGx5IGR1ZSB0byB0aGUgZnVsbCBzZWxlY3RvciBub3QgbWF0Y2hpbmcgYnV0IGdldHMgcmlkIG9mIGEgTE9UIG9mIGNydWZ0IGFueXdheS5cbmNvbnN0IGdldEV4cG9ydENTUyA9IGFzeW5jICh1c2VkQ2xhc3NlczogU2V0PHN0cmluZz4pOiBQcm9taXNlPHN0cmluZz4gPT4ge1xuICAgIC8vIG9ubHkgaW5jbHVkZSBidW5kbGUuY3NzIGFuZCB0aGUgZGF0YS1teC10aGVtZT1saWdodCBzdHlsaW5nXG4gICAgY29uc3Qgc3R5bGVzaGVldHMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnN0eWxlU2hlZXRzKS5maWx0ZXIocyA9PiB7XG4gICAgICAgIHJldHVybiBzLmhyZWY/LmVuZHNXaXRoKFwiYnVuZGxlLmNzc1wiKSB8fCBpc0xpZ2h0VGhlbWUocyk7XG4gICAgfSk7XG5cbiAgICAvLyBJZiB0aGUgbGlnaHQgdGhlbWUgaXNuJ3QgbG9hZGVkIHdlIHdpbGwgaGF2ZSB0byBmZXRjaCAmIHBhcnNlIGl0IG1hbnVhbGx5XG4gICAgaWYgKCFzdHlsZXNoZWV0cy5zb21lKGlzTGlnaHRUaGVtZSkpIHtcbiAgICAgICAgY29uc3QgaHJlZiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTExpbmtFbGVtZW50PignbGlua1tyZWw9XCJzdHlsZXNoZWV0XCJdW2hyZWYkPVwidGhlbWUtbGlnaHQuY3NzXCJdJykuaHJlZjtcbiAgICAgICAgc3R5bGVzaGVldHMucHVzaChhd2FpdCBnZXRSdWxlc0Zyb21Dc3NGaWxlKGhyZWYpKTtcbiAgICB9XG5cbiAgICBsZXQgY3NzID0gXCJcIjtcbiAgICBmb3IgKGNvbnN0IHN0eWxlc2hlZXQgb2Ygc3R5bGVzaGVldHMpIHtcbiAgICAgICAgZm9yIChjb25zdCBydWxlIG9mIHN0eWxlc2hlZXQuY3NzUnVsZXMpIHtcbiAgICAgICAgICAgIGlmIChydWxlIGluc3RhbmNlb2YgQ1NTRm9udEZhY2VSdWxlKSBjb250aW51ZTsgLy8gd2UgZG9uJ3Qgd2FudCB0byBidW5kbGUgYW55IGZvbnRzXG5cbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdG9yVGV4dCA9IChydWxlIGFzIENTU1N0eWxlUnVsZSkuc2VsZWN0b3JUZXh0O1xuXG4gICAgICAgICAgICAvLyBvbmx5IHNraXAgdGhlIHJ1bGUgaWYgYWxsIGJyYW5jaGVzICgsKSBvZiB0aGUgc2VsZWN0b3IgYXJlIHJlZHVuZGFudFxuICAgICAgICAgICAgaWYgKHNlbGVjdG9yVGV4dD8uc3BsaXQoXCIsXCIpLmV2ZXJ5KHNlbGVjdG9yID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjbGFzc2VzID0gc2VsZWN0b3IubWF0Y2goY3NzU2VsZWN0b3JUZXh0Q2xhc3Nlc1JlZ2V4KTtcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NlcyAmJiAhY2xhc3Nlcy5ldmVyeShjID0+IHVzZWRDbGFzc2VzLmhhcyhjLnN1YnN0cmluZygxKSkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBzaWduYWwgYXMgYSByZWR1bmRhbnQgc2VsZWN0b3JcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlOyAvLyBza2lwIHRoaXMgcnVsZSBhcyBpdCBpcyByZWR1bmRhbnRcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY3NzICs9IG11dGF0ZUNzc1RleHQocnVsZS5jc3NUZXh0KSArIFwiXFxuXCI7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY3NzICsgY3VzdG9tQ1NTO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgZ2V0RXhwb3J0Q1NTO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFnQkE7O0FBaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUlBLE1BQU1BLDJCQUEyQixHQUFHLFdBQXBDOztBQUVBLFNBQVNDLGFBQVQsQ0FBdUJDLEdBQXZCLEVB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