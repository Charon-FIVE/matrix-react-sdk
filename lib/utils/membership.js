"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.EffectiveMembership = void 0;
exports.getEffectiveMembership = getEffectiveMembership;
exports.isJoinedOrNearlyJoined = isJoinedOrNearlyJoined;
exports.splitRoomsByMembership = splitRoomsByMembership;
exports.waitForMember = waitForMember;

var _roomState = require("matrix-js-sdk/src/models/room-state");

/*
Copyright 2020 - 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Approximation of a membership status for a given room.
 */
let EffectiveMembership;
exports.EffectiveMembership = EffectiveMembership;

(function (EffectiveMembership) {
  EffectiveMembership["Join"] = "JOIN";
  EffectiveMembership["Invite"] = "INVITE";
  EffectiveMembership["Leave"] = "LEAVE";
})(EffectiveMembership || (exports.EffectiveMembership = EffectiveMembership = {}));

function splitRoomsByMembership(rooms) {
  const split = {
    [EffectiveMembership.Invite]: [],
    [EffectiveMembership.Join]: [],
    [EffectiveMembership.Leave]: []
  };

  for (const room of rooms) {
    split[getEffectiveMembership(room.getMyMembership())].push(room);
  }

  return split;
}

function getEffectiveMembership(membership) {
  if (membership === 'invite') {
    return EffectiveMembership.Invite;
  } else if (membership === 'join') {
    // TODO: Include knocks? Update docs as needed in the enum. https://github.com/vector-im/element-web/issues/14237
    return EffectiveMembership.Join;
  } else {
    // Probably a leave, kick, or ban
    return EffectiveMembership.Leave;
  }
}

function isJoinedOrNearlyJoined(membership) {
  const effective = getEffectiveMembership(membership);
  return effective === EffectiveMembership.Join || effective === EffectiveMembership.Invite;
}
/**
 * Try to ensure the user is already in the megolm session before continuing
 * NOTE: this assumes you've just created the room and there's not been an opportunity
 * for other code to run, so we shouldn't miss RoomState.newMember when it comes by.
 */


async function waitForMember(client, roomId, userId) {
  let opts = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {
    timeout: 1500
  };
  const {
    timeout
  } = opts;
  let handler;
  return new Promise(resolve => {
    handler = function (_, __, member) {
      // eslint-disable-line @typescript-eslint/naming-convention
      if (member.userId !== userId) return;
      if (member.roomId !== roomId) return;
      resolve(true);
    };

    client.on(_roomState.RoomStateEvent.NewMember, handler);
    /* We don't want to hang if this goes wrong, so we proceed and hope the other
       user is already in the megolm session */

    setTimeout(resolve, timeout, false);
  }).finally(() => {
    client.removeListener(_roomState.RoomStateEvent.NewMember, handler);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFZmZlY3RpdmVNZW1iZXJzaGlwIiwic3BsaXRSb29tc0J5TWVtYmVyc2hpcCIsInJvb21zIiwic3BsaXQiLCJJbnZpdGUiLCJKb2luIiwiTGVhdmUiLCJyb29tIiwiZ2V0RWZmZWN0aXZlTWVtYmVyc2hpcCIsImdldE15TWVtYmVyc2hpcCIsInB1c2giLCJtZW1iZXJzaGlwIiwiaXNKb2luZWRPck5lYXJseUpvaW5lZCIsImVmZmVjdGl2ZSIsIndhaXRGb3JNZW1iZXIiLCJjbGllbnQiLCJyb29tSWQiLCJ1c2VySWQiLCJvcHRzIiwidGltZW91dCIsImhhbmRsZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsIl8iLCJfXyIsIm1lbWJlciIsIm9uIiwiUm9vbVN0YXRlRXZlbnQiLCJOZXdNZW1iZXIiLCJzZXRUaW1lb3V0IiwiZmluYWxseSIsInJlbW92ZUxpc3RlbmVyIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL21lbWJlcnNoaXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIwIC0gMjAyMiBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCB7IFJvb20gfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb21cIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IFJvb21NZW1iZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20tbWVtYmVyXCI7XG5pbXBvcnQgeyBSb29tU3RhdGVFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbS1zdGF0ZVwiO1xuXG4vKipcbiAqIEFwcHJveGltYXRpb24gb2YgYSBtZW1iZXJzaGlwIHN0YXR1cyBmb3IgYSBnaXZlbiByb29tLlxuICovXG5leHBvcnQgZW51bSBFZmZlY3RpdmVNZW1iZXJzaGlwIHtcbiAgICAvKipcbiAgICAgKiBUaGUgdXNlciBpcyBlZmZlY3RpdmVseSBqb2luZWQgdG8gdGhlIHJvb20uIEZvciBleGFtcGxlLCBhY3R1YWxseSBqb2luZWRcbiAgICAgKiBvciBrbm9ja2luZyBvbiB0aGUgcm9vbSAod2hlbiB0aGF0IGJlY29tZXMgcG9zc2libGUpLlxuICAgICAqL1xuICAgIEpvaW4gPSBcIkpPSU5cIixcblxuICAgIC8qKlxuICAgICAqIFRoZSB1c2VyIGlzIGVmZmVjdGl2ZWx5IGludml0ZWQgdG8gdGhlIHJvb20uIEN1cnJlbnRseSB0aGlzIGlzIGEgZGlyZWN0IG1hcFxuICAgICAqIHRvIHRoZSBpbnZpdGUgbWVtYmVyc2hpcCBhcyBubyBvdGhlciBtZW1iZXJzaGlwIHN0YXRlcyBhcmUgZWZmZWN0aXZlbHlcbiAgICAgKiBpbnZpdGVzLlxuICAgICAqL1xuICAgIEludml0ZSA9IFwiSU5WSVRFXCIsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgdXNlciBpcyBlZmZlY3RpdmVseSBubyBsb25nZXIgaW4gdGhlIHJvb20uIEZvciBleGFtcGxlLCBraWNrZWQsXG4gICAgICogYmFubmVkLCBvciB2b2x1bnRhcmlseSBsZWZ0LlxuICAgICAqL1xuICAgIExlYXZlID0gXCJMRUFWRVwiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1lbWJlcnNoaXBTcGxpdCB7XG4gICAgLy8gQHRzLWlnbm9yZSAtIFRTIHdhbnRzIHRoaXMgdG8gYmUgYSBzdHJpbmcga2V5LCBidXQgd2Uga25vdyBiZXR0ZXIuXG4gICAgW3N0YXRlOiBFZmZlY3RpdmVNZW1iZXJzaGlwXTogUm9vbVtdO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3BsaXRSb29tc0J5TWVtYmVyc2hpcChyb29tczogUm9vbVtdKTogTWVtYmVyc2hpcFNwbGl0IHtcbiAgICBjb25zdCBzcGxpdDogTWVtYmVyc2hpcFNwbGl0ID0ge1xuICAgICAgICBbRWZmZWN0aXZlTWVtYmVyc2hpcC5JbnZpdGVdOiBbXSxcbiAgICAgICAgW0VmZmVjdGl2ZU1lbWJlcnNoaXAuSm9pbl06IFtdLFxuICAgICAgICBbRWZmZWN0aXZlTWVtYmVyc2hpcC5MZWF2ZV06IFtdLFxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IHJvb20gb2Ygcm9vbXMpIHtcbiAgICAgICAgc3BsaXRbZ2V0RWZmZWN0aXZlTWVtYmVyc2hpcChyb29tLmdldE15TWVtYmVyc2hpcCgpKV0ucHVzaChyb29tKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3BsaXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFZmZlY3RpdmVNZW1iZXJzaGlwKG1lbWJlcnNoaXA6IHN0cmluZyk6IEVmZmVjdGl2ZU1lbWJlcnNoaXAge1xuICAgIGlmIChtZW1iZXJzaGlwID09PSAnaW52aXRlJykge1xuICAgICAgICByZXR1cm4gRWZmZWN0aXZlTWVtYmVyc2hpcC5JbnZpdGU7XG4gICAgfSBlbHNlIGlmIChtZW1iZXJzaGlwID09PSAnam9pbicpIHtcbiAgICAgICAgLy8gVE9ETzogSW5jbHVkZSBrbm9ja3M/IFVwZGF0ZSBkb2NzIGFzIG5lZWRlZCBpbiB0aGUgZW51bS4gaHR0cHM6Ly9naXRodWIuY29tL3ZlY3Rvci1pbS9lbGVtZW50LXdlYi9pc3N1ZXMvMTQyMzdcbiAgICAgICAgcmV0dXJuIEVmZmVjdGl2ZU1lbWJlcnNoaXAuSm9pbjtcbiAgICB9IGVsc2Uge1xuICAgICAgICAvLyBQcm9iYWJseSBhIGxlYXZlLCBraWNrLCBvciBiYW5cbiAgICAgICAgcmV0dXJuIEVmZmVjdGl2ZU1lbWJlcnNoaXAuTGVhdmU7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNKb2luZWRPck5lYXJseUpvaW5lZChtZW1iZXJzaGlwOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBlZmZlY3RpdmUgPSBnZXRFZmZlY3RpdmVNZW1iZXJzaGlwKG1lbWJlcnNoaXApO1xuICAgIHJldHVybiBlZmZlY3RpdmUgPT09IEVmZmVjdGl2ZU1lbWJlcnNoaXAuSm9pbiB8fCBlZmZlY3RpdmUgPT09IEVmZmVjdGl2ZU1lbWJlcnNoaXAuSW52aXRlO1xufVxuXG4vKipcbiAqIFRyeSB0byBlbnN1cmUgdGhlIHVzZXIgaXMgYWxyZWFkeSBpbiB0aGUgbWVnb2xtIHNlc3Npb24gYmVmb3JlIGNvbnRpbnVpbmdcbiAqIE5PVEU6IHRoaXMgYXNzdW1lcyB5b3UndmUganVzdCBjcmVhdGVkIHRoZSByb29tIGFuZCB0aGVyZSdzIG5vdCBiZWVuIGFuIG9wcG9ydHVuaXR5XG4gKiBmb3Igb3RoZXIgY29kZSB0byBydW4sIHNvIHdlIHNob3VsZG4ndCBtaXNzIFJvb21TdGF0ZS5uZXdNZW1iZXIgd2hlbiBpdCBjb21lcyBieS5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JNZW1iZXIoY2xpZW50OiBNYXRyaXhDbGllbnQsIHJvb21JZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZywgb3B0cyA9IHsgdGltZW91dDogMTUwMCB9KSB7XG4gICAgY29uc3QgeyB0aW1lb3V0IH0gPSBvcHRzO1xuICAgIGxldCBoYW5kbGVyO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24oXywgX18sIG1lbWJlcjogUm9vbU1lbWJlcikgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICAgICAgICAgICAgaWYgKG1lbWJlci51c2VySWQgIT09IHVzZXJJZCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKG1lbWJlci5yb29tSWQgIT09IHJvb21JZCkgcmV0dXJuO1xuICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfTtcbiAgICAgICAgY2xpZW50Lm9uKFJvb21TdGF0ZUV2ZW50Lk5ld01lbWJlciwgaGFuZGxlcik7XG5cbiAgICAgICAgLyogV2UgZG9uJ3Qgd2FudCB0byBoYW5nIGlmIHRoaXMgZ29lcyB3cm9uZywgc28gd2UgcHJvY2VlZCBhbmQgaG9wZSB0aGUgb3RoZXJcbiAgICAgICAgICAgdXNlciBpcyBhbHJlYWR5IGluIHRoZSBtZWdvbG0gc2Vzc2lvbiAqL1xuICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQsIGZhbHNlKTtcbiAgICB9KS5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgY2xpZW50LnJlbW92ZUxpc3RlbmVyKFJvb21TdGF0ZUV2ZW50Lk5ld01lbWJlciwgaGFuZGxlcik7XG4gICAgfSk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBbUJBOztBQW5CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBT0E7QUFDQTtBQUNBO0lBQ1lBLG1COzs7V0FBQUEsbUI7RUFBQUEsbUI7RUFBQUEsbUI7RUFBQUEsbUI7R0FBQUEsbUIsbUNBQUFBLG1COztBQTBCTCxTQUFTQyxzQkFBVCxDQUFnQ0MsS0FBaEMsRUFBZ0U7RUFDbkUsTUFBTUMsS0FBc0IsR0FBRztJQUMzQixDQUFDSCxtQkFBbUIsQ0FBQ0ksTUFBckIsR0FBOEIsRUFESDtJQUUzQixDQUFDSixtQkFBbUIsQ0FBQ0ssSUFBckIsR0FBNEIsRUFGRDtJQUczQixDQUFDTCxtQkFBbUIsQ0FBQ00sS0FBckIsR0FBNkI7RUFIRixDQUEvQjs7RUFNQSxLQUFLLE1BQU1DLElBQVgsSUFBbUJMLEtBQW5CLEVBQTBCO0lBQ3RCQyxLQUFLLENBQUNLLHNCQUFzQixDQUFDRCxJQUFJLENBQUNFLGVBQUwsRUFBRCxDQUF2QixDQUFMLENBQXNEQyxJQUF0RCxDQUEyREgsSUFBM0Q7RUFDSDs7RUFFRCxPQUFPSixLQUFQO0FBQ0g7O0FBRU0sU0FBU0ssc0JBQVQsQ0FBZ0NHLFVBQWhDLEVBQXlFO0VBQzVFLElBQUlBLFVBQVUsS0FBSyxRQUFuQixFQUE2QjtJQUN6QixPQUFPWCxtQkFBbUIsQ0FBQ0ksTUFBM0I7RUFDSCxDQUZELE1BRU8sSUFBSU8sVUFBVSxLQUFLLE1BQW5CLEVBQTJCO0lBQzlCO0lBQ0EsT0FBT1gsbUJBQW1CLENBQUNLLElBQTNCO0VBQ0gsQ0FITSxNQUdBO0lBQ0g7SUFDQSxPQUFPTCxtQkFBbUIsQ0FBQ00sS0FBM0I7RUFDSDtBQUNKOztBQUVNLFNBQVNNLHNCQUFULENBQWdDRCxVQUFoQyxFQUE2RDtFQUNoRSxNQUFNRSxTQUFTLEdBQUdMLHNCQUFzQixDQUFDRyxVQUFELENBQXhDO0VBQ0EsT0FBT0UsU0FBUyxLQUFLYixtQkFBbUIsQ0FBQ0ssSUFBbEMsSUFBMENRLFNBQVMsS0FBS2IsbUJBQW1CLENBQUNJLE1BQW5GO0FBQ0g7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDTyxlQUFlVSxhQUFmLENBQTZCQyxNQUE3QixFQUFtREMsTUFBbkQsRUFBbUVDLE1BQW5FLEVBQTZHO0VBQUEsSUFBMUJDLElBQTBCLHVFQUFuQjtJQUFFQyxPQUFPLEVBQUU7RUFBWCxDQUFtQjtFQUNoSCxNQUFNO0lBQUVBO0VBQUYsSUFBY0QsSUFBcEI7RUFDQSxJQUFJRSxPQUFKO0VBQ0EsT0FBTyxJQUFJQyxPQUFKLENBQWFDLE9BQUQsSUFBYTtJQUM1QkYsT0FBTyxHQUFHLFVBQVNHLENBQVQsRUFBWUMsRUFBWixFQUFnQkMsTUFBaEIsRUFBb0M7TUFBRTtNQUM1QyxJQUFJQSxNQUFNLENBQUNSLE1BQVAsS0FBa0JBLE1BQXRCLEVBQThCO01BQzlCLElBQUlRLE1BQU0sQ0FBQ1QsTUFBUCxLQUFrQkEsTUFBdEIsRUFBOEI7TUFDOUJNLE9BQU8sQ0FBQyxJQUFELENBQVA7SUFDSCxDQUpEOztJQUtBUCxNQUFNLENBQUNXLEVBQVAsQ0FBVUMseUJBQUEsQ0FBZUMsU0FBekIsRUFBb0NSLE9BQXBDO0lBRUE7QUFDUjs7SUFDUVMsVUFBVSxDQUFDUCxPQUFELEVBQVVILE9BQVYsRUFBbUIsS0FBbkIsQ0FBVjtFQUNILENBWE0sRUFXSlcsT0FYSSxDQVdJLE1BQU07SUFDYmYsTUFBTSxDQUFDZ0IsY0FBUCxDQUFzQkoseUJBQUEsQ0FBZUMsU0FBckMsRUFBZ0RSLE9BQWhEO0VBQ0gsQ0FiTSxDQUFQO0FBY0gifQ==