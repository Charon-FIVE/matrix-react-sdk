"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startDm = startDm;

var _actions = require("../../dispatcher/actions");

var _directMessages = require("../direct-messages");

var _DMRoomMap = _interopRequireDefault(require("../DMRoomMap"));

var _isLocalRoom = require("../localRoom/isLocalRoom");

var _findDMForUser = require("./findDMForUser");

var _dispatcher = _interopRequireDefault(require("../../dispatcher/dispatcher"));

var _UserAddress = require("../../UserAddress");

var _createRoom = _interopRequireDefault(require("../../createRoom"));

/*
Copyright 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Start a DM.
 *
 * @returns {Promise<string | null} Resolves to the room id.
 */
async function startDm(client, targets) {
  let showSpinner = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;
  const targetIds = targets.map(t => t.userId); // Check if there is already a DM with these people and reuse it if possible.

  let existingRoom;

  if (targetIds.length === 1) {
    existingRoom = (0, _findDMForUser.findDMForUser)(client, targetIds[0]);
  } else {
    existingRoom = _DMRoomMap.default.shared().getDMRoomForIdentifiers(targetIds);
  }

  if (existingRoom && !(0, _isLocalRoom.isLocalRoom)(existingRoom)) {
    _dispatcher.default.dispatch({
      action: _actions.Action.ViewRoom,
      room_id: existingRoom.roomId,
      should_peek: false,
      joining: false,
      metricsTrigger: "MessageUser"
    });

    return Promise.resolve(existingRoom.roomId);
  }

  const createRoomOptions = {
    inlineErrors: true
  }; // XXX: Type out `createRoomOptions`

  if (await (0, _directMessages.determineCreateRoomEncryptionOption)(client, targets)) {
    createRoomOptions.encryption = true;
  } // Check if it's a traditional DM and create the room if required.
  // TODO: [Canonical DMs] Remove this check and instead just create the multi-person DM


  const isSelf = targetIds.length === 1 && targetIds[0] === client.getUserId();

  if (targetIds.length === 1 && !isSelf) {
    createRoomOptions.dmUserId = targetIds[0];
  }

  if (targetIds.length > 1) {
    createRoomOptions.createOpts = targetIds.reduce((roomOptions, address) => {
      const type = (0, _UserAddress.getAddressType)(address);

      if (type === 'email') {
        const invite = {
          id_server: client.getIdentityServerUrl(true),
          medium: 'email',
          address
        };
        roomOptions.invite_3pid.push(invite);
      } else if (type === 'mx-user-id') {
        roomOptions.invite.push(address);
      }

      return roomOptions;
    }, {
      invite: [],
      invite_3pid: []
    });
  }

  createRoomOptions.spinner = showSpinner;
  return (0, _createRoom.default)(createRoomOptions);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzdGFydERtIiwiY2xpZW50IiwidGFyZ2V0cyIsInNob3dTcGlubmVyIiwidGFyZ2V0SWRzIiwibWFwIiwidCIsInVzZXJJZCIsImV4aXN0aW5nUm9vbSIsImxlbmd0aCIsImZpbmRETUZvclVzZXIiLCJETVJvb21NYXAiLCJzaGFyZWQiLCJnZXRETVJvb21Gb3JJZGVudGlmaWVycyIsImlzTG9jYWxSb29tIiwiZGlzIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJWaWV3Um9vbSIsInJvb21faWQiLCJyb29tSWQiLCJzaG91bGRfcGVlayIsImpvaW5pbmciLCJtZXRyaWNzVHJpZ2dlciIsIlByb21pc2UiLCJyZXNvbHZlIiwiY3JlYXRlUm9vbU9wdGlvbnMiLCJpbmxpbmVFcnJvcnMiLCJkZXRlcm1pbmVDcmVhdGVSb29tRW5jcnlwdGlvbk9wdGlvbiIsImVuY3J5cHRpb24iLCJpc1NlbGYiLCJnZXRVc2VySWQiLCJkbVVzZXJJZCIsImNyZWF0ZU9wdHMiLCJyZWR1Y2UiLCJyb29tT3B0aW9ucyIsImFkZHJlc3MiLCJ0eXBlIiwiZ2V0QWRkcmVzc1R5cGUiLCJpbnZpdGUiLCJpZF9zZXJ2ZXIiLCJnZXRJZGVudGl0eVNlcnZlclVybCIsIm1lZGl1bSIsImludml0ZV8zcGlkIiwicHVzaCIsInNwaW5uZXIiLCJjcmVhdGVSb29tIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL2RtL3N0YXJ0RG0udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIyIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHsgSUludml0ZTNQSUQsIE1hdHJpeENsaWVudCwgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tYXRyaXhcIjtcblxuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uLy4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IHsgVmlld1Jvb21QYXlsb2FkIH0gZnJvbSBcIi4uLy4uL2Rpc3BhdGNoZXIvcGF5bG9hZHMvVmlld1Jvb21QYXlsb2FkXCI7XG5pbXBvcnQgeyBkZXRlcm1pbmVDcmVhdGVSb29tRW5jcnlwdGlvbk9wdGlvbiwgTWVtYmVyIH0gZnJvbSBcIi4uL2RpcmVjdC1tZXNzYWdlc1wiO1xuaW1wb3J0IERNUm9vbU1hcCBmcm9tIFwiLi4vRE1Sb29tTWFwXCI7XG5pbXBvcnQgeyBpc0xvY2FsUm9vbSB9IGZyb20gXCIuLi9sb2NhbFJvb20vaXNMb2NhbFJvb21cIjtcbmltcG9ydCB7IGZpbmRETUZvclVzZXIgfSBmcm9tIFwiLi9maW5kRE1Gb3JVc2VyXCI7XG5pbXBvcnQgZGlzIGZyb20gXCIuLi8uLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCB7IGdldEFkZHJlc3NUeXBlIH0gZnJvbSBcIi4uLy4uL1VzZXJBZGRyZXNzXCI7XG5pbXBvcnQgY3JlYXRlUm9vbSBmcm9tIFwiLi4vLi4vY3JlYXRlUm9vbVwiO1xuXG4vKipcbiAqIFN0YXJ0IGEgRE0uXG4gKlxuICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nIHwgbnVsbH0gUmVzb2x2ZXMgdG8gdGhlIHJvb20gaWQuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzdGFydERtKGNsaWVudDogTWF0cml4Q2xpZW50LCB0YXJnZXRzOiBNZW1iZXJbXSwgc2hvd1NwaW5uZXIgPSB0cnVlKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgY29uc3QgdGFyZ2V0SWRzID0gdGFyZ2V0cy5tYXAodCA9PiB0LnVzZXJJZCk7XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyZSBpcyBhbHJlYWR5IGEgRE0gd2l0aCB0aGVzZSBwZW9wbGUgYW5kIHJldXNlIGl0IGlmIHBvc3NpYmxlLlxuICAgIGxldCBleGlzdGluZ1Jvb206IFJvb207XG4gICAgaWYgKHRhcmdldElkcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgZXhpc3RpbmdSb29tID0gZmluZERNRm9yVXNlcihjbGllbnQsIHRhcmdldElkc1swXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZXhpc3RpbmdSb29tID0gRE1Sb29tTWFwLnNoYXJlZCgpLmdldERNUm9vbUZvcklkZW50aWZpZXJzKHRhcmdldElkcyk7XG4gICAgfVxuICAgIGlmIChleGlzdGluZ1Jvb20gJiYgIWlzTG9jYWxSb29tKGV4aXN0aW5nUm9vbSkpIHtcbiAgICAgICAgZGlzLmRpc3BhdGNoPFZpZXdSb29tUGF5bG9hZD4oe1xuICAgICAgICAgICAgYWN0aW9uOiBBY3Rpb24uVmlld1Jvb20sXG4gICAgICAgICAgICByb29tX2lkOiBleGlzdGluZ1Jvb20ucm9vbUlkLFxuICAgICAgICAgICAgc2hvdWxkX3BlZWs6IGZhbHNlLFxuICAgICAgICAgICAgam9pbmluZzogZmFsc2UsXG4gICAgICAgICAgICBtZXRyaWNzVHJpZ2dlcjogXCJNZXNzYWdlVXNlclwiLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShleGlzdGluZ1Jvb20ucm9vbUlkKTtcbiAgICB9XG5cbiAgICBjb25zdCBjcmVhdGVSb29tT3B0aW9ucyA9IHsgaW5saW5lRXJyb3JzOiB0cnVlIH0gYXMgYW55OyAvLyBYWFg6IFR5cGUgb3V0IGBjcmVhdGVSb29tT3B0aW9uc2BcblxuICAgIGlmIChhd2FpdCBkZXRlcm1pbmVDcmVhdGVSb29tRW5jcnlwdGlvbk9wdGlvbihjbGllbnQsIHRhcmdldHMpKSB7XG4gICAgICAgIGNyZWF0ZVJvb21PcHRpb25zLmVuY3J5cHRpb24gPSB0cnVlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGl0J3MgYSB0cmFkaXRpb25hbCBETSBhbmQgY3JlYXRlIHRoZSByb29tIGlmIHJlcXVpcmVkLlxuICAgIC8vIFRPRE86IFtDYW5vbmljYWwgRE1zXSBSZW1vdmUgdGhpcyBjaGVjayBhbmQgaW5zdGVhZCBqdXN0IGNyZWF0ZSB0aGUgbXVsdGktcGVyc29uIERNXG4gICAgY29uc3QgaXNTZWxmID0gdGFyZ2V0SWRzLmxlbmd0aCA9PT0gMSAmJiB0YXJnZXRJZHNbMF0gPT09IGNsaWVudC5nZXRVc2VySWQoKTtcbiAgICBpZiAodGFyZ2V0SWRzLmxlbmd0aCA9PT0gMSAmJiAhaXNTZWxmKSB7XG4gICAgICAgIGNyZWF0ZVJvb21PcHRpb25zLmRtVXNlcklkID0gdGFyZ2V0SWRzWzBdO1xuICAgIH1cblxuICAgIGlmICh0YXJnZXRJZHMubGVuZ3RoID4gMSkge1xuICAgICAgICBjcmVhdGVSb29tT3B0aW9ucy5jcmVhdGVPcHRzID0gdGFyZ2V0SWRzLnJlZHVjZShcbiAgICAgICAgICAgIChyb29tT3B0aW9ucywgYWRkcmVzcykgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBnZXRBZGRyZXNzVHlwZShhZGRyZXNzKTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2VtYWlsJykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnZpdGU6IElJbnZpdGUzUElEID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWRfc2VydmVyOiBjbGllbnQuZ2V0SWRlbnRpdHlTZXJ2ZXJVcmwodHJ1ZSksXG4gICAgICAgICAgICAgICAgICAgICAgICBtZWRpdW06ICdlbWFpbCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICByb29tT3B0aW9ucy5pbnZpdGVfM3BpZC5wdXNoKGludml0ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnbXgtdXNlci1pZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcm9vbU9wdGlvbnMuaW52aXRlLnB1c2goYWRkcmVzcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiByb29tT3B0aW9ucztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7IGludml0ZTogW10sIGludml0ZV8zcGlkOiBbXSB9LFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGNyZWF0ZVJvb21PcHRpb25zLnNwaW5uZXIgPSBzaG93U3Bpbm5lcjtcbiAgICByZXR1cm4gY3JlYXRlUm9vbShjcmVhdGVSb29tT3B0aW9ucyk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWtCQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUExQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQWNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDTyxlQUFlQSxPQUFmLENBQXVCQyxNQUF2QixFQUE2Q0MsT0FBN0MsRUFBNEc7RUFBQSxJQUE1Q0MsV0FBNEMsdUVBQTlCLElBQThCO0VBQy9H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