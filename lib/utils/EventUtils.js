"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.MessageModerationState = void 0;
exports.canCancel = canCancel;
exports.canEditContent = canEditContent;
exports.canEditOwnEvent = canEditOwnEvent;
exports.canPinEvent = canPinEvent;
exports.editEvent = editEvent;
exports.fetchInitialEvent = fetchInitialEvent;
exports.findEditableEvent = findEditableEvent;
exports.getMessageModerationState = getMessageModerationState;
exports.hasThreadSummary = hasThreadSummary;
exports.isContentActionable = isContentActionable;
exports.isLocationEvent = void 0;
exports.isVoiceMessage = isVoiceMessage;

var _event = require("matrix-js-sdk/src/models/event");

var _event2 = require("matrix-js-sdk/src/@types/event");

var _logger = require("matrix-js-sdk/src/logger");

var _matrixEventsSdk = require("matrix-events-sdk");

var _location = require("matrix-js-sdk/src/@types/location");

var _beacon = require("matrix-js-sdk/src/@types/beacon");

var _thread = require("matrix-js-sdk/src/models/thread");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _shouldHideEvent = _interopRequireDefault(require("../shouldHideEvent"));

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _MPollBody = require("../components/views/messages/MPollBody");

var _actions = require("../dispatcher/actions");

/*
Copyright 2019 - 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

/**
 * Returns whether an event should allow actions like reply, reactions, edit, etc.
 * which effectively checks whether it's a regular message that has been sent and that we
 * can display.
 *
 * @param {MatrixEvent} mxEvent The event to check
 * @returns {boolean} true if actionable
 */
function isContentActionable(mxEvent) {
  const {
    status: eventStatus
  } = mxEvent; // status is SENT before remote-echo, null after

  const isSent = !eventStatus || eventStatus === _event.EventStatus.SENT;

  if (isSent && !mxEvent.isRedacted()) {
    if (mxEvent.getType() === 'm.room.message') {
      const content = mxEvent.getContent();

      if (content.msgtype && content.msgtype !== 'm.bad.encrypted' && content.hasOwnProperty('body')) {
        return true;
      }
    } else if (mxEvent.getType() === 'm.sticker' || _matrixEventsSdk.M_POLL_START.matches(mxEvent.getType()) || _beacon.M_BEACON_INFO.matches(mxEvent.getType())) {
      return true;
    }
  }

  return false;
}

function canEditContent(mxEvent) {
  const isCancellable = mxEvent.getType() === _event2.EventType.RoomMessage || _matrixEventsSdk.M_POLL_START.matches(mxEvent.getType());

  if (!isCancellable || mxEvent.status === _event.EventStatus.CANCELLED || mxEvent.isRedacted() || mxEvent.isRelation(_event2.RelationType.Replace) || mxEvent.getSender() !== _MatrixClientPeg.MatrixClientPeg.get().getUserId()) {
    return false;
  }

  const {
    msgtype,
    body
  } = mxEvent.getOriginalContent();
  return _matrixEventsSdk.M_POLL_START.matches(mxEvent.getType()) || (msgtype === _event2.MsgType.Text || msgtype === _event2.MsgType.Emote) && !!body && typeof body === 'string';
}

function canEditOwnEvent(mxEvent) {
  // for now we only allow editing
  // your own events. So this just call through
  // In the future though, moderators will be able to
  // edit other people's messages as well but we don't
  // want findEditableEvent to return other people's events
  // hence this method.
  return canEditContent(mxEvent);
}

const MAX_JUMP_DISTANCE = 100;

function findEditableEvent(_ref) {
  let {
    events,
    isForward,
    fromEventId
  } = _ref;
  const maxIdx = events.length - 1;
  const inc = isForward ? 1 : -1;
  const beginIdx = isForward ? 0 : maxIdx;
  let endIdx = isForward ? maxIdx : 0;

  if (!fromEventId) {
    endIdx = Math.min(Math.max(0, beginIdx + inc * MAX_JUMP_DISTANCE), maxIdx);
  }

  let foundFromEventId = !fromEventId;

  for (let i = beginIdx; i !== endIdx + inc; i += inc) {
    const e = events[i]; // find start event first

    if (!foundFromEventId && e.getId() === fromEventId) {
      foundFromEventId = true; // don't look further than MAX_JUMP_DISTANCE events from `fromEventId`
      // to not iterate potentially 1000nds of events on key up/down

      endIdx = Math.min(Math.max(0, i + inc * MAX_JUMP_DISTANCE), maxIdx);
    } else if (foundFromEventId && !(0, _shouldHideEvent.default)(e) && canEditOwnEvent(e)) {
      // otherwise look for editable event
      return e;
    }
  }
}
/**
 * How we should render a message depending on its moderation state.
 */


let MessageModerationState; // This is lazily initialized and cached since getMessageModerationState needs it,
// and is called on timeline rendering hot-paths

exports.MessageModerationState = MessageModerationState;

(function (MessageModerationState) {
  MessageModerationState["VISIBLE_FOR_ALL"] = "VISIBLE_FOR_ALL";
  MessageModerationState["HIDDEN_TO_CURRENT_USER"] = "HIDDEN_TO_CURRENT_USER";
  MessageModerationState["SEE_THROUGH_FOR_CURRENT_USER"] = "SEE_THROUGH_FOR_CURRENT_USER";
})(MessageModerationState || (exports.MessageModerationState = MessageModerationState = {}));

let msc3531Enabled = null;

const getMsc3531Enabled = () => {
  if (msc3531Enabled === null) {
    msc3531Enabled = _SettingsStore.default.getValue("feature_msc3531_hide_messages_pending_moderation");
  }

  return msc3531Enabled;
};
/**
 * Determine whether a message should be displayed as hidden pending moderation.
 *
 * If MSC3531 is deactivated in settings, all messages are considered visible
 * to all.
 */


function getMessageModerationState(mxEvent, client) {
  client = client ?? _MatrixClientPeg.MatrixClientPeg.get(); // because param defaults don't do the correct thing

  if (!getMsc3531Enabled()) {
    return MessageModerationState.VISIBLE_FOR_ALL;
  }

  const visibility = mxEvent.messageVisibility();

  if (visibility.visible) {
    return MessageModerationState.VISIBLE_FOR_ALL;
  } // At this point, we know that the message is marked as hidden
  // pending moderation. However, if we're the author or a moderator,
  // we still need to display it.


  if (mxEvent.sender?.userId === client.getUserId()) {
    // We're the author, show the message.
    return MessageModerationState.SEE_THROUGH_FOR_CURRENT_USER;
  }

  const room = client.getRoom(mxEvent.getRoomId());

  if (_event2.EVENT_VISIBILITY_CHANGE_TYPE.name && room.currentState.maySendStateEvent(_event2.EVENT_VISIBILITY_CHANGE_TYPE.name, client.getUserId())) {
    // We're a moderator (as indicated by prefixed event name), show the message.
    return MessageModerationState.SEE_THROUGH_FOR_CURRENT_USER;
  }

  if (_event2.EVENT_VISIBILITY_CHANGE_TYPE.altName && room.currentState.maySendStateEvent(_event2.EVENT_VISIBILITY_CHANGE_TYPE.altName, client.getUserId())) {
    // We're a moderator (as indicated by unprefixed event name), show the message.
    return MessageModerationState.SEE_THROUGH_FOR_CURRENT_USER;
  } // For everybody else, hide the message.


  return MessageModerationState.HIDDEN_TO_CURRENT_USER;
}

function isVoiceMessage(mxEvent) {
  const content = mxEvent.getContent(); // MSC2516 is a legacy identifier. See https://github.com/matrix-org/matrix-doc/pull/3245

  return !!content['org.matrix.msc2516.voice'] || !!content['org.matrix.msc3245.voice'];
}

async function fetchInitialEvent(client, roomId, eventId) {
  let initialEvent;

  try {
    const eventData = await client.fetchRoomEvent(roomId, eventId);
    initialEvent = new _event.MatrixEvent(eventData);
  } catch (e) {
    _logger.logger.warn("Could not find initial event: " + eventId);

    initialEvent = null;
  }

  if (client.supportsExperimentalThreads() && initialEvent?.isRelation(_thread.THREAD_RELATION_TYPE.name) && !initialEvent.getThread()) {
    const threadId = initialEvent.threadRootId;
    const room = client.getRoom(roomId);

    try {
      room.createThread(threadId, room.findEventById(threadId), [initialEvent], true);
    } catch (e) {
      _logger.logger.warn("Could not find root event: " + threadId);
    }
  }

  return initialEvent;
}

function editEvent(mxEvent, timelineRenderingType, getRelationsForEvent) {
  if (!canEditContent(mxEvent)) return;

  if (_matrixEventsSdk.M_POLL_START.matches(mxEvent.getType())) {
    (0, _MPollBody.launchPollEditor)(mxEvent, getRelationsForEvent);
  } else {
    _dispatcher.default.dispatch({
      action: _actions.Action.EditEvent,
      event: mxEvent,
      timelineRenderingType: timelineRenderingType
    });
  }
}

function canCancel(status) {
  return status === _event.EventStatus.QUEUED || status === _event.EventStatus.NOT_SENT || status === _event.EventStatus.ENCRYPTING;
}

const isLocationEvent = event => {
  const eventType = event.getType();
  return _location.M_LOCATION.matches(eventType) || eventType === _event2.EventType.RoomMessage && _location.M_LOCATION.matches(event.getContent().msgtype);
};

exports.isLocationEvent = isLocationEvent;

function hasThreadSummary(event) {
  return event.isThreadRoot && event.getThread()?.length && !!event.getThread().replyToEvent;
}

function canPinEvent(event) {
  return !_beacon.M_BEACON_INFO.matches(event.getType());
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpc0NvbnRlbnRBY3Rpb25hYmxlIiwibXhFdmVudCIsInN0YXR1cyIsImV2ZW50U3RhdHVzIiwiaXNTZW50IiwiRXZlbnRTdGF0dXMiLCJTRU5UIiwiaXNSZWRhY3RlZCIsImdldFR5cGUiLCJjb250ZW50IiwiZ2V0Q29udGVudCIsIm1zZ3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsIk1fUE9MTF9TVEFSVCIsIm1hdGNoZXMiLCJNX0JFQUNPTl9JTkZPIiwiY2FuRWRpdENvbnRlbnQiLCJpc0NhbmNlbGxhYmxlIiwiRXZlbnRUeXBlIiwiUm9vbU1lc3NhZ2UiLCJDQU5DRUxMRUQiLCJpc1JlbGF0aW9uIiwiUmVsYXRpb25UeXBlIiwiUmVwbGFjZSIsImdldFNlbmRlciIsIk1hdHJpeENsaWVudFBlZyIsImdldCIsImdldFVzZXJJZCIsImJvZHkiLCJnZXRPcmlnaW5hbENvbnRlbnQiLCJNc2dUeXBlIiwiVGV4dCIsIkVtb3RlIiwiY2FuRWRpdE93bkV2ZW50IiwiTUFYX0pVTVBfRElTVEFOQ0UiLCJmaW5kRWRpdGFibGVFdmVudCIsImV2ZW50cyIsImlzRm9yd2FyZCIsImZyb21FdmVudElkIiwibWF4SWR4IiwibGVuZ3RoIiwiaW5jIiwiYmVnaW5JZHgiLCJlbmRJZHgiLCJNYXRoIiwibWluIiwibWF4IiwiZm91bmRGcm9tRXZlbnRJZCIsImkiLCJlIiwiZ2V0SWQiLCJzaG91bGRIaWRlRXZlbnQiLCJNZXNzYWdlTW9kZXJhdGlvblN0YXRlIiwibXNjMzUzMUVuYWJsZWQiLCJnZXRNc2MzNTMxRW5hYmxlZCIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImdldE1lc3NhZ2VNb2RlcmF0aW9uU3RhdGUiLCJjbGllbnQiLCJWSVNJQkxFX0ZPUl9BTEwiLCJ2aXNpYmlsaXR5IiwibWVzc2FnZVZpc2liaWxpdHkiLCJ2aXNpYmxlIiwic2VuZGVyIiwidXNlcklkIiwiU0VFX1RIUk9VR0hfRk9SX0NVUlJFTlRfVVNFUiIsInJvb20iLCJnZXRSb29tIiwiZ2V0Um9vbUlkIiwiRVZFTlRfVklTSUJJTElUWV9DSEFOR0VfVFlQRSIsIm5hbWUiLCJjdXJyZW50U3RhdGUiLCJtYXlTZW5kU3RhdGVFdmVudCIsImFsdE5hbWUiLCJISURERU5fVE9fQ1VSUkVOVF9VU0VSIiwiaXNWb2ljZU1lc3NhZ2UiLCJmZXRjaEluaXRpYWxFdmVudCIsInJvb21JZCIsImV2ZW50SWQiLCJpbml0aWFsRXZlbnQiLCJldmVudERhdGEiLCJmZXRjaFJvb21FdmVudCIsIk1hdHJpeEV2ZW50IiwibG9nZ2VyIiwid2FybiIsInN1cHBvcnRzRXhwZXJpbWVudGFsVGhyZWFkcyIsIlRIUkVBRF9SRUxBVElPTl9UWVBFIiwiZ2V0VGhyZWFkIiwidGhyZWFkSWQiLCJ0aHJlYWRSb290SWQiLCJjcmVhdGVUaHJlYWQiLCJmaW5kRXZlbnRCeUlkIiwiZWRpdEV2ZW50IiwidGltZWxpbmVSZW5kZXJpbmdUeXBlIiwiZ2V0UmVsYXRpb25zRm9yRXZlbnQiLCJsYXVuY2hQb2xsRWRpdG9yIiwiZGVmYXVsdERpc3BhdGNoZXIiLCJkaXNwYXRjaCIsImFjdGlvbiIsIkFjdGlvbiIsIkVkaXRFdmVudCIsImV2ZW50IiwiY2FuQ2FuY2VsIiwiUVVFVUVEIiwiTk9UX1NFTlQiLCJFTkNSWVBUSU5HIiwiaXNMb2NhdGlvbkV2ZW50IiwiZXZlbnRUeXBlIiwiTV9MT0NBVElPTiIsImhhc1RocmVhZFN1bW1hcnkiLCJpc1RocmVhZFJvb3QiLCJyZXBseVRvRXZlbnQiLCJjYW5QaW5FdmVudCJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9FdmVudFV0aWxzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSAtIDIwMjIgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBFdmVudFN0YXR1cywgTWF0cml4RXZlbnQgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnQnO1xuaW1wb3J0IHsgRXZlbnRUeXBlLCBFVkVOVF9WSVNJQklMSVRZX0NIQU5HRV9UWVBFLCBNc2dUeXBlLCBSZWxhdGlvblR5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnQgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9jbGllbnQnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyJztcbmltcG9ydCB7IE1fUE9MTF9TVEFSVCB9IGZyb20gXCJtYXRyaXgtZXZlbnRzLXNka1wiO1xuaW1wb3J0IHsgTV9MT0NBVElPTiB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvbG9jYXRpb25cIjtcbmltcG9ydCB7IE1fQkVBQ09OX0lORk8gfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9AdHlwZXMvYmVhY29uJztcbmltcG9ydCB7IFRIUkVBRF9SRUxBVElPTl9UWVBFIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3RocmVhZCc7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgc2hvdWxkSGlkZUV2ZW50IGZyb20gXCIuLi9zaG91bGRIaWRlRXZlbnRcIjtcbmltcG9ydCB7IEdldFJlbGF0aW9uc0ZvckV2ZW50IH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3Mvcm9vbXMvRXZlbnRUaWxlXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IGRlZmF1bHREaXNwYXRjaGVyIGZyb20gXCIuLi9kaXNwYXRjaGVyL2Rpc3BhdGNoZXJcIjtcbmltcG9ydCB7IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSB9IGZyb20gXCIuLi9jb250ZXh0cy9Sb29tQ29udGV4dFwiO1xuaW1wb3J0IHsgbGF1bmNoUG9sbEVkaXRvciB9IGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL21lc3NhZ2VzL01Qb2xsQm9keVwiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuXG4vKipcbiAqIFJldHVybnMgd2hldGhlciBhbiBldmVudCBzaG91bGQgYWxsb3cgYWN0aW9ucyBsaWtlIHJlcGx5LCByZWFjdGlvbnMsIGVkaXQsIGV0Yy5cbiAqIHdoaWNoIGVmZmVjdGl2ZWx5IGNoZWNrcyB3aGV0aGVyIGl0J3MgYSByZWd1bGFyIG1lc3NhZ2UgdGhhdCBoYXMgYmVlbiBzZW50IGFuZCB0aGF0IHdlXG4gKiBjYW4gZGlzcGxheS5cbiAqXG4gKiBAcGFyYW0ge01hdHJpeEV2ZW50fSBteEV2ZW50IFRoZSBldmVudCB0byBjaGVja1xuICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgYWN0aW9uYWJsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNDb250ZW50QWN0aW9uYWJsZShteEV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgc3RhdHVzOiBldmVudFN0YXR1cyB9ID0gbXhFdmVudDtcblxuICAgIC8vIHN0YXR1cyBpcyBTRU5UIGJlZm9yZSByZW1vdGUtZWNobywgbnVsbCBhZnRlclxuICAgIGNvbnN0IGlzU2VudCA9ICFldmVudFN0YXR1cyB8fCBldmVudFN0YXR1cyA9PT0gRXZlbnRTdGF0dXMuU0VOVDtcblxuICAgIGlmIChpc1NlbnQgJiYgIW14RXZlbnQuaXNSZWRhY3RlZCgpKSB7XG4gICAgICAgIGlmIChteEV2ZW50LmdldFR5cGUoKSA9PT0gJ20ucm9vbS5tZXNzYWdlJykge1xuICAgICAgICAgICAgY29uc3QgY29udGVudCA9IG14RXZlbnQuZ2V0Q29udGVudCgpO1xuICAgICAgICAgICAgaWYgKGNvbnRlbnQubXNndHlwZSAmJiBjb250ZW50Lm1zZ3R5cGUgIT09ICdtLmJhZC5lbmNyeXB0ZWQnICYmIGNvbnRlbnQuaGFzT3duUHJvcGVydHkoJ2JvZHknKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgICAgbXhFdmVudC5nZXRUeXBlKCkgPT09ICdtLnN0aWNrZXInIHx8XG4gICAgICAgICAgICBNX1BPTExfU1RBUlQubWF0Y2hlcyhteEV2ZW50LmdldFR5cGUoKSkgfHxcbiAgICAgICAgICAgIE1fQkVBQ09OX0lORk8ubWF0Y2hlcyhteEV2ZW50LmdldFR5cGUoKSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbkVkaXRDb250ZW50KG14RXZlbnQ6IE1hdHJpeEV2ZW50KTogYm9vbGVhbiB7XG4gICAgY29uc3QgaXNDYW5jZWxsYWJsZSA9IChcbiAgICAgICAgbXhFdmVudC5nZXRUeXBlKCkgPT09IEV2ZW50VHlwZS5Sb29tTWVzc2FnZSB8fFxuICAgICAgICBNX1BPTExfU1RBUlQubWF0Y2hlcyhteEV2ZW50LmdldFR5cGUoKSlcbiAgICApO1xuXG4gICAgaWYgKFxuICAgICAgICAhaXNDYW5jZWxsYWJsZSB8fFxuICAgICAgICBteEV2ZW50LnN0YXR1cyA9PT0gRXZlbnRTdGF0dXMuQ0FOQ0VMTEVEIHx8XG4gICAgICAgIG14RXZlbnQuaXNSZWRhY3RlZCgpIHx8XG4gICAgICAgIG14RXZlbnQuaXNSZWxhdGlvbihSZWxhdGlvblR5cGUuUmVwbGFjZSkgfHxcbiAgICAgICAgbXhFdmVudC5nZXRTZW5kZXIoKSAhPT0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpXG4gICAgKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCB7IG1zZ3R5cGUsIGJvZHkgfSA9IG14RXZlbnQuZ2V0T3JpZ2luYWxDb250ZW50KCk7XG4gICAgcmV0dXJuIChcbiAgICAgICAgTV9QT0xMX1NUQVJULm1hdGNoZXMobXhFdmVudC5nZXRUeXBlKCkpIHx8XG4gICAgICAgIChcbiAgICAgICAgICAgIChtc2d0eXBlID09PSBNc2dUeXBlLlRleHQgfHwgbXNndHlwZSA9PT0gTXNnVHlwZS5FbW90ZSkgJiZcbiAgICAgICAgICAgICEhYm9keSAmJlxuICAgICAgICAgICAgdHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnXG4gICAgICAgIClcbiAgICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FuRWRpdE93bkV2ZW50KG14RXZlbnQ6IE1hdHJpeEV2ZW50KTogYm9vbGVhbiB7XG4gICAgLy8gZm9yIG5vdyB3ZSBvbmx5IGFsbG93IGVkaXRpbmdcbiAgICAvLyB5b3VyIG93biBldmVudHMuIFNvIHRoaXMganVzdCBjYWxsIHRocm91Z2hcbiAgICAvLyBJbiB0aGUgZnV0dXJlIHRob3VnaCwgbW9kZXJhdG9ycyB3aWxsIGJlIGFibGUgdG9cbiAgICAvLyBlZGl0IG90aGVyIHBlb3BsZSdzIG1lc3NhZ2VzIGFzIHdlbGwgYnV0IHdlIGRvbid0XG4gICAgLy8gd2FudCBmaW5kRWRpdGFibGVFdmVudCB0byByZXR1cm4gb3RoZXIgcGVvcGxlJ3MgZXZlbnRzXG4gICAgLy8gaGVuY2UgdGhpcyBtZXRob2QuXG4gICAgcmV0dXJuIGNhbkVkaXRDb250ZW50KG14RXZlbnQpO1xufVxuXG5jb25zdCBNQVhfSlVNUF9ESVNUQU5DRSA9IDEwMDtcbmV4cG9ydCBmdW5jdGlvbiBmaW5kRWRpdGFibGVFdmVudCh7XG4gICAgZXZlbnRzLFxuICAgIGlzRm9yd2FyZCxcbiAgICBmcm9tRXZlbnRJZCxcbn06IHtcbiAgICBldmVudHM6IE1hdHJpeEV2ZW50W107XG4gICAgaXNGb3J3YXJkOiBib29sZWFuO1xuICAgIGZyb21FdmVudElkPzogc3RyaW5nO1xufSk6IE1hdHJpeEV2ZW50IHtcbiAgICBjb25zdCBtYXhJZHggPSBldmVudHMubGVuZ3RoIC0gMTtcbiAgICBjb25zdCBpbmMgPSBpc0ZvcndhcmQgPyAxIDogLTE7XG4gICAgY29uc3QgYmVnaW5JZHggPSBpc0ZvcndhcmQgPyAwIDogbWF4SWR4O1xuICAgIGxldCBlbmRJZHggPSBpc0ZvcndhcmQgPyBtYXhJZHggOiAwO1xuICAgIGlmICghZnJvbUV2ZW50SWQpIHtcbiAgICAgICAgZW5kSWR4ID0gTWF0aC5taW4oTWF0aC5tYXgoMCwgYmVnaW5JZHggKyAoaW5jICogTUFYX0pVTVBfRElTVEFOQ0UpKSwgbWF4SWR4KTtcbiAgICB9XG4gICAgbGV0IGZvdW5kRnJvbUV2ZW50SWQgPSAhZnJvbUV2ZW50SWQ7XG4gICAgZm9yIChsZXQgaSA9IGJlZ2luSWR4OyBpICE9PSAoZW5kSWR4ICsgaW5jKTsgaSArPSBpbmMpIHtcbiAgICAgICAgY29uc3QgZSA9IGV2ZW50c1tpXTtcbiAgICAgICAgLy8gZmluZCBzdGFydCBldmVudCBmaXJzdFxuICAgICAgICBpZiAoIWZvdW5kRnJvbUV2ZW50SWQgJiYgZS5nZXRJZCgpID09PSBmcm9tRXZlbnRJZCkge1xuICAgICAgICAgICAgZm91bmRGcm9tRXZlbnRJZCA9IHRydWU7XG4gICAgICAgICAgICAvLyBkb24ndCBsb29rIGZ1cnRoZXIgdGhhbiBNQVhfSlVNUF9ESVNUQU5DRSBldmVudHMgZnJvbSBgZnJvbUV2ZW50SWRgXG4gICAgICAgICAgICAvLyB0byBub3QgaXRlcmF0ZSBwb3RlbnRpYWxseSAxMDAwbmRzIG9mIGV2ZW50cyBvbiBrZXkgdXAvZG93blxuICAgICAgICAgICAgZW5kSWR4ID0gTWF0aC5taW4oTWF0aC5tYXgoMCwgaSArIChpbmMgKiBNQVhfSlVNUF9ESVNUQU5DRSkpLCBtYXhJZHgpO1xuICAgICAgICB9IGVsc2UgaWYgKGZvdW5kRnJvbUV2ZW50SWQgJiYgIXNob3VsZEhpZGVFdmVudChlKSAmJiBjYW5FZGl0T3duRXZlbnQoZSkpIHtcbiAgICAgICAgICAgIC8vIG90aGVyd2lzZSBsb29rIGZvciBlZGl0YWJsZSBldmVudFxuICAgICAgICAgICAgcmV0dXJuIGU7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogSG93IHdlIHNob3VsZCByZW5kZXIgYSBtZXNzYWdlIGRlcGVuZGluZyBvbiBpdHMgbW9kZXJhdGlvbiBzdGF0ZS5cbiAqL1xuZXhwb3J0IGVudW0gTWVzc2FnZU1vZGVyYXRpb25TdGF0ZSB7XG4gICAgLyoqXG4gICAgICogVGhlIG1lc3NhZ2UgaXMgdmlzaWJsZSB0byBhbGwuXG4gICAgICovXG4gICAgVklTSUJMRV9GT1JfQUxMID0gXCJWSVNJQkxFX0ZPUl9BTExcIixcbiAgICAvKipcbiAgICAgKiBUaGUgbWVzc2FnZSBpcyBoaWRkZW4gcGVuZGluZyBtb2RlcmF0aW9uIGFuZCB3ZSdyZSBub3QgYSB1c2VyIHdobyBzaG91bGRcbiAgICAgKiBzZWUgaXQgbmV2ZXJ0aGVsZXNzLlxuICAgICAqL1xuICAgIEhJRERFTl9UT19DVVJSRU5UX1VTRVIgPSBcIkhJRERFTl9UT19DVVJSRU5UX1VTRVJcIixcbiAgICAvKipcbiAgICAgKiBUaGUgbWVzc2FnZSBpcyBoaWRkZW4gcGVuZGluZyBtb2RlcmF0aW9uIGFuZCB3ZSdyZSBlaXRoZXIgdGhlIGF1dGhvciBvZlxuICAgICAqIHRoZSBtZXNzYWdlIG9yIGEgbW9kZXJhdG9yLiBJbiBlaXRoZXIgY2FzZSwgd2UgbmVlZCB0byBzZWUgdGhlIG1lc3NhZ2VcbiAgICAgKiB3aXRoIGEgbWFya2VyLlxuICAgICAqL1xuICAgIFNFRV9USFJPVUdIX0ZPUl9DVVJSRU5UX1VTRVIgPSBcIlNFRV9USFJPVUdIX0ZPUl9DVVJSRU5UX1VTRVJcIixcbn1cblxuLy8gVGhpcyBpcyBsYXppbHkgaW5pdGlhbGl6ZWQgYW5kIGNhY2hlZCBzaW5jZSBnZXRNZXNzYWdlTW9kZXJhdGlvblN0YXRlIG5lZWRzIGl0LFxuLy8gYW5kIGlzIGNhbGxlZCBvbiB0aW1lbGluZSByZW5kZXJpbmcgaG90LXBhdGhzXG5sZXQgbXNjMzUzMUVuYWJsZWQ6IGJvb2xlYW4gfCBudWxsID0gbnVsbDtcbmNvbnN0IGdldE1zYzM1MzFFbmFibGVkID0gKCk6IGJvb2xlYW4gPT4ge1xuICAgIGlmIChtc2MzNTMxRW5hYmxlZCA9PT0gbnVsbCkge1xuICAgICAgICBtc2MzNTMxRW5hYmxlZCA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJmZWF0dXJlX21zYzM1MzFfaGlkZV9tZXNzYWdlc19wZW5kaW5nX21vZGVyYXRpb25cIik7XG4gICAgfVxuICAgIHJldHVybiBtc2MzNTMxRW5hYmxlZDtcbn07XG5cbi8qKlxuICogRGV0ZXJtaW5lIHdoZXRoZXIgYSBtZXNzYWdlIHNob3VsZCBiZSBkaXNwbGF5ZWQgYXMgaGlkZGVuIHBlbmRpbmcgbW9kZXJhdGlvbi5cbiAqXG4gKiBJZiBNU0MzNTMxIGlzIGRlYWN0aXZhdGVkIGluIHNldHRpbmdzLCBhbGwgbWVzc2FnZXMgYXJlIGNvbnNpZGVyZWQgdmlzaWJsZVxuICogdG8gYWxsLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWVzc2FnZU1vZGVyYXRpb25TdGF0ZShteEV2ZW50OiBNYXRyaXhFdmVudCwgY2xpZW50PzogTWF0cml4Q2xpZW50KTogTWVzc2FnZU1vZGVyYXRpb25TdGF0ZSB7XG4gICAgY2xpZW50ID0gY2xpZW50ID8/IE1hdHJpeENsaWVudFBlZy5nZXQoKTsgLy8gYmVjYXVzZSBwYXJhbSBkZWZhdWx0cyBkb24ndCBkbyB0aGUgY29ycmVjdCB0aGluZ1xuXG4gICAgaWYgKCFnZXRNc2MzNTMxRW5hYmxlZCgpKSB7XG4gICAgICAgIHJldHVybiBNZXNzYWdlTW9kZXJhdGlvblN0YXRlLlZJU0lCTEVfRk9SX0FMTDtcbiAgICB9XG4gICAgY29uc3QgdmlzaWJpbGl0eSA9IG14RXZlbnQubWVzc2FnZVZpc2liaWxpdHkoKTtcbiAgICBpZiAodmlzaWJpbGl0eS52aXNpYmxlKSB7XG4gICAgICAgIHJldHVybiBNZXNzYWdlTW9kZXJhdGlvblN0YXRlLlZJU0lCTEVfRk9SX0FMTDtcbiAgICB9XG5cbiAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBrbm93IHRoYXQgdGhlIG1lc3NhZ2UgaXMgbWFya2VkIGFzIGhpZGRlblxuICAgIC8vIHBlbmRpbmcgbW9kZXJhdGlvbi4gSG93ZXZlciwgaWYgd2UncmUgdGhlIGF1dGhvciBvciBhIG1vZGVyYXRvcixcbiAgICAvLyB3ZSBzdGlsbCBuZWVkIHRvIGRpc3BsYXkgaXQuXG5cbiAgICBpZiAobXhFdmVudC5zZW5kZXI/LnVzZXJJZCA9PT0gY2xpZW50LmdldFVzZXJJZCgpKSB7XG4gICAgICAgIC8vIFdlJ3JlIHRoZSBhdXRob3IsIHNob3cgdGhlIG1lc3NhZ2UuXG4gICAgICAgIHJldHVybiBNZXNzYWdlTW9kZXJhdGlvblN0YXRlLlNFRV9USFJPVUdIX0ZPUl9DVVJSRU5UX1VTRVI7XG4gICAgfVxuXG4gICAgY29uc3Qgcm9vbSA9IGNsaWVudC5nZXRSb29tKG14RXZlbnQuZ2V0Um9vbUlkKCkpO1xuICAgIGlmIChFVkVOVF9WSVNJQklMSVRZX0NIQU5HRV9UWVBFLm5hbWVcbiAgICAgICAgJiYgcm9vbS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRVZFTlRfVklTSUJJTElUWV9DSEFOR0VfVFlQRS5uYW1lLCBjbGllbnQuZ2V0VXNlcklkKCkpXG4gICAgKSB7XG4gICAgICAgIC8vIFdlJ3JlIGEgbW9kZXJhdG9yIChhcyBpbmRpY2F0ZWQgYnkgcHJlZml4ZWQgZXZlbnQgbmFtZSksIHNob3cgdGhlIG1lc3NhZ2UuXG4gICAgICAgIHJldHVybiBNZXNzYWdlTW9kZXJhdGlvblN0YXRlLlNFRV9USFJPVUdIX0ZPUl9DVVJSRU5UX1VTRVI7XG4gICAgfVxuICAgIGlmIChFVkVOVF9WSVNJQklMSVRZX0NIQU5HRV9UWVBFLmFsdE5hbWVcbiAgICAgICAgJiYgcm9vbS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRVZFTlRfVklTSUJJTElUWV9DSEFOR0VfVFlQRS5hbHROYW1lLCBjbGllbnQuZ2V0VXNlcklkKCkpXG4gICAgKSB7XG4gICAgICAgIC8vIFdlJ3JlIGEgbW9kZXJhdG9yIChhcyBpbmRpY2F0ZWQgYnkgdW5wcmVmaXhlZCBldmVudCBuYW1lKSwgc2hvdyB0aGUgbWVzc2FnZS5cbiAgICAgICAgcmV0dXJuIE1lc3NhZ2VNb2RlcmF0aW9uU3RhdGUuU0VFX1RIUk9VR0hfRk9SX0NVUlJFTlRfVVNFUjtcbiAgICB9XG4gICAgLy8gRm9yIGV2ZXJ5Ym9keSBlbHNlLCBoaWRlIHRoZSBtZXNzYWdlLlxuICAgIHJldHVybiBNZXNzYWdlTW9kZXJhdGlvblN0YXRlLkhJRERFTl9UT19DVVJSRU5UX1VTRVI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1ZvaWNlTWVzc2FnZShteEV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBteEV2ZW50LmdldENvbnRlbnQoKTtcbiAgICAvLyBNU0MyNTE2IGlzIGEgbGVnYWN5IGlkZW50aWZpZXIuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vbWF0cml4LW9yZy9tYXRyaXgtZG9jL3B1bGwvMzI0NVxuICAgIHJldHVybiAoXG4gICAgICAgICEhY29udGVudFsnb3JnLm1hdHJpeC5tc2MyNTE2LnZvaWNlJ10gfHxcbiAgICAgICAgISFjb250ZW50WydvcmcubWF0cml4Lm1zYzMyNDUudm9pY2UnXVxuICAgICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmZXRjaEluaXRpYWxFdmVudChcbiAgICBjbGllbnQ6IE1hdHJpeENsaWVudCxcbiAgICByb29tSWQ6IHN0cmluZyxcbiAgICBldmVudElkOiBzdHJpbmcsXG4pOiBQcm9taXNlPE1hdHJpeEV2ZW50IHwgbnVsbD4ge1xuICAgIGxldCBpbml0aWFsRXZlbnQ6IE1hdHJpeEV2ZW50O1xuXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZXZlbnREYXRhID0gYXdhaXQgY2xpZW50LmZldGNoUm9vbUV2ZW50KHJvb21JZCwgZXZlbnRJZCk7XG4gICAgICAgIGluaXRpYWxFdmVudCA9IG5ldyBNYXRyaXhFdmVudChldmVudERhdGEpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oXCJDb3VsZCBub3QgZmluZCBpbml0aWFsIGV2ZW50OiBcIiArIGV2ZW50SWQpO1xuICAgICAgICBpbml0aWFsRXZlbnQgPSBudWxsO1xuICAgIH1cblxuICAgIGlmIChjbGllbnQuc3VwcG9ydHNFeHBlcmltZW50YWxUaHJlYWRzKCkgJiZcbiAgICAgICAgaW5pdGlhbEV2ZW50Py5pc1JlbGF0aW9uKFRIUkVBRF9SRUxBVElPTl9UWVBFLm5hbWUpICYmXG4gICAgICAgICFpbml0aWFsRXZlbnQuZ2V0VGhyZWFkKClcbiAgICApIHtcbiAgICAgICAgY29uc3QgdGhyZWFkSWQgPSBpbml0aWFsRXZlbnQudGhyZWFkUm9vdElkO1xuICAgICAgICBjb25zdCByb29tID0gY2xpZW50LmdldFJvb20ocm9vbUlkKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJvb20uY3JlYXRlVGhyZWFkKHRocmVhZElkLCByb29tLmZpbmRFdmVudEJ5SWQodGhyZWFkSWQpLCBbaW5pdGlhbEV2ZW50XSwgdHJ1ZSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiQ291bGQgbm90IGZpbmQgcm9vdCBldmVudDogXCIgKyB0aHJlYWRJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaW5pdGlhbEV2ZW50O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZWRpdEV2ZW50KFxuICAgIG14RXZlbnQ6IE1hdHJpeEV2ZW50LFxuICAgIHRpbWVsaW5lUmVuZGVyaW5nVHlwZTogVGltZWxpbmVSZW5kZXJpbmdUeXBlLFxuICAgIGdldFJlbGF0aW9uc0ZvckV2ZW50PzogR2V0UmVsYXRpb25zRm9yRXZlbnQsXG4pOiB2b2lkIHtcbiAgICBpZiAoIWNhbkVkaXRDb250ZW50KG14RXZlbnQpKSByZXR1cm47XG5cbiAgICBpZiAoTV9QT0xMX1NUQVJULm1hdGNoZXMobXhFdmVudC5nZXRUeXBlKCkpKSB7XG4gICAgICAgIGxhdW5jaFBvbGxFZGl0b3IobXhFdmVudCwgZ2V0UmVsYXRpb25zRm9yRXZlbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGRlZmF1bHREaXNwYXRjaGVyLmRpc3BhdGNoKHtcbiAgICAgICAgICAgIGFjdGlvbjogQWN0aW9uLkVkaXRFdmVudCxcbiAgICAgICAgICAgIGV2ZW50OiBteEV2ZW50LFxuICAgICAgICAgICAgdGltZWxpbmVSZW5kZXJpbmdUeXBlOiB0aW1lbGluZVJlbmRlcmluZ1R5cGUsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbkNhbmNlbChzdGF0dXM6IEV2ZW50U3RhdHVzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN0YXR1cyA9PT0gRXZlbnRTdGF0dXMuUVVFVUVEIHx8IHN0YXR1cyA9PT0gRXZlbnRTdGF0dXMuTk9UX1NFTlQgfHwgc3RhdHVzID09PSBFdmVudFN0YXR1cy5FTkNSWVBUSU5HO1xufVxuXG5leHBvcnQgY29uc3QgaXNMb2NhdGlvbkV2ZW50ID0gKGV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4gPT4ge1xuICAgIGNvbnN0IGV2ZW50VHlwZSA9IGV2ZW50LmdldFR5cGUoKTtcbiAgICByZXR1cm4gKFxuICAgICAgICBNX0xPQ0FUSU9OLm1hdGNoZXMoZXZlbnRUeXBlKSB8fFxuICAgICAgICAoXG4gICAgICAgICAgICBldmVudFR5cGUgPT09IEV2ZW50VHlwZS5Sb29tTWVzc2FnZSAmJlxuICAgICAgICAgICAgTV9MT0NBVElPTi5tYXRjaGVzKGV2ZW50LmdldENvbnRlbnQoKS5tc2d0eXBlKVxuICAgICAgICApXG4gICAgKTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNUaHJlYWRTdW1tYXJ5KGV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBldmVudC5pc1RocmVhZFJvb3QgJiYgZXZlbnQuZ2V0VGhyZWFkKCk/Lmxlbmd0aCAmJiAhIWV2ZW50LmdldFRocmVhZCgpLnJlcGx5VG9FdmVudDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhblBpbkV2ZW50KGV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhTV9CRUFDT05fSU5GTy5tYXRjaGVzKGV2ZW50LmdldFR5cGUoKSk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFoQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQW9CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ08sU0FBU0EsbUJBQVQsQ0FBNkJDLE9BQTdCLEVBQTREO0VBQy9ELE1BQU07SUFBRUMsTUFBTSxFQUFFQztFQUFWLElBQTBCRixP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