"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.showSpacePreferences = exports.showSpaceInvite = exports.showCreateNewSubspace = exports.showCreateNewRoom = exports.showAddExistingSubspace = exports.showAddExistingRooms = exports.shouldShowSpaceSettings = exports.shouldShowSpaceInvite = exports.makeSpaceParentEvent = exports.bulkSpaceBehaviour = void 0;
exports.showSpaceSettings = showSpaceSettings;

var _react = _interopRequireDefault(require("react"));

var _event = require("matrix-js-sdk/src/@types/event");

var _partials = require("matrix-js-sdk/src/@types/partials");

var _Permalinks = require("./permalinks/Permalinks");

var _Modal = _interopRequireDefault(require("../Modal"));

var _CreateRoomDialog = _interopRequireDefault(require("../components/views/dialogs/CreateRoomDialog"));

var _createRoom = _interopRequireDefault(require("../createRoom"));

var _languageHandler = require("../languageHandler");

var _SpacePublicShare = _interopRequireDefault(require("../components/views/spaces/SpacePublicShare"));

var _InfoDialog = _interopRequireDefault(require("../components/views/dialogs/InfoDialog"));

var _RoomInvite = require("../RoomInvite");

var _CreateSubspaceDialog = _interopRequireDefault(require("../components/views/dialogs/CreateSubspaceDialog"));

var _AddExistingSubspaceDialog = _interopRequireDefault(require("../components/views/dialogs/AddExistingSubspaceDialog"));

var _dispatcher = _interopRequireDefault(require("../dispatcher/dispatcher"));

var _RoomViewStore = require("../stores/RoomViewStore");

var _actions = require("../dispatcher/actions");

var _Spinner = _interopRequireDefault(require("../components/views/elements/Spinner"));

var _UIComponents = require("../customisations/helpers/UIComponents");

var _UIFeature = require("../settings/UIFeature");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const shouldShowSpaceSettings = space => {
  const userId = space.client.getUserId();
  return space.getMyMembership() === "join" && (space.currentState.maySendStateEvent(_event.EventType.RoomAvatar, userId) || space.currentState.maySendStateEvent(_event.EventType.RoomName, userId) || space.currentState.maySendStateEvent(_event.EventType.RoomTopic, userId) || space.currentState.maySendStateEvent(_event.EventType.RoomJoinRules, userId));
};

exports.shouldShowSpaceSettings = shouldShowSpaceSettings;

const makeSpaceParentEvent = function (room) {
  let canonical = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
  return {
    type: _event.EventType.SpaceParent,
    content: {
      "via": (0, _Permalinks.calculateRoomVia)(room),
      "canonical": canonical
    },
    state_key: room.roomId
  };
};

exports.makeSpaceParentEvent = makeSpaceParentEvent;

function showSpaceSettings(space) {
  _dispatcher.default.dispatch({
    action: _actions.Action.OpenSpaceSettings,
    space
  });
}

const showAddExistingRooms = space => {
  _dispatcher.default.dispatch({
    action: _actions.Action.OpenAddToExistingSpaceDialog,
    space
  });
};

exports.showAddExistingRooms = showAddExistingRooms;

const showCreateNewRoom = async (space, type) => {
  const modal = _Modal.default.createDialog(_CreateRoomDialog.default, {
    type,
    defaultPublic: space.getJoinRule() === _partials.JoinRule.Public,
    parentSpace: space
  });

  const [shouldCreate, opts] = await modal.finished;

  if (shouldCreate) {
    await (0, _createRoom.default)(opts);
  }

  return shouldCreate;
};

exports.showCreateNewRoom = showCreateNewRoom;

const shouldShowSpaceInvite = space => (space?.getMyMembership() === "join" && space.canInvite(space.client.getUserId()) || space.getJoinRule() === _partials.JoinRule.Public) && (0, _UIComponents.shouldShowComponent)(_UIFeature.UIComponent.InviteUsers);

exports.shouldShowSpaceInvite = shouldShowSpaceInvite;

const showSpaceInvite = function (space) {
  let initialText = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "";

  if (space.getJoinRule() === "public") {
    const modal = _Modal.default.createDialog(_InfoDialog.default, {
      title: (0, _languageHandler._t)("Invite to %(spaceName)s", {
        spaceName: space.name
      }),
      description: /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("span", null, (0, _languageHandler._t)("Share your public space")), /*#__PURE__*/_react.default.createElement(_SpacePublicShare.default, {
        space: space,
        onFinished: () => modal.close()
      })),
      fixedWidth: false,
      button: false,
      className: "mx_SpacePanel_sharePublicSpace",
      hasCloseButton: true
    });
  } else {
    (0, _RoomInvite.showRoomInviteDialog)(space.roomId, initialText);
  }
};

exports.showSpaceInvite = showSpaceInvite;

const showAddExistingSubspace = space => {
  _Modal.default.createDialog(_AddExistingSubspaceDialog.default, {
    space,
    onCreateSubspaceClick: () => showCreateNewSubspace(space),
    onFinished: added => {
      if (added && _RoomViewStore.RoomViewStore.instance.getRoomId() === space.roomId) {
        _dispatcher.default.fire(_actions.Action.UpdateSpaceHierarchy);
      }
    }
  }, "mx_AddExistingToSpaceDialog_wrapper");
};

exports.showAddExistingSubspace = showAddExistingSubspace;

const showCreateNewSubspace = space => {
  _Modal.default.createDialog(_CreateSubspaceDialog.default, {
    space,
    onAddExistingSpaceClick: () => showAddExistingSubspace(space),
    onFinished: added => {
      if (added && _RoomViewStore.RoomViewStore.instance.getRoomId() === space.roomId) {
        _dispatcher.default.fire(_actions.Action.UpdateSpaceHierarchy);
      }
    }
  }, "mx_CreateSubspaceDialog_wrapper");
};

exports.showCreateNewSubspace = showCreateNewSubspace;

const bulkSpaceBehaviour = async (space, children, fn) => {
  const modal = _Modal.default.createDialog(_Spinner.default, null, "mx_Dialog_spinner");

  try {
    for (const room of children) {
      await fn(room);
    }

    await fn(space);
  } finally {
    modal.close();
  }
};

exports.bulkSpaceBehaviour = bulkSpaceBehaviour;

const showSpacePreferences = (space, initialTabId) => {
  _dispatcher.default.dispatch({
    action: _actions.Action.OpenSpacePreferences,
    space,
    initialTabId
  });
};

exports.showSpacePreferences = showSpacePreferences;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzaG91bGRTaG93U3BhY2VTZXR0aW5ncyIsInNwYWNlIiwidXNlcklkIiwiY2xpZW50IiwiZ2V0VXNlcklkIiwiZ2V0TXlNZW1iZXJzaGlwIiwiY3VycmVudFN0YXRlIiwibWF5U2VuZFN0YXRlRXZlbnQiLCJFdmVudFR5cGUiLCJSb29tQXZhdGFyIiwiUm9vbU5hbWUiLCJSb29tVG9waWMiLCJSb29tSm9pblJ1bGVzIiwibWFrZVNwYWNlUGFyZW50RXZlbnQiLCJyb29tIiwiY2Fub25pY2FsIiwidHlwZSIsIlNwYWNlUGFyZW50IiwiY29udGVudCIsImNhbGN1bGF0ZVJvb21WaWEiLCJzdGF0ZV9rZXkiLCJyb29tSWQiLCJzaG93U3BhY2VTZXR0aW5ncyIsImRlZmF1bHREaXNwYXRjaGVyIiwiZGlzcGF0Y2giLCJhY3Rpb24iLCJBY3Rpb24iLCJPcGVuU3BhY2VTZXR0aW5ncyIsInNob3dBZGRFeGlzdGluZ1Jvb21zIiwiT3BlbkFkZFRvRXhpc3RpbmdTcGFjZURpYWxvZyIsInNob3dDcmVhdGVOZXdSb29tIiwibW9kYWwiLCJNb2RhbCIsImNyZWF0ZURpYWxvZyIsIkNyZWF0ZVJvb21EaWFsb2ciLCJkZWZhdWx0UHVibGljIiwiZ2V0Sm9pblJ1bGUiLCJKb2luUnVsZSIsIlB1YmxpYyIsInBhcmVudFNwYWNlIiwic2hvdWxkQ3JlYXRlIiwib3B0cyIsImZpbmlzaGVkIiwiY3JlYXRlUm9vbSIsInNob3VsZFNob3dTcGFjZUludml0ZSIsImNhbkludml0ZSIsInNob3VsZFNob3dDb21wb25lbnQiLCJVSUNvbXBvbmVudCIsIkludml0ZVVzZXJzIiwic2hvd1NwYWNlSW52aXRlIiwiaW5pdGlhbFRleHQiLCJJbmZvRGlhbG9nIiwidGl0bGUiLCJfdCIsInNwYWNlTmFtZSIsIm5hbWUiLCJkZXNjcmlwdGlvbiIsImNsb3NlIiwiZml4ZWRXaWR0aCIsImJ1dHRvbiIsImNsYXNzTmFtZSIsImhhc0Nsb3NlQnV0dG9uIiwic2hvd1Jvb21JbnZpdGVEaWFsb2ciLCJzaG93QWRkRXhpc3RpbmdTdWJzcGFjZSIsIkFkZEV4aXN0aW5nU3Vic3BhY2VEaWFsb2ciLCJvbkNyZWF0ZVN1YnNwYWNlQ2xpY2siLCJzaG93Q3JlYXRlTmV3U3Vic3BhY2UiLCJvbkZpbmlzaGVkIiwiYWRkZWQiLCJSb29tVmlld1N0b3JlIiwiaW5zdGFuY2UiLCJnZXRSb29tSWQiLCJmaXJlIiwiVXBkYXRlU3BhY2VIaWVyYXJjaHkiLCJDcmVhdGVTdWJzcGFjZURpYWxvZyIsIm9uQWRkRXhpc3RpbmdTcGFjZUNsaWNrIiwiYnVsa1NwYWNlQmVoYXZpb3VyIiwiY2hpbGRyZW4iLCJmbiIsIlNwaW5uZXIiLCJzaG93U3BhY2VQcmVmZXJlbmNlcyIsImluaXRpYWxUYWJJZCIsIk9wZW5TcGFjZVByZWZlcmVuY2VzIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL3NwYWNlLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tXCI7XG5pbXBvcnQgeyBSb29tVHlwZSwgRXZlbnRUeXBlIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL0B0eXBlcy9ldmVudFwiO1xuaW1wb3J0IHsgSm9pblJ1bGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3BhcnRpYWxzXCI7XG5cbmltcG9ydCB7IGNhbGN1bGF0ZVJvb21WaWEgfSBmcm9tIFwiLi9wZXJtYWxpbmtzL1Blcm1hbGlua3NcIjtcbmltcG9ydCBNb2RhbCBmcm9tIFwiLi4vTW9kYWxcIjtcbmltcG9ydCBDcmVhdGVSb29tRGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvQ3JlYXRlUm9vbURpYWxvZ1wiO1xuaW1wb3J0IGNyZWF0ZVJvb20sIHsgSU9wdHMgfSBmcm9tIFwiLi4vY3JlYXRlUm9vbVwiO1xuaW1wb3J0IHsgX3QgfSBmcm9tIFwiLi4vbGFuZ3VhZ2VIYW5kbGVyXCI7XG5pbXBvcnQgU3BhY2VQdWJsaWNTaGFyZSBmcm9tIFwiLi4vY29tcG9uZW50cy92aWV3cy9zcGFjZXMvU3BhY2VQdWJsaWNTaGFyZVwiO1xuaW1wb3J0IEluZm9EaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9JbmZvRGlhbG9nXCI7XG5pbXBvcnQgeyBzaG93Um9vbUludml0ZURpYWxvZyB9IGZyb20gXCIuLi9Sb29tSW52aXRlXCI7XG5pbXBvcnQgQ3JlYXRlU3Vic3BhY2VEaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9DcmVhdGVTdWJzcGFjZURpYWxvZ1wiO1xuaW1wb3J0IEFkZEV4aXN0aW5nU3Vic3BhY2VEaWFsb2cgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlhbG9ncy9BZGRFeGlzdGluZ1N1YnNwYWNlRGlhbG9nXCI7XG5pbXBvcnQgZGVmYXVsdERpc3BhdGNoZXIgZnJvbSBcIi4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgUm9vbVZpZXdTdG9yZSB9IGZyb20gXCIuLi9zdG9yZXMvUm9vbVZpZXdTdG9yZVwiO1xuaW1wb3J0IHsgQWN0aW9uIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvYWN0aW9uc1wiO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZWxlbWVudHMvU3Bpbm5lclwiO1xuaW1wb3J0IHsgc2hvdWxkU2hvd0NvbXBvbmVudCB9IGZyb20gXCIuLi9jdXN0b21pc2F0aW9ucy9oZWxwZXJzL1VJQ29tcG9uZW50c1wiO1xuaW1wb3J0IHsgVUlDb21wb25lbnQgfSBmcm9tIFwiLi4vc2V0dGluZ3MvVUlGZWF0dXJlXCI7XG5pbXBvcnQgeyBPcGVuU3BhY2VQcmVmZXJlbmNlc1BheWxvYWQsIFNwYWNlUHJlZmVyZW5jZVRhYiB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL3BheWxvYWRzL09wZW5TcGFjZVByZWZlcmVuY2VzUGF5bG9hZFwiO1xuaW1wb3J0IHsgT3BlblNwYWNlU2V0dGluZ3NQYXlsb2FkIH0gZnJvbSBcIi4uL2Rpc3BhdGNoZXIvcGF5bG9hZHMvT3BlblNwYWNlU2V0dGluZ3NQYXlsb2FkXCI7XG5pbXBvcnQgeyBPcGVuQWRkRXhpc3RpbmdUb1NwYWNlRGlhbG9nUGF5bG9hZCB9IGZyb20gXCIuLi9kaXNwYXRjaGVyL3BheWxvYWRzL09wZW5BZGRFeGlzdGluZ1RvU3BhY2VEaWFsb2dQYXlsb2FkXCI7XG5cbmV4cG9ydCBjb25zdCBzaG91bGRTaG93U3BhY2VTZXR0aW5ncyA9IChzcGFjZTogUm9vbSkgPT4ge1xuICAgIGNvbnN0IHVzZXJJZCA9IHNwYWNlLmNsaWVudC5nZXRVc2VySWQoKTtcbiAgICByZXR1cm4gc3BhY2UuZ2V0TXlNZW1iZXJzaGlwKCkgPT09IFwiam9pblwiXG4gICAgICAgICYmIChzcGFjZS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21BdmF0YXIsIHVzZXJJZClcbiAgICAgICAgICAgIHx8IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbU5hbWUsIHVzZXJJZClcbiAgICAgICAgICAgIHx8IHNwYWNlLmN1cnJlbnRTdGF0ZS5tYXlTZW5kU3RhdGVFdmVudChFdmVudFR5cGUuUm9vbVRvcGljLCB1c2VySWQpXG4gICAgICAgICAgICB8fCBzcGFjZS5jdXJyZW50U3RhdGUubWF5U2VuZFN0YXRlRXZlbnQoRXZlbnRUeXBlLlJvb21Kb2luUnVsZXMsIHVzZXJJZCkpO1xufTtcblxuZXhwb3J0IGNvbnN0IG1ha2VTcGFjZVBhcmVudEV2ZW50ID0gKHJvb206IFJvb20sIGNhbm9uaWNhbCA9IGZhbHNlKSA9PiAoe1xuICAgIHR5cGU6IEV2ZW50VHlwZS5TcGFjZVBhcmVudCxcbiAgICBjb250ZW50OiB7XG4gICAgICAgIFwidmlhXCI6IGNhbGN1bGF0ZVJvb21WaWEocm9vbSksXG4gICAgICAgIFwiY2Fub25pY2FsXCI6IGNhbm9uaWNhbCxcbiAgICB9LFxuICAgIHN0YXRlX2tleTogcm9vbS5yb29tSWQsXG59KTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNob3dTcGFjZVNldHRpbmdzKHNwYWNlOiBSb29tKSB7XG4gICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2g8T3BlblNwYWNlU2V0dGluZ3NQYXlsb2FkPih7XG4gICAgICAgIGFjdGlvbjogQWN0aW9uLk9wZW5TcGFjZVNldHRpbmdzLFxuICAgICAgICBzcGFjZSxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IHNob3dBZGRFeGlzdGluZ1Jvb21zID0gKHNwYWNlOiBSb29tKTogdm9pZCA9PiB7XG4gICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2g8T3BlbkFkZEV4aXN0aW5nVG9TcGFjZURpYWxvZ1BheWxvYWQ+KHtcbiAgICAgICAgYWN0aW9uOiBBY3Rpb24uT3BlbkFkZFRvRXhpc3RpbmdTcGFjZURpYWxvZyxcbiAgICAgICAgc3BhY2UsXG4gICAgfSk7XG59O1xuXG5leHBvcnQgY29uc3Qgc2hvd0NyZWF0ZU5ld1Jvb20gPSBhc3luYyAoc3BhY2U6IFJvb20sIHR5cGU/OiBSb29tVHlwZSk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIGNvbnN0IG1vZGFsID0gTW9kYWwuY3JlYXRlRGlhbG9nPFtib29sZWFuLCBJT3B0c10+KENyZWF0ZVJvb21EaWFsb2csIHtcbiAgICAgICAgdHlwZSxcbiAgICAgICAgZGVmYXVsdFB1YmxpYzogc3BhY2UuZ2V0Sm9pblJ1bGUoKSA9PT0gSm9pblJ1bGUuUHVibGljLFxuICAgICAgICBwYXJlbnRTcGFjZTogc3BhY2UsXG4gICAgfSk7XG4gICAgY29uc3QgW3Nob3VsZENyZWF0ZSwgb3B0c10gPSBhd2FpdCBtb2RhbC5maW5pc2hlZDtcbiAgICBpZiAoc2hvdWxkQ3JlYXRlKSB7XG4gICAgICAgIGF3YWl0IGNyZWF0ZVJvb20ob3B0cyk7XG4gICAgfVxuICAgIHJldHVybiBzaG91bGRDcmVhdGU7XG59O1xuXG5leHBvcnQgY29uc3Qgc2hvdWxkU2hvd1NwYWNlSW52aXRlID0gKHNwYWNlOiBSb29tKSA9PlxuICAgIChcbiAgICAgICAgKHNwYWNlPy5nZXRNeU1lbWJlcnNoaXAoKSA9PT0gXCJqb2luXCIgJiYgc3BhY2UuY2FuSW52aXRlKHNwYWNlLmNsaWVudC5nZXRVc2VySWQoKSkpIHx8XG4gICAgICAgIHNwYWNlLmdldEpvaW5SdWxlKCkgPT09IEpvaW5SdWxlLlB1YmxpY1xuICAgICkgJiYgc2hvdWxkU2hvd0NvbXBvbmVudChVSUNvbXBvbmVudC5JbnZpdGVVc2Vycyk7XG5cbmV4cG9ydCBjb25zdCBzaG93U3BhY2VJbnZpdGUgPSAoc3BhY2U6IFJvb20sIGluaXRpYWxUZXh0ID0gXCJcIik6IHZvaWQgPT4ge1xuICAgIGlmIChzcGFjZS5nZXRKb2luUnVsZSgpID09PSBcInB1YmxpY1wiKSB7XG4gICAgICAgIGNvbnN0IG1vZGFsID0gTW9kYWwuY3JlYXRlRGlhbG9nKEluZm9EaWFsb2csIHtcbiAgICAgICAgICAgIHRpdGxlOiBfdChcIkludml0ZSB0byAlKHNwYWNlTmFtZSlzXCIsIHsgc3BhY2VOYW1lOiBzcGFjZS5uYW1lIH0pLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IDxSZWFjdC5GcmFnbWVudD5cbiAgICAgICAgICAgICAgICA8c3Bhbj57IF90KFwiU2hhcmUgeW91ciBwdWJsaWMgc3BhY2VcIikgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8U3BhY2VQdWJsaWNTaGFyZSBzcGFjZT17c3BhY2V9IG9uRmluaXNoZWQ9eygpID0+IG1vZGFsLmNsb3NlKCl9IC8+XG4gICAgICAgICAgICA8L1JlYWN0LkZyYWdtZW50PixcbiAgICAgICAgICAgIGZpeGVkV2lkdGg6IGZhbHNlLFxuICAgICAgICAgICAgYnV0dG9uOiBmYWxzZSxcbiAgICAgICAgICAgIGNsYXNzTmFtZTogXCJteF9TcGFjZVBhbmVsX3NoYXJlUHVibGljU3BhY2VcIixcbiAgICAgICAgICAgIGhhc0Nsb3NlQnV0dG9uOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBzaG93Um9vbUludml0ZURpYWxvZyhzcGFjZS5yb29tSWQsIGluaXRpYWxUZXh0KTtcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3Qgc2hvd0FkZEV4aXN0aW5nU3Vic3BhY2UgPSAoc3BhY2U6IFJvb20pOiB2b2lkID0+IHtcbiAgICBNb2RhbC5jcmVhdGVEaWFsb2coQWRkRXhpc3RpbmdTdWJzcGFjZURpYWxvZywge1xuICAgICAgICBzcGFjZSxcbiAgICAgICAgb25DcmVhdGVTdWJzcGFjZUNsaWNrOiAoKSA9PiBzaG93Q3JlYXRlTmV3U3Vic3BhY2Uoc3BhY2UpLFxuICAgICAgICBvbkZpbmlzaGVkOiAoYWRkZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgIGlmIChhZGRlZCAmJiBSb29tVmlld1N0b3JlLmluc3RhbmNlLmdldFJvb21JZCgpID09PSBzcGFjZS5yb29tSWQpIHtcbiAgICAgICAgICAgICAgICBkZWZhdWx0RGlzcGF0Y2hlci5maXJlKEFjdGlvbi5VcGRhdGVTcGFjZUhpZXJhcmNoeSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgfSwgXCJteF9BZGRFeGlzdGluZ1RvU3BhY2VEaWFsb2dfd3JhcHBlclwiKTtcbn07XG5cbmV4cG9ydCBjb25zdCBzaG93Q3JlYXRlTmV3U3Vic3BhY2UgPSAoc3BhY2U6IFJvb20pOiB2b2lkID0+IHtcbiAgICBNb2RhbC5jcmVhdGVEaWFsb2coQ3JlYXRlU3Vic3BhY2VEaWFsb2csIHtcbiAgICAgICAgc3BhY2UsXG4gICAgICAgIG9uQWRkRXhpc3RpbmdTcGFjZUNsaWNrOiAoKSA9PiBzaG93QWRkRXhpc3RpbmdTdWJzcGFjZShzcGFjZSksXG4gICAgICAgIG9uRmluaXNoZWQ6IChhZGRlZDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgaWYgKGFkZGVkICYmIFJvb21WaWV3U3RvcmUuaW5zdGFuY2UuZ2V0Um9vbUlkKCkgPT09IHNwYWNlLnJvb21JZCkge1xuICAgICAgICAgICAgICAgIGRlZmF1bHREaXNwYXRjaGVyLmZpcmUoQWN0aW9uLlVwZGF0ZVNwYWNlSGllcmFyY2h5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9LCBcIm14X0NyZWF0ZVN1YnNwYWNlRGlhbG9nX3dyYXBwZXJcIik7XG59O1xuXG5leHBvcnQgY29uc3QgYnVsa1NwYWNlQmVoYXZpb3VyID0gYXN5bmMgKFxuICAgIHNwYWNlOiBSb29tLFxuICAgIGNoaWxkcmVuOiBSb29tW10sXG4gICAgZm46IChyb29tOiBSb29tKSA9PiBQcm9taXNlPHVua25vd24+LFxuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgbW9kYWwgPSBNb2RhbC5jcmVhdGVEaWFsb2coU3Bpbm5lciwgbnVsbCwgXCJteF9EaWFsb2dfc3Bpbm5lclwiKTtcbiAgICB0cnkge1xuICAgICAgICBmb3IgKGNvbnN0IHJvb20gb2YgY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGF3YWl0IGZuKHJvb20pO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IGZuKHNwYWNlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgICBtb2RhbC5jbG9zZSgpO1xuICAgIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzaG93U3BhY2VQcmVmZXJlbmNlcyA9IChzcGFjZTogUm9vbSwgaW5pdGlhbFRhYklkPzogU3BhY2VQcmVmZXJlbmNlVGFiKSA9PiB7XG4gICAgZGVmYXVsdERpc3BhdGNoZXIuZGlzcGF0Y2g8T3BlblNwYWNlUHJlZmVyZW5jZXNQYXlsb2FkPih7XG4gICAgICAgIGFjdGlvbjogQWN0aW9uLk9wZW5TcGFjZVByZWZlcmVuY2VzLFxuICAgICAgICBzcGFjZSxcbiAgICAgICAgaW5pdGlhbFRhYklkLFxuICAgIH0pO1xufTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQWdCQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFwQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBMkJPLE1BQU1BLHVCQUF1QixHQUFJQyxLQUFELElBQWlCO0VBQ3BELE1BQU1DLE1BQU0sR0FBR0QsS0FBSyxDQUFDRSxNQUFOLENBQWFDLFNBQWIsRUFBZjtFQUNBLE9BQU9ILEtBQUssQ0FBQ0ksZUFBTixPQUE0QixNQUE1QixLQUNDSixLQUFLLENBQUNLLFlBQU4sQ0FBbUJDLGlCQUFuQixDQUFxQ0MsZ0JBQUEsQ0FBVUMsVUFBL0MsRUFB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