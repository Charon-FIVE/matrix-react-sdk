"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _logger = require("matrix-js-sdk/src/logger");

var _event = require("matrix-js-sdk/src/@types/event");

var _createRoom = require("./createRoom");

var _MatrixClientPeg = require("./MatrixClientPeg");

var _DMRoomMap = _interopRequireDefault(require("./utils/DMRoomMap"));

var _LegacyCallHandler = _interopRequireDefault(require("./LegacyCallHandler"));

var _callTypes = require("./call-types");

var _findDMForUser = require("./utils/dm/findDMForUser");

/*
Copyright 2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// Functions for mapping virtual users & rooms. Currently the only lookup
// is sip virtual: there could be others in the future.
class VoipUserMapper {
  constructor() {
    (0, _defineProperty2.default)(this, "virtualToNativeRoomIdCache", new Map());
  }

  static sharedInstance() {
    if (window.mxVoipUserMapper === undefined) window.mxVoipUserMapper = new VoipUserMapper();
    return window.mxVoipUserMapper;
  }

  async userToVirtualUser(userId) {
    const results = await _LegacyCallHandler.default.instance.sipVirtualLookup(userId);
    if (results.length === 0 || !results[0].fields.lookup_success) return null;
    return results[0].userid;
  }

  async getVirtualUserForRoom(roomId) {
    const userId = _DMRoomMap.default.shared().getUserIdForRoomId(roomId);

    if (!userId) return null;
    const virtualUser = await this.userToVirtualUser(userId);
    if (!virtualUser) return null;
    return virtualUser;
  }

  async getOrCreateVirtualRoomForRoom(roomId) {
    const virtualUser = await this.getVirtualUserForRoom(roomId);
    if (!virtualUser) return null;
    const virtualRoomId = await (0, _createRoom.ensureVirtualRoomExists)(_MatrixClientPeg.MatrixClientPeg.get(), virtualUser, roomId);

    _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(virtualRoomId, _callTypes.VIRTUAL_ROOM_EVENT_TYPE, {
      native_room: roomId
    });

    this.virtualToNativeRoomIdCache.set(virtualRoomId, roomId);
    return virtualRoomId;
  }
  /**
   * Gets the ID of the virtual room for a room, or null if the room has no
   * virtual room
   */


  async getVirtualRoomForRoom(roomId) {
    const virtualUser = await this.getVirtualUserForRoom(roomId);
    if (!virtualUser) return null;
    return (0, _findDMForUser.findDMForUser)(_MatrixClientPeg.MatrixClientPeg.get(), virtualUser);
  }

  nativeRoomForVirtualRoom(roomId) {
    const cachedNativeRoomId = this.virtualToNativeRoomIdCache.get(roomId);

    if (cachedNativeRoomId) {
      _logger.logger.log("Returning native room ID " + cachedNativeRoomId + " for virtual room ID " + roomId + " from cache");

      return cachedNativeRoomId;
    }

    const virtualRoom = _MatrixClientPeg.MatrixClientPeg.get().getRoom(roomId);

    if (!virtualRoom) return null;
    const virtualRoomEvent = virtualRoom.getAccountData(_callTypes.VIRTUAL_ROOM_EVENT_TYPE);
    if (!virtualRoomEvent || !virtualRoomEvent.getContent()) return null;
    const nativeRoomID = virtualRoomEvent.getContent()['native_room'];

    const nativeRoom = _MatrixClientPeg.MatrixClientPeg.get().getRoom(nativeRoomID);

    if (!nativeRoom || nativeRoom.getMyMembership() !== 'join') return null;
    return nativeRoomID;
  }

  isVirtualRoom(room) {
    if (this.nativeRoomForVirtualRoom(room.roomId)) return true;
    if (this.virtualToNativeRoomIdCache.has(room.roomId)) return true; // also look in the create event for the claimed native room ID, which is the only
    // way we can recognise a virtual room we've created when it first arrives down
    // our stream. We don't trust this in general though, as it could be faked by an
    // inviter: our main source of truth is the DM state.

    const roomCreateEvent = room.currentState.getStateEvents(_event.EventType.RoomCreate, "");
    if (!roomCreateEvent || !roomCreateEvent.getContent()) return false; // we only look at this for rooms we created (so inviters can't just cause rooms
    // to be invisible)

    if (roomCreateEvent.getSender() !== _MatrixClientPeg.MatrixClientPeg.get().getUserId()) return false;

    const claimedNativeRoomId = roomCreateEvent.getContent()[_callTypes.VIRTUAL_ROOM_EVENT_TYPE];

    return Boolean(claimedNativeRoomId);
  }

  async onNewInvitedRoom(invitedRoom) {
    if (!_LegacyCallHandler.default.instance.getSupportsVirtualRooms()) return;
    const inviterId = invitedRoom.getDMInviter();

    _logger.logger.log(`Checking virtual-ness of room ID ${invitedRoom.roomId}, invited by ${inviterId}`);

    const result = await _LegacyCallHandler.default.instance.sipNativeLookup(inviterId);

    if (result.length === 0) {
      return;
    }

    if (result[0].fields.is_virtual) {
      const nativeUser = result[0].userid;
      const nativeRoom = (0, _findDMForUser.findDMForUser)(_MatrixClientPeg.MatrixClientPeg.get(), nativeUser);

      if (nativeRoom) {
        // It's a virtual room with a matching native room, so set the room account data. This
        // will make sure we know where how to map calls and also allow us know not to display
        // it in the future.
        _MatrixClientPeg.MatrixClientPeg.get().setRoomAccountData(invitedRoom.roomId, _callTypes.VIRTUAL_ROOM_EVENT_TYPE, {
          native_room: nativeRoom.roomId
        }); // also auto-join the virtual room if we have a matching native room
        // (possibly we should only join if we've also joined the native room, then we'd also have
        // to make sure we joined virtual rooms on joining a native one)


        _MatrixClientPeg.MatrixClientPeg.get().joinRoom(invitedRoom.roomId);
      } // also put this room in the virtual room ID cache so isVirtualRoom return the right answer
      // in however long it takes for the echo of setAccountData to come down the sync


      this.virtualToNativeRoomIdCache.set(invitedRoom.roomId, nativeRoom.roomId);
    }
  }

}

exports.default = VoipUserMapper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWb2lwVXNlck1hcHBlciIsIk1hcCIsInNoYXJlZEluc3RhbmNlIiwid2luZG93IiwibXhWb2lwVXNlck1hcHBlciIsInVuZGVmaW5lZCIsInVzZXJUb1ZpcnR1YWxVc2VyIiwidXNlcklkIiwicmVzdWx0cyIsIkxlZ2FjeUNhbGxIYW5kbGVyIiwiaW5zdGFuY2UiLCJzaXBWaXJ0dWFsTG9va3VwIiwibGVuZ3RoIiwiZmllbGRzIiwibG9va3VwX3N1Y2Nlc3MiLCJ1c2VyaWQiLCJnZXRWaXJ0dWFsVXNlckZvclJvb20iLCJyb29tSWQiLCJETVJvb21NYXAiLCJzaGFyZWQiLCJnZXRVc2VySWRGb3JSb29tSWQiLCJ2aXJ0dWFsVXNlciIsImdldE9yQ3JlYXRlVmlydHVhbFJvb21Gb3JSb29tIiwidmlydHVhbFJvb21JZCIsImVuc3VyZVZpcnR1YWxSb29tRXhpc3RzIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwic2V0Um9vbUFjY291bnREYXRhIiwiVklSVFVBTF9ST09NX0VWRU5UX1RZUEUiLCJuYXRpdmVfcm9vbSIsInZpcnR1YWxUb05hdGl2ZVJvb21JZENhY2hlIiwic2V0IiwiZ2V0VmlydHVhbFJvb21Gb3JSb29tIiwiZmluZERNRm9yVXNlciIsIm5hdGl2ZVJvb21Gb3JWaXJ0dWFsUm9vbSIsImNhY2hlZE5hdGl2ZVJvb21JZCIsImxvZ2dlciIsImxvZyIsInZpcnR1YWxSb29tIiwiZ2V0Um9vbSIsInZpcnR1YWxSb29tRXZlbnQiLCJnZXRBY2NvdW50RGF0YSIsImdldENvbnRlbnQiLCJuYXRpdmVSb29tSUQiLCJuYXRpdmVSb29tIiwiZ2V0TXlNZW1iZXJzaGlwIiwiaXNWaXJ0dWFsUm9vbSIsInJvb20iLCJoYXMiLCJyb29tQ3JlYXRlRXZlbnQiLCJjdXJyZW50U3RhdGUiLCJnZXRTdGF0ZUV2ZW50cyIsIkV2ZW50VHlwZSIsIlJvb21DcmVhdGUiLCJnZXRTZW5kZXIiLCJnZXRVc2VySWQiLCJjbGFpbWVkTmF0aXZlUm9vbUlkIiwiQm9vbGVhbiIsIm9uTmV3SW52aXRlZFJvb20iLCJpbnZpdGVkUm9vbSIsImdldFN1cHBvcnRzVmlydHVhbFJvb21zIiwiaW52aXRlcklkIiwiZ2V0RE1JbnZpdGVyIiwicmVzdWx0Iiwic2lwTmF0aXZlTG9va3VwIiwiaXNfdmlydHVhbCIsIm5hdGl2ZVVzZXIiLCJqb2luUm9vbSJdLCJzb3VyY2VzIjpbIi4uL3NyYy9Wb2lwVXNlck1hcHBlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjEgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgeyBSb29tIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20nO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50JztcblxuaW1wb3J0IHsgZW5zdXJlVmlydHVhbFJvb21FeGlzdHMgfSBmcm9tICcuL2NyZWF0ZVJvb20nO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4vTWF0cml4Q2xpZW50UGVnXCI7XG5pbXBvcnQgRE1Sb29tTWFwIGZyb20gXCIuL3V0aWxzL0RNUm9vbU1hcFwiO1xuaW1wb3J0IExlZ2FjeUNhbGxIYW5kbGVyIGZyb20gJy4vTGVnYWN5Q2FsbEhhbmRsZXInO1xuaW1wb3J0IHsgVklSVFVBTF9ST09NX0VWRU5UX1RZUEUgfSBmcm9tIFwiLi9jYWxsLXR5cGVzXCI7XG5pbXBvcnQgeyBmaW5kRE1Gb3JVc2VyIH0gZnJvbSAnLi91dGlscy9kbS9maW5kRE1Gb3JVc2VyJztcblxuLy8gRnVuY3Rpb25zIGZvciBtYXBwaW5nIHZpcnR1YWwgdXNlcnMgJiByb29tcy4gQ3VycmVudGx5IHRoZSBvbmx5IGxvb2t1cFxuLy8gaXMgc2lwIHZpcnR1YWw6IHRoZXJlIGNvdWxkIGJlIG90aGVycyBpbiB0aGUgZnV0dXJlLlxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWb2lwVXNlck1hcHBlciB7XG4gICAgLy8gV2Ugc3RvcmUgbWFwcGluZ3Mgb2YgdmlydHVhbCAtPiBuYXRpdmUgcm9vbSBJRHMgaGVyZSB1bnRpbCB0aGUgbG9jYWwgZWNobyBmb3IgdGhlXG4gICAgLy8gYWNjb3VudCBkYXRhIGFycml2ZXMuXG4gICAgcHJpdmF0ZSB2aXJ0dWFsVG9OYXRpdmVSb29tSWRDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG5cbiAgICBwdWJsaWMgc3RhdGljIHNoYXJlZEluc3RhbmNlKCk6IFZvaXBVc2VyTWFwcGVyIHtcbiAgICAgICAgaWYgKHdpbmRvdy5teFZvaXBVc2VyTWFwcGVyID09PSB1bmRlZmluZWQpIHdpbmRvdy5teFZvaXBVc2VyTWFwcGVyID0gbmV3IFZvaXBVc2VyTWFwcGVyKCk7XG4gICAgICAgIHJldHVybiB3aW5kb3cubXhWb2lwVXNlck1hcHBlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHVzZXJUb1ZpcnR1YWxVc2VyKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IExlZ2FjeUNhbGxIYW5kbGVyLmluc3RhbmNlLnNpcFZpcnR1YWxMb29rdXAodXNlcklkKTtcbiAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwIHx8ICFyZXN1bHRzWzBdLmZpZWxkcy5sb29rdXBfc3VjY2VzcykgcmV0dXJuIG51bGw7XG4gICAgICAgIHJldHVybiByZXN1bHRzWzBdLnVzZXJpZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGdldFZpcnR1YWxVc2VyRm9yUm9vbShyb29tSWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgICAgICBjb25zdCB1c2VySWQgPSBETVJvb21NYXAuc2hhcmVkKCkuZ2V0VXNlcklkRm9yUm9vbUlkKHJvb21JZCk7XG4gICAgICAgIGlmICghdXNlcklkKSByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCB2aXJ0dWFsVXNlciA9IGF3YWl0IHRoaXMudXNlclRvVmlydHVhbFVzZXIodXNlcklkKTtcbiAgICAgICAgaWYgKCF2aXJ0dWFsVXNlcikgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgcmV0dXJuIHZpcnR1YWxVc2VyO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBnZXRPckNyZWF0ZVZpcnR1YWxSb29tRm9yUm9vbShyb29tSWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgICAgICBjb25zdCB2aXJ0dWFsVXNlciA9IGF3YWl0IHRoaXMuZ2V0VmlydHVhbFVzZXJGb3JSb29tKHJvb21JZCk7XG4gICAgICAgIGlmICghdmlydHVhbFVzZXIpIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IHZpcnR1YWxSb29tSWQgPSBhd2FpdCBlbnN1cmVWaXJ0dWFsUm9vbUV4aXN0cyhNYXRyaXhDbGllbnRQZWcuZ2V0KCksIHZpcnR1YWxVc2VyLCByb29tSWQpO1xuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuc2V0Um9vbUFjY291bnREYXRhKHZpcnR1YWxSb29tSWQsIFZJUlRVQUxfUk9PTV9FVkVOVF9UWVBFLCB7XG4gICAgICAgICAgICBuYXRpdmVfcm9vbTogcm9vbUlkLFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpcnR1YWxUb05hdGl2ZVJvb21JZENhY2hlLnNldCh2aXJ0dWFsUm9vbUlkLCByb29tSWQpO1xuXG4gICAgICAgIHJldHVybiB2aXJ0dWFsUm9vbUlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIElEIG9mIHRoZSB2aXJ0dWFsIHJvb20gZm9yIGEgcm9vbSwgb3IgbnVsbCBpZiB0aGUgcm9vbSBoYXMgbm9cbiAgICAgKiB2aXJ0dWFsIHJvb21cbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgZ2V0VmlydHVhbFJvb21Gb3JSb29tKHJvb21JZDogc3RyaW5nKTogUHJvbWlzZTxSb29tIHwgbnVsbD4ge1xuICAgICAgICBjb25zdCB2aXJ0dWFsVXNlciA9IGF3YWl0IHRoaXMuZ2V0VmlydHVhbFVzZXJGb3JSb29tKHJvb21JZCk7XG4gICAgICAgIGlmICghdmlydHVhbFVzZXIpIHJldHVybiBudWxsO1xuXG4gICAgICAgIHJldHVybiBmaW5kRE1Gb3JVc2VyKE1hdHJpeENsaWVudFBlZy5nZXQoKSwgdmlydHVhbFVzZXIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBuYXRpdmVSb29tRm9yVmlydHVhbFJvb20ocm9vbUlkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBjYWNoZWROYXRpdmVSb29tSWQgPSB0aGlzLnZpcnR1YWxUb05hdGl2ZVJvb21JZENhY2hlLmdldChyb29tSWQpO1xuICAgICAgICBpZiAoY2FjaGVkTmF0aXZlUm9vbUlkKSB7XG4gICAgICAgICAgICBsb2dnZXIubG9nKFxuICAgICAgICAgICAgICAgIFwiUmV0dXJuaW5nIG5hdGl2ZSByb29tIElEIFwiICsgY2FjaGVkTmF0aXZlUm9vbUlkICsgXCIgZm9yIHZpcnR1YWwgcm9vbSBJRCBcIiArIHJvb21JZCArIFwiIGZyb20gY2FjaGVcIixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gY2FjaGVkTmF0aXZlUm9vbUlkO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdmlydHVhbFJvb20gPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZ2V0Um9vbShyb29tSWQpO1xuICAgICAgICBpZiAoIXZpcnR1YWxSb29tKSByZXR1cm4gbnVsbDtcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb21FdmVudCA9IHZpcnR1YWxSb29tLmdldEFjY291bnREYXRhKFZJUlRVQUxfUk9PTV9FVkVOVF9UWVBFKTtcbiAgICAgICAgaWYgKCF2aXJ0dWFsUm9vbUV2ZW50IHx8ICF2aXJ0dWFsUm9vbUV2ZW50LmdldENvbnRlbnQoKSkgcmV0dXJuIG51bGw7XG4gICAgICAgIGNvbnN0IG5hdGl2ZVJvb21JRCA9IHZpcnR1YWxSb29tRXZlbnQuZ2V0Q29udGVudCgpWyduYXRpdmVfcm9vbSddO1xuICAgICAgICBjb25zdCBuYXRpdmVSb29tID0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFJvb20obmF0aXZlUm9vbUlEKTtcbiAgICAgICAgaWYgKCFuYXRpdmVSb29tIHx8IG5hdGl2ZVJvb20uZ2V0TXlNZW1iZXJzaGlwKCkgIT09ICdqb2luJykgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgcmV0dXJuIG5hdGl2ZVJvb21JRDtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNWaXJ0dWFsUm9vbShyb29tOiBSb29tKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLm5hdGl2ZVJvb21Gb3JWaXJ0dWFsUm9vbShyb29tLnJvb21JZCkpIHJldHVybiB0cnVlO1xuXG4gICAgICAgIGlmICh0aGlzLnZpcnR1YWxUb05hdGl2ZVJvb21JZENhY2hlLmhhcyhyb29tLnJvb21JZCkpIHJldHVybiB0cnVlO1xuXG4gICAgICAgIC8vIGFsc28gbG9vayBpbiB0aGUgY3JlYXRlIGV2ZW50IGZvciB0aGUgY2xhaW1lZCBuYXRpdmUgcm9vbSBJRCwgd2hpY2ggaXMgdGhlIG9ubHlcbiAgICAgICAgLy8gd2F5IHdlIGNhbiByZWNvZ25pc2UgYSB2aXJ0dWFsIHJvb20gd2UndmUgY3JlYXRlZCB3aGVuIGl0IGZpcnN0IGFycml2ZXMgZG93blxuICAgICAgICAvLyBvdXIgc3RyZWFtLiBXZSBkb24ndCB0cnVzdCB0aGlzIGluIGdlbmVyYWwgdGhvdWdoLCBhcyBpdCBjb3VsZCBiZSBmYWtlZCBieSBhblxuICAgICAgICAvLyBpbnZpdGVyOiBvdXIgbWFpbiBzb3VyY2Ugb2YgdHJ1dGggaXMgdGhlIERNIHN0YXRlLlxuICAgICAgICBjb25zdCByb29tQ3JlYXRlRXZlbnQgPSByb29tLmN1cnJlbnRTdGF0ZS5nZXRTdGF0ZUV2ZW50cyhFdmVudFR5cGUuUm9vbUNyZWF0ZSwgXCJcIik7XG4gICAgICAgIGlmICghcm9vbUNyZWF0ZUV2ZW50IHx8ICFyb29tQ3JlYXRlRXZlbnQuZ2V0Q29udGVudCgpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIC8vIHdlIG9ubHkgbG9vayBhdCB0aGlzIGZvciByb29tcyB3ZSBjcmVhdGVkIChzbyBpbnZpdGVycyBjYW4ndCBqdXN0IGNhdXNlIHJvb21zXG4gICAgICAgIC8vIHRvIGJlIGludmlzaWJsZSlcbiAgICAgICAgaWYgKHJvb21DcmVhdGVFdmVudC5nZXRTZW5kZXIoKSAhPT0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGNvbnN0IGNsYWltZWROYXRpdmVSb29tSWQgPSByb29tQ3JlYXRlRXZlbnQuZ2V0Q29udGVudCgpW1ZJUlRVQUxfUk9PTV9FVkVOVF9UWVBFXTtcbiAgICAgICAgcmV0dXJuIEJvb2xlYW4oY2xhaW1lZE5hdGl2ZVJvb21JZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIG9uTmV3SW52aXRlZFJvb20oaW52aXRlZFJvb206IFJvb20pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCFMZWdhY3lDYWxsSGFuZGxlci5pbnN0YW5jZS5nZXRTdXBwb3J0c1ZpcnR1YWxSb29tcygpKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgaW52aXRlcklkID0gaW52aXRlZFJvb20uZ2V0RE1JbnZpdGVyKCk7XG4gICAgICAgIGxvZ2dlci5sb2coYENoZWNraW5nIHZpcnR1YWwtbmVzcyBvZiByb29tIElEICR7aW52aXRlZFJvb20ucm9vbUlkfSwgaW52aXRlZCBieSAke2ludml0ZXJJZH1gKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgTGVnYWN5Q2FsbEhhbmRsZXIuaW5zdGFuY2Uuc2lwTmF0aXZlTG9va3VwKGludml0ZXJJZCk7XG4gICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVzdWx0WzBdLmZpZWxkcy5pc192aXJ0dWFsKSB7XG4gICAgICAgICAgICBjb25zdCBuYXRpdmVVc2VyID0gcmVzdWx0WzBdLnVzZXJpZDtcbiAgICAgICAgICAgIGNvbnN0IG5hdGl2ZVJvb20gPSBmaW5kRE1Gb3JVc2VyKE1hdHJpeENsaWVudFBlZy5nZXQoKSwgbmF0aXZlVXNlcik7XG4gICAgICAgICAgICBpZiAobmF0aXZlUm9vbSkge1xuICAgICAgICAgICAgICAgIC8vIEl0J3MgYSB2aXJ0dWFsIHJvb20gd2l0aCBhIG1hdGNoaW5nIG5hdGl2ZSByb29tLCBzbyBzZXQgdGhlIHJvb20gYWNjb3VudCBkYXRhLiBUaGlzXG4gICAgICAgICAgICAgICAgLy8gd2lsbCBtYWtlIHN1cmUgd2Uga25vdyB3aGVyZSBob3cgdG8gbWFwIGNhbGxzIGFuZCBhbHNvIGFsbG93IHVzIGtub3cgbm90IHRvIGRpc3BsYXlcbiAgICAgICAgICAgICAgICAvLyBpdCBpbiB0aGUgZnV0dXJlLlxuICAgICAgICAgICAgICAgIE1hdHJpeENsaWVudFBlZy5nZXQoKS5zZXRSb29tQWNjb3VudERhdGEoaW52aXRlZFJvb20ucm9vbUlkLCBWSVJUVUFMX1JPT01fRVZFTlRfVFlQRSwge1xuICAgICAgICAgICAgICAgICAgICBuYXRpdmVfcm9vbTogbmF0aXZlUm9vbS5yb29tSWQsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy8gYWxzbyBhdXRvLWpvaW4gdGhlIHZpcnR1YWwgcm9vbSBpZiB3ZSBoYXZlIGEgbWF0Y2hpbmcgbmF0aXZlIHJvb21cbiAgICAgICAgICAgICAgICAvLyAocG9zc2libHkgd2Ugc2hvdWxkIG9ubHkgam9pbiBpZiB3ZSd2ZSBhbHNvIGpvaW5lZCB0aGUgbmF0aXZlIHJvb20sIHRoZW4gd2UnZCBhbHNvIGhhdmVcbiAgICAgICAgICAgICAgICAvLyB0byBtYWtlIHN1cmUgd2Ugam9pbmVkIHZpcnR1YWwgcm9vbXMgb24gam9pbmluZyBhIG5hdGl2ZSBvbmUpXG4gICAgICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLmpvaW5Sb29tKGludml0ZWRSb29tLnJvb21JZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGFsc28gcHV0IHRoaXMgcm9vbSBpbiB0aGUgdmlydHVhbCByb29tIElEIGNhY2hlIHNvIGlzVmlydHVhbFJvb20gcmV0dXJuIHRoZSByaWdodCBhbnN3ZXJcbiAgICAgICAgICAgIC8vIGluIGhvd2V2ZXIgbG9uZyBpdCB0YWtlcyBmb3IgdGhlIGVjaG8gb2Ygc2V0QWNjb3VudERhdGEgdG8gY29tZSBkb3duIHRoZSBzeW5jXG4gICAgICAgICAgICB0aGlzLnZpcnR1YWxUb05hdGl2ZVJvb21JZENhY2hlLnNldChpbnZpdGVkUm9vbS5yb29tSWQsIG5hdGl2ZVJvb20ucm9v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