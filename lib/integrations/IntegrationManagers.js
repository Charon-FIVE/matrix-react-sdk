"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.IntegrationManagers = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _url = _interopRequireDefault(require("url"));

var _logger = require("matrix-js-sdk/src/logger");

var _client = require("matrix-js-sdk/src/client");

var _SdkConfig = _interopRequireDefault(require("../SdkConfig"));

var _Modal = _interopRequireDefault(require("../Modal"));

var _IntegrationManagerInstance = require("./IntegrationManagerInstance");

var _IntegrationsImpossibleDialog = _interopRequireDefault(require("../components/views/dialogs/IntegrationsImpossibleDialog"));

var _IntegrationsDisabledDialog = _interopRequireDefault(require("../components/views/dialogs/IntegrationsDisabledDialog"));

var _WidgetUtils = _interopRequireDefault(require("../utils/WidgetUtils"));

var _MatrixClientPeg = require("../MatrixClientPeg");

var _strings = require("../utils/strings");

/*
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const KIND_PREFERENCE = [// Ordered: first is most preferred, last is least preferred.
_IntegrationManagerInstance.Kind.Account, _IntegrationManagerInstance.Kind.Homeserver, _IntegrationManagerInstance.Kind.Config];

class IntegrationManagers {
  static sharedInstance() {
    if (!IntegrationManagers.instance) {
      IntegrationManagers.instance = new IntegrationManagers();
    }

    return IntegrationManagers.instance;
  }

  constructor() {
    (0, _defineProperty2.default)(this, "managers", []);
    (0, _defineProperty2.default)(this, "client", void 0);
    (0, _defineProperty2.default)(this, "primaryManager", void 0);
    (0, _defineProperty2.default)(this, "setupHomeserverManagers", async discoveryResponse => {
      _logger.logger.log("Updating homeserver-configured integration managers...");

      if (discoveryResponse && discoveryResponse['m.integrations']) {
        let managers = discoveryResponse['m.integrations']['managers'];
        if (!Array.isArray(managers)) managers = []; // make it an array so we can wipe the HS managers

        _logger.logger.log(`Homeserver has ${managers.length} integration managers`); // Clear out any known managers for the homeserver
        // TODO: Log out of the scalar clients


        this.managers = this.managers.filter(m => m.kind !== _IntegrationManagerInstance.Kind.Homeserver); // Now add all the managers the homeserver wants us to have

        for (const hsManager of managers) {
          if (!hsManager["api_url"]) continue;
          this.managers.push(new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Homeserver, hsManager["api_url"], hsManager["ui_url"]));
        }

        this.primaryManager = null; // reset primary
      } else {
        _logger.logger.log("Homeserver has no integration managers");
      }
    });
    (0, _defineProperty2.default)(this, "onAccountData", ev => {
      if (ev.getType() === 'm.widgets') {
        this.compileManagers();
      }
    });
    this.compileManagers();
  }

  startWatching() {
    this.stopWatching();
    this.client = _MatrixClientPeg.MatrixClientPeg.get();
    this.client.on(_client.ClientEvent.AccountData, this.onAccountData);
    this.client.on(_client.ClientEvent.ClientWellKnown, this.setupHomeserverManagers);
    this.compileManagers();
  }

  stopWatching() {
    if (!this.client) return;
    this.client.removeListener(_client.ClientEvent.AccountData, this.onAccountData);
    this.client.removeListener(_client.ClientEvent.ClientWellKnown, this.setupHomeserverManagers);
  }

  compileManagers() {
    this.managers = [];
    this.setupConfiguredManager();
    this.setupAccountManagers();
  }

  setupConfiguredManager() {
    const apiUrl = _SdkConfig.default.get("integrations_rest_url");

    const uiUrl = _SdkConfig.default.get("integrations_ui_url");

    if (apiUrl && uiUrl) {
      this.managers.push(new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Config, apiUrl, uiUrl));
      this.primaryManager = null; // reset primary
    }
  }

  setupAccountManagers() {
    if (!this.client || !this.client.getUserId()) return; // not logged in

    const widgets = _WidgetUtils.default.getIntegrationManagerWidgets();

    widgets.forEach(w => {
      const data = w.content['data'];
      if (!data) return;
      const uiUrl = w.content['url'];
      const apiUrl = data['api_url'];
      if (!apiUrl || !uiUrl) return;
      const manager = new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Account, apiUrl, uiUrl, w['id'] || w['state_key'] || '');
      this.managers.push(manager);
    });
    this.primaryManager = null; // reset primary
  }

  hasManager() {
    return this.managers.length > 0;
  }

  getOrderedManagers() {
    const ordered = [];

    for (const kind of KIND_PREFERENCE) {
      const managers = this.managers.filter(m => m.kind === kind);
      if (!managers || !managers.length) continue;

      if (kind === _IntegrationManagerInstance.Kind.Account) {
        // Order by state_keys (IDs)
        managers.sort((a, b) => (0, _strings.compare)(a.id, b.id));
      }

      ordered.push(...managers);
    }

    return ordered;
  }

  getPrimaryManager() {
    if (this.hasManager()) {
      if (this.primaryManager) return this.primaryManager;
      this.primaryManager = this.getOrderedManagers()[0];
      return this.primaryManager;
    } else {
      return null;
    }
  }

  openNoManagerDialog() {
    _Modal.default.createDialog(_IntegrationsImpossibleDialog.default);
  }

  showDisabledDialog() {
    _Modal.default.createDialog(_IntegrationsDisabledDialog.default);
  }

  async overwriteManagerOnAccount(manager) {
    // TODO: TravisR - We should be logging out of scalar clients.
    await _WidgetUtils.default.removeIntegrationManagerWidgets(); // TODO: TravisR - We should actually be carrying over the discovery response verbatim.

    await _WidgetUtils.default.addIntegrationManagerWidget(manager.name, manager.uiUrl, manager.apiUrl);
  }
  /**
   * Attempts to discover an integration manager using only its name. This will not validate that
   * the integration manager is functional - that is the caller's responsibility.
   * @param {string} domainName The domain name to look up.
   * @returns {Promise<IntegrationManagerInstance>} Resolves to an integration manager instance,
   * or null if none was found.
   */


  async tryDiscoverManager(domainName) {
    _logger.logger.log("Looking up integration manager via .well-known");

    if (domainName.startsWith("http:") || domainName.startsWith("https:")) {
      // trim off the scheme and just use the domain
      domainName = _url.default.parse(domainName).host;
    }

    let wkConfig;

    try {
      const result = await fetch(`https://${domainName}/.well-known/matrix/integrations`);
      wkConfig = await result.json();
    } catch (e) {
      _logger.logger.error(e);

      _logger.logger.warn("Failed to locate integration manager");

      return null;
    }

    if (!wkConfig || !wkConfig["m.integrations_widget"]) {
      _logger.logger.warn("Missing integrations widget on .well-known response");

      return null;
    }

    const widget = wkConfig["m.integrations_widget"];

    if (!widget["url"] || !widget["data"] || !widget["data"]["api_url"]) {
      _logger.logger.warn("Malformed .well-known response for integrations widget");

      return null;
    } // All discovered managers are per-user managers


    const manager = new _IntegrationManagerInstance.IntegrationManagerInstance(_IntegrationManagerInstance.Kind.Account, widget["data"]["api_url"], widget["url"]);

    _logger.logger.log("Got an integration manager (untested)"); // We don't test the manager because the caller may need to do extra
    // checks or similar with it. For instance, they may need to deal with
    // terms of service or want to call something particular.


    return manager;
  }

} // For debugging


exports.IntegrationManagers = IntegrationManagers;
(0, _defineProperty2.default)(IntegrationManagers, "instance", void 0);
window.mxIntegrationManagers = IntegrationManagers;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJLSU5EX1BSRUZFUkVOQ0UiLCJLaW5kIiwiQWNjb3VudCIsIkhvbWVzZXJ2ZXIiLCJDb25maWciLCJJbnRlZ3JhdGlvbk1hbmFnZXJzIiwic2hhcmVkSW5zdGFuY2UiLCJpbnN0YW5jZSIsImNvbnN0cnVjdG9yIiwiZGlzY292ZXJ5UmVzcG9uc2UiLCJsb2dnZXIiLCJsb2ciLCJtYW5hZ2VycyIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsImZpbHRlciIsIm0iLCJraW5kIiwiaHNNYW5hZ2VyIiwicHVzaCIsIkludGVncmF0aW9uTWFuYWdlckluc3RhbmNlIiwicHJpbWFyeU1hbmFnZXIiLCJldiIsImdldFR5cGUiLCJjb21waWxlTWFuYWdlcnMiLCJzdGFydFdhdGNoaW5nIiwic3RvcFdhdGNoaW5nIiwiY2xpZW50IiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwib24iLCJDbGllbnRFdmVudCIsIkFjY291bnREYXRhIiwib25BY2NvdW50RGF0YSIsIkNsaWVudFdlbGxLbm93biIsInNldHVwSG9tZXNlcnZlck1hbmFnZXJzIiwicmVtb3ZlTGlzdGVuZXIiLCJzZXR1cENvbmZpZ3VyZWRNYW5hZ2VyIiwic2V0dXBBY2NvdW50TWFuYWdlcnMiLCJhcGlVcmwiLCJTZGtDb25maWciLCJ1aVVybCIsImdldFVzZXJJZCIsIndpZGdldHMiLCJXaWRnZXRVdGlscyIsImdldEludGVncmF0aW9uTWFuYWdlcldpZGdldHMiLCJmb3JFYWNoIiwidyIsImRhdGEiLCJjb250ZW50IiwibWFuYWdlciIsImhhc01hbmFnZXIiLCJnZXRPcmRlcmVkTWFuYWdlcnMiLCJvcmRlcmVkIiwic29ydCIsImEiLCJiIiwiY29tcGFyZSIsImlkIiwiZ2V0UHJpbWFyeU1hbmFnZXIiLCJvcGVuTm9NYW5hZ2VyRGlhbG9nIiwiTW9kYWwiLCJjcmVhdGVEaWFsb2ciLCJJbnRlZ3JhdGlvbnNJbXBvc3NpYmxlRGlhbG9nIiwic2hvd0Rpc2FibGVkRGlhbG9nIiwiSW50ZWdyYXRpb25zRGlzYWJsZWREaWFsb2ciLCJvdmVyd3JpdGVNYW5hZ2VyT25BY2NvdW50IiwicmVtb3ZlSW50ZWdyYXRpb25NYW5hZ2VyV2lkZ2V0cyIsImFkZEludGVncmF0aW9uTWFuYWdlcldpZGdldCIsIm5hbWUiLCJ0cnlEaXNjb3Zlck1hbmFnZXIiLCJkb21haW5OYW1lIiwic3RhcnRzV2l0aCIsInVybCIsInBhcnNlIiwiaG9zdCIsIndrQ29uZmlnIiwicmVzdWx0IiwiZmV0Y2giLCJqc29uIiwiZSIsImVycm9yIiwid2FybiIsIndpZGdldCIsIndpbmRvdyIsIm14SW50ZWdyYXRpb25NYW5hZ2VycyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlZ3JhdGlvbnMvSW50ZWdyYXRpb25NYW5hZ2Vycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbG9nZ2VyXCI7XG5pbXBvcnQgeyBDbGllbnRFdmVudCwgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuXG5pbXBvcnQgdHlwZSB7IE1hdHJpeEV2ZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudFwiO1xuaW1wb3J0IFNka0NvbmZpZyBmcm9tICcuLi9TZGtDb25maWcnO1xuaW1wb3J0IE1vZGFsIGZyb20gJy4uL01vZGFsJztcbmltcG9ydCB7IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlLCBLaW5kIH0gZnJvbSBcIi4vSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2VcIjtcbmltcG9ydCBJbnRlZ3JhdGlvbnNJbXBvc3NpYmxlRGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSW50ZWdyYXRpb25zSW1wb3NzaWJsZURpYWxvZ1wiO1xuaW1wb3J0IEludGVncmF0aW9uc0Rpc2FibGVkRGlhbG9nIGZyb20gXCIuLi9jb21wb25lbnRzL3ZpZXdzL2RpYWxvZ3MvSW50ZWdyYXRpb25zRGlzYWJsZWREaWFsb2dcIjtcbmltcG9ydCBXaWRnZXRVdGlscyBmcm9tIFwiLi4vdXRpbHMvV2lkZ2V0VXRpbHNcIjtcbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gXCIuLi9NYXRyaXhDbGllbnRQZWdcIjtcbmltcG9ydCB7IGNvbXBhcmUgfSBmcm9tIFwiLi4vdXRpbHMvc3RyaW5nc1wiO1xuXG5jb25zdCBLSU5EX1BSRUZFUkVOQ0UgPSBbXG4gICAgLy8gT3JkZXJlZDogZmlyc3QgaXMgbW9zdCBwcmVmZXJyZWQsIGxhc3QgaXMgbGVhc3QgcHJlZmVycmVkLlxuICAgIEtpbmQuQWNjb3VudCxcbiAgICBLaW5kLkhvbWVzZXJ2ZXIsXG4gICAgS2luZC5Db25maWcsXG5dO1xuXG5leHBvcnQgY2xhc3MgSW50ZWdyYXRpb25NYW5hZ2VycyB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U7XG5cbiAgICBwcml2YXRlIG1hbmFnZXJzOiBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZVtdID0gW107XG4gICAgcHJpdmF0ZSBjbGllbnQ6IE1hdHJpeENsaWVudDtcbiAgICBwcml2YXRlIHByaW1hcnlNYW5hZ2VyOiBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZTtcblxuICAgIHB1YmxpYyBzdGF0aWMgc2hhcmVkSW5zdGFuY2UoKTogSW50ZWdyYXRpb25NYW5hZ2VycyB7XG4gICAgICAgIGlmICghSW50ZWdyYXRpb25NYW5hZ2Vycy5pbnN0YW5jZSkge1xuICAgICAgICAgICAgSW50ZWdyYXRpb25NYW5hZ2Vycy5pbnN0YW5jZSA9IG5ldyBJbnRlZ3JhdGlvbk1hbmFnZXJzKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEludGVncmF0aW9uTWFuYWdlcnMuaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuY29tcGlsZU1hbmFnZXJzKCk7XG4gICAgfVxuXG4gICAgc3RhcnRXYXRjaGluZygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdG9wV2F0Y2hpbmcoKTtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIHRoaXMuY2xpZW50Lm9uKENsaWVudEV2ZW50LkFjY291bnREYXRhLCB0aGlzLm9uQWNjb3VudERhdGEpO1xuICAgICAgICB0aGlzLmNsaWVudC5vbihDbGllbnRFdmVudC5DbGllbnRXZWxsS25vd24sIHRoaXMuc2V0dXBIb21lc2VydmVyTWFuYWdlcnMpO1xuICAgICAgICB0aGlzLmNvbXBpbGVNYW5hZ2VycygpO1xuICAgIH1cblxuICAgIHN0b3BXYXRjaGluZygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmNsaWVudCkgcmV0dXJuO1xuICAgICAgICB0aGlzLmNsaWVudC5yZW1vdmVMaXN0ZW5lcihDbGllbnRFdmVudC5BY2NvdW50RGF0YSwgdGhpcy5vbkFjY291bnREYXRhKTtcbiAgICAgICAgdGhpcy5jbGllbnQucmVtb3ZlTGlzdGVuZXIoQ2xpZW50RXZlbnQuQ2xpZW50V2VsbEtub3duLCB0aGlzLnNldHVwSG9tZXNlcnZlck1hbmFnZXJzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbXBpbGVNYW5hZ2VycygpIHtcbiAgICAgICAgdGhpcy5tYW5hZ2VycyA9IFtdO1xuICAgICAgICB0aGlzLnNldHVwQ29uZmlndXJlZE1hbmFnZXIoKTtcbiAgICAgICAgdGhpcy5zZXR1cEFjY291bnRNYW5hZ2VycygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0dXBDb25maWd1cmVkTWFuYWdlcigpIHtcbiAgICAgICAgY29uc3QgYXBpVXJsOiBzdHJpbmcgPSBTZGtDb25maWcuZ2V0KFwiaW50ZWdyYXRpb25zX3Jlc3RfdXJsXCIpO1xuICAgICAgICBjb25zdCB1aVVybDogc3RyaW5nID0gU2RrQ29uZmlnLmdldChcImludGVncmF0aW9uc191aV91cmxcIik7XG5cbiAgICAgICAgaWYgKGFwaVVybCAmJiB1aVVybCkge1xuICAgICAgICAgICAgdGhpcy5tYW5hZ2Vycy5wdXNoKG5ldyBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZShLaW5kLkNvbmZpZywgYXBpVXJsLCB1aVVybCkpO1xuICAgICAgICAgICAgdGhpcy5wcmltYXJ5TWFuYWdlciA9IG51bGw7IC8vIHJlc2V0IHByaW1hcnlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc2V0dXBIb21lc2VydmVyTWFuYWdlcnMgPSBhc3luYyAoZGlzY292ZXJ5UmVzcG9uc2UpID0+IHtcbiAgICAgICAgbG9nZ2VyLmxvZyhcIlVwZGF0aW5nIGhvbWVzZXJ2ZXItY29uZmlndXJlZCBpbnRlZ3JhdGlvbiBtYW5hZ2Vycy4uLlwiKTtcbiAgICAgICAgaWYgKGRpc2NvdmVyeVJlc3BvbnNlICYmIGRpc2NvdmVyeVJlc3BvbnNlWydtLmludGVncmF0aW9ucyddKSB7XG4gICAgICAgICAgICBsZXQgbWFuYWdlcnMgPSBkaXNjb3ZlcnlSZXNwb25zZVsnbS5pbnRlZ3JhdGlvbnMnXVsnbWFuYWdlcnMnXTtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtYW5hZ2VycykpIG1hbmFnZXJzID0gW107IC8vIG1ha2UgaXQgYW4gYXJyYXkgc28gd2UgY2FuIHdpcGUgdGhlIEhTIG1hbmFnZXJzXG5cbiAgICAgICAgICAgIGxvZ2dlci5sb2coYEhvbWVzZXJ2ZXIgaGFzICR7bWFuYWdlcnMubGVuZ3RofSBpbnRlZ3JhdGlvbiBtYW5hZ2Vyc2ApO1xuXG4gICAgICAgICAgICAvLyBDbGVhciBvdXQgYW55IGtub3duIG1hbmFnZXJzIGZvciB0aGUgaG9tZXNlcnZlclxuICAgICAgICAgICAgLy8gVE9ETzogTG9nIG91dCBvZiB0aGUgc2NhbGFyIGNsaWVudHNcbiAgICAgICAgICAgIHRoaXMubWFuYWdlcnMgPSB0aGlzLm1hbmFnZXJzLmZpbHRlcihtID0+IG0ua2luZCAhPT0gS2luZC5Ib21lc2VydmVyKTtcblxuICAgICAgICAgICAgLy8gTm93IGFkZCBhbGwgdGhlIG1hbmFnZXJzIHRoZSBob21lc2VydmVyIHdhbnRzIHVzIHRvIGhhdmVcbiAgICAgICAgICAgIGZvciAoY29uc3QgaHNNYW5hZ2VyIG9mIG1hbmFnZXJzKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFoc01hbmFnZXJbXCJhcGlfdXJsXCJdKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB0aGlzLm1hbmFnZXJzLnB1c2gobmV3IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlKFxuICAgICAgICAgICAgICAgICAgICBLaW5kLkhvbWVzZXJ2ZXIsXG4gICAgICAgICAgICAgICAgICAgIGhzTWFuYWdlcltcImFwaV91cmxcIl0sXG4gICAgICAgICAgICAgICAgICAgIGhzTWFuYWdlcltcInVpX3VybFwiXSwgLy8gb3B0aW9uYWxcbiAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5wcmltYXJ5TWFuYWdlciA9IG51bGw7IC8vIHJlc2V0IHByaW1hcnlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZ2dlci5sb2coXCJIb21lc2VydmVyIGhhcyBubyBpbnRlZ3JhdGlvbiBtYW5hZ2Vyc1wiKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIHNldHVwQWNjb3VudE1hbmFnZXJzKCkge1xuICAgICAgICBpZiAoIXRoaXMuY2xpZW50IHx8ICF0aGlzLmNsaWVudC5nZXRVc2VySWQoKSkgcmV0dXJuOyAvLyBub3QgbG9nZ2VkIGluXG4gICAgICAgIGNvbnN0IHdpZGdldHMgPSBXaWRnZXRVdGlscy5nZXRJbnRlZ3JhdGlvbk1hbmFnZXJXaWRnZXRzKCk7XG4gICAgICAgIHdpZGdldHMuZm9yRWFjaCh3ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB3LmNvbnRlbnRbJ2RhdGEnXTtcbiAgICAgICAgICAgIGlmICghZGF0YSkgcmV0dXJuO1xuXG4gICAgICAgICAgICBjb25zdCB1aVVybCA9IHcuY29udGVudFsndXJsJ107XG4gICAgICAgICAgICBjb25zdCBhcGlVcmwgPSBkYXRhWydhcGlfdXJsJ10gYXMgc3RyaW5nO1xuICAgICAgICAgICAgaWYgKCFhcGlVcmwgfHwgIXVpVXJsKSByZXR1cm47XG5cbiAgICAgICAgICAgIGNvbnN0IG1hbmFnZXIgPSBuZXcgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UoXG4gICAgICAgICAgICAgICAgS2luZC5BY2NvdW50LFxuICAgICAgICAgICAgICAgIGFwaVVybCxcbiAgICAgICAgICAgICAgICB1aVVybCxcbiAgICAgICAgICAgICAgICB3WydpZCddIHx8IHdbJ3N0YXRlX2tleSddIHx8ICcnLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMubWFuYWdlcnMucHVzaChtYW5hZ2VyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucHJpbWFyeU1hbmFnZXIgPSBudWxsOyAvLyByZXNldCBwcmltYXJ5XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkFjY291bnREYXRhID0gKGV2OiBNYXRyaXhFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoZXYuZ2V0VHlwZSgpID09PSAnbS53aWRnZXRzJykge1xuICAgICAgICAgICAgdGhpcy5jb21waWxlTWFuYWdlcnMoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBoYXNNYW5hZ2VyKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5tYW5hZ2Vycy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIGdldE9yZGVyZWRNYW5hZ2VycygpOiBJbnRlZ3JhdGlvbk1hbmFnZXJJbnN0YW5jZVtdIHtcbiAgICAgICAgY29uc3Qgb3JkZXJlZCA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGtpbmQgb2YgS0lORF9QUkVGRVJFTkNFKSB7XG4gICAgICAgICAgICBjb25zdCBtYW5hZ2VycyA9IHRoaXMubWFuYWdlcnMuZmlsdGVyKG0gPT4gbS5raW5kID09PSBraW5kKTtcbiAgICAgICAgICAgIGlmICghbWFuYWdlcnMgfHwgIW1hbmFnZXJzLmxlbmd0aCkgY29udGludWU7XG5cbiAgICAgICAgICAgIGlmIChraW5kID09PSBLaW5kLkFjY291bnQpIHtcbiAgICAgICAgICAgICAgICAvLyBPcmRlciBieSBzdGF0ZV9rZXlzIChJRHMpXG4gICAgICAgICAgICAgICAgbWFuYWdlcnMuc29ydCgoYSwgYikgPT4gY29tcGFyZShhLmlkLCBiLmlkKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIG9yZGVyZWQucHVzaCguLi5tYW5hZ2Vycyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9yZGVyZWQ7XG4gICAgfVxuXG4gICAgZ2V0UHJpbWFyeU1hbmFnZXIoKTogSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2Uge1xuICAgICAgICBpZiAodGhpcy5oYXNNYW5hZ2VyKCkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnByaW1hcnlNYW5hZ2VyKSByZXR1cm4gdGhpcy5wcmltYXJ5TWFuYWdlcjtcblxuICAgICAgICAgICAgdGhpcy5wcmltYXJ5TWFuYWdlciA9IHRoaXMuZ2V0T3JkZXJlZE1hbmFnZXJzKClbMF07XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcmltYXJ5TWFuYWdlcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb3Blbk5vTWFuYWdlckRpYWxvZygpOiB2b2lkIHtcbiAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKEludGVncmF0aW9uc0ltcG9zc2libGVEaWFsb2cpO1xuICAgIH1cblxuICAgIHNob3dEaXNhYmxlZERpYWxvZygpOiB2b2lkIHtcbiAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKEludGVncmF0aW9uc0Rpc2FibGVkRGlhbG9nKTtcbiAgICB9XG5cbiAgICBhc3luYyBvdmVyd3JpdGVNYW5hZ2VyT25BY2NvdW50KG1hbmFnZXI6IEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlKSB7XG4gICAgICAgIC8vIFRPRE86IFRyYXZpc1IgLSBXZSBzaG91bGQgYmUgbG9nZ2luZyBvdXQgb2Ygc2NhbGFyIGNsaWVudHMuXG4gICAgICAgIGF3YWl0IFdpZGdldFV0aWxzLnJlbW92ZUludGVncmF0aW9uTWFuYWdlcldpZGdldHMoKTtcblxuICAgICAgICAvLyBUT0RPOiBUcmF2aXNSIC0gV2Ugc2hvdWxkIGFjdHVhbGx5IGJlIGNhcnJ5aW5nIG92ZXIgdGhlIGRpc2NvdmVyeSByZXNwb25zZSB2ZXJiYXRpbS5cbiAgICAgICAgYXdhaXQgV2lkZ2V0VXRpbHMuYWRkSW50ZWdyYXRpb25NYW5hZ2VyV2lkZ2V0KG1hbmFnZXIubmFtZSwgbWFuYWdlci51aVVybCwgbWFuYWdlci5hcGlVcmwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGVtcHRzIHRvIGRpc2NvdmVyIGFuIGludGVncmF0aW9uIG1hbmFnZXIgdXNpbmcgb25seSBpdHMgbmFtZS4gVGhpcyB3aWxsIG5vdCB2YWxpZGF0ZSB0aGF0XG4gICAgICogdGhlIGludGVncmF0aW9uIG1hbmFnZXIgaXMgZnVuY3Rpb25hbCAtIHRoYXQgaXMgdGhlIGNhbGxlcidzIHJlc3BvbnNpYmlsaXR5LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkb21haW5OYW1lIFRoZSBkb21haW4gbmFtZSB0byBsb29rIHVwLlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlPn0gUmVzb2x2ZXMgdG8gYW4gaW50ZWdyYXRpb24gbWFuYWdlciBpbnN0YW5jZSxcbiAgICAgKiBvciBudWxsIGlmIG5vbmUgd2FzIGZvdW5kLlxuICAgICAqL1xuICAgIGFzeW5jIHRyeURpc2NvdmVyTWFuYWdlcihkb21haW5OYW1lOiBzdHJpbmcpOiBQcm9taXNlPEludGVncmF0aW9uTWFuYWdlckluc3RhbmNlPiB7XG4gICAgICAgIGxvZ2dlci5sb2coXCJMb29raW5nIHVwIGludGVncmF0aW9uIG1hbmFnZXIgdmlhIC53ZWxsLWtub3duXCIpO1xuICAgICAgICBpZiAoZG9tYWluTmFtZS5zdGFydHNXaXRoKFwiaHR0cDpcIikgfHwgZG9tYWluTmFtZS5zdGFydHNXaXRoKFwiaHR0cHM6XCIpKSB7XG4gICAgICAgICAgICAvLyB0cmltIG9mZiB0aGUgc2NoZW1lIGFuZCBqdXN0IHVzZSB0aGUgZG9tYWluXG4gICAgICAgICAgICBkb21haW5OYW1lID0gdXJsLnBhcnNlKGRvbWFpbk5hbWUpLmhvc3Q7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgd2tDb25maWc6IG9iamVjdDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZldGNoKGBodHRwczovLyR7ZG9tYWluTmFtZX0vLndlbGwta25vd24vbWF0cml4L2ludGVncmF0aW9uc2ApO1xuICAgICAgICAgICAgd2tDb25maWcgPSBhd2FpdCByZXN1bHQuanNvbigpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgICAgICBsb2dnZXIud2FybihcIkZhaWxlZCB0byBsb2NhdGUgaW50ZWdyYXRpb24gbWFuYWdlclwiKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF3a0NvbmZpZyB8fCAhd2tDb25maWdbXCJtLmludGVncmF0aW9uc193aWRnZXRcIl0pIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKFwiTWlzc2luZyBpbnRlZ3JhdGlvbnMgd2lkZ2V0IG9uIC53ZWxsLWtub3duIHJlc3BvbnNlXCIpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3aWRnZXQgPSB3a0NvbmZpZ1tcIm0uaW50ZWdyYXRpb25zX3dpZGdldFwiXTtcbiAgICAgICAgaWYgKCF3aWRnZXRbXCJ1cmxcIl0gfHwgIXdpZGdldFtcImRhdGFcIl0gfHwgIXdpZGdldFtcImRhdGFcIl1bXCJhcGlfdXJsXCJdKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybihcIk1hbGZvcm1lZCAud2VsbC1rbm93biByZXNwb25zZSBmb3IgaW50ZWdyYXRpb25zIHdpZGdldFwiKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWxsIGRpc2NvdmVyZWQgbWFuYWdlcnMgYXJlIHBlci11c2VyIG1hbmFnZXJzXG4gICAgICAgIGNvbnN0IG1hbmFnZXIgPSBuZXcgSW50ZWdyYXRpb25NYW5hZ2VySW5zdGFuY2UoS2luZC5BY2NvdW50LCB3aWRnZXRbXCJkYXRhXCJdW1wiYXBpX3VybFwiXSwgd2lkZ2V0W1widXJsXCJdKTtcbiAgICAgICAgbG9nZ2VyLmxvZyhcIkdvdCBhbiBpbnRlZ3JhdGlvbiBtYW5hZ2VyICh1bnRlc3RlZClcIik7XG5cbiAgICAgICAgLy8gV2UgZG9uJ3QgdGVzdCB0aGUgbWFuYWdlciBiZWNhdXNlIHRoZSBjYWxsZXIgbWF5IG5lZWQgdG8gZG8gZXh0cmFcbiAgICAgICAgLy8gY2hlY2tzIG9yIHNpbWlsYXIgd2l0aCBpdC4gRm9yIGluc3RhbmNlLCB0aGV5IG1heSBuZWVkIHRvIGRlYWwgd2l0aFxuICAgICAgICAvLyB0ZXJtcyBvZiBzZXJ2aWNlIG9yIHdhbnQgdG8gY2FsbCBzb21ldGhpbmcgcGFydGljdWxhci5cblxuICAgICAgICByZXR1cm4gbWFuYWdlcjtcbiAgICB9XG59XG5cbi8vIEZvciBkZWJ1Z2dpbmdcbndpbmRvdy5teEludGVncmF0aW9uTWFuYWdlcnMgPSBJbnRlZ3JhdGlvbk1hbmFnZXJzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUE1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBZ0JBLE1BQU1BLGVBQWUsR0FBRyxDQUNwQjtBQUNBQyxnQ0FBQSxDQUFLQyxPQUZlLEVBR3BCRCxnQ0FBQSxDQUFLRSxVQUhlLEVBSXBCRixnQ0FBQSxDQUFLRyxNQUplLENBQXhCOztBQU9PLE1BQU1DLG1CQUFOLENBQTBCO0VBT0QsT0FBZEMsY0FBYyxHQUF3QjtJQUNoRCxJQUFJLENBQUNELG1CQUFtQixDQUFDRSxRQUF6QixFQUFtQztNQUMvQkYsbUJBQW1CLENBQUNFLFFBQXBCLEdBQStCLElBQUlGLG1CQUFKLEVBQS9CO0lBQ0g7O0lBQ0QsT0FBT0EsbUJBQW1CLENBQUNFLFFBQTNCO0VBQ0g7O0VBRURDLFdBQVcsR0FBRztJQUFBLGdEQVhtQyxFQVduQztJQUFBO0lBQUE7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