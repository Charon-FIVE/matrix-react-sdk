"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.usePublicRoomDirectory = exports.ALL_ROOMS = void 0;

var _react = require("react");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _SdkConfig = _interopRequireDefault(require("../SdkConfig"));

var _SettingsStore = _interopRequireDefault(require("../settings/SettingsStore"));

var _useLatestResult = require("./useLatestResult");

/*
Copyright 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const ALL_ROOMS = "ALL_ROOMS";
exports.ALL_ROOMS = ALL_ROOMS;
const LAST_SERVER_KEY = "mx_last_room_directory_server";
const LAST_INSTANCE_KEY = "mx_last_room_directory_instance";
let thirdParty;

const usePublicRoomDirectory = () => {
  const [publicRooms, setPublicRooms] = (0, _react.useState)([]);
  const [config, setConfigInternal] = (0, _react.useState)(undefined);
  const [protocols, setProtocols] = (0, _react.useState)(null);
  const [ready, setReady] = (0, _react.useState)(false);
  const [loading, setLoading] = (0, _react.useState)(false);
  const [updateQuery, updateResult] = (0, _useLatestResult.useLatestResult)(setPublicRooms);

  async function initProtocols() {
    if (!_MatrixClientPeg.MatrixClientPeg.get()) {
      // We may not have a client yet when invoked from welcome page
      setReady(true);
    } else if (thirdParty) {
      setProtocols(thirdParty);
    } else {
      const response = await _MatrixClientPeg.MatrixClientPeg.get().getThirdpartyProtocols();
      thirdParty = response;
      setProtocols(response);
    }
  }

  function setConfig(config) {
    if (!ready) {
      throw new Error("public room configuration not initialised yet");
    } else {
      setConfigInternal(config);
    }
  }

  const search = (0, _react.useCallback)(async _ref => {
    let {
      limit = 20,
      query,
      roomTypes
    } = _ref;
    const opts = {
      limit
    };

    if (config?.roomServer != _MatrixClientPeg.MatrixClientPeg.getHomeserverName()) {
      opts.server = config?.roomServer;
    }

    if (config?.instanceId === ALL_ROOMS) {
      opts.include_all_networks = true;
    } else if (config?.instanceId) {
      opts.third_party_instance_id = config.instanceId;
    }

    if (query || roomTypes) {
      opts.filter = {
        generic_search_term: query,
        room_types: (await _MatrixClientPeg.MatrixClientPeg.get().doesServerSupportUnstableFeature("org.matrix.msc3827.stable")) ? Array.from(roomTypes) : null
      };
    }

    updateQuery(opts);

    try {
      setLoading(true);
      const {
        chunk
      } = await _MatrixClientPeg.MatrixClientPeg.get().publicRooms(opts);
      updateResult(opts, chunk);
      return true;
    } catch (e) {
      console.error("Could not fetch public rooms for params", opts, e);
      updateResult(opts, []);
      return false;
    } finally {
      setLoading(false);
    }
  }, [config, updateQuery, updateResult]);
  (0, _react.useEffect)(() => {
    initProtocols();
  }, []);
  (0, _react.useEffect)(() => {
    if (protocols === null) {
      return;
    }

    const myHomeserver = _MatrixClientPeg.MatrixClientPeg.getHomeserverName();

    const lsRoomServer = localStorage.getItem(LAST_SERVER_KEY);
    const lsInstanceId = localStorage.getItem(LAST_INSTANCE_KEY) ?? undefined;
    let roomServer = myHomeserver;

    if (_SdkConfig.default.getObject("room_directory")?.get("servers")?.includes(lsRoomServer) || _SettingsStore.default.getValue("room_directory_servers")?.includes(lsRoomServer)) {
      roomServer = lsRoomServer;
    }

    let instanceId = undefined;

    if (roomServer === myHomeserver && (lsInstanceId === ALL_ROOMS || Object.values(protocols).some(p => {
      p.instances.some(i => i.instance_id === lsInstanceId);
    }))) {
      instanceId = lsInstanceId;
    }

    setReady(true);
    setConfigInternal({
      roomServer,
      instanceId
    });
  }, [protocols]);
  (0, _react.useEffect)(() => {
    localStorage.setItem(LAST_SERVER_KEY, config?.roomServer);

    if (config?.instanceId) {
      localStorage.setItem(LAST_INSTANCE_KEY, config?.instanceId);
    } else {
      localStorage.removeItem(LAST_INSTANCE_KEY);
    }
  }, [config]);
  return {
    ready,
    loading,
    publicRooms,
    protocols,
    config,
    search,
    setConfig
  };
};

exports.usePublicRoomDirectory = usePublicRoomDirectory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBTExfUk9PTVMiLCJMQVNUX1NFUlZFUl9LRVkiLCJMQVNUX0lOU1RBTkNFX0tFWSIsInRoaXJkUGFydHkiLCJ1c2VQdWJsaWNSb29tRGlyZWN0b3J5IiwicHVibGljUm9vbXMiLCJzZXRQdWJsaWNSb29tcyIsInVzZVN0YXRlIiwiY29uZmlnIiwic2V0Q29uZmlnSW50ZXJuYWwiLCJ1bmRlZmluZWQiLCJwcm90b2NvbHMiLCJzZXRQcm90b2NvbHMiLCJyZWFkeSIsInNldFJlYWR5IiwibG9hZGluZyIsInNldExvYWRpbmciLCJ1cGRhdGVRdWVyeSIsInVwZGF0ZVJlc3VsdCIsInVzZUxhdGVzdFJlc3VsdCIsImluaXRQcm90b2NvbHMiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJyZXNwb25zZSIsImdldFRoaXJkcGFydHlQcm90b2NvbHMiLCJzZXRDb25maWciLCJFcnJvciIsInNlYXJjaCIsInVzZUNhbGxiYWNrIiwibGltaXQiLCJxdWVyeSIsInJvb21UeXBlcyIsIm9wdHMiLCJyb29tU2VydmVyIiwiZ2V0SG9tZXNlcnZlck5hbWUiLCJzZXJ2ZXIiLCJpbnN0YW5jZUlkIiwiaW5jbHVkZV9hbGxfbmV0d29ya3MiLCJ0aGlyZF9wYXJ0eV9pbnN0YW5jZV9pZCIsImZpbHRlciIsImdlbmVyaWNfc2VhcmNoX3Rlcm0iLCJyb29tX3R5cGVzIiwiZG9lc1NlcnZlclN1cHBvcnRVbnN0YWJsZUZlYXR1cmUiLCJBcnJheSIsImZyb20iLCJjaHVuayIsImUiLCJjb25zb2xlIiwiZXJyb3IiLCJ1c2VFZmZlY3QiLCJteUhvbWVzZXJ2ZXIiLCJsc1Jvb21TZXJ2ZXIiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwibHNJbnN0YW5jZUlkIiwiU2RrQ29uZmlnIiwiZ2V0T2JqZWN0IiwiaW5jbHVkZXMiLCJTZXR0aW5nc1N0b3JlIiwiZ2V0VmFsdWUiLCJPYmplY3QiLCJ2YWx1ZXMiLCJzb21lIiwicCIsImluc3RhbmNlcyIsImkiLCJpbnN0YW5jZV9pZCIsInNldEl0ZW0iLCJyZW1vdmVJdGVtIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL2hvb2tzL3VzZVB1YmxpY1Jvb21EaXJlY3RvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIyIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHsgUm9vbVR5cGUgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL2V2ZW50XCI7XG5pbXBvcnQgeyBJUm9vbURpcmVjdG9yeU9wdGlvbnMgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvQHR5cGVzL3JlcXVlc3RzXCI7XG5pbXBvcnQgeyBJUHJvdG9jb2wsIElQdWJsaWNSb29tc0NodW5rUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9jbGllbnRcIjtcbmltcG9ydCB7IHVzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZVN0YXRlIH0gZnJvbSBcInJlYWN0XCI7XG5cbmltcG9ydCB7IElQdWJsaWNSb29tRGlyZWN0b3J5Q29uZmlnIH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvdmlld3MvZGlyZWN0b3J5L05ldHdvcmtEcm9wZG93blwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IFNka0NvbmZpZyBmcm9tIFwiLi4vU2RrQ29uZmlnXCI7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IHsgUHJvdG9jb2xzIH0gZnJvbSBcIi4uL3V0aWxzL0RpcmVjdG9yeVV0aWxzXCI7XG5pbXBvcnQgeyB1c2VMYXRlc3RSZXN1bHQgfSBmcm9tIFwiLi91c2VMYXRlc3RSZXN1bHRcIjtcblxuZXhwb3J0IGNvbnN0IEFMTF9ST09NUyA9IFwiQUxMX1JPT01TXCI7XG5jb25zdCBMQVNUX1NFUlZFUl9LRVkgPSBcIm14X2xhc3Rfcm9vbV9kaXJlY3Rvcnlfc2VydmVyXCI7XG5jb25zdCBMQVNUX0lOU1RBTkNFX0tFWSA9IFwibXhfbGFzdF9yb29tX2RpcmVjdG9yeV9pbnN0YW5jZVwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIElQdWJsaWNSb29tc09wdHMge1xuICAgIGxpbWl0OiBudW1iZXI7XG4gICAgcXVlcnk/OiBzdHJpbmc7XG4gICAgcm9vbVR5cGVzPzogU2V0PFJvb21UeXBlIHwgbnVsbD47XG59XG5cbmxldCB0aGlyZFBhcnR5OiBQcm90b2NvbHM7XG5cbmV4cG9ydCBjb25zdCB1c2VQdWJsaWNSb29tRGlyZWN0b3J5ID0gKCkgPT4ge1xuICAgIGNvbnN0IFtwdWJsaWNSb29tcywgc2V0UHVibGljUm9vbXNdID0gdXNlU3RhdGU8SVB1YmxpY1Jvb21zQ2h1bmtSb29tW10+KFtdKTtcblxuICAgIGNvbnN0IFtjb25maWcsIHNldENvbmZpZ0ludGVybmFsXSA9IHVzZVN0YXRlPElQdWJsaWNSb29tRGlyZWN0b3J5Q29uZmlnIHwgbnVsbCB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblxuICAgIGNvbnN0IFtwcm90b2NvbHMsIHNldFByb3RvY29sc10gPSB1c2VTdGF0ZTxQcm90b2NvbHMgfCBudWxsPihudWxsKTtcblxuICAgIGNvbnN0IFtyZWFkeSwgc2V0UmVhZHldID0gdXNlU3RhdGUoZmFsc2UpO1xuICAgIGNvbnN0IFtsb2FkaW5nLCBzZXRMb2FkaW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICAgIGNvbnN0IFt1cGRhdGVRdWVyeSwgdXBkYXRlUmVzdWx0XSA9IHVzZUxhdGVzdFJlc3VsdDxJUm9vbURpcmVjdG9yeU9wdGlvbnMsIElQdWJsaWNSb29tc0NodW5rUm9vbVtdPihzZXRQdWJsaWNSb29tcyk7XG5cbiAgICBhc3luYyBmdW5jdGlvbiBpbml0UHJvdG9jb2xzKCkge1xuICAgICAgICBpZiAoIU1hdHJpeENsaWVudFBlZy5nZXQoKSkge1xuICAgICAgICAgICAgLy8gV2UgbWF5IG5vdCBoYXZlIGEgY2xpZW50IHlldCB3aGVuIGludm9rZWQgZnJvbSB3ZWxjb21lIHBhZ2VcbiAgICAgICAgICAgIHNldFJlYWR5KHRydWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXJkUGFydHkpIHtcbiAgICAgICAgICAgIHNldFByb3RvY29scyh0aGlyZFBhcnR5KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFRoaXJkcGFydHlQcm90b2NvbHMoKTtcbiAgICAgICAgICAgIHRoaXJkUGFydHkgPSByZXNwb25zZTtcbiAgICAgICAgICAgIHNldFByb3RvY29scyhyZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRDb25maWcoY29uZmlnOiBJUHVibGljUm9vbURpcmVjdG9yeUNvbmZpZykge1xuICAgICAgICBpZiAoIXJlYWR5KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJwdWJsaWMgcm9vbSBjb25maWd1cmF0aW9uIG5vdCBpbml0aWFsaXNlZCB5ZXRcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZXRDb25maWdJbnRlcm5hbChjb25maWcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgc2VhcmNoID0gdXNlQ2FsbGJhY2soYXN5bmMgKHtcbiAgICAgICAgbGltaXQgPSAyMCxcbiAgICAgICAgcXVlcnksXG4gICAgICAgIHJvb21UeXBlcyxcbiAgICB9OiBJUHVibGljUm9vbXNPcHRzKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgICAgIGNvbnN0IG9wdHM6IElSb29tRGlyZWN0b3J5T3B0aW9ucyA9IHsgbGltaXQgfTtcblxuICAgICAgICBpZiAoY29uZmlnPy5yb29tU2VydmVyICE9IE1hdHJpeENsaWVudFBlZy5nZXRIb21lc2VydmVyTmFtZSgpKSB7XG4gICAgICAgICAgICBvcHRzLnNlcnZlciA9IGNvbmZpZz8ucm9vbVNlcnZlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25maWc/Lmluc3RhbmNlSWQgPT09IEFMTF9ST09NUykge1xuICAgICAgICAgICAgb3B0cy5pbmNsdWRlX2FsbF9uZXR3b3JrcyA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAoY29uZmlnPy5pbnN0YW5jZUlkKSB7XG4gICAgICAgICAgICBvcHRzLnRoaXJkX3BhcnR5X2luc3RhbmNlX2lkID0gY29uZmlnLmluc3RhbmNlSWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocXVlcnkgfHwgcm9vbVR5cGVzKSB7XG4gICAgICAgICAgICBvcHRzLmZpbHRlciA9IHtcbiAgICAgICAgICAgICAgICBnZW5lcmljX3NlYXJjaF90ZXJtOiBxdWVyeSxcbiAgICAgICAgICAgICAgICByb29tX3R5cGVzOiBhd2FpdCBNYXRyaXhDbGllbnRQZWcuZ2V0KCkuZG9lc1NlcnZlclN1cHBvcnRVbnN0YWJsZUZlYXR1cmUoXG4gICAgICAgICAgICAgICAgICAgIFwib3JnLm1hdHJpeC5tc2MzODI3LnN0YWJsZVwiLFxuICAgICAgICAgICAgICAgICkgPyBBcnJheS5mcm9tPFJvb21UeXBlIHwgbnVsbD4ocm9vbVR5cGVzKSA6IG51bGwsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgdXBkYXRlUXVlcnkob3B0cyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzZXRMb2FkaW5nKHRydWUpO1xuICAgICAgICAgICAgY29uc3QgeyBjaHVuayB9ID0gYXdhaXQgTWF0cml4Q2xpZW50UGVnLmdldCgpLnB1YmxpY1Jvb21zKG9wdHMpO1xuICAgICAgICAgICAgdXBkYXRlUmVzdWx0KG9wdHMsIGNodW5rKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiQ291bGQgbm90IGZldGNoIHB1YmxpYyByb29tcyBmb3IgcGFyYW1zXCIsIG9wdHMsIGUpO1xuICAgICAgICAgICAgdXBkYXRlUmVzdWx0KG9wdHMsIFtdKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIHNldExvYWRpbmcoZmFsc2UpO1xuICAgICAgICB9XG4gICAgfSwgW2NvbmZpZywgdXBkYXRlUXVlcnksIHVwZGF0ZVJlc3VsdF0pO1xuXG4gICAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICAgICAgaW5pdFByb3RvY29scygpO1xuICAgIH0sIFtdKTtcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGlmIChwcm90b2NvbHMgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG15SG9tZXNlcnZlciA9IE1hdHJpeENsaWVudFBlZy5nZXRIb21lc2VydmVyTmFtZSgpO1xuICAgICAgICBjb25zdCBsc1Jvb21TZXJ2ZXIgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMQVNUX1NFUlZFUl9LRVkpO1xuICAgICAgICBjb25zdCBsc0luc3RhbmNlSWQ6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExBU1RfSU5TVEFOQ0VfS0VZKSA/PyB1bmRlZmluZWQ7XG5cbiAgICAgICAgbGV0IHJvb21TZXJ2ZXI6IHN0cmluZyA9IG15SG9tZXNlcnZlcjtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgU2RrQ29uZmlnLmdldE9iamVjdChcInJvb21fZGlyZWN0b3J5XCIpPy5nZXQoXCJzZXJ2ZXJzXCIpPy5pbmNsdWRlcyhsc1Jvb21TZXJ2ZXIpIHx8XG4gICAgICAgICAgICAgICAgICAgIFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJyb29tX2RpcmVjdG9yeV9zZXJ2ZXJzXCIpPy5pbmNsdWRlcyhsc1Jvb21TZXJ2ZXIpXG4gICAgICAgICkge1xuICAgICAgICAgICAgcm9vbVNlcnZlciA9IGxzUm9vbVNlcnZlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBpbnN0YW5jZUlkOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChyb29tU2VydmVyID09PSBteUhvbWVzZXJ2ZXIgJiYgKFxuICAgICAgICAgICAgbHNJbnN0YW5jZUlkID09PSBBTExfUk9PTVMgfHxcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhwcm90b2NvbHMpLnNvbWUoKHA6IElQcm90b2NvbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5pbnN0YW5jZXMuc29tZShpID0+IGkuaW5zdGFuY2VfaWQgPT09IGxzSW5zdGFuY2VJZCk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICkpIHtcbiAgICAgICAgICAgIGluc3RhbmNlSWQgPSBsc0luc3RhbmNlSWQ7XG4gICAgICAgIH1cblxuICAgICAgICBzZXRSZWFkeSh0cnVlKTtcbiAgICAgICAgc2V0Q29uZmlnSW50ZXJuYWwoeyByb29tU2VydmVyLCBpbnN0YW5jZUlkIH0pO1xuICAgIH0sIFtwcm90b2NvbHNdKTtcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKExBU1RfU0VSVkVSX0tFWSwgY29uZmlnPy5yb29tU2VydmVyKTtcbiAgICAgICAgaWYgKGNvbmZpZz8uaW5zdGFuY2VJZCkge1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTEFTVF9JTlNUQU5DRV9LRVksIGNvbmZpZz8uaW5zdGFuY2VJZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShMQVNUX0lOU1RBTkNFX0tFWSk7XG4gICAgICAgIH1cbiAgICB9LCBbY29uZmlnXSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICByZWFkeSxcbiAgICAgICAgbG9hZGluZyxcbiAgICAgICAgcHVibGljUm9vbXMsXG4gICAgICAgIHByb3RvY29scyxcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBzZWFyY2gsXG4gICAgICAgIHNldENvbmZpZyxcbiAgICB9IGFzIGNvbnN0O1xufTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBbUJBOztBQUdBOztBQUNBOztBQUNBOztBQUVBOztBQTFCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFjTyxNQUFNQSxTQUFTLEdBQUcsV0FBbEI7O0FBQ1AsTUFBTUMsZUFBZSxHQUFHLCtCQUF4QjtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLGlDQUExQjtBQVFBLElBQUlDLFVBQUo7O0FBRU8sTUFBTUMsc0JBQXNCLEdBQUcsTUFBTTtFQUN4QyxNQUFNLENBQUNDLFdBQUQsRUFBY0MsY0FBZCxJQUFnQyxJQUFBQyxlQUFBLEVBQWtD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