"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _lodash = require("lodash");

var _room2 = require("matrix-js-sdk/src/models/room");

var _roomState = require("matrix-js-sdk/src/models/room-state");

var _MatrixClientPeg = require("../MatrixClientPeg");

var _QueryMatcher = _interopRequireDefault(require("./QueryMatcher"));

var _Components = require("./Components");

var _AutocompleteProvider = _interopRequireDefault(require("./AutocompleteProvider"));

var _languageHandler = require("../languageHandler");

var _Permalinks = require("../utils/permalinks/Permalinks");

var _MemberAvatar = _interopRequireDefault(require("../components/views/avatars/MemberAvatar"));

var _UserIdentifier = _interopRequireDefault(require("../customisations/UserIdentifier"));

/*
Copyright 2016 Aviral Dasgupta
Copyright 2017 Vector Creations Ltd
Copyright 2017, 2018 New Vector Ltd
Copyright 2018 Michael Telatynski <7t3chguy@gmail.com>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const USER_REGEX = /\B@\S*/g; // used when you hit 'tab' - we allow some separator chars at the beginning
// to allow you to tab-complete /mat into /(matthew)

const FORCED_USER_REGEX = /[^/,:; \t\n]\S*/g;

class UserProvider extends _AutocompleteProvider.default {
  constructor(_room, renderingType) {
    super({
      commandRegex: USER_REGEX,
      forcedCommandRegex: FORCED_USER_REGEX,
      renderingType
    });
    (0, _defineProperty2.default)(this, "matcher", void 0);
    (0, _defineProperty2.default)(this, "users", void 0);
    (0, _defineProperty2.default)(this, "room", void 0);
    (0, _defineProperty2.default)(this, "onRoomTimeline", (ev, room, toStartOfTimeline, removed, data) => {
      if (!room) return; // notification timeline, we'll get this event again with a room specific timeline

      if (removed) return;
      if (room.roomId !== this.room.roomId) return; // ignore events from filtered timelines

      if (data.timeline.getTimelineSet() !== room.getUnfilteredTimelineSet()) return; // ignore anything but real-time updates at the end of the room:
      // updates from pagination will happen when the paginate completes.

      if (toStartOfTimeline || !data || !data.liveEvent) return; // TODO: lazyload if we have no ev.sender room member?

      this.onUserSpoke(ev.sender);
    });
    (0, _defineProperty2.default)(this, "onRoomStateUpdate", state => {
      // ignore updates in other rooms
      if (state.roomId !== this.room.roomId) return; // blow away the users cache

      this.users = null;
    });
    this.room = _room;
    this.matcher = new _QueryMatcher.default([], {
      keys: ['name'],
      funcs: [obj => obj.userId.slice(1)],
      // index by user id minus the leading '@'
      shouldMatchWordsOnly: false
    });

    _MatrixClientPeg.MatrixClientPeg.get().on(_room2.RoomEvent.Timeline, this.onRoomTimeline);

    _MatrixClientPeg.MatrixClientPeg.get().on(_roomState.RoomStateEvent.Update, this.onRoomStateUpdate);
  }

  destroy() {
    if (_MatrixClientPeg.MatrixClientPeg.get()) {
      _MatrixClientPeg.MatrixClientPeg.get().removeListener(_room2.RoomEvent.Timeline, this.onRoomTimeline);

      _MatrixClientPeg.MatrixClientPeg.get().removeListener(_roomState.RoomStateEvent.Update, this.onRoomStateUpdate);
    }
  }

  async getCompletions(rawQuery, selection) {
    let force = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    let limit = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : -1;
    // lazy-load user list into matcher
    if (!this.users) this.makeUsers();
    let completions = [];
    const {
      command,
      range
    } = this.getCurrentCommand(rawQuery, selection, force);
    if (!command) return completions;
    const fullMatch = command[0]; // Don't search if the query is a single "@"

    if (fullMatch && fullMatch !== '@') {
      // Don't include the '@' in our search query - it's only used as a way to trigger completion
      const query = fullMatch.startsWith('@') ? fullMatch.substring(1) : fullMatch;
      completions = this.matcher.match(query, limit).map(user => {
        const description = _UserIdentifier.default.getDisplayUserIdentifier(user.userId, {
          roomId: this.room.roomId,
          withDisplayName: true
        });

        const displayName = user.name || user.userId || '';
        return {
          // Length of completion should equal length of text in decorator. draft-js
          // relies on the length of the entity === length of the text in the decoration.
          completion: user.rawDisplayName,
          completionId: user.userId,
          type: "user",
          suffix: selection.beginning && range.start === 0 ? ': ' : ' ',
          href: (0, _Permalinks.makeUserPermalink)(user.userId),
          component: /*#__PURE__*/_react.default.createElement(_Components.PillCompletion, {
            title: displayName,
            description: description
          }, /*#__PURE__*/_react.default.createElement(_MemberAvatar.default, {
            member: user,
            width: 24,
            height: 24
          })),
          range
        };
      });
    }

    return completions;
  }

  getName() {
    return (0, _languageHandler._t)('Users');
  }

  makeUsers() {
    const events = this.room.getLiveTimeline().getEvents();
    const lastSpoken = {};

    for (const event of events) {
      lastSpoken[event.getSender()] = event.getTs();
    }

    const currentUserId = _MatrixClientPeg.MatrixClientPeg.get().credentials.userId;

    this.users = this.room.getJoinedMembers().filter(_ref => {
      let {
        userId
      } = _ref;
      return userId !== currentUserId;
    });
    this.users = this.users.concat(this.room.getMembersWithMembership("invite"));
    this.users = (0, _lodash.sortBy)(this.users, member => 1E20 - lastSpoken[member.userId] || 1E20);
    this.matcher.setObjects(this.users);
  }

  onUserSpoke(user) {
    if (!this.users) return;
    if (!user) return;
    if (user.userId === _MatrixClientPeg.MatrixClientPeg.get().credentials.userId) return; // Move the user that spoke to the front of the array

    this.users.splice(this.users.findIndex(user2 => user2.userId === user.userId), 1);
    this.users = [user, ...this.users];
    this.matcher.setObjects(this.users);
  }

  renderCompletions(completions) {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Autocomplete_Completion_container_pill",
      role: "presentation",
      "aria-label": (0, _languageHandler._t)("User Autocomplete")
    }, completions);
  }

  shouldForceComplete() {
    return true;
  }

}

exports.default = UserProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJVU0VSX1JFR0VYIiwiRk9SQ0VEX1VTRVJfUkVHRVgiLCJVc2VyUHJvdmlkZXIiLCJBdXRvY29tcGxldGVQcm92aWRlciIsImNvbnN0cnVjdG9yIiwicm9vbSIsInJlbmRlcmluZ1R5cGUiLCJjb21tYW5kUmVnZXgiLCJmb3JjZWRDb21tYW5kUmVnZXgiLCJldiIsInRvU3RhcnRPZlRpbWVsaW5lIiwicmVtb3ZlZCIsImRhdGEiLCJyb29tSWQiLCJ0aW1lbGluZSIsImdldFRpbWVsaW5lU2V0IiwiZ2V0VW5maWx0ZXJlZFRpbWVsaW5lU2V0IiwibGl2ZUV2ZW50Iiwib25Vc2VyU3Bva2UiLCJzZW5kZXIiLCJzdGF0ZSIsInVzZXJzIiwibWF0Y2hlciIsIlF1ZXJ5TWF0Y2hlciIsImtleXMiLCJmdW5jcyIsIm9iaiIsInVzZXJJZCIsInNsaWNlIiwic2hvdWxkTWF0Y2hXb3Jkc09ubHkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJvbiIsIlJvb21FdmVudCIsIlRpbWVsaW5lIiwib25Sb29tVGltZWxpbmUiLCJSb29tU3RhdGVFdmVudCIsIlVwZGF0ZSIsIm9uUm9vbVN0YXRlVXBkYXRlIiwiZGVzdHJveSIsInJlbW92ZUxpc3RlbmVyIiwiZ2V0Q29tcGxldGlvbnMiLCJyYXdRdWVyeSIsInNlbGVjdGlvbiIsImZvcmNlIiwibGltaXQiLCJtYWtlVXNlcnMiLCJjb21wbGV0aW9ucyIsImNvbW1hbmQiLCJyYW5nZSIsImdldEN1cnJlbnRDb21tYW5kIiwiZnVsbE1hdGNoIiwicXVlcnkiLCJzdGFydHNXaXRoIiwic3Vic3RyaW5nIiwibWF0Y2giLCJtYXAiLCJ1c2VyIiwiZGVzY3JpcHRpb24iLCJVc2VySWRlbnRpZmllckN1c3RvbWlzYXRpb25zIiwiZ2V0RGlzcGxheVVzZXJJZGVudGlmaWVyIiwid2l0aERpc3BsYXlOYW1lIiwiZGlzcGxheU5hbWUiLCJuYW1lIiwiY29tcGxldGlvbiIsInJhd0Rpc3BsYXlOYW1lIiwiY29tcGxldGlvbklkIiwidHlwZSIsInN1ZmZpeCIsImJlZ2lubmluZyIsInN0YXJ0IiwiaHJlZiIsIm1ha2VVc2VyUGVybWFsaW5rIiwiY29tcG9uZW50IiwiZ2V0TmFtZSIsIl90IiwiZXZlbnRzIiwiZ2V0TGl2ZVRpbWVsaW5lIiwiZ2V0RXZlbnRzIiwibGFzdFNwb2tlbiIsImV2ZW50IiwiZ2V0U2VuZGVyIiwiZ2V0VHMiLCJjdXJyZW50VXNlcklkIiwiY3JlZGVudGlhbHMiLCJnZXRKb2luZWRNZW1iZXJzIiwiZmlsdGVyIiwiY29uY2F0IiwiZ2V0TWVtYmVyc1dpdGhNZW1iZXJzaGlwIiwic29ydEJ5IiwibWVtYmVyIiwic2V0T2JqZWN0cyIsInNwbGljZSIsImZpbmRJbmRleCIsInVzZXIyIiwicmVuZGVyQ29tcGxldGlvbnMiLCJzaG91bGRGb3JjZUNvbXBsZXRlIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL2F1dG9jb21wbGV0ZS9Vc2VyUHJvdmlkZXIudHN4Il0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxNiBBdmlyYWwgRGFzZ3VwdGFcbkNvcHlyaWdodCAyMDE3IFZlY3RvciBDcmVhdGlvbnMgTHRkXG5Db3B5cmlnaHQgMjAxNywgMjAxOCBOZXcgVmVjdG9yIEx0ZFxuQ29weXJpZ2h0IDIwMTggTWljaGFlbCBUZWxhdHluc2tpIDw3dDNjaGd1eUBnbWFpbC5jb20+XG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcbmltcG9ydCB7IFJvb20sIFJvb21FdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IHsgUm9vbU1lbWJlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbS1tZW1iZXJcIjtcbmltcG9ydCB7IFJvb21TdGF0ZSwgUm9vbVN0YXRlRXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvbW9kZWxzL3Jvb20tc3RhdGVcIjtcbmltcG9ydCB7IElSb29tVGltZWxpbmVEYXRhIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9ldmVudC10aW1lbGluZS1zZXRcIjtcblxuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBRdWVyeU1hdGNoZXIgZnJvbSAnLi9RdWVyeU1hdGNoZXInO1xuaW1wb3J0IHsgUGlsbENvbXBsZXRpb24gfSBmcm9tICcuL0NvbXBvbmVudHMnO1xuaW1wb3J0IEF1dG9jb21wbGV0ZVByb3ZpZGVyIGZyb20gJy4vQXV0b2NvbXBsZXRlUHJvdmlkZXInO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgbWFrZVVzZXJQZXJtYWxpbmsgfSBmcm9tIFwiLi4vdXRpbHMvcGVybWFsaW5rcy9QZXJtYWxpbmtzXCI7XG5pbXBvcnQgeyBJQ29tcGxldGlvbiwgSVNlbGVjdGlvblJhbmdlIH0gZnJvbSBcIi4vQXV0b2NvbXBsZXRlclwiO1xuaW1wb3J0IE1lbWJlckF2YXRhciBmcm9tICcuLi9jb21wb25lbnRzL3ZpZXdzL2F2YXRhcnMvTWVtYmVyQXZhdGFyJztcbmltcG9ydCB7IFRpbWVsaW5lUmVuZGVyaW5nVHlwZSB9IGZyb20gJy4uL2NvbnRleHRzL1Jvb21Db250ZXh0JztcbmltcG9ydCBVc2VySWRlbnRpZmllckN1c3RvbWlzYXRpb25zIGZyb20gJy4uL2N1c3RvbWlzYXRpb25zL1VzZXJJZGVudGlmaWVyJztcblxuY29uc3QgVVNFUl9SRUdFWCA9IC9cXEJAXFxTKi9nO1xuXG4vLyB1c2VkIHdoZW4geW91IGhpdCAndGFiJyAtIHdlIGFsbG93IHNvbWUgc2VwYXJhdG9yIGNoYXJzIGF0IHRoZSBiZWdpbm5pbmdcbi8vIHRvIGFsbG93IHlvdSB0byB0YWItY29tcGxldGUgL21hdCBpbnRvIC8obWF0dGhldylcbmNvbnN0IEZPUkNFRF9VU0VSX1JFR0VYID0gL1teLyw6OyBcXHRcXG5dXFxTKi9nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyUHJvdmlkZXIgZXh0ZW5kcyBBdXRvY29tcGxldGVQcm92aWRlciB7XG4gICAgbWF0Y2hlcjogUXVlcnlNYXRjaGVyPFJvb21NZW1iZXI+O1xuICAgIHVzZXJzOiBSb29tTWVtYmVyW107XG4gICAgcm9vbTogUm9vbTtcblxuICAgIGNvbnN0cnVjdG9yKHJvb206IFJvb20sIHJlbmRlcmluZ1R5cGU/OiBUaW1lbGluZVJlbmRlcmluZ1R5cGUpIHtcbiAgICAgICAgc3VwZXIoe1xuICAgICAgICAgICAgY29tbWFuZFJlZ2V4OiBVU0VSX1JFR0VYLFxuICAgICAgICAgICAgZm9yY2VkQ29tbWFuZFJlZ2V4OiBGT1JDRURfVVNFUl9SRUdFWCxcbiAgICAgICAgICAgIHJlbmRlcmluZ1R5cGUsXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJvb20gPSByb29tO1xuICAgICAgICB0aGlzLm1hdGNoZXIgPSBuZXcgUXVlcnlNYXRjaGVyKFtdLCB7XG4gICAgICAgICAgICBrZXlzOiBbJ25hbWUnXSxcbiAgICAgICAgICAgIGZ1bmNzOiBbb2JqID0+IG9iai51c2VySWQuc2xpY2UoMSldLCAvLyBpbmRleCBieSB1c2VyIGlkIG1pbnVzIHRoZSBsZWFkaW5nICdAJ1xuICAgICAgICAgICAgc2hvdWxkTWF0Y2hXb3Jkc09ubHk6IGZhbHNlLFxuICAgICAgICB9KTtcblxuICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkub24oUm9vbUV2ZW50LlRpbWVsaW5lLCB0aGlzLm9uUm9vbVRpbWVsaW5lKTtcbiAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLm9uKFJvb21TdGF0ZUV2ZW50LlVwZGF0ZSwgdGhpcy5vblJvb21TdGF0ZVVwZGF0ZSk7XG4gICAgfVxuXG4gICAgZGVzdHJveSgpIHtcbiAgICAgICAgaWYgKE1hdHJpeENsaWVudFBlZy5nZXQoKSkge1xuICAgICAgICAgICAgTWF0cml4Q2xpZW50UGVnLmdldCgpLnJlbW92ZUxpc3RlbmVyKFJvb21FdmVudC5UaW1lbGluZSwgdGhpcy5vblJvb21UaW1lbGluZSk7XG4gICAgICAgICAgICBNYXRyaXhDbGllbnRQZWcuZ2V0KCkucmVtb3ZlTGlzdGVuZXIoUm9vbVN0YXRlRXZlbnQuVXBkYXRlLCB0aGlzLm9uUm9vbVN0YXRlVXBkYXRlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25Sb29tVGltZWxpbmUgPSAoXG4gICAgICAgIGV2OiBNYXRyaXhFdmVudCxcbiAgICAgICAgcm9vbTogUm9vbSB8IG51bGwsXG4gICAgICAgIHRvU3RhcnRPZlRpbWVsaW5lOiBib29sZWFuLFxuICAgICAgICByZW1vdmVkOiBib29sZWFuLFxuICAgICAgICBkYXRhOiBJUm9vbVRpbWVsaW5lRGF0YSxcbiAgICApID0+IHtcbiAgICAgICAgaWYgKCFyb29tKSByZXR1cm47IC8vIG5vdGlmaWNhdGlvbiB0aW1lbGluZSwgd2UnbGwgZ2V0IHRoaXMgZXZlbnQgYWdhaW4gd2l0aCBhIHJvb20gc3BlY2lmaWMgdGltZWxpbmVcbiAgICAgICAgaWYgKHJlbW92ZWQpIHJldHVybjtcbiAgICAgICAgaWYgKHJvb20ucm9vbUlkICE9PSB0aGlzLnJvb20ucm9vbUlkKSByZXR1cm47XG5cbiAgICAgICAgLy8gaWdub3JlIGV2ZW50cyBmcm9tIGZpbHRlcmVkIHRpbWVsaW5lc1xuICAgICAgICBpZiAoZGF0YS50aW1lbGluZS5nZXRUaW1lbGluZVNldCgpICE9PSByb29tLmdldFVuZmlsdGVyZWRUaW1lbGluZVNldCgpKSByZXR1cm47XG5cbiAgICAgICAgLy8gaWdub3JlIGFueXRoaW5nIGJ1dCByZWFsLXRpbWUgdXBkYXRlcyBhdCB0aGUgZW5kIG9mIHRoZSByb29tOlxuICAgICAgICAvLyB1cGRhdGVzIGZyb20gcGFnaW5hdGlvbiB3aWxsIGhhcHBlbiB3aGVuIHRoZSBwYWdpbmF0ZSBjb21wbGV0ZXMuXG4gICAgICAgIGlmICh0b1N0YXJ0T2ZUaW1lbGluZSB8fCAhZGF0YSB8fCAhZGF0YS5saXZlRXZlbnQpIHJldHVybjtcblxuICAgICAgICAvLyBUT0RPOiBsYXp5bG9hZCBpZiB3ZSBoYXZlIG5vIGV2LnNlbmRlciByb29tIG1lbWJlcj9cbiAgICAgICAgdGhpcy5vblVzZXJTcG9rZShldi5zZW5kZXIpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uUm9vbVN0YXRlVXBkYXRlID0gKHN0YXRlOiBSb29tU3RhdGUpID0+IHtcbiAgICAgICAgLy8gaWdub3JlIHVwZGF0ZXMgaW4gb3RoZXIgcm9vbXNcbiAgICAgICAgaWYgKHN0YXRlLnJvb21JZCAhPT0gdGhpcy5yb29tLnJvb21JZCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIGJsb3cgYXdheSB0aGUgdXNlcnMgY2FjaGVcbiAgICAgICAgdGhpcy51c2VycyA9IG51bGw7XG4gICAgfTtcblxuICAgIGFzeW5jIGdldENvbXBsZXRpb25zKFxuICAgICAgICByYXdRdWVyeTogc3RyaW5nLFxuICAgICAgICBzZWxlY3Rpb246IElTZWxlY3Rpb25SYW5nZSxcbiAgICAgICAgZm9yY2UgPSBmYWxzZSxcbiAgICAgICAgbGltaXQgPSAtMSxcbiAgICApOiBQcm9taXNlPElDb21wbGV0aW9uW10+IHtcbiAgICAgICAgLy8gbGF6eS1sb2FkIHVzZXIgbGlzdCBpbnRvIG1hdGNoZXJcbiAgICAgICAgaWYgKCF0aGlzLnVzZXJzKSB0aGlzLm1ha2VVc2VycygpO1xuXG4gICAgICAgIGxldCBjb21wbGV0aW9ucyA9IFtdO1xuICAgICAgICBjb25zdCB7IGNvbW1hbmQsIHJhbmdlIH0gPSB0aGlzLmdldEN1cnJlbnRDb21tYW5kKHJhd1F1ZXJ5LCBzZWxlY3Rpb24sIGZvcmNlKTtcblxuICAgICAgICBpZiAoIWNvbW1hbmQpIHJldHVybiBjb21wbGV0aW9ucztcblxuICAgICAgICBjb25zdCBmdWxsTWF0Y2ggPSBjb21tYW5kWzBdO1xuICAgICAgICAvLyBEb24ndCBzZWFyY2ggaWYgdGhlIHF1ZXJ5IGlzIGEgc2luZ2xlIFwiQFwiXG4gICAgICAgIGlmIChmdWxsTWF0Y2ggJiYgZnVsbE1hdGNoICE9PSAnQCcpIHtcbiAgICAgICAgICAgIC8vIERvbid0IGluY2x1ZGUgdGhlICdAJyBpbiBvdXIgc2VhcmNoIHF1ZXJ5IC0gaXQncyBvbmx5IHVzZWQgYXMgYSB3YXkgdG8gdHJpZ2dlciBjb21wbGV0aW9uXG4gICAgICAgICAgICBjb25zdCBxdWVyeSA9IGZ1bGxNYXRjaC5zdGFydHNXaXRoKCdAJykgPyBmdWxsTWF0Y2guc3Vic3RyaW5nKDEpIDogZnVsbE1hdGNoO1xuICAgICAgICAgICAgY29tcGxldGlvbnMgPSB0aGlzLm1hdGNoZXIubWF0Y2gocXVlcnksIGxpbWl0KS5tYXAoKHVzZXIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZXNjcmlwdGlvbiA9IFVzZXJJZGVudGlmaWVyQ3VzdG9taXNhdGlvbnMuZ2V0RGlzcGxheVVzZXJJZGVudGlmaWVyKFxuICAgICAgICAgICAgICAgICAgICB1c2VyLnVzZXJJZCwgeyByb29tSWQ6IHRoaXMucm9vbS5yb29tSWQsIHdpdGhEaXNwbGF5TmFtZTogdHJ1ZSB9LFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSAodXNlci5uYW1lIHx8IHVzZXIudXNlcklkIHx8ICcnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBMZW5ndGggb2YgY29tcGxldGlvbiBzaG91bGQgZXF1YWwgbGVuZ3RoIG9mIHRleHQgaW4gZGVjb3JhdG9yLiBkcmFmdC1qc1xuICAgICAgICAgICAgICAgICAgICAvLyByZWxpZXMgb24gdGhlIGxlbmd0aCBvZiB0aGUgZW50aXR5ID09PSBsZW5ndGggb2YgdGhlIHRleHQgaW4gdGhlIGRlY29yYXRpb24uXG4gICAgICAgICAgICAgICAgICAgIGNvbXBsZXRpb246IHVzZXIucmF3RGlzcGxheU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbXBsZXRpb25JZDogdXNlci51c2VySWQsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IFwidXNlclwiLFxuICAgICAgICAgICAgICAgICAgICBzdWZmaXg6IChzZWxlY3Rpb24uYmVnaW5uaW5nICYmIHJhbmdlLnN0YXJ0ID09PSAwKSA/ICc6ICcgOiAnICcsXG4gICAgICAgICAgICAgICAgICAgIGhyZWY6IG1ha2VVc2VyUGVybWFsaW5rKHVzZXIudXNlcklkKSxcbiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50OiAoXG4gICAgICAgICAgICAgICAgICAgICAgICA8UGlsbENvbXBsZXRpb24gdGl0bGU9e2Rpc3BsYXlOYW1lfSBkZXNjcmlwdGlvbj17ZGVzY3JpcHRpb259PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZW1iZXJBdmF0YXIgbWVtYmVyPXt1c2VyfSB3aWR0aD17MjR9IGhlaWdodD17MjR9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L1BpbGxDb21wbGV0aW9uPlxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICByYW5nZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbXBsZXRpb25zO1xuICAgIH1cblxuICAgIGdldE5hbWUoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIF90KCdVc2VycycpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbWFrZVVzZXJzKCkge1xuICAgICAgICBjb25zdCBldmVudHMgPSB0aGlzLnJvb20uZ2V0TGl2ZVRpbWVsaW5lKCkuZ2V0RXZlbnRzKCk7XG4gICAgICAgIGNvbnN0IGxhc3RTcG9rZW4gPSB7fTtcblxuICAgICAgICBmb3IgKGNvbnN0IGV2ZW50IG9mIGV2ZW50cykge1xuICAgICAgICAgICAgbGFzdFNwb2tlbltldmVudC5nZXRTZW5kZXIoKV0gPSBldmVudC5nZXRUcygpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY3VycmVudFVzZXJJZCA9IE1hdHJpeENsaWVudFBlZy5nZXQoKS5jcmVkZW50aWFscy51c2VySWQ7XG4gICAgICAgIHRoaXMudXNlcnMgPSB0aGlzLnJvb20uZ2V0Sm9pbmVkTWVtYmVycygpLmZpbHRlcigoeyB1c2VySWQgfSkgPT4gdXNlcklkICE9PSBjdXJyZW50VXNlcklkKTtcbiAgICAgICAgdGhpcy51c2VycyA9IHRoaXMudXNlcnMuY29uY2F0KHRoaXMucm9vbS5nZXRNZW1iZXJzV2l0aE1lbWJlcnNoaXAoXCJpbnZpdGVcIikpO1xuXG4gICAgICAgIHRoaXMudXNlcnMgPSBzb3J0QnkodGhpcy51c2VycywgKG1lbWJlcikgPT4gMUUyMCAtIGxhc3RTcG9rZW5bbWVtYmVyLnVzZXJJZF0gfHwgMUUyMCk7XG5cbiAgICAgICAgdGhpcy5tYXRjaGVyLnNldE9iamVjdHModGhpcy51c2Vycyk7XG4gICAgfVxuXG4gICAgb25Vc2VyU3Bva2UodXNlcjogUm9vbU1lbWJlcikge1xuICAgICAgICBpZiAoIXRoaXMudXNlcnMpIHJldHVybjtcbiAgICAgICAgaWYgKCF1c2VyKSByZXR1cm47XG4gICAgICAgIGlmICh1c2VyLnVzZXJJZCA9PT0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmNyZWRlbnRpYWxzLnVzZXJJZCkgcmV0dXJuO1xuXG4gICAgICAgIC8vIE1vdmUgdGhlIHVzZXIgdGhhdCBzcG9rZSB0byB0aGUgZnJvbnQgb2YgdGhlIGFycmF5XG4gICAgICAgIHRoaXMudXNlcnMuc3BsaWNlKFxuICAgICAgICAgICAgdGhpcy51c2Vycy5maW5kSW5kZXgoKHVzZXIyKSA9PiB1c2VyMi51c2VySWQgPT09IHVzZXIudXNlcklkKSwgMSk7XG4gICAgICAgIHRoaXMudXNlcnMgPSBbdXNlciwgLi4udGhpcy51c2Vyc107XG5cbiAgICAgICAgdGhpcy5tYXRjaGVyLnNldE9iamVjdHModGhpcy51c2Vycyk7XG4gICAgfVxuXG4gICAgcmVuZGVyQ29tcGxldGlvbnMoY29tcGxldGlvbnM6IFJlYWN0LlJlYWN0Tm9kZVtdKTogUmVhY3QuUmVhY3ROb2RlIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJteF9BdXRvY29tcGxldGVfQ29tcGxldGlvbl9jb250YWluZXJfcGlsbFwiXG4gICAgICAgICAgICAgICAgcm9sZT1cInByZXNlbnRhdGlvblwiXG4gICAgICAgICAgICAgICAgYXJpYS1sYWJlbD17X3QoXCJVc2VyIEF1dG9jb21wbGV0ZVwiKX1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGNvbXBsZXRpb25zIH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cblxuICAgIHNob3VsZEZvcmNlQ29tcGxldGUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFtQkE7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBcENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQXFCQSxNQUFNQSxVQUFVLEdBQUcsU0FBbkIsQyxDQUVBO0FBQ0E7O0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsa0JBQTFCOztBQUVlLE1BQU1DLFlBQU4sU0FBMkJDLDZCQUEzQixDQUFnRDtFQUszREMsV0FBVyxDQUFDQyxLQUFELEVBQWFDLGFBQWIsRUFBb0Q7SUFDM0QsTUFBTTtNQUNGQyxZQUFZLEVBQUVQLFVBRFo7TUFFRlEsa0JBQWtCLEVBQUVQLGlCQUZsQjtNQUdGSztJQUhFLENBQU47SUFEMkQ7SUFBQTtJQUFBO0lBQUEsc0RBd0J0QyxDQUNyQkcsRUFEcUIsRUFFckJKLElBRnFCLEVBR3JCSyxpQkFIcUIsRUFJckJDLE9BSnFCLEVBS3JCQyxJQUxxQixLQU1wQjtNQUNELElBQUksQ0FBQ1AsSUFBTCxFQUFXLE9BRFYsQ0FDa0I7O01BQ25CLElBQUlNLE9BQUosRUFBYTtNQUNiLElBQUlOLElBQUksQ0FBQ1EsTUFBTCxLQUFnQixLQUFLUixJQUFMLENBQVVRLE1BQTlCLEVBQXNDLE9BSHJDLENBS0Q7O01BQ0EsSUFBSUQsSUFBSSxDQUFDRSxRQUFMLENBQWNDLGNBQWQsT0FBbUNWLElBQUksQ0FBQ1csd0JBQUwsRUFBdkMsRUFBd0UsT0FOdkUsQ0FRRDtNQUNBOztNQUNBLElBQUlOLGlCQUFpQixJQUFJLENBQUNFLElBQXRCLElBQThCLENBQUNBLElBQUksQ0FBQ0ssU0FBeEMsRUFBbUQsT0FWbEQsQ0FZRDs7TUFDQSxLQUFL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