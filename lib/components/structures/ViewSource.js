"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _SyntaxHighlight = _interopRequireDefault(require("../views/elements/SyntaxHighlight"));

var _languageHandler = require("../../languageHandler");

var _MatrixClientContext = _interopRequireDefault(require("../../contexts/MatrixClientContext"));

var _EventUtils = require("../../utils/EventUtils");

var _MatrixClientPeg = require("../../MatrixClientPeg");

var _BaseDialog = _interopRequireDefault(require("../views/dialogs/BaseDialog"));

var _BaseTool = require("../views/dialogs/devtools/BaseTool");

var _RoomState = require("../views/dialogs/devtools/RoomState");

var _Event = require("../views/dialogs/devtools/Event");

var _CopyableText = _interopRequireDefault(require("../views/elements/CopyableText"));

/*
Copyright 2015, 2016 OpenMarket Ltd
Copyright 2019 Michael Telatynski <7t3chguy@gmail.com>
Copyright 2019 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class ViewSource extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onBack", () => {
      // TODO: refresh the "Event ID:" modal header
      this.setState({
        isEditing: false
      });
    });
    this.state = {
      isEditing: false
    };
  }

  onEdit() {
    this.setState({
      isEditing: true
    });
  } // returns the dialog body for viewing the event source


  viewSourceContent() {
    const mxEvent = this.props.mxEvent.replacingEvent() || this.props.mxEvent; // show the replacing event, not the original, if it is an edit

    const isEncrypted = mxEvent.isEncrypted(); // @ts-ignore

    const decryptedEventSource = mxEvent.clearEvent; // FIXME: clearEvent is private

    const originalEventSource = mxEvent.event;

    const copyOriginalFunc = () => {
      return (0, _Event.stringify)(originalEventSource);
    };

    if (isEncrypted) {
      const copyDecryptedFunc = () => {
        return (0, _Event.stringify)(decryptedEventSource);
      };

      return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("details", {
        open: true,
        className: "mx_ViewSource_details"
      }, /*#__PURE__*/_react.default.createElement("summary", null, /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_ViewSource_heading"
      }, (0, _languageHandler._t)("Decrypted event source"))), /*#__PURE__*/_react.default.createElement(_CopyableText.default, {
        getTextToCopy: copyDecryptedFunc
      }, /*#__PURE__*/_react.default.createElement(_SyntaxHighlight.default, {
        language: "json"
      }, (0, _Event.stringify)(decryptedEventSource)))), /*#__PURE__*/_react.default.createElement("details", {
        className: "mx_ViewSource_details"
      }, /*#__PURE__*/_react.default.createElement("summary", null, /*#__PURE__*/_react.default.createElement("span", {
        className: "mx_ViewSource_heading"
      }, (0, _languageHandler._t)("Original event source"))), /*#__PURE__*/_react.default.createElement(_CopyableText.default, {
        getTextToCopy: copyOriginalFunc
      }, /*#__PURE__*/_react.default.createElement(_SyntaxHighlight.default, {
        language: "json"
      }, (0, _Event.stringify)(originalEventSource)))));
    } else {
      return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_ViewSource_heading"
      }, (0, _languageHandler._t)("Original event source")), /*#__PURE__*/_react.default.createElement(_CopyableText.default, {
        getTextToCopy: copyOriginalFunc
      }, /*#__PURE__*/_react.default.createElement(_SyntaxHighlight.default, {
        language: "json"
      }, (0, _Event.stringify)(originalEventSource))));
    }
  } // returns the SendCustomEvent component prefilled with the correct details


  editSourceContent() {
    const mxEvent = this.props.mxEvent.replacingEvent() || this.props.mxEvent; // show the replacing event, not the original, if it is an edit

    const isStateEvent = mxEvent.isState();
    const roomId = mxEvent.getRoomId();

    if (isStateEvent) {
      return /*#__PURE__*/_react.default.createElement(_MatrixClientContext.default.Consumer, null, cli => /*#__PURE__*/_react.default.createElement(_BaseTool.DevtoolsContext.Provider, {
        value: {
          room: cli.getRoom(roomId)
        }
      }, /*#__PURE__*/_react.default.createElement(_RoomState.StateEventEditor, {
        onBack: this.onBack,
        mxEvent: mxEvent
      })));
    }

    return /*#__PURE__*/_react.default.createElement(_MatrixClientContext.default.Consumer, null, cli => /*#__PURE__*/_react.default.createElement(_BaseTool.DevtoolsContext.Provider, {
      value: {
        room: cli.getRoom(roomId)
      }
    }, /*#__PURE__*/_react.default.createElement(_Event.TimelineEventEditor, {
      onBack: this.onBack,
      mxEvent: mxEvent
    })));
  }

  canSendStateEvent(mxEvent) {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const room = cli.getRoom(mxEvent.getRoomId());
    return room.currentState.mayClientSendStateEvent(mxEvent.getType(), cli);
  }

  render() {
    const mxEvent = this.props.mxEvent.replacingEvent() || this.props.mxEvent; // show the replacing event, not the original, if it is an edit

    const isEditing = this.state.isEditing;
    const roomId = mxEvent.getRoomId();
    const eventId = mxEvent.getId();
    const canEdit = mxEvent.isState() ? this.canSendStateEvent(mxEvent) : (0, _EventUtils.canEditContent)(this.props.mxEvent);
    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_ViewSource",
      onFinished: this.props.onFinished,
      title: (0, _languageHandler._t)("View Source")
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_ViewSource_header"
    }, /*#__PURE__*/_react.default.createElement(_CopyableText.default, {
      getTextToCopy: () => roomId,
      border: false
    }, (0, _languageHandler._t)("Room ID: %(roomId)s", {
      roomId
    })), /*#__PURE__*/_react.default.createElement(_CopyableText.default, {
      getTextToCopy: () => eventId,
      border: false
    }, (0, _languageHandler._t)("Event ID: %(eventId)s", {
      eventId
    }))), isEditing ? this.editSourceContent() : this.viewSourceContent(), !isEditing && canEdit && /*#__PURE__*/_react.default.createElement("div", {
      className: "mx_Dialog_buttons"
    }, /*#__PURE__*/_react.default.createElement("button", {
      onClick: () => this.onEdit()
    }, (0, _languageHandler._t)("Edit"))));
  }

}

exports.default = ViewSource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJWaWV3U291cmNlIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic2V0U3RhdGUiLCJpc0VkaXRpbmciLCJzdGF0ZSIsIm9uRWRpdCIsInZpZXdTb3VyY2VDb250ZW50IiwibXhFdmVudCIsInJlcGxhY2luZ0V2ZW50IiwiaXNFbmNyeXB0ZWQiLCJkZWNyeXB0ZWRFdmVudFNvdXJjZSIsImNsZWFyRXZlbnQiLCJvcmlnaW5hbEV2ZW50U291cmNlIiwiZXZlbnQiLCJjb3B5T3JpZ2luYWxGdW5jIiwic3RyaW5naWZ5IiwiY29weURlY3J5cHRlZEZ1bmMiLCJfdCIsImVkaXRTb3VyY2VDb250ZW50IiwiaXNTdGF0ZUV2ZW50IiwiaXNTdGF0ZSIsInJvb21JZCIsImdldFJvb21JZCIsImNsaSIsInJvb20iLCJnZXRSb29tIiwib25CYWNrIiwiY2FuU2VuZFN0YXRlRXZlbnQiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJjdXJyZW50U3RhdGUiLCJtYXlDbGllbnRTZW5kU3RhdGVFdmVudCIsImdldFR5cGUiLCJyZW5kZXIiLCJldmVudElkIiwiZ2V0SWQiLCJjYW5FZGl0IiwiY2FuRWRpdENvbnRlbnQiLCJvbkZpbmlzaGVkIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvc3RydWN0dXJlcy9WaWV3U291cmNlLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTUsIDIwMTYgT3Blbk1hcmtldCBMdGRcbkNvcHlyaWdodCAyMDE5IE1pY2hhZWwgVGVsYXR5bnNraSA8N3QzY2hndXlAZ21haWwuY29tPlxuQ29weXJpZ2h0IDIwMTkgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBNYXRyaXhFdmVudCB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvZXZlbnRcIjtcblxuaW1wb3J0IFN5bnRheEhpZ2hsaWdodCBmcm9tIFwiLi4vdmlld3MvZWxlbWVudHMvU3ludGF4SGlnaGxpZ2h0XCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCBNYXRyaXhDbGllbnRDb250ZXh0IGZyb20gXCIuLi8uLi9jb250ZXh0cy9NYXRyaXhDbGllbnRDb250ZXh0XCI7XG5pbXBvcnQgeyBjYW5FZGl0Q29udGVudCB9IGZyb20gXCIuLi8uLi91dGlscy9FdmVudFV0aWxzXCI7XG5pbXBvcnQgeyBNYXRyaXhDbGllbnRQZWcgfSBmcm9tICcuLi8uLi9NYXRyaXhDbGllbnRQZWcnO1xuaW1wb3J0IHsgSURpYWxvZ1Byb3BzIH0gZnJvbSBcIi4uL3ZpZXdzL2RpYWxvZ3MvSURpYWxvZ1Byb3BzXCI7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi4vdmlld3MvZGlhbG9ncy9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgeyBEZXZ0b29sc0NvbnRleHQgfSBmcm9tIFwiLi4vdmlld3MvZGlhbG9ncy9kZXZ0b29scy9CYXNlVG9vbFwiO1xuaW1wb3J0IHsgU3RhdGVFdmVudEVkaXRvciB9IGZyb20gXCIuLi92aWV3cy9kaWFsb2dzL2RldnRvb2xzL1Jvb21TdGF0ZVwiO1xuaW1wb3J0IHsgc3RyaW5naWZ5LCBUaW1lbGluZUV2ZW50RWRpdG9yIH0gZnJvbSBcIi4uL3ZpZXdzL2RpYWxvZ3MvZGV2dG9vbHMvRXZlbnRcIjtcbmltcG9ydCBDb3B5YWJsZVRleHQgZnJvbSBcIi4uL3ZpZXdzL2VsZW1lbnRzL0NvcHlhYmxlVGV4dFwiO1xuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICBteEV2ZW50OiBNYXRyaXhFdmVudDsgLy8gdGhlIE1hdHJpeEV2ZW50IGFzc29jaWF0ZWQgd2l0aCB0aGUgY29udGV4dCBtZW51XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIGlzRWRpdGluZzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVmlld1NvdXJjZSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxJUHJvcHMsIElTdGF0ZT4ge1xuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBpc0VkaXRpbmc6IGZhbHNlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25CYWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICAvLyBUT0RPOiByZWZyZXNoIHRoZSBcIkV2ZW50IElEOlwiIG1vZGFsIGhlYWRlclxuICAgICAgICB0aGlzLnNldFN0YXRlKHsgaXNFZGl0aW5nOiBmYWxzZSB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkVkaXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyBpc0VkaXRpbmc6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJucyB0aGUgZGlhbG9nIGJvZHkgZm9yIHZpZXdpbmcgdGhlIGV2ZW50IHNvdXJjZVxuICAgIHByaXZhdGUgdmlld1NvdXJjZUNvbnRlbnQoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCBteEV2ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50LnJlcGxhY2luZ0V2ZW50KCkgfHwgdGhpcy5wcm9wcy5teEV2ZW50OyAvLyBzaG93IHRoZSByZXBsYWNpbmcgZXZlbnQsIG5vdCB0aGUgb3JpZ2luYWwsIGlmIGl0IGlzIGFuIGVkaXRcbiAgICAgICAgY29uc3QgaXNFbmNyeXB0ZWQgPSBteEV2ZW50LmlzRW5jcnlwdGVkKCk7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgZGVjcnlwdGVkRXZlbnRTb3VyY2UgPSBteEV2ZW50LmNsZWFyRXZlbnQ7IC8vIEZJWE1FOiBjbGVhckV2ZW50IGlzIHByaXZhdGVcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxFdmVudFNvdXJjZSA9IG14RXZlbnQuZXZlbnQ7XG4gICAgICAgIGNvbnN0IGNvcHlPcmlnaW5hbEZ1bmMgPSAoKTogc3RyaW5nID0+IHtcbiAgICAgICAgICAgIHJldHVybiBzdHJpbmdpZnkob3JpZ2luYWxFdmVudFNvdXJjZSk7XG4gICAgICAgIH07XG4gICAgICAgIGlmIChpc0VuY3J5cHRlZCkge1xuICAgICAgICAgICAgY29uc3QgY29weURlY3J5cHRlZEZ1bmMgPSAoKTogc3RyaW5nID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5naWZ5KGRlY3J5cHRlZEV2ZW50U291cmNlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDw+XG4gICAgICAgICAgICAgICAgICAgIDxkZXRhaWxzIG9wZW4gY2xhc3NOYW1lPVwibXhfVmlld1NvdXJjZV9kZXRhaWxzXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8c3VtbWFyeT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJteF9WaWV3U291cmNlX2hlYWRpbmdcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkRlY3J5cHRlZCBldmVudCBzb3VyY2VcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvc3VtbWFyeT5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxDb3B5YWJsZVRleHQgZ2V0VGV4dFRvQ29weT17Y29weURlY3J5cHRlZEZ1bmN9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxTeW50YXhIaWdobGlnaHQgbGFuZ3VhZ2U9XCJqc29uXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgc3RyaW5naWZ5KGRlY3J5cHRlZEV2ZW50U291cmNlKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9TeW50YXhIaWdobGlnaHQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L0NvcHlhYmxlVGV4dD5cbiAgICAgICAgICAgICAgICAgICAgPC9kZXRhaWxzPlxuICAgICAgICAgICAgICAgICAgICA8ZGV0YWlscyBjbGFzc05hbWU9XCJteF9WaWV3U291cmNlX2RldGFpbHNcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxzdW1tYXJ5PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cIm14X1ZpZXdTb3VyY2VfaGVhZGluZ1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiT3JpZ2luYWwgZXZlbnQgc291cmNlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3N1bW1hcnk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8Q29weWFibGVUZXh0IGdldFRleHRUb0NvcHk9e2NvcHlPcmlnaW5hbEZ1bmN9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxTeW50YXhIaWdobGlnaHQgbGFuZ3VhZ2U9XCJqc29uXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgc3RyaW5naWZ5KG9yaWdpbmFsRXZlbnRTb3VyY2UpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L1N5bnRheEhpZ2hsaWdodD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQ29weWFibGVUZXh0PlxuICAgICAgICAgICAgICAgICAgICA8L2RldGFpbHM+XG4gICAgICAgICAgICAgICAgPC8+XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1ZpZXdTb3VyY2VfaGVhZGluZ1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIk9yaWdpbmFsIGV2ZW50IHNvdXJjZVwiKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8Q29weWFibGVUZXh0IGdldFRleHRUb0NvcHk9e2NvcHlPcmlnaW5hbEZ1bmN9PlxuICAgICAgICAgICAgICAgICAgICAgICAgPFN5bnRheEhpZ2hsaWdodCBsYW5ndWFnZT1cImpzb25cIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHN0cmluZ2lmeShvcmlnaW5hbEV2ZW50U291cmNlKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L1N5bnRheEhpZ2hsaWdodD5cbiAgICAgICAgICAgICAgICAgICAgPC9Db3B5YWJsZVRleHQ+XG4gICAgICAgICAgICAgICAgPC8+XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gcmV0dXJucyB0aGUgU2VuZEN1c3RvbUV2ZW50IGNvbXBvbmVudCBwcmVmaWxsZWQgd2l0aCB0aGUgY29ycmVjdCBkZXRhaWxzXG4gICAgcHJpdmF0ZSBlZGl0U291cmNlQ29udGVudCgpOiBKU1guRWxlbWVudCB7XG4gICAgICAgIGNvbnN0IG14RXZlbnQgPSB0aGlzLnByb3BzLm14RXZlbnQucmVwbGFjaW5nRXZlbnQoKSB8fCB0aGlzLnByb3BzLm14RXZlbnQ7IC8vIHNob3cgdGhlIHJlcGxhY2luZyBldmVudCwgbm90IHRoZSBvcmlnaW5hbCwgaWYgaXQgaXMgYW4gZWRpdFxuXG4gICAgICAgIGNvbnN0IGlzU3RhdGVFdmVudCA9IG14RXZlbnQuaXNTdGF0ZSgpO1xuICAgICAgICBjb25zdCByb29tSWQgPSBteEV2ZW50LmdldFJvb21JZCgpO1xuXG4gICAgICAgIGlmIChpc1N0YXRlRXZlbnQpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPE1hdHJpeENsaWVudENvbnRleHQuQ29uc3VtZXI+XG4gICAgICAgICAgICAgICAgICAgIHsgKGNsaSkgPT4gKFxuICAgICAgICAgICAgICAgICAgICAgICAgPERldnRvb2xzQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17eyByb29tOiBjbGkuZ2V0Um9vbShyb29tSWQpIH19PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxTdGF0ZUV2ZW50RWRpdG9yIG9uQmFjaz17dGhpcy5vbkJhY2t9IG14RXZlbnQ9e214RXZlbnR9IC8+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L0RldnRvb2xzQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICAgICAgPC9NYXRyaXhDbGllbnRDb250ZXh0LkNvbnN1bWVyPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8TWF0cml4Q2xpZW50Q29udGV4dC5Db25zdW1lcj5cbiAgICAgICAgICAgICAgICB7IChjbGkpID0+IChcbiAgICAgICAgICAgICAgICAgICAgPERldnRvb2xzQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17eyByb29tOiBjbGkuZ2V0Um9vbShyb29tSWQpIH19PlxuICAgICAgICAgICAgICAgICAgICAgICAgPFRpbWVsaW5lRXZlbnRFZGl0b3Igb25CYWNrPXt0aGlzLm9uQmFja30gbXhFdmVudD17bXhFdmVudH0gLz5cbiAgICAgICAgICAgICAgICAgICAgPC9EZXZ0b29sc0NvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICA8L01hdHJpeENsaWVudENvbnRleHQuQ29uc3VtZXI+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYW5TZW5kU3RhdGVFdmVudChteEV2ZW50OiBNYXRyaXhFdmVudCk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHJvb20gPSBjbGkuZ2V0Um9vbShteEV2ZW50LmdldFJvb21JZCgpKTtcbiAgICAgICAgcmV0dXJuIHJvb20uY3VycmVudFN0YXRlLm1heUNsaWVudFNlbmRTdGF0ZUV2ZW50KG14RXZlbnQuZ2V0VHlwZSgpLCBjbGkpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW5kZXIoKTogSlNYLkVsZW1lbnQge1xuICAgICAgICBjb25zdCBteEV2ZW50ID0gdGhpcy5wcm9wcy5teEV2ZW50LnJlcGxhY2luZ0V2ZW50KCkgfHwgdGhpcy5wcm9wcy5teEV2ZW50OyAvLyBzaG93IHRoZSByZXBsYWNpbmcgZXZlbnQsIG5vdCB0aGUgb3JpZ2luYWwsIGlmIGl0IGlzIGFuIGVkaXRcblxuICAgICAgICBjb25zdCBpc0VkaXRpbmcgPSB0aGlzLnN0YXRlLmlzRWRpdGluZztcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gbXhFdmVudC5nZXRSb29tSWQoKTtcbiAgICAgICAgY29uc3QgZXZlbnRJZCA9IG14RXZlbnQuZ2V0SWQoKTtcbiAgICAgICAgY29uc3QgY2FuRWRpdCA9IG14RXZlbnQuaXNTdGF0ZSgpID8gdGhpcy5jYW5TZW5kU3RhdGVFdmVudChteEV2ZW50KSA6IGNhbkVkaXRDb250ZW50KHRoaXMucHJvcHMubXhFdmVudCk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZURpYWxvZyBjbGFzc05hbWU9XCJteF9WaWV3U291cmNlXCIgb25GaW5pc2hlZD17dGhpcy5wcm9wcy5vbkZpbmlzaGVkfSB0aXRsZT17X3QoXCJWaWV3IFNvdXJjZVwiKX0+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9WaWV3U291cmNlX2hlYWRlclwiPlxuICAgICAgICAgICAgICAgICAgICA8Q29weWFibGVUZXh0IGdldFRleHRUb0NvcHk9eygpID0+IHJvb21JZH0gYm9yZGVyPXtmYWxzZX0+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiUm9vbSBJRDogJShyb29tSWQpc1wiLCB7IHJvb21JZCB9KSB9XG4gICAgICAgICAgICAgICAgICAgIDwvQ29weWFibGVUZXh0PlxuICAgICAgICAgICAgICAgICAgICA8Q29weWFibGVUZXh0IGdldFRleHRUb0NvcHk9eygpID0+IGV2ZW50SWR9IGJvcmRlcj17ZmFsc2V9PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkV2ZW50IElEOiAlKGV2ZW50SWQpc1wiLCB7IGV2ZW50SWQgfSkgfVxuICAgICAgICAgICAgICAgICAgICA8L0NvcHlhYmxlVGV4dD5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICB7IGlzRWRpdGluZyA/IHRoaXMuZWRpdFNvdXJjZUNvbnRlbnQoKSA6IHRoaXMudmlld1NvdXJjZUNvbnRlbnQoKSB9XG4gICAgICAgICAgICAgICAgeyAhaXNFZGl0aW5nICYmIGNhbkVkaXQgJiYgKFxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0RpYWxvZ19idXR0b25zXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIG9uQ2xpY2s9eygpID0+IHRoaXMub25FZGl0KCl9PnsgX3QoXCJFZGl0XCIpIH08L2J1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgKSB9XG4gICAgICAgICAgICA8L0Jhc2VEaWFsb2c+XG4gICAgICAgICk7XG4gICAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWtCQTs7QUFHQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUEvQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQXlCZSxNQUFNQSxVQUFOLFNBQXlCQyxjQUFBLENBQU1DLFNBQS9CLENBQXlEO0VBQ3BFQyxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7SUFDdkIsTUFBTUEsS0FBTjtJQUR1Qiw4Q0FRVixNQUFZO01BQ3pCO01BQ0EsS0FBS0MsUUFBTCxDQUFjO1FBQUVDLFNBQVMsRUFBRTtNQUFiLENBQWQ7SUFDSCxDQVgwQjtJQUd2QixLQUFLQyxLQUFMLEdBQWE7TUFDVEQsU0FBUyxFQUFFO0lBREYsQ0FBYjtFQUdIOztFQU9PRSxNQUFNLEdBQVM7SUFDbkIsS0FBS0gsUUFBTCxDQUFjO01BQUVDLFNBQVMsRUFBRTtJQUFiLENBQWQ7RUFDSCxDQWhCbUUsQ0FrQnBFOzs7RUFDUUcsaUJBQWlCLEdBQWdCO0lBQ3JDLE1BQU1DLE9BQU8sR0FBRyxLQUFLTixLQUFMLENBQVdNLE9BQVgsQ0FBbUJDLGNBQW5CLE1BQXVDLEtBQUtQLEtBQUwsQ0FBV00sT0FBbEUsQ0FEcUMsQ0FDc0M7O0lBQzNFLE1BQU1FLFdBQVcsR0FBR0YsT0FBTyxDQUFDRSxXQUFSLEVBQXBCLENBRnFD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