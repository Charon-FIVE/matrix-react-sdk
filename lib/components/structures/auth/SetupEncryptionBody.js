"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _logger = require("matrix-js-sdk/src/logger");

var _languageHandler = require("../../../languageHandler");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _VerificationRequestDialog = _interopRequireDefault(require("../../views/dialogs/VerificationRequestDialog"));

var _SetupEncryptionStore = require("../../../stores/SetupEncryptionStore");

var _EncryptionPanel = _interopRequireDefault(require("../../views/right_panel/EncryptionPanel"));

var _AccessibleButton = _interopRequireDefault(require("../../views/elements/AccessibleButton"));

var _Spinner = _interopRequireDefault(require("../../views/elements/Spinner"));

/*
Copyright 2020-2021 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
function keyHasPassphrase(keyInfo) {
  return Boolean(keyInfo.passphrase && keyInfo.passphrase.salt && keyInfo.passphrase.iterations);
}

class SetupEncryptionBody extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onStoreUpdate", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      if (store.phase === _SetupEncryptionStore.Phase.Finished) {
        this.props.onFinished();
        return;
      }

      this.setState({
        phase: store.phase,
        verificationRequest: store.verificationRequest,
        backupInfo: store.backupInfo,
        lostKeys: store.lostKeys()
      });
    });
    (0, _defineProperty2.default)(this, "onUsePassphraseClick", async () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.usePassPhrase();
    });
    (0, _defineProperty2.default)(this, "onVerifyClick", () => {
      const cli = _MatrixClientPeg.MatrixClientPeg.get();

      const userId = cli.getUserId();
      const requestPromise = cli.requestVerification(userId); // We need to call onFinished now to close this dialog, and
      // again later to signal that the verification is complete.

      this.props.onFinished();

      _Modal.default.createDialog(_VerificationRequestDialog.default, {
        verificationRequestPromise: requestPromise,
        member: cli.getUser(userId),
        onFinished: async () => {
          const request = await requestPromise;
          request.cancel();
          this.props.onFinished();
        }
      });
    });
    (0, _defineProperty2.default)(this, "onSkipConfirmClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.skipConfirm();
    });
    (0, _defineProperty2.default)(this, "onSkipBackClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.returnAfterSkip();
    });
    (0, _defineProperty2.default)(this, "onResetClick", ev => {
      ev.preventDefault();

      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.reset();
    });
    (0, _defineProperty2.default)(this, "onResetConfirmClick", () => {
      this.props.onFinished();

      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.resetConfirm();
    });
    (0, _defineProperty2.default)(this, "onResetBackClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.returnAfterReset();
    });
    (0, _defineProperty2.default)(this, "onDoneClick", () => {
      const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

      store.done();
    });
    (0, _defineProperty2.default)(this, "onEncryptionPanelClose", () => {
      this.props.onFinished();
    });

    const _store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

    _store.on("update", this.onStoreUpdate);

    _store.start();

    this.state = {
      phase: _store.phase,
      // this serves dual purpose as the object for the request logic and
      // the presence of it indicating that we're in 'verify mode'.
      // Because of the latter, it lives in the state.
      verificationRequest: _store.verificationRequest,
      backupInfo: _store.backupInfo,
      lostKeys: _store.lostKeys()
    };
  }

  componentWillUnmount() {
    const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

    store.off("update", this.onStoreUpdate);
    store.stop();
  }

  render() {
    const {
      phase,
      lostKeys
    } = this.state;

    if (this.state.verificationRequest) {
      return /*#__PURE__*/_react.default.createElement(_EncryptionPanel.default, {
        layout: "dialog",
        verificationRequest: this.state.verificationRequest,
        onClose: this.onEncryptionPanelClose,
        member: _MatrixClientPeg.MatrixClientPeg.get().getUser(this.state.verificationRequest.otherUserId),
        isRoomEncrypted: false
      });
    } else if (phase === _SetupEncryptionStore.Phase.Intro) {
      if (lostKeys) {
        return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("It looks like you don't have a Security Key or any other devices you can " + "verify against.  This device will not be able to access old encrypted messages. " + "In order to verify your identity on this device, you'll need to reset " + "your verification keys.")), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CompleteSecurity_actionRow"
        }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
          kind: "primary",
          onClick: this.onResetConfirmClick
        }, (0, _languageHandler._t)("Proceed with reset"))));
      } else {
        const store = _SetupEncryptionStore.SetupEncryptionStore.sharedInstance();

        let recoveryKeyPrompt;

        if (store.keyInfo && keyHasPassphrase(store.keyInfo)) {
          recoveryKeyPrompt = (0, _languageHandler._t)("Verify with Security Key or Phrase");
        } else if (store.keyInfo) {
          recoveryKeyPrompt = (0, _languageHandler._t)("Verify with Security Key");
        }

        let useRecoveryKeyButton;

        if (recoveryKeyPrompt) {
          useRecoveryKeyButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
            kind: "primary",
            onClick: this.onUsePassphraseClick
          }, recoveryKeyPrompt);
        }

        let verifyButton;

        if (store.hasDevicesToVerifyAgainst) {
          verifyButton = /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
            kind: "primary",
            onClick: this.onVerifyClick
          }, (0, _languageHandler._t)("Verify with another device"));
        }

        return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Verify your identity to access encrypted messages and prove your identity to others.")), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_CompleteSecurity_actionRow"
        }, verifyButton, useRecoveryKeyButton), /*#__PURE__*/_react.default.createElement("div", {
          className: "mx_SetupEncryptionBody_reset"
        }, (0, _languageHandler._t)("Forgotten or lost all recovery methods? <a>Reset all</a>", null, {
          a: sub => /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
            kind: "link_inline",
            className: "mx_SetupEncryptionBody_reset_link",
            onClick: this.onResetClick
          }, sub)
        })));
      }
    } else if (phase === _SetupEncryptionStore.Phase.Done) {
      let message;

      if (this.state.backupInfo) {
        message = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your new device is now verified. It has access to your " + "encrypted messages, and other users will see it as trusted."));
      } else {
        message = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your new device is now verified. Other users will see it as trusted."));
      }

      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"
      }), message, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_actionRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onDoneClick
      }, (0, _languageHandler._t)("Done"))));
    } else if (phase === _SetupEncryptionStore.Phase.ConfirmSkip) {
      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Without verifying, you won't have access to all your messages " + "and may appear as untrusted to others.")), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_actionRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "danger_outline",
        onClick: this.onSkipConfirmClick
      }, (0, _languageHandler._t)("I'll verify later")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onSkipBackClick
      }, (0, _languageHandler._t)("Go Back"))));
    } else if (phase === _SetupEncryptionStore.Phase.ConfirmReset) {
      return /*#__PURE__*/_react.default.createElement("div", null, /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Resetting your verification keys cannot be undone. After resetting, " + "you won't have access to old encrypted messages, and any friends who " + "have previously verified you will see security warnings until you " + "re-verify with them.")), /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Please only proceed if you're sure you've lost all of your other " + "devices and your security key.")), /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CompleteSecurity_actionRow"
      }, /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "danger_outline",
        onClick: this.onResetConfirmClick
      }, (0, _languageHandler._t)("Proceed with reset")), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        kind: "primary",
        onClick: this.onResetBackClick
      }, (0, _languageHandler._t)("Go Back"))));
    } else if (phase === _SetupEncryptionStore.Phase.Busy || phase === _SetupEncryptionStore.Phase.Loading) {
      return /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else {
      _logger.logger.log(`SetupEncryptionBody: Unknown phase ${phase}`);
    }
  }

}

exports.default = SetupEncryptionBody;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJrZXlIYXNQYXNzcGhyYXNlIiwia2V5SW5mbyIsIkJvb2xlYW4iLCJwYXNzcGhyYXNlIiwic2FsdCIsIml0ZXJhdGlvbnMiLCJTZXR1cEVuY3J5cHRpb25Cb2R5IiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic3RvcmUiLCJTZXR1cEVuY3J5cHRpb25TdG9yZSIsInNoYXJlZEluc3RhbmNlIiwicGhhc2UiLCJQaGFzZSIsIkZpbmlzaGVkIiwib25GaW5pc2hlZCIsInNldFN0YXRlIiwidmVyaWZpY2F0aW9uUmVxdWVzdCIsImJhY2t1cEluZm8iLCJsb3N0S2V5cyIsInVzZVBhc3NQaHJhc2UiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJ1c2VySWQiLCJnZXRVc2VySWQiLCJyZXF1ZXN0UHJvbWlzZSIsInJlcXVlc3RWZXJpZmljYXRpb24iLCJNb2RhbCIsImNyZWF0ZURpYWxvZyIsIlZlcmlmaWNhdGlvblJlcXVlc3REaWFsb2ciLCJ2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZSIsIm1lbWJlciIsImdldFVzZXIiLCJyZXF1ZXN0IiwiY2FuY2VsIiwic2tpcENvbmZpcm0iLCJyZXR1cm5BZnRlclNraXAiLCJldiIsInByZXZlbnREZWZhdWx0IiwicmVzZXQiLCJyZXNldENvbmZpcm0iLCJyZXR1cm5BZnRlclJlc2V0IiwiZG9uZSIsIm9uIiwib25TdG9yZVVwZGF0ZSIsInN0YXJ0Iiwic3RhdGUiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsIm9mZiIsInN0b3AiLCJyZW5kZXIiLCJvbkVuY3J5cHRpb25QYW5lbENsb3NlIiwib3RoZXJVc2VySWQiLCJJbnRybyIsIl90Iiwib25SZXNldENvbmZpcm1DbGljayIsInJlY292ZXJ5S2V5UHJvbXB0IiwidXNlUmVjb3ZlcnlLZXlCdXR0b24iLCJvblVzZVBhc3NwaHJhc2VDbGljayIsInZlcmlmeUJ1dHRvbiIsImhhc0RldmljZXNUb1ZlcmlmeUFnYWluc3QiLCJvblZlcmlmeUNsaWNrIiwiYSIsInN1YiIsIm9uUmVzZXRDbGljayIsIkRvbmUiLCJtZXNzYWdlIiwib25Eb25lQ2xpY2siLCJDb25maXJtU2tpcCIsIm9uU2tpcENvbmZpcm1DbGljayIsIm9uU2tpcEJhY2tDbGljayIsIkNvbmZpcm1SZXNldCIsIm9uUmVzZXRCYWNrQ2xpY2siLCJCdXN5IiwiTG9hZGluZyIsImxvZ2dlciIsImxvZyJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3N0cnVjdHVyZXMvYXV0aC9TZXR1cEVuY3J5cHRpb25Cb2R5LnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMjAtMjAyMSBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBJU2VjcmV0U3RvcmFnZUtleUluZm8gfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9jcnlwdG8vYXBpJztcbmltcG9ydCB7IElLZXlCYWNrdXBJbmZvIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NyeXB0by9rZXliYWNrdXBcIjtcbmltcG9ydCB7IFZlcmlmaWNhdGlvblJlcXVlc3QgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvL3ZlcmlmaWNhdGlvbi9yZXF1ZXN0L1ZlcmlmaWNhdGlvblJlcXVlc3RcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9sb2dnZXJcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSAnLi4vLi4vLi4vTWF0cml4Q2xpZW50UGVnJztcbmltcG9ydCBNb2RhbCBmcm9tICcuLi8uLi8uLi9Nb2RhbCc7XG5pbXBvcnQgVmVyaWZpY2F0aW9uUmVxdWVzdERpYWxvZyBmcm9tICcuLi8uLi92aWV3cy9kaWFsb2dzL1ZlcmlmaWNhdGlvblJlcXVlc3REaWFsb2cnO1xuaW1wb3J0IHsgU2V0dXBFbmNyeXB0aW9uU3RvcmUsIFBoYXNlIH0gZnJvbSAnLi4vLi4vLi4vc3RvcmVzL1NldHVwRW5jcnlwdGlvblN0b3JlJztcbmltcG9ydCBFbmNyeXB0aW9uUGFuZWwgZnJvbSBcIi4uLy4uL3ZpZXdzL3JpZ2h0X3BhbmVsL0VuY3J5cHRpb25QYW5lbFwiO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vLi4vdmlld3MvZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgU3Bpbm5lciBmcm9tICcuLi8uLi92aWV3cy9lbGVtZW50cy9TcGlubmVyJztcblxuZnVuY3Rpb24ga2V5SGFzUGFzc3BocmFzZShrZXlJbmZvOiBJU2VjcmV0U3RvcmFnZUtleUluZm8pOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbihcbiAgICAgICAga2V5SW5mby5wYXNzcGhyYXNlICYmXG4gICAgICAgIGtleUluZm8ucGFzc3BocmFzZS5zYWx0ICYmXG4gICAgICAgIGtleUluZm8ucGFzc3BocmFzZS5pdGVyYXRpb25zLFxuICAgICk7XG59XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIG9uRmluaXNoZWQ6ICgpID0+IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJU3RhdGUge1xuICAgIHBoYXNlOiBQaGFzZTtcbiAgICB2ZXJpZmljYXRpb25SZXF1ZXN0OiBWZXJpZmljYXRpb25SZXF1ZXN0O1xuICAgIGJhY2t1cEluZm86IElLZXlCYWNrdXBJbmZvO1xuICAgIGxvc3RLZXlzOiBib29sZWFuO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTZXR1cEVuY3J5cHRpb25Cb2R5IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICBjb25zdCBzdG9yZSA9IFNldHVwRW5jcnlwdGlvblN0b3JlLnNoYXJlZEluc3RhbmNlKCk7XG4gICAgICAgIHN0b3JlLm9uKFwidXBkYXRlXCIsIHRoaXMub25TdG9yZVVwZGF0ZSk7XG4gICAgICAgIHN0b3JlLnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAgICAgICBwaGFzZTogc3RvcmUucGhhc2UsXG4gICAgICAgICAgICAvLyB0aGlzIHNlcnZlcyBkdWFsIHB1cnBvc2UgYXMgdGhlIG9iamVjdCBmb3IgdGhlIHJlcXVlc3QgbG9naWMgYW5kXG4gICAgICAgICAgICAvLyB0aGUgcHJlc2VuY2Ugb2YgaXQgaW5kaWNhdGluZyB0aGF0IHdlJ3JlIGluICd2ZXJpZnkgbW9kZScuXG4gICAgICAgICAgICAvLyBCZWNhdXNlIG9mIHRoZSBsYXR0ZXIsIGl0IGxpdmVzIGluIHRoZSBzdGF0ZS5cbiAgICAgICAgICAgIHZlcmlmaWNhdGlvblJlcXVlc3Q6IHN0b3JlLnZlcmlmaWNhdGlvblJlcXVlc3QsXG4gICAgICAgICAgICBiYWNrdXBJbmZvOiBzdG9yZS5iYWNrdXBJbmZvLFxuICAgICAgICAgICAgbG9zdEtleXM6IHN0b3JlLmxvc3RLZXlzKCksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblN0b3JlVXBkYXRlID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBzdG9yZSA9IFNldHVwRW5jcnlwdGlvblN0b3JlLnNoYXJlZEluc3RhbmNlKCk7XG4gICAgICAgIGlmIChzdG9yZS5waGFzZSA9PT0gUGhhc2UuRmluaXNoZWQpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgcGhhc2U6IHN0b3JlLnBoYXNlLFxuICAgICAgICAgICAgdmVyaWZpY2F0aW9uUmVxdWVzdDogc3RvcmUudmVyaWZpY2F0aW9uUmVxdWVzdCxcbiAgICAgICAgICAgIGJhY2t1cEluZm86IHN0b3JlLmJhY2t1cEluZm8sXG4gICAgICAgICAgICBsb3N0S2V5czogc3RvcmUubG9zdEtleXMoKSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgICAgY29uc3Qgc3RvcmUgPSBTZXR1cEVuY3J5cHRpb25TdG9yZS5zaGFyZWRJbnN0YW5jZSgpO1xuICAgICAgICBzdG9yZS5vZmYoXCJ1cGRhdGVcIiwgdGhpcy5vblN0b3JlVXBkYXRlKTtcbiAgICAgICAgc3RvcmUuc3RvcCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Vc2VQYXNzcGhyYXNlQ2xpY2sgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUudXNlUGFzc1BocmFzZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVmVyaWZ5Q2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3QgdXNlcklkID0gY2xpLmdldFVzZXJJZCgpO1xuICAgICAgICBjb25zdCByZXF1ZXN0UHJvbWlzZSA9IGNsaS5yZXF1ZXN0VmVyaWZpY2F0aW9uKHVzZXJJZCk7XG5cbiAgICAgICAgLy8gV2UgbmVlZCB0byBjYWxsIG9uRmluaXNoZWQgbm93IHRvIGNsb3NlIHRoaXMgZGlhbG9nLCBhbmRcbiAgICAgICAgLy8gYWdhaW4gbGF0ZXIgdG8gc2lnbmFsIHRoYXQgdGhlIHZlcmlmaWNhdGlvbiBpcyBjb21wbGV0ZS5cbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhWZXJpZmljYXRpb25SZXF1ZXN0RGlhbG9nLCB7XG4gICAgICAgICAgICB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZTogcmVxdWVzdFByb21pc2UsXG4gICAgICAgICAgICBtZW1iZXI6IGNsaS5nZXRVc2VyKHVzZXJJZCksXG4gICAgICAgICAgICBvbkZpbmlzaGVkOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IHJlcXVlc3RQcm9taXNlO1xuICAgICAgICAgICAgICAgIHJlcXVlc3QuY2FuY2VsKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNraXBDb25maXJtQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUuc2tpcENvbmZpcm0oKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvblNraXBCYWNrQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUucmV0dXJuQWZ0ZXJTa2lwKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNldENsaWNrID0gKGV2OiBSZWFjdC5Nb3VzZUV2ZW50PEhUTUxCdXR0b25FbGVtZW50PikgPT4ge1xuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBjb25zdCBzdG9yZSA9IFNldHVwRW5jcnlwdGlvblN0b3JlLnNoYXJlZEluc3RhbmNlKCk7XG4gICAgICAgIHN0b3JlLnJlc2V0KCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNldENvbmZpcm1DbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKCk7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUucmVzZXRDb25maXJtKCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25SZXNldEJhY2tDbGljayA9ICgpID0+IHtcbiAgICAgICAgY29uc3Qgc3RvcmUgPSBTZXR1cEVuY3J5cHRpb25TdG9yZS5zaGFyZWRJbnN0YW5jZSgpO1xuICAgICAgICBzdG9yZS5yZXR1cm5BZnRlclJlc2V0KCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Eb25lQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgc3RvcmUuZG9uZSgpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRW5jcnlwdGlvblBhbmVsQ2xvc2UgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZCgpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBwaGFzZSxcbiAgICAgICAgICAgIGxvc3RLZXlzLFxuICAgICAgICB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBpZiAodGhpcy5zdGF0ZS52ZXJpZmljYXRpb25SZXF1ZXN0KSB7XG4gICAgICAgICAgICByZXR1cm4gPEVuY3J5cHRpb25QYW5lbFxuICAgICAgICAgICAgICAgIGxheW91dD1cImRpYWxvZ1wiXG4gICAgICAgICAgICAgICAgdmVyaWZpY2F0aW9uUmVxdWVzdD17dGhpcy5zdGF0ZS52ZXJpZmljYXRpb25SZXF1ZXN0fVxuICAgICAgICAgICAgICAgIG9uQ2xvc2U9e3RoaXMub25FbmNyeXB0aW9uUGFuZWxDbG9zZX1cbiAgICAgICAgICAgICAgICBtZW1iZXI9e01hdHJpeENsaWVudFBlZy5nZXQoKS5nZXRVc2VyKHRoaXMuc3RhdGUudmVyaWZpY2F0aW9uUmVxdWVzdC5vdGhlclVzZXJJZCl9XG4gICAgICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkPXtmYWxzZX1cbiAgICAgICAgICAgIC8+O1xuICAgICAgICB9IGVsc2UgaWYgKHBoYXNlID09PSBQaGFzZS5JbnRybykge1xuICAgICAgICAgICAgaWYgKGxvc3RLZXlzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJJdCBsb29rcyBsaWtlIHlvdSBkb24ndCBoYXZlIGEgU2VjdXJpdHkgS2V5IG9yIGFueSBvdGhlciBkZXZpY2VzIHlvdSBjYW4gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwidmVyaWZ5IGFnYWluc3QuICBUaGlzIGRldmljZSB3aWxsIG5vdCBiZSBhYmxlIHRvIGFjY2VzcyBvbGQgZW5jcnlwdGVkIG1lc3NhZ2VzLiBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJJbiBvcmRlciB0byB2ZXJpZnkgeW91ciBpZGVudGl0eSBvbiB0aGlzIGRldmljZSwgeW91J2xsIG5lZWQgdG8gcmVzZXQgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwieW91ciB2ZXJpZmljYXRpb24ga2V5cy5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICkgfTwvcD5cblxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Db21wbGV0ZVNlY3VyaXR5X2FjdGlvblJvd1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJwcmltYXJ5XCIgb25DbGljaz17dGhpcy5vblJlc2V0Q29uZmlybUNsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlByb2NlZWQgd2l0aCByZXNldFwiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gU2V0dXBFbmNyeXB0aW9uU3RvcmUuc2hhcmVkSW5zdGFuY2UoKTtcbiAgICAgICAgICAgICAgICBsZXQgcmVjb3ZlcnlLZXlQcm9tcHQ7XG4gICAgICAgICAgICAgICAgaWYgKHN0b3JlLmtleUluZm8gJiYga2V5SGFzUGFzc3BocmFzZShzdG9yZS5rZXlJbmZvKSkge1xuICAgICAgICAgICAgICAgICAgICByZWNvdmVyeUtleVByb21wdCA9IF90KFwiVmVyaWZ5IHdpdGggU2VjdXJpdHkgS2V5IG9yIFBocmFzZVwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0b3JlLmtleUluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVjb3ZlcnlLZXlQcm9tcHQgPSBfdChcIlZlcmlmeSB3aXRoIFNlY3VyaXR5IEtleVwiKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgdXNlUmVjb3ZlcnlLZXlCdXR0b247XG4gICAgICAgICAgICAgICAgaWYgKHJlY292ZXJ5S2V5UHJvbXB0KSB7XG4gICAgICAgICAgICAgICAgICAgIHVzZVJlY292ZXJ5S2V5QnV0dG9uID0gPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlcIiBvbkNsaWNrPXt0aGlzLm9uVXNlUGFzc3BocmFzZUNsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHsgcmVjb3ZlcnlLZXlQcm9tcHQgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCB2ZXJpZnlCdXR0b247XG4gICAgICAgICAgICAgICAgaWYgKHN0b3JlLmhhc0RldmljZXNUb1ZlcmlmeUFnYWluc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmVyaWZ5QnV0dG9uID0gPEFjY2Vzc2libGVCdXR0b24ga2luZD1cInByaW1hcnlcIiBvbkNsaWNrPXt0aGlzLm9uVmVyaWZ5Q2xpY2t9PlxuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIlZlcmlmeSB3aXRoIGFub3RoZXIgZGV2aWNlXCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICAgICAgPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZlcmlmeSB5b3VyIGlkZW50aXR5IHRvIGFjY2VzcyBlbmNyeXB0ZWQgbWVzc2FnZXMgYW5kIHByb3ZlIHlvdXIgaWRlbnRpdHkgdG8gb3RoZXJzLlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgKSB9PC9wPlxuXG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NvbXBsZXRlU2VjdXJpdHlfYWN0aW9uUm93XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB2ZXJpZnlCdXR0b24gfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdXNlUmVjb3ZlcnlLZXlCdXR0b24gfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X1NldHVwRW5jcnlwdGlvbkJvZHlfcmVzZXRcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiRm9yZ290dGVuIG9yIGxvc3QgYWxsIHJlY292ZXJ5IG1ldGhvZHM/IDxhPlJlc2V0IGFsbDwvYT5cIiwgbnVsbCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhOiAoc3ViKSA9PiA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImxpbmtfaW5saW5lXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X1NldHVwRW5jcnlwdGlvbkJvZHlfcmVzZXRfbGlua1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uUmVzZXRDbGlja31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBzdWIgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHBoYXNlID09PSBQaGFzZS5Eb25lKSB7XG4gICAgICAgICAgICBsZXQgbWVzc2FnZTtcbiAgICAgICAgICAgIGlmICh0aGlzLnN0YXRlLmJhY2t1cEluZm8pIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlID0gPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgXCJZb3VyIG5ldyBkZXZpY2UgaXMgbm93IHZlcmlmaWVkLiBJdCBoYXMgYWNjZXNzIHRvIHlvdXIgXCIgK1xuICAgICAgICAgICAgICAgICAgICBcImVuY3J5cHRlZCBtZXNzYWdlcywgYW5kIG90aGVyIHVzZXJzIHdpbGwgc2VlIGl0IGFzIHRydXN0ZWQuXCIsXG4gICAgICAgICAgICAgICAgKSB9PC9wPjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9IDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgIFwiWW91ciBuZXcgZGV2aWNlIGlzIG5vdyB2ZXJpZmllZC4gT3RoZXIgdXNlcnMgd2lsbCBzZWUgaXQgYXMgdHJ1c3RlZC5cIixcbiAgICAgICAgICAgICAgICApIH08L3A+O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0NvbXBsZXRlU2VjdXJpdHlfaGVyb0ljb24gbXhfRTJFSWNvbl92ZXJpZmllZFwiIC8+XG4gICAgICAgICAgICAgICAgICAgIHsgbWVzc2FnZSB9XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ29tcGxldGVTZWN1cml0eV9hY3Rpb25Sb3dcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cInByaW1hcnlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMub25Eb25lQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkRvbmVcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAocGhhc2UgPT09IFBoYXNlLkNvbmZpcm1Ta2lwKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIDxwPnsgX3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIldpdGhvdXQgdmVyaWZ5aW5nLCB5b3Ugd29uJ3QgaGF2ZSBhY2Nlc3MgdG8gYWxsIHlvdXIgbWVzc2FnZXMgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJhbmQgbWF5IGFwcGVhciBhcyB1bnRydXN0ZWQgdG8gb3RoZXJzLlwiLFxuICAgICAgICAgICAgICAgICAgICApIH08L3A+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibXhfQ29tcGxldGVTZWN1cml0eV9hY3Rpb25Sb3dcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD1cImRhbmdlcl9vdXRsaW5lXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLm9uU2tpcENvbmZpcm1DbGlja31cbiAgICAgICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiSSdsbCB2ZXJpZnkgbGF0ZXJcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBraW5kPVwicHJpbWFyeVwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5vblNraXBCYWNrQ2xpY2t9XG4gICAgICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyBfdChcIkdvIEJhY2tcIikgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAocGhhc2UgPT09IFBoYXNlLkNvbmZpcm1SZXNldCkge1xuICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgICAgICAgICA8cD57IF90KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJSZXNldHRpbmcgeW91ciB2ZXJpZmljYXRpb24ga2V5cyBjYW5ub3QgYmUgdW5kb25lLiBBZnRlciByZXNldHRpbmcsIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwieW91IHdvbid0IGhhdmUgYWNjZXNzIHRvIG9sZCBlbmNyeXB0ZWQgbWVzc2FnZXMsIGFuZCBhbnkgZnJpZW5kcyB3aG8gXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJoYXZlIHByZXZpb3VzbHkgdmVyaWZpZWQgeW91IHdpbGwgc2VlIHNlY3VyaXR5IHdhcm5pbmdzIHVudGlsIHlvdSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICBcInJlLXZlcmlmeSB3aXRoIHRoZW0uXCIsXG4gICAgICAgICAgICAgICAgICAgICkgfTwvcD5cbiAgICAgICAgICAgICAgICAgICAgPHA+eyBfdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiUGxlYXNlIG9ubHkgcHJvY2VlZCBpZiB5b3UncmUgc3VyZSB5b3UndmUgbG9zdCBhbGwgb2YgeW91ciBvdGhlciBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICBcImRldmljZXMgYW5kIHlvdXIgc2VjdXJpdHkga2V5LlwiLFxuICAgICAgICAgICAgICAgICAgICApIH08L3A+XG5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJteF9Db21wbGV0ZVNlY3VyaXR5X2FjdGlvblJvd1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24ga2luZD1cImRhbmdlcl9vdXRsaW5lXCIgb25DbGljaz17dGhpcy5vblJlc2V0Q29uZmlybUNsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiUHJvY2VlZCB3aXRoIHJlc2V0XCIpIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtpbmQ9XCJwcmltYXJ5XCIgb25DbGljaz17dGhpcy5vblJlc2V0QmFja0NsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiR28gQmFja1wiKSB9XG4gICAgICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChwaGFzZSA9PT0gUGhhc2UuQnVzeSB8fCBwaGFzZSA9PT0gUGhhc2UuTG9hZGluZykge1xuICAgICAgICAgICAgcmV0dXJuIDxTcGlubmVyIC8+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nZ2VyLmxvZyhgU2V0dXBFbmNyeXB0aW9uQm9keTogVW5rbm93biBwaGFzZSAke3BoYXNlfWApO1xuICAgICAgICB9XG4gICAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQWdCQTs7QUFJQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUE3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBaUJBLFNBQVNBLGdCQUFULENBQTBCQyxPQUExQixFQUFtRTtFQUMvRCxPQUFPQyxPQUFPLENBQ1ZELE9BQU8sQ0FBQ0UsVUFBUixJQUNBRixPQUFPLENBQUNFLFVBQVIsQ0FBbUJDLElBRG5CLElBRUFILE9BQU8sQ0FBQ0UsVUFBUixDQUFtQkUsVUFIVCxDQUFkO0FBS0g7O0FBYWMsTUFBTUMsbUJBQU4sU0FBa0NDLGNBQUEsQ0FBTUMsU0FBeEMsQ0FBa0U7RUFDN0VDLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0lBQ2YsTUFBTUEsS0FBTjtJQURlLHFEQWdCSyxNQUFNO01BQzFCLE1BQU1DLEtBQUssR0FBR0MsMENBQUEsQ0FBcUJDLGNBQXJCLEVBQWQ7O01BQ0EsSUFBSUYsS0FBSyxDQUFDRyxLQUFOLEtBQWdCQywyQkFBQSxDQUFNQyxRQUExQixFQUFvQztRQUNoQyxLQUFLTixLQUFMLENBQVdPLFVBQVg7UUFDQTtNQUNIOztNQUNELEtBQUtDLFFBQUwsQ0FBYztRQUNWSixLQUFLLEVBQUVILEtBQUssQ0FBQ0csS0FESDtRQUVWSyxtQkFBbUIsRUFBRVIsS0FBSyxDQUFDUSxtQkFGakI7UUFHVkMsVUFBVSxFQUFFVCxLQUFLLENBQUNTLFVBSFI7UUFJVkMsUUFBUSxFQUFFVixLQUFLLENBQUNVLFFBQU47TUFKQSxDQUFkO0lBTUgsQ0E1QmtCO0lBQUEsNERBb0NZLFlBQVk7TUFDdkMsTUFBTVYsS0FBSyxHQUFHQywwQ0FBQSxDQUFx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