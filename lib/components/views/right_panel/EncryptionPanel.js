"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _VerificationRequest = require("matrix-js-sdk/src/crypto/verification/request/VerificationRequest");

var _EncryptionInfo = _interopRequireDefault(require("./EncryptionInfo"));

var _VerificationPanel = _interopRequireDefault(require("./VerificationPanel"));

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _createRoom = require("../../../createRoom");

var _useEventEmitter = require("../../../hooks/useEventEmitter");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _languageHandler = require("../../../languageHandler");

var _RightPanelStorePhases = require("../../../stores/right-panel/RightPanelStorePhases");

var _RightPanelStore = _interopRequireDefault(require("../../../stores/right-panel/RightPanelStore"));

var _ErrorDialog = _interopRequireDefault(require("../dialogs/ErrorDialog"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
// cancellation codes which constitute a key mismatch
const MISMATCHES = ["m.key_mismatch", "m.user_error", "m.mismatched_sas"];

const EncryptionPanel = props => {
  const {
    verificationRequest,
    verificationRequestPromise,
    member,
    onClose,
    layout,
    isRoomEncrypted
  } = props;
  const [request, setRequest] = (0, _react.useState)(verificationRequest); // state to show a spinner immediately after clicking "start verification",
  // before we have a request

  const [isRequesting, setRequesting] = (0, _react.useState)(false);
  const [phase, setPhase] = (0, _react.useState)(request?.phase);
  (0, _react.useEffect)(() => {
    setRequest(verificationRequest);

    if (verificationRequest) {
      setRequesting(false);
      setPhase(verificationRequest.phase);
    }
  }, [verificationRequest]);
  (0, _react.useEffect)(() => {
    async function awaitPromise() {
      setRequesting(true);
      const requestFromPromise = await verificationRequestPromise;
      setRequesting(false);
      setRequest(requestFromPromise);
      setPhase(requestFromPromise.phase);
    }

    if (verificationRequestPromise) {
      awaitPromise();
    }
  }, [verificationRequestPromise]);
  const changeHandler = (0, _react.useCallback)(() => {
    // handle transitions -> cancelled for mismatches which fire a modal instead of showing a card
    if (request && request.cancelled && MISMATCHES.includes(request.cancellationCode)) {
      _Modal.default.createDialog(_ErrorDialog.default, {
        headerImage: require("../../../../res/img/e2e/warning-deprecated.svg").default,
        title: (0, _languageHandler._t)("Your messages are not secure"),
        description: /*#__PURE__*/_react.default.createElement("div", null, (0, _languageHandler._t)("One of the following may be compromised:"), /*#__PURE__*/_react.default.createElement("ul", null, /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Your homeserver")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("The homeserver the user you're verifying is connected to")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Yours, or the other users' internet connection")), /*#__PURE__*/_react.default.createElement("li", null, (0, _languageHandler._t)("Yours, or the other users' session")))),
        onFinished: onClose
      });

      return; // don't update phase here as we will be transitioning away from this view shortly
    }

    if (request) {
      setPhase(request.phase);
    }
  }, [onClose, request]);
  (0, _useEventEmitter.useTypedEventEmitter)(request, _VerificationRequest.VerificationRequestEvent.Change, changeHandler);
  const onStartVerification = (0, _react.useCallback)(async () => {
    setRequesting(true);

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const roomId = await (0, _createRoom.ensureDMExists)(cli, member.userId);
    const verificationRequest_ = await cli.requestVerificationDM(member.userId, roomId);
    setRequest(verificationRequest_);
    setPhase(verificationRequest_.phase); // Notify the RightPanelStore about this

    if (_RightPanelStore.default.instance.currentCard.phase != _RightPanelStorePhases.RightPanelPhases.EncryptionPanel) {
      _RightPanelStore.default.instance.pushCard({
        phase: _RightPanelStorePhases.RightPanelPhases.EncryptionPanel,
        state: {
          member,
          verificationRequest: verificationRequest_
        }
      });
    }

    if (!_RightPanelStore.default.instance.isOpen) _RightPanelStore.default.instance.togglePanel(null);
  }, [member]);
  const requested = !request && isRequesting || request && (phase === _VerificationRequest.PHASE_REQUESTED || phase === _VerificationRequest.PHASE_UNSENT || phase === undefined);
  const isSelfVerification = request ? request.isSelfVerification : member.userId === _MatrixClientPeg.MatrixClientPeg.get().getUserId();

  if (!request || requested) {
    const initiatedByMe = !request && isRequesting || request && request.initiatedByMe;
    return /*#__PURE__*/_react.default.createElement(_EncryptionInfo.default, {
      isRoomEncrypted: isRoomEncrypted,
      onStartVerification: onStartVerification,
      member: member,
      isSelfVerification: isSelfVerification,
      waitingForOtherParty: requested && initiatedByMe,
      waitingForNetwork: requested && !initiatedByMe,
      inDialog: layout === "dialog"
    });
  } else {
    return /*#__PURE__*/_react.default.createElement(_VerificationPanel.default, {
      isRoomEncrypted: isRoomEncrypted,
      layout: layout,
      onClose: onClose,
      member: member,
      request: request,
      key: request.channel.transactionId,
      inDialog: layout === "dialog",
      phase: phase
    });
  }
};

var _default = EncryptionPanel;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNSVNNQVRDSEVTIiwiRW5jcnlwdGlvblBhbmVsIiwicHJvcHMiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0IiwidmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UiLCJtZW1iZXIiLCJvbkNsb3NlIiwibGF5b3V0IiwiaXNSb29tRW5jcnlwdGVkIiwicmVxdWVzdCIsInNldFJlcXVlc3QiLCJ1c2VTdGF0ZSIsImlzUmVxdWVzdGluZyIsInNldFJlcXVlc3RpbmciLCJwaGFzZSIsInNldFBoYXNlIiwidXNlRWZmZWN0IiwiYXdhaXRQcm9taXNlIiwicmVxdWVzdEZyb21Qcm9taXNlIiwiY2hhbmdlSGFuZGxlciIsInVzZUNhbGxiYWNrIiwiY2FuY2VsbGVkIiwiaW5jbHVkZXMiLCJjYW5jZWxsYXRpb25Db2RlIiwiTW9kYWwiLCJjcmVhdGVEaWFsb2ciLCJFcnJvckRpYWxvZyIsImhlYWRlckltYWdlIiwicmVxdWlyZSIsImRlZmF1bHQiLCJ0aXRsZSIsIl90IiwiZGVzY3JpcHRpb24iLCJvbkZpbmlzaGVkIiwidXNlVHlwZWRFdmVudEVtaXR0ZXIiLCJWZXJpZmljYXRpb25SZXF1ZXN0RXZlbnQiLCJDaGFuZ2UiLCJvblN0YXJ0VmVyaWZpY2F0aW9uIiwiY2xpIiwiTWF0cml4Q2xpZW50UGVnIiwiZ2V0Iiwicm9vbUlkIiwiZW5zdXJlRE1FeGlzdHMiLCJ1c2VySWQiLCJ2ZXJpZmljYXRpb25SZXF1ZXN0XyIsInJlcXVlc3RWZXJpZmljYXRpb25ETSIsIlJpZ2h0UGFuZWxTdG9yZSIsImluc3RhbmNlIiwiY3VycmVudENhcmQiLCJSaWdodFBhbmVsUGhhc2VzIiwicHVzaENhcmQiLCJzdGF0ZSIsImlzT3BlbiIsInRvZ2dsZVBhbmVsIiwicmVxdWVzdGVkIiwiUEhBU0VfUkVRVUVTVEVEIiwiUEhBU0VfVU5TRU5UIiwidW5kZWZpbmVkIiwiaXNTZWxmVmVyaWZpY2F0aW9uIiwiZ2V0VXNlcklkIiwiaW5pdGlhdGVkQnlNZSIsImNoYW5uZWwiLCJ0cmFuc2FjdGlvbklkIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvdmlld3MvcmlnaHRfcGFuZWwvRW5jcnlwdGlvblBhbmVsLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuQ29weXJpZ2h0IDIwMTksIDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgdXNlQ2FsbGJhY2ssIHVzZUVmZmVjdCwgdXNlU3RhdGUgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCB7XG4gICAgUEhBU0VfUkVRVUVTVEVELFxuICAgIFBIQVNFX1VOU0VOVCxcbiAgICBWZXJpZmljYXRpb25SZXF1ZXN0LFxuICAgIFZlcmlmaWNhdGlvblJlcXVlc3RFdmVudCxcbn0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NyeXB0by92ZXJpZmljYXRpb24vcmVxdWVzdC9WZXJpZmljYXRpb25SZXF1ZXN0XCI7XG5pbXBvcnQgeyBSb29tTWVtYmVyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tLW1lbWJlclwiO1xuaW1wb3J0IHsgVXNlciB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvdXNlclwiO1xuXG5pbXBvcnQgRW5jcnlwdGlvbkluZm8gZnJvbSBcIi4vRW5jcnlwdGlvbkluZm9cIjtcbmltcG9ydCBWZXJpZmljYXRpb25QYW5lbCBmcm9tIFwiLi9WZXJpZmljYXRpb25QYW5lbFwiO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50UGVnIH0gZnJvbSBcIi4uLy4uLy4uL01hdHJpeENsaWVudFBlZ1wiO1xuaW1wb3J0IHsgZW5zdXJlRE1FeGlzdHMgfSBmcm9tIFwiLi4vLi4vLi4vY3JlYXRlUm9vbVwiO1xuaW1wb3J0IHsgdXNlVHlwZWRFdmVudEVtaXR0ZXIgfSBmcm9tIFwiLi4vLi4vLi4vaG9va3MvdXNlRXZlbnRFbWl0dGVyXCI7XG5pbXBvcnQgTW9kYWwgZnJvbSBcIi4uLy4uLy4uL01vZGFsXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IFJpZ2h0UGFuZWxQaGFzZXMgfSBmcm9tICcuLi8uLi8uLi9zdG9yZXMvcmlnaHQtcGFuZWwvUmlnaHRQYW5lbFN0b3JlUGhhc2VzJztcbmltcG9ydCBSaWdodFBhbmVsU3RvcmUgZnJvbSBcIi4uLy4uLy4uL3N0b3Jlcy9yaWdodC1wYW5lbC9SaWdodFBhbmVsU3RvcmVcIjtcbmltcG9ydCBFcnJvckRpYWxvZyBmcm9tIFwiLi4vZGlhbG9ncy9FcnJvckRpYWxvZ1wiO1xuXG4vLyBjYW5jZWxsYXRpb24gY29kZXMgd2hpY2ggY29uc3RpdHV0ZSBhIGtleSBtaXNtYXRjaFxuY29uc3QgTUlTTUFUQ0hFUyA9IFtcIm0ua2V5X21pc21hdGNoXCIsIFwibS51c2VyX2Vycm9yXCIsIFwibS5taXNtYXRjaGVkX3Nhc1wiXTtcblxuaW50ZXJmYWNlIElQcm9wcyB7XG4gICAgbWVtYmVyOiBSb29tTWVtYmVyIHwgVXNlcjtcbiAgICBvbkNsb3NlOiAoKSA9PiB2b2lkO1xuICAgIHZlcmlmaWNhdGlvblJlcXVlc3Q6IFZlcmlmaWNhdGlvblJlcXVlc3Q7XG4gICAgdmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2U/OiBQcm9taXNlPFZlcmlmaWNhdGlvblJlcXVlc3Q+O1xuICAgIGxheW91dDogc3RyaW5nO1xuICAgIGlzUm9vbUVuY3J5cHRlZDogYm9vbGVhbjtcbn1cblxuY29uc3QgRW5jcnlwdGlvblBhbmVsOiBSZWFjdC5GQzxJUHJvcHM+ID0gKHByb3BzOiBJUHJvcHMpID0+IHtcbiAgICBjb25zdCB7XG4gICAgICAgIHZlcmlmaWNhdGlvblJlcXVlc3QsXG4gICAgICAgIHZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlLFxuICAgICAgICBtZW1iZXIsXG4gICAgICAgIG9uQ2xvc2UsXG4gICAgICAgIGxheW91dCxcbiAgICAgICAgaXNSb29tRW5jcnlwdGVkLFxuICAgIH0gPSBwcm9wcztcbiAgICBjb25zdCBbcmVxdWVzdCwgc2V0UmVxdWVzdF0gPSB1c2VTdGF0ZSh2ZXJpZmljYXRpb25SZXF1ZXN0KTtcbiAgICAvLyBzdGF0ZSB0byBzaG93IGEgc3Bpbm5lciBpbW1lZGlhdGVseSBhZnRlciBjbGlja2luZyBcInN0YXJ0IHZlcmlmaWNhdGlvblwiLFxuICAgIC8vIGJlZm9yZSB3ZSBoYXZlIGEgcmVxdWVzdFxuICAgIGNvbnN0IFtpc1JlcXVlc3RpbmcsIHNldFJlcXVlc3RpbmddID0gdXNlU3RhdGUoZmFsc2UpO1xuICAgIGNvbnN0IFtwaGFzZSwgc2V0UGhhc2VdID0gdXNlU3RhdGUocmVxdWVzdD8ucGhhc2UpO1xuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIHNldFJlcXVlc3QodmVyaWZpY2F0aW9uUmVxdWVzdCk7XG4gICAgICAgIGlmICh2ZXJpZmljYXRpb25SZXF1ZXN0KSB7XG4gICAgICAgICAgICBzZXRSZXF1ZXN0aW5nKGZhbHNlKTtcbiAgICAgICAgICAgIHNldFBoYXNlKHZlcmlmaWNhdGlvblJlcXVlc3QucGhhc2UpO1xuICAgICAgICB9XG4gICAgfSwgW3ZlcmlmaWNhdGlvblJlcXVlc3RdKTtcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGFzeW5jIGZ1bmN0aW9uIGF3YWl0UHJvbWlzZSgpIHtcbiAgICAgICAgICAgIHNldFJlcXVlc3RpbmcodHJ1ZSk7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0RnJvbVByb21pc2UgPSBhd2FpdCB2ZXJpZmljYXRpb25SZXF1ZXN0UHJvbWlzZTtcbiAgICAgICAgICAgIHNldFJlcXVlc3RpbmcoZmFsc2UpO1xuICAgICAgICAgICAgc2V0UmVxdWVzdChyZXF1ZXN0RnJvbVByb21pc2UpO1xuICAgICAgICAgICAgc2V0UGhhc2UocmVxdWVzdEZyb21Qcm9taXNlLnBoYXNlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmVyaWZpY2F0aW9uUmVxdWVzdFByb21pc2UpIHtcbiAgICAgICAgICAgIGF3YWl0UHJvbWlzZSgpO1xuICAgICAgICB9XG4gICAgfSwgW3ZlcmlmaWNhdGlvblJlcXVlc3RQcm9taXNlXSk7XG4gICAgY29uc3QgY2hhbmdlSGFuZGxlciA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICAgICAgLy8gaGFuZGxlIHRyYW5zaXRpb25zIC0+IGNhbmNlbGxlZCBmb3IgbWlzbWF0Y2hlcyB3aGljaCBmaXJlIGEgbW9kYWwgaW5zdGVhZCBvZiBzaG93aW5nIGEgY2FyZFxuICAgICAgICBpZiAocmVxdWVzdCAmJiByZXF1ZXN0LmNhbmNlbGxlZCAmJiBNSVNNQVRDSEVTLmluY2x1ZGVzKHJlcXVlc3QuY2FuY2VsbGF0aW9uQ29kZSkpIHtcbiAgICAgICAgICAgIE1vZGFsLmNyZWF0ZURpYWxvZyhFcnJvckRpYWxvZywge1xuICAgICAgICAgICAgICAgIGhlYWRlckltYWdlOiByZXF1aXJlKFwiLi4vLi4vLi4vLi4vcmVzL2ltZy9lMmUvd2FybmluZy1kZXByZWNhdGVkLnN2Z1wiKS5kZWZhdWx0LFxuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIllvdXIgbWVzc2FnZXMgYXJlIG5vdCBzZWN1cmVcIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IDxkaXY+XG4gICAgICAgICAgICAgICAgICAgIHsgX3QoXCJPbmUgb2YgdGhlIGZvbGxvd2luZyBtYXkgYmUgY29tcHJvbWlzZWQ6XCIpIH1cbiAgICAgICAgICAgICAgICAgICAgPHVsPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJZb3VyIGhvbWVzZXJ2ZXJcIikgfTwvbGk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8bGk+eyBfdChcIlRoZSBob21lc2VydmVyIHRoZSB1c2VyIHlvdSdyZSB2ZXJpZnlpbmcgaXMgY29ubmVjdGVkIHRvXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJZb3Vycywgb3IgdGhlIG90aGVyIHVzZXJzJyBpbnRlcm5ldCBjb25uZWN0aW9uXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGxpPnsgX3QoXCJZb3Vycywgb3IgdGhlIG90aGVyIHVzZXJzJyBzZXNzaW9uXCIpIH08L2xpPlxuICAgICAgICAgICAgICAgICAgICA8L3VsPlxuICAgICAgICAgICAgICAgIDwvZGl2PixcbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkOiBvbkNsb3NlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm47IC8vIGRvbid0IHVwZGF0ZSBwaGFzZSBoZXJlIGFzIHdlIHdpbGwgYmUgdHJhbnNpdGlvbmluZyBhd2F5IGZyb20gdGhpcyB2aWV3IHNob3J0bHlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXF1ZXN0KSB7XG4gICAgICAgICAgICBzZXRQaGFzZShyZXF1ZXN0LnBoYXNlKTtcbiAgICAgICAgfVxuICAgIH0sIFtvbkNsb3NlLCByZXF1ZXN0XSk7XG5cbiAgICB1c2VUeXBlZEV2ZW50RW1pdHRlcihyZXF1ZXN0LCBWZXJpZmljYXRpb25SZXF1ZXN0RXZlbnQuQ2hhbmdlLCBjaGFuZ2VIYW5kbGVyKTtcblxuICAgIGNvbnN0IG9uU3RhcnRWZXJpZmljYXRpb24gPSB1c2VDYWxsYmFjayhhc3luYyAoKSA9PiB7XG4gICAgICAgIHNldFJlcXVlc3RpbmcodHJ1ZSk7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY29uc3Qgcm9vbUlkID0gYXdhaXQgZW5zdXJlRE1FeGlzdHMoY2xpLCBtZW1iZXIudXNlcklkKTtcbiAgICAgICAgY29uc3QgdmVyaWZpY2F0aW9uUmVxdWVzdF8gPSBhd2FpdCBjbGkucmVxdWVzdFZlcmlmaWNhdGlvbkRNKG1lbWJlci51c2VySWQsIHJvb21JZCk7XG4gICAgICAgIHNldFJlcXVlc3QodmVyaWZpY2F0aW9uUmVxdWVzdF8pO1xuICAgICAgICBzZXRQaGFzZSh2ZXJpZmljYXRpb25SZXF1ZXN0Xy5waGFzZSk7XG4gICAgICAgIC8vIE5vdGlmeSB0aGUgUmlnaHRQYW5lbFN0b3JlIGFib3V0IHRoaXNcbiAgICAgICAgaWYgKFJpZ2h0UGFuZWxTdG9yZS5pbnN0YW5jZS5jdXJyZW50Q2FyZC5waGFzZSAhPSBSaWdodFBhbmVsUGhhc2VzLkVuY3J5cHRpb25QYW5lbCkge1xuICAgICAgICAgICAgUmlnaHRQYW5lbFN0b3JlLmluc3RhbmNlLnB1c2hDYXJkKHtcbiAgICAgICAgICAgICAgICBwaGFzZTogUmlnaHRQYW5lbFBoYXNlcy5FbmNyeXB0aW9uUGFuZWwsXG4gICAgICAgICAgICAgICAgc3RhdGU6IHsgbWVtYmVyLCB2ZXJpZmljYXRpb25SZXF1ZXN0OiB2ZXJpZmljYXRpb25SZXF1ZXN0XyB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFSaWdodFBhbmVsU3RvcmUuaW5zdGFuY2UuaXNPcGVuKSBSaWdodFBhbmVsU3RvcmUuaW5zdGFuY2UudG9nZ2xlUGFuZWwobnVsbCk7XG4gICAgfSwgW21lbWJlcl0pO1xuXG4gICAgY29uc3QgcmVxdWVzdGVkID1cbiAgICAgICAgKCFyZXF1ZXN0ICYmIGlzUmVxdWVzdGluZykgfHxcbiAgICAgICAgKHJlcXVlc3QgJiYgKHBoYXNlID09PSBQSEFTRV9SRVFVRVNURUQgfHwgcGhhc2UgPT09IFBIQVNFX1VOU0VOVCB8fCBwaGFzZSA9PT0gdW5kZWZpbmVkKSk7XG4gICAgY29uc3QgaXNTZWxmVmVyaWZpY2F0aW9uID0gcmVxdWVzdCA/XG4gICAgICAgIHJlcXVlc3QuaXNTZWxmVmVyaWZpY2F0aW9uIDpcbiAgICAgICAgbWVtYmVyLnVzZXJJZCA9PT0gTWF0cml4Q2xpZW50UGVnLmdldCgpLmdldFVzZXJJZCgpO1xuXG4gICAgaWYgKCFyZXF1ZXN0IHx8IHJlcXVlc3RlZCkge1xuICAgICAgICBjb25zdCBpbml0aWF0ZWRCeU1lID0gKCFyZXF1ZXN0ICYmIGlzUmVxdWVzdGluZykgfHwgKHJlcXVlc3QgJiYgcmVxdWVzdC5pbml0aWF0ZWRCeU1lKTtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxFbmNyeXB0aW9uSW5mb1xuICAgICAgICAgICAgICAgIGlzUm9vbUVuY3J5cHRlZD17aXNSb29tRW5jcnlwdGVkfVxuICAgICAgICAgICAgICAgIG9uU3RhcnRWZXJpZmljYXRpb249e29uU3RhcnRWZXJpZmljYXRpb259XG4gICAgICAgICAgICAgICAgbWVtYmVyPXttZW1iZXJ9XG4gICAgICAgICAgICAgICAgaXNTZWxmVmVyaWZpY2F0aW9uPXtpc1NlbGZWZXJpZmljYXRpb259XG4gICAgICAgICAgICAgICAgd2FpdGluZ0Zvck90aGVyUGFydHk9e3JlcXVlc3RlZCAmJiBpbml0aWF0ZWRCeU1lfVxuICAgICAgICAgICAgICAgIHdhaXRpbmdGb3JOZXR3b3JrPXtyZXF1ZXN0ZWQgJiYgIWluaXRpYXRlZEJ5TWV9XG4gICAgICAgICAgICAgICAgaW5EaWFsb2c9e2xheW91dCA9PT0gXCJkaWFsb2dcIn0gLz5cbiAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPFZlcmlmaWNhdGlvblBhbmVsXG4gICAgICAgICAgICAgICAgaXNSb29tRW5jcnlwdGVkPXtpc1Jvb21FbmNyeXB0ZWR9XG4gICAgICAgICAgICAgICAgbGF5b3V0PXtsYXlvdXR9XG4gICAgICAgICAgICAgICAgb25DbG9zZT17b25DbG9zZX1cbiAgICAgICAgICAgICAgICBtZW1iZXI9e21lbWJlcn1cbiAgICAgICAgICAgICAgICByZXF1ZXN0PXtyZXF1ZXN0fVxuICAgICAgICAgICAgICAgIGtleT17cmVxdWVzdC5jaGFubmVsLnRyYW5zYWN0aW9uSWR9XG4gICAgICAgICAgICAgICAgaW5EaWFsb2c9e2xheW91dCA9PT0gXCJkaWFsb2dcIn1cbiAgICAgICAgICAgICAgICBwaGFzZT17cGhhc2V9XG4gICAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IEVuY3J5cHRpb25QYW5lbDtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBZ0JBOztBQUNBOztBQVNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFuQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBdUJBO0FBQ0EsTUFBTUEsVUFBVSxHQUFHLENBQUMsZ0JBQUQsRUFBbUIsY0FBbkIsRUFBbUMsa0JBQW5DLENBQW5COztBQVdBLE1BQU1DLGVBQWlDLEdBQUlDLEtBQUQsSUFBbUI7RUFDekQsTUFBTTtJQUNGQyxtQkFERTtJQUVGQywwQkFGRTtJQUdGQyxNQUhFO0lBSUZDLE9BSkU7SUFLRkMsTUFMRTtJQU1GQztFQU5FLElBT0ZOLEtBUEo7RUFRQSxN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