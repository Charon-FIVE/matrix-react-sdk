"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.generateCompletionDomId = exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _lodash = require("lodash");

var _Autocompleter = _interopRequireDefault(require("../../../autocomplete/Autocompleter"));

var _SettingsStore = _interopRequireDefault(require("../../../settings/SettingsStore"));

var _RoomContext = _interopRequireDefault(require("../../../contexts/RoomContext"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2016 Aviral Dasgupta
Copyright 2017 New Vector Ltd

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const MAX_PROVIDER_MATCHES = 20;

const generateCompletionDomId = number => `mx_Autocomplete_Completion_${number}`;

exports.generateCompletionDomId = generateCompletionDomId;

class Autocomplete extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "autocompleter", void 0);
    (0, _defineProperty2.default)(this, "queryRequested", void 0);
    (0, _defineProperty2.default)(this, "debounceCompletionsRequest", void 0);
    (0, _defineProperty2.default)(this, "containerRef", /*#__PURE__*/(0, _react.createRef)());
    (0, _defineProperty2.default)(this, "hide", () => {
      this.setState({
        hide: true,
        selectionOffset: 1,
        completions: [],
        completionList: []
      });
    });
    (0, _defineProperty2.default)(this, "onConfirmCompletion", () => {
      this.onCompletionClicked(this.state.selectionOffset);
    });
    (0, _defineProperty2.default)(this, "onCompletionClicked", selectionOffset => {
      const count = this.countCompletions();

      if (count === 0 || selectionOffset < 1 || selectionOffset > count) {
        return false;
      }

      this.props.onConfirm(this.state.completionList[selectionOffset - 1]);
      this.hide();
      return true;
    });
    this.state = {
      // list of completionResults, each containing completions
      completions: [],
      // array of completions, so we can look up current selection by offset quickly
      completionList: [],
      // how far down the completion list we are (THIS IS 1-INDEXED!)
      selectionOffset: 1,
      // whether we should show completions if they're available
      shouldShowCompletions: true,
      hide: false,
      forceComplete: false
    };
  }

  componentDidMount() {
    this.autocompleter = new _Autocompleter.default(this.props.room, this.context.timelineRenderingType);
    this.applyNewProps();
  }

  applyNewProps(oldQuery, oldRoom) {
    if (oldRoom && this.props.room.roomId !== oldRoom.roomId) {
      this.autocompleter.destroy();
      this.autocompleter = new _Autocompleter.default(this.props.room);
    } // Query hasn't changed so don't try to complete it


    if (oldQuery === this.props.query) {
      return;
    }

    this.complete(this.props.query, this.props.selection);
  }

  componentWillUnmount() {
    this.autocompleter.destroy();
  }

  complete(query, selection) {
    this.queryRequested = query;

    if (this.debounceCompletionsRequest) {
      clearTimeout(this.debounceCompletionsRequest);
    }

    if (query === "") {
      this.setState({
        // Clear displayed completions
        completions: [],
        completionList: [],
        // Reset selected completion
        selectionOffset: 1,
        // Hide the autocomplete box
        hide: true
      });
      return Promise.resolve(null);
    }

    let autocompleteDelay = _SettingsStore.default.getValue("autocompleteDelay"); // Don't debounce if we are already showing completions


    if (this.state.completions.length > 0 || this.state.forceComplete) {
      autocompleteDelay = 0;
    }

    return new Promise(resolve => {
      this.debounceCompletionsRequest = setTimeout(() => {
        resolve(this.processQuery(query, selection));
      }, autocompleteDelay);
    });
  }

  processQuery(query, selection) {
    return this.autocompleter.getCompletions(query, selection, this.state.forceComplete, MAX_PROVIDER_MATCHES).then(completions => {
      // Only ever process the completions for the most recent query being processed
      if (query !== this.queryRequested) {
        return;
      }

      this.processCompletions(completions);
    });
  }

  processCompletions(completions) {
    const completionList = (0, _lodash.flatMap)(completions, provider => provider.completions); // Reset selection when completion list becomes empty.

    let selectionOffset = 1;

    if (completionList.length > 0) {
      /* If the currently selected completion is still in the completion list,
       try to find it and jump to it. If not, select composer.
       */
      const currentSelection = this.state.selectionOffset <= 1 ? null : this.state.completionList[this.state.selectionOffset - 1].completion;
      selectionOffset = completionList.findIndex(completion => completion.completion === currentSelection);

      if (selectionOffset === -1) {
        selectionOffset = 1;
      } else {
        selectionOffset++; // selectionOffset is 1-indexed!
      }
    }

    let hide = true; // If `completion.command.command` is truthy, then a provider has matched with the query

    const anyMatches = completions.some(completion => !!completion.command.command);

    if (anyMatches) {
      hide = false;

      if (this.props.onSelectionChange) {
        this.props.onSelectionChange(selectionOffset - 1);
      }
    }

    this.setState({
      completions,
      completionList,
      selectionOffset,
      hide,
      // Force complete is turned off each time since we can't edit the query in that case
      forceComplete: false
    });
  }

  hasSelection() {
    return this.countCompletions() > 0 && this.state.selectionOffset !== 0;
  }

  countCompletions() {
    return this.state.completionList.length;
  } // called from MessageComposerInput


  moveSelection(delta) {
    const completionCount = this.countCompletions();
    if (completionCount === 0) return; // there are no items to move the selection through
    // Note: selectionOffset 0 represents the unsubstituted text, while 1 means first pill selected

    const index = (this.state.selectionOffset + delta + completionCount - 1) % completionCount;
    this.setSelection(1 + index);
  }

  onEscape(e) {
    const completionCount = this.countCompletions();

    if (completionCount === 0) {
      // autocomplete is already empty, so don't preventDefault
      return;
    }

    e.preventDefault(); // selectionOffset = 0, so we don't end up completing when autocomplete is hidden

    this.hide();
  }

  forceComplete() {
    return new Promise(resolve => {
      this.setState({
        forceComplete: true,
        hide: false
      }, () => {
        this.complete(this.props.query, this.props.selection).then(() => {
          resolve(this.countCompletions());
        });
      });
    });
  }

  setSelection(selectionOffset) {
    this.setState({
      selectionOffset,
      hide: false
    });

    if (this.props.onSelectionChange) {
      this.props.onSelectionChange(selectionOffset - 1);
    }
  }

  componentDidUpdate(prevProps) {
    this.applyNewProps(prevProps.query, prevProps.room); // this is the selected completion, so scroll it into view if needed

    const selectedCompletion = this.refs[`completion${this.state.selectionOffset}`];

    if (selectedCompletion) {
      selectedCompletion.scrollIntoView({
        behavior: "auto",
        block: "nearest"
      });
    } else if (this.containerRef.current) {
      this.containerRef.current.scrollTo({
        top: 0
      });
    }
  }

  render() {
    let position = 1;
    const renderedCompletions = this.state.completions.map((completionResult, i) => {
      const completions = completionResult.completions.map((completion, j) => {
        const selected = position === this.state.selectionOffset;
        const className = (0, _classnames.default)('mx_Autocomplete_Completion', {
          selected
        });
        const componentPosition = position;
        position++;

        const onClick = () => {
          this.onCompletionClicked(componentPosition);
        };

        return /*#__PURE__*/_react.default.cloneElement(completion.component, {
          "key": j,
          "ref": `completion${componentPosition}`,
          "id": generateCompletionDomId(componentPosition - 1),
          // 0 index the completion IDs
          className,
          onClick,
          "aria-selected": selected
        });
      });
      return completions.length > 0 ? /*#__PURE__*/_react.default.createElement("div", {
        key: i,
        className: "mx_Autocomplete_ProviderSection",
        role: "presentation"
      }, /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_Autocomplete_provider_name"
      }, completionResult.provider.getName()), completionResult.provider.renderCompletions(completions)) : null;
    }).filter(completion => !!completion);
    return !this.state.hide && renderedCompletions.length > 0 ? /*#__PURE__*/_react.default.createElement("div", {
      id: "mx_Autocomplete",
      className: "mx_Autocomplete",
      ref: this.containerRef,
      role: "listbox"
    }, renderedCompletions) : null;
  }

}

exports.default = Autocomplete;
(0, _defineProperty2.default)(Autocomplete, "contextType", _RoomContext.default);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNQVhfUFJPVklERVJfTUFUQ0hFUyIsImdlbmVyYXRlQ29tcGxldGlvbkRvbUlkIiwibnVtYmVyIiwiQXV0b2NvbXBsZXRlIiwiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNyZWF0ZVJlZiIsInNldFN0YXRlIiwiaGlkZSIsInNlbGVjdGlvbk9mZnNldCIsImNvbXBsZXRpb25zIiwiY29tcGxldGlvbkxpc3QiLCJvbkNvbXBsZXRpb25DbGlja2VkIiwic3RhdGUiLCJjb3VudCIsImNvdW50Q29tcGxldGlvbnMiLCJvbkNvbmZpcm0iLCJzaG91bGRTaG93Q29tcGxldGlvbnMiLCJmb3JjZUNvbXBsZXRlIiwiY29tcG9uZW50RGlkTW91bnQiLCJhdXRvY29tcGxldGVyIiwiQXV0b2NvbXBsZXRlciIsInJvb20iLCJjb250ZXh0IiwidGltZWxpbmVSZW5kZXJpbmdUeXBlIiwiYXBwbHlOZXdQcm9wcyIsIm9sZFF1ZXJ5Iiwib2xkUm9vbSIsInJvb21JZCIsImRlc3Ryb3kiLCJxdWVyeSIsImNvbXBsZXRlIiwic2VsZWN0aW9uIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJxdWVyeVJlcXVlc3RlZCIsImRlYm91bmNlQ29tcGxldGlvbnNSZXF1ZXN0IiwiY2xlYXJUaW1lb3V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJhdXRvY29tcGxldGVEZWxheSIsIlNldHRpbmdzU3RvcmUiLCJnZXRWYWx1ZSIsImxlbmd0aCIsInNldFRpbWVvdXQiLCJwcm9jZXNzUXVlcnkiLCJnZXRDb21wbGV0aW9ucyIsInRoZW4iLCJwcm9jZXNzQ29tcGxldGlvbnMiLCJmbGF0TWFwIiwicHJvdmlkZXIiLCJjdXJyZW50U2VsZWN0aW9uIiwiY29tcGxldGlvbiIsImZpbmRJbmRleCIsImFueU1hdGNoZXMiLCJzb21lIiwiY29tbWFuZCIsIm9uU2VsZWN0aW9uQ2hhbmdlIiwiaGFzU2VsZWN0aW9uIiwibW92ZVNlbGVjdGlvbiIsImRlbHRhIiwiY29tcGxldGlvbkNvdW50IiwiaW5kZXgiLCJzZXRTZWxlY3Rpb24iLCJvbkVzY2FwZSIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImNvbXBvbmVudERpZFVwZGF0ZSIsInByZXZQcm9wcyIsInNlbGVjdGVkQ29tcGxldGlvbiIsInJlZnMiLCJzY3JvbGxJbnRvVmlldyIsImJlaGF2aW9yIiwiYmxvY2siLCJjb250YWluZXJSZWYiLCJjdXJyZW50Iiwic2Nyb2xsVG8iLCJ0b3AiLCJyZW5kZXIiLCJwb3NpdGlvbiIsInJlbmRlcmVkQ29tcGxldGlvbnMiLCJtYXAiLCJjb21wbGV0aW9uUmVzdWx0IiwiaSIsImoiLCJzZWxlY3RlZCIsImNsYXNzTmFtZSIsImNsYXNzTmFtZXMiLCJjb21wb25lbnRQb3NpdGlvbiIsIm9uQ2xpY2siLCJjbG9uZUVsZW1lbnQiLCJjb21wb25lbnQiLCJnZXROYW1lIiwicmVuZGVyQ29tcGxldGlvbnMiLCJmaWx0ZXIiLCJSb29tQ29udGV4dCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL3Jvb21zL0F1dG9jb21wbGV0ZS50c3giXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE2IEF2aXJhbCBEYXNndXB0YVxuQ29weXJpZ2h0IDIwMTcgTmV3IFZlY3RvciBMdGRcblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QsIHsgY3JlYXRlUmVmLCBLZXlib2FyZEV2ZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyBmbGF0TWFwIH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21vZGVscy9yb29tJztcblxuaW1wb3J0IEF1dG9jb21wbGV0ZXIsIHsgSUNvbXBsZXRpb24sIElTZWxlY3Rpb25SYW5nZSwgSVByb3ZpZGVyQ29tcGxldGlvbnMgfSBmcm9tICcuLi8uLi8uLi9hdXRvY29tcGxldGUvQXV0b2NvbXBsZXRlcic7XG5pbXBvcnQgU2V0dGluZ3NTdG9yZSBmcm9tIFwiLi4vLi4vLi4vc2V0dGluZ3MvU2V0dGluZ3NTdG9yZVwiO1xuaW1wb3J0IFJvb21Db250ZXh0IGZyb20gJy4uLy4uLy4uL2NvbnRleHRzL1Jvb21Db250ZXh0JztcblxuY29uc3QgTUFYX1BST1ZJREVSX01BVENIRVMgPSAyMDtcblxuZXhwb3J0IGNvbnN0IGdlbmVyYXRlQ29tcGxldGlvbkRvbUlkID0gKG51bWJlcikgPT4gYG14X0F1dG9jb21wbGV0ZV9Db21wbGV0aW9uXyR7bnVtYmVyfWA7XG5cbmludGVyZmFjZSBJUHJvcHMge1xuICAgIC8vIHRoZSBxdWVyeSBzdHJpbmcgZm9yIHdoaWNoIHRvIHNob3cgYXV0b2NvbXBsZXRlIHN1Z2dlc3Rpb25zXG4gICAgcXVlcnk6IHN0cmluZztcbiAgICAvLyBtZXRob2QgaW52b2tlZCB3aXRoIHJhbmdlIGFuZCB0ZXh0IGNvbnRlbnQgd2hlbiBjb21wbGV0aW9uIGlzIGNvbmZpcm1lZFxuICAgIG9uQ29uZmlybTogKGNvbXBsZXRpb246IElDb21wbGV0aW9uKSA9PiB2b2lkO1xuICAgIC8vIG1ldGhvZCBpbnZva2VkIHdoZW4gc2VsZWN0ZWQgKGlmIGFueSkgY29tcGxldGlvbiBjaGFuZ2VzXG4gICAgb25TZWxlY3Rpb25DaGFuZ2U/OiAocGFydEluZGV4OiBudW1iZXIpID0+IHZvaWQ7XG4gICAgc2VsZWN0aW9uOiBJU2VsZWN0aW9uUmFuZ2U7XG4gICAgLy8gVGhlIHJvb20gaW4gd2hpY2ggd2UncmUgYXV0b2NvbXBsZXRpbmdcbiAgICByb29tOiBSb29tO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBjb21wbGV0aW9uczogSVByb3ZpZGVyQ29tcGxldGlvbnNbXTtcbiAgICBjb21wbGV0aW9uTGlzdDogSUNvbXBsZXRpb25bXTtcbiAgICBzZWxlY3Rpb25PZmZzZXQ6IG51bWJlcjtcbiAgICBzaG91bGRTaG93Q29tcGxldGlvbnM6IGJvb2xlYW47XG4gICAgaGlkZTogYm9vbGVhbjtcbiAgICBmb3JjZUNvbXBsZXRlOiBib29sZWFuO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRvY29tcGxldGUgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PElQcm9wcywgSVN0YXRlPiB7XG4gICAgYXV0b2NvbXBsZXRlcjogQXV0b2NvbXBsZXRlcjtcbiAgICBxdWVyeVJlcXVlc3RlZDogc3RyaW5nO1xuICAgIGRlYm91bmNlQ29tcGxldGlvbnNSZXF1ZXN0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBjb250YWluZXJSZWYgPSBjcmVhdGVSZWY8SFRNTERpdkVsZW1lbnQ+KCk7XG5cbiAgICBwdWJsaWMgc3RhdGljIGNvbnRleHRUeXBlID0gUm9vbUNvbnRleHQ7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgICAgICAgIC8vIGxpc3Qgb2YgY29tcGxldGlvblJlc3VsdHMsIGVhY2ggY29udGFpbmluZyBjb21wbGV0aW9uc1xuICAgICAgICAgICAgY29tcGxldGlvbnM6IFtdLFxuXG4gICAgICAgICAgICAvLyBhcnJheSBvZiBjb21wbGV0aW9ucywgc28gd2UgY2FuIGxvb2sgdXAgY3VycmVudCBzZWxlY3Rpb24gYnkgb2Zmc2V0IHF1aWNrbHlcbiAgICAgICAgICAgIGNvbXBsZXRpb25MaXN0OiBbXSxcblxuICAgICAgICAgICAgLy8gaG93IGZhciBkb3duIHRoZSBjb21wbGV0aW9uIGxpc3Qgd2UgYXJlIChUSElTIElTIDEtSU5ERVhFRCEpXG4gICAgICAgICAgICBzZWxlY3Rpb25PZmZzZXQ6IDEsXG5cbiAgICAgICAgICAgIC8vIHdoZXRoZXIgd2Ugc2hvdWxkIHNob3cgY29tcGxldGlvbnMgaWYgdGhleSdyZSBhdmFpbGFibGVcbiAgICAgICAgICAgIHNob3VsZFNob3dDb21wbGV0aW9uczogdHJ1ZSxcblxuICAgICAgICAgICAgaGlkZTogZmFsc2UsXG5cbiAgICAgICAgICAgIGZvcmNlQ29tcGxldGU6IGZhbHNlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgICB0aGlzLmF1dG9jb21wbGV0ZXIgPSBuZXcgQXV0b2NvbXBsZXRlcih0aGlzLnByb3BzLnJvb20sIHRoaXMuY29udGV4dC50aW1lbGluZVJlbmRlcmluZ1R5cGUpO1xuICAgICAgICB0aGlzLmFwcGx5TmV3UHJvcHMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFwcGx5TmV3UHJvcHMob2xkUXVlcnk/OiBzdHJpbmcsIG9sZFJvb20/OiBSb29tKTogdm9pZCB7XG4gICAgICAgIGlmIChvbGRSb29tICYmIHRoaXMucHJvcHMucm9vbS5yb29tSWQgIT09IG9sZFJvb20ucm9vbUlkKSB7XG4gICAgICAgICAgICB0aGlzLmF1dG9jb21wbGV0ZXIuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGVyID0gbmV3IEF1dG9jb21wbGV0ZXIodGhpcy5wcm9wcy5yb29tKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFF1ZXJ5IGhhc24ndCBjaGFuZ2VkIHNvIGRvbid0IHRyeSB0byBjb21wbGV0ZSBpdFxuICAgICAgICBpZiAob2xkUXVlcnkgPT09IHRoaXMucHJvcHMucXVlcnkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29tcGxldGUodGhpcy5wcm9wcy5xdWVyeSwgdGhpcy5wcm9wcy5zZWxlY3Rpb24pO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLmF1dG9jb21wbGV0ZXIuZGVzdHJveSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY29tcGxldGUocXVlcnk6IHN0cmluZywgc2VsZWN0aW9uOiBJU2VsZWN0aW9uUmFuZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdGhpcy5xdWVyeVJlcXVlc3RlZCA9IHF1ZXJ5O1xuICAgICAgICBpZiAodGhpcy5kZWJvdW5jZUNvbXBsZXRpb25zUmVxdWVzdCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZGVib3VuY2VDb21wbGV0aW9uc1JlcXVlc3QpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChxdWVyeSA9PT0gXCJcIikge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgLy8gQ2xlYXIgZGlzcGxheWVkIGNvbXBsZXRpb25zXG4gICAgICAgICAgICAgICAgY29tcGxldGlvbnM6IFtdLFxuICAgICAgICAgICAgICAgIGNvbXBsZXRpb25MaXN0OiBbXSxcbiAgICAgICAgICAgICAgICAvLyBSZXNldCBzZWxlY3RlZCBjb21wbGV0aW9uXG4gICAgICAgICAgICAgICAgc2VsZWN0aW9uT2Zmc2V0OiAxLFxuICAgICAgICAgICAgICAgIC8vIEhpZGUgdGhlIGF1dG9jb21wbGV0ZSBib3hcbiAgICAgICAgICAgICAgICBoaWRlOiB0cnVlLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBhdXRvY29tcGxldGVEZWxheSA9IFNldHRpbmdzU3RvcmUuZ2V0VmFsdWUoXCJhdXRvY29tcGxldGVEZWxheVwiKTtcblxuICAgICAgICAvLyBEb24ndCBkZWJvdW5jZSBpZiB3ZSBhcmUgYWxyZWFkeSBzaG93aW5nIGNvbXBsZXRpb25zXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmNvbXBsZXRpb25zLmxlbmd0aCA+IDAgfHwgdGhpcy5zdGF0ZS5mb3JjZUNvbXBsZXRlKSB7XG4gICAgICAgICAgICBhdXRvY29tcGxldGVEZWxheSA9IDA7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGVib3VuY2VDb21wbGV0aW9uc1JlcXVlc3QgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMucHJvY2Vzc1F1ZXJ5KHF1ZXJ5LCBzZWxlY3Rpb24pKTtcbiAgICAgICAgICAgIH0sIGF1dG9jb21wbGV0ZURlbGF5KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUXVlcnkocXVlcnk6IHN0cmluZywgc2VsZWN0aW9uOiBJU2VsZWN0aW9uUmFuZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0b2NvbXBsZXRlci5nZXRDb21wbGV0aW9ucyhcbiAgICAgICAgICAgIHF1ZXJ5LCBzZWxlY3Rpb24sIHRoaXMuc3RhdGUuZm9yY2VDb21wbGV0ZSwgTUFYX1BST1ZJREVSX01BVENIRVMsXG4gICAgICAgICkudGhlbigoY29tcGxldGlvbnMpID0+IHtcbiAgICAgICAgICAgIC8vIE9ubHkgZXZlciBwcm9jZXNzIHRoZSBjb21wbGV0aW9ucyBmb3IgdGhlIG1vc3QgcmVjZW50IHF1ZXJ5IGJlaW5nIHByb2Nlc3NlZFxuICAgICAgICAgICAgaWYgKHF1ZXJ5ICE9PSB0aGlzLnF1ZXJ5UmVxdWVzdGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzQ29tcGxldGlvbnMoY29tcGxldGlvbnMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NDb21wbGV0aW9ucyhjb21wbGV0aW9uczogSVByb3ZpZGVyQ29tcGxldGlvbnNbXSk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb21wbGV0aW9uTGlzdCA9IGZsYXRNYXAoY29tcGxldGlvbnMsIChwcm92aWRlcikgPT4gcHJvdmlkZXIuY29tcGxldGlvbnMpO1xuXG4gICAgICAgIC8vIFJlc2V0IHNlbGVjdGlvbiB3aGVuIGNvbXBsZXRpb24gbGlzdCBiZWNvbWVzIGVtcHR5LlxuICAgICAgICBsZXQgc2VsZWN0aW9uT2Zmc2V0ID0gMTtcbiAgICAgICAgaWYgKGNvbXBsZXRpb25MaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8qIElmIHRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgY29tcGxldGlvbiBpcyBzdGlsbCBpbiB0aGUgY29tcGxldGlvbiBsaXN0LFxuICAgICAgICAgICAgIHRyeSB0byBmaW5kIGl0IGFuZCBqdW1wIHRvIGl0LiBJZiBub3QsIHNlbGVjdCBjb21wb3Nlci5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgY29uc3QgY3VycmVudFNlbGVjdGlvbiA9IHRoaXMuc3RhdGUuc2VsZWN0aW9uT2Zmc2V0IDw9IDEgPyBudWxsIDpcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLmNvbXBsZXRpb25MaXN0W3RoaXMuc3RhdGUuc2VsZWN0aW9uT2Zmc2V0IC0gMV0uY29tcGxldGlvbjtcbiAgICAgICAgICAgIHNlbGVjdGlvbk9mZnNldCA9IGNvbXBsZXRpb25MaXN0LmZpbmRJbmRleChcbiAgICAgICAgICAgICAgICAoY29tcGxldGlvbikgPT4gY29tcGxldGlvbi5jb21wbGV0aW9uID09PSBjdXJyZW50U2VsZWN0aW9uKTtcbiAgICAgICAgICAgIGlmIChzZWxlY3Rpb25PZmZzZXQgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgc2VsZWN0aW9uT2Zmc2V0ID0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc2VsZWN0aW9uT2Zmc2V0Kys7IC8vIHNlbGVjdGlvbk9mZnNldCBpcyAxLWluZGV4ZWQhXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaGlkZSA9IHRydWU7XG4gICAgICAgIC8vIElmIGBjb21wbGV0aW9uLmNvbW1hbmQuY29tbWFuZGAgaXMgdHJ1dGh5LCB0aGVuIGEgcHJvdmlkZXIgaGFzIG1hdGNoZWQgd2l0aCB0aGUgcXVlcnlcbiAgICAgICAgY29uc3QgYW55TWF0Y2hlcyA9IGNvbXBsZXRpb25zLnNvbWUoKGNvbXBsZXRpb24pID0+ICEhY29tcGxldGlvbi5jb21tYW5kLmNvbW1hbmQpO1xuICAgICAgICBpZiAoYW55TWF0Y2hlcykge1xuICAgICAgICAgICAgaGlkZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHRoaXMucHJvcHMub25TZWxlY3Rpb25DaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uU2VsZWN0aW9uQ2hhbmdlKHNlbGVjdGlvbk9mZnNldCAtIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBjb21wbGV0aW9ucyxcbiAgICAgICAgICAgIGNvbXBsZXRpb25MaXN0LFxuICAgICAgICAgICAgc2VsZWN0aW9uT2Zmc2V0LFxuICAgICAgICAgICAgaGlkZSxcbiAgICAgICAgICAgIC8vIEZvcmNlIGNvbXBsZXRlIGlzIHR1cm5lZCBvZmYgZWFjaCB0aW1lIHNpbmNlIHdlIGNhbid0IGVkaXQgdGhlIHF1ZXJ5IGluIHRoYXQgY2FzZVxuICAgICAgICAgICAgZm9yY2VDb21wbGV0ZTogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBoYXNTZWxlY3Rpb24oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvdW50Q29tcGxldGlvbnMoKSA+IDAgJiYgdGhpcy5zdGF0ZS5zZWxlY3Rpb25PZmZzZXQgIT09IDA7XG4gICAgfVxuXG4gICAgcHVibGljIGNvdW50Q29tcGxldGlvbnMoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuY29tcGxldGlvbkxpc3QubGVuZ3RoO1xuICAgIH1cblxuICAgIC8vIGNhbGxlZCBmcm9tIE1lc3NhZ2VDb21wb3NlcklucHV0XG4gICAgcHVibGljIG1vdmVTZWxlY3Rpb24oZGVsdGE6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBjb21wbGV0aW9uQ291bnQgPSB0aGlzLmNvdW50Q29tcGxldGlvbnMoKTtcbiAgICAgICAgaWYgKGNvbXBsZXRpb25Db3VudCA9PT0gMCkgcmV0dXJuOyAvLyB0aGVyZSBhcmUgbm8gaXRlbXMgdG8gbW92ZSB0aGUgc2VsZWN0aW9uIHRocm91Z2hcblxuICAgICAgICAvLyBOb3RlOiBzZWxlY3Rpb25PZmZzZXQgMCByZXByZXNlbnRzIHRoZSB1bnN1YnN0aXR1dGVkIHRleHQsIHdoaWxlIDEgbWVhbnMgZmlyc3QgcGlsbCBzZWxlY3RlZFxuICAgICAgICBjb25zdCBpbmRleCA9ICh0aGlzLnN0YXRlLnNlbGVjdGlvbk9mZnNldCArIGRlbHRhICsgY29tcGxldGlvbkNvdW50IC0gMSkgJSBjb21wbGV0aW9uQ291bnQ7XG4gICAgICAgIHRoaXMuc2V0U2VsZWN0aW9uKDEgKyBpbmRleCk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uRXNjYXBlKGU6IEtleWJvYXJkRXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY29tcGxldGlvbkNvdW50ID0gdGhpcy5jb3VudENvbXBsZXRpb25zKCk7XG4gICAgICAgIGlmIChjb21wbGV0aW9uQ291bnQgPT09IDApIHtcbiAgICAgICAgICAgIC8vIGF1dG9jb21wbGV0ZSBpcyBhbHJlYWR5IGVtcHR5LCBzbyBkb24ndCBwcmV2ZW50RGVmYXVsdFxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIC8vIHNlbGVjdGlvbk9mZnNldCA9IDAsIHNvIHdlIGRvbid0IGVuZCB1cCBjb21wbGV0aW5nIHdoZW4gYXV0b2NvbXBsZXRlIGlzIGhpZGRlblxuICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhpZGUgPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaGlkZTogdHJ1ZSxcbiAgICAgICAgICAgIHNlbGVjdGlvbk9mZnNldDogMSxcbiAgICAgICAgICAgIGNvbXBsZXRpb25zOiBbXSxcbiAgICAgICAgICAgIGNvbXBsZXRpb25MaXN0OiBbXSxcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBmb3JjZUNvbXBsZXRlKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICAgICAgZm9yY2VDb21wbGV0ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBoaWRlOiBmYWxzZSxcbiAgICAgICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbXBsZXRlKHRoaXMucHJvcHMucXVlcnksIHRoaXMucHJvcHMuc2VsZWN0aW9uKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmNvdW50Q29tcGxldGlvbnMoKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uQ29uZmlybUNvbXBsZXRpb24gPSAoKTogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMub25Db21wbGV0aW9uQ2xpY2tlZCh0aGlzLnN0YXRlLnNlbGVjdGlvbk9mZnNldCk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25Db21wbGV0aW9uQ2xpY2tlZCA9IChzZWxlY3Rpb25PZmZzZXQ6IG51bWJlcik6IGJvb2xlYW4gPT4ge1xuICAgICAgICBjb25zdCBjb3VudCA9IHRoaXMuY291bnRDb21wbGV0aW9ucygpO1xuICAgICAgICBpZiAoY291bnQgPT09IDAgfHwgc2VsZWN0aW9uT2Zmc2V0IDwgMSB8fCBzZWxlY3Rpb25PZmZzZXQgPiBjb3VudCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wcm9wcy5vbkNvbmZpcm0odGhpcy5zdGF0ZS5jb21wbGV0aW9uTGlzdFtzZWxlY3Rpb25PZmZzZXQgLSAxXSk7XG4gICAgICAgIHRoaXMuaGlkZSgpO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHNldFNlbGVjdGlvbihzZWxlY3Rpb25PZmZzZXQ6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2VsZWN0aW9uT2Zmc2V0LCBoaWRlOiBmYWxzZSB9KTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25TZWxlY3Rpb25DaGFuZ2UpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25TZWxlY3Rpb25DaGFuZ2Uoc2VsZWN0aW9uT2Zmc2V0IC0gMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzOiBJUHJvcHMpIHtcbiAgICAgICAgdGhpcy5hcHBseU5ld1Byb3BzKHByZXZQcm9wcy5xdWVyeSwgcHJldlByb3BzLnJvb20pO1xuICAgICAgICAvLyB0aGlzIGlzIHRoZSBzZWxlY3RlZCBjb21wbGV0aW9uLCBzbyBzY3JvbGwgaXQgaW50byB2aWV3IGlmIG5lZWRlZFxuICAgICAgICBjb25zdCBzZWxlY3RlZENvbXBsZXRpb24gPSB0aGlzLnJlZnNbYGNvbXBsZXRpb24ke3RoaXMuc3RhdGUuc2VsZWN0aW9uT2Zmc2V0fWBdIGFzIEhUTUxFbGVtZW50O1xuXG4gICAgICAgIGlmIChzZWxlY3RlZENvbXBsZXRpb24pIHtcbiAgICAgICAgICAgIHNlbGVjdGVkQ29tcGxldGlvbi5zY3JvbGxJbnRvVmlldyh7XG4gICAgICAgICAgICAgICAgYmVoYXZpb3I6IFwiYXV0b1wiLFxuICAgICAgICAgICAgICAgIGJsb2NrOiBcIm5lYXJlc3RcIixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY29udGFpbmVyUmVmLmN1cnJlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyUmVmLmN1cnJlbnQuc2Nyb2xsVG8oeyB0b3A6IDAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGxldCBwb3NpdGlvbiA9IDE7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVkQ29tcGxldGlvbnMgPSB0aGlzLnN0YXRlLmNvbXBsZXRpb25zLm1hcCgoY29tcGxldGlvblJlc3VsdCwgaSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29tcGxldGlvbnMgPSBjb21wbGV0aW9uUmVzdWx0LmNvbXBsZXRpb25zLm1hcCgoY29tcGxldGlvbiwgaikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gcG9zaXRpb24gPT09IHRoaXMuc3RhdGUuc2VsZWN0aW9uT2Zmc2V0O1xuICAgICAgICAgICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IGNsYXNzTmFtZXMoJ214X0F1dG9jb21wbGV0ZV9Db21wbGV0aW9uJywgeyBzZWxlY3RlZCB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCBjb21wb25lbnRQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIHBvc2l0aW9uKys7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBvbkNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGlvbkNsaWNrZWQoY29tcG9uZW50UG9zaXRpb24pO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gUmVhY3QuY2xvbmVFbGVtZW50KGNvbXBsZXRpb24uY29tcG9uZW50LCB7XG4gICAgICAgICAgICAgICAgICAgIFwia2V5XCI6IGosXG4gICAgICAgICAgICAgICAgICAgIFwicmVmXCI6IGBjb21wbGV0aW9uJHtjb21wb25lbnRQb3NpdGlvbn1gLFxuICAgICAgICAgICAgICAgICAgICBcImlkXCI6IGdlbmVyYXRlQ29tcGxldGlvbkRvbUlkKGNvbXBvbmVudFBvc2l0aW9uIC0gMSksIC8vIDAgaW5kZXggdGhlIGNvbXBsZXRpb24gSURzXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgb25DbGljayxcbiAgICAgICAgICAgICAgICAgICAgXCJhcmlhLXNlbGVjdGVkXCI6IHNlbGVjdGVkLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBjb21wbGV0aW9ucy5sZW5ndGggPiAwID8gKFxuICAgICAgICAgICAgICAgIDxkaXYga2V5PXtpfSBjbGFzc05hbWU9XCJteF9BdXRvY29tcGxldGVfUHJvdmlkZXJTZWN0aW9uXCIgcm9sZT1cInByZXNlbnRhdGlvblwiPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIm14X0F1dG9jb21wbGV0ZV9wcm92aWRlcl9uYW1lXCI+eyBjb21wbGV0aW9uUmVzdWx0LnByb3ZpZGVyLmdldE5hbWUoKSB9PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIHsgY29tcGxldGlvblJlc3VsdC5wcm92aWRlci5yZW5kZXJDb21wbGV0aW9ucyhjb21wbGV0aW9ucykgfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKSA6IG51bGw7XG4gICAgICAgIH0pLmZpbHRlcigoY29tcGxldGlvbikgPT4gISFjb21wbGV0aW9uKTtcblxuICAgICAgICByZXR1cm4gIXRoaXMuc3RhdGUuaGlkZSAmJiByZW5kZXJlZENvbXBsZXRpb25zLmxlbmd0aCA+IDAgPyAoXG4gICAgICAgICAgICA8ZGl2IGlkPVwibXhfQXV0b2NvbXBsZXRlXCIgY2xhc3NOYW1lPVwibXhfQXV0b2NvbXBsZXRlXCIgcmVmPXt0aGlzLmNvbnRhaW5lclJlZn0gcm9sZT1cImxpc3Rib3hcIj5cbiAgICAgICAgICAgICAgICB7IHJlbmRlcmVkQ29tcGxldGlvbnMgfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICkgOiBudWxsO1xuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFpQkE7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQXhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQVdBLE1BQU1BLG9CQUFvQixHQUFHLEVBQTdCOztBQUVPLE1BQU1DLHVCQUF1QixHQUFJQyxNQUFELElBQWEsOEJBQTZCQSxNQUFPLEVBQWpGOzs7O0FBdUJRLE1BQU1DLFlBQU4sU0FBMkJDLGNBQUEsQ0FBTUMsYUFBakMsQ0FBK0Q7RUFRMUVDLFdBQVcsQ0FBQ0MsS0FBRCxFQUFRO0lBQ2YsTUFBTUEsS0FBTjtJQURlO0lBQUE7SUFBQTtJQUFBLGlFQUpJLElBQUFDLGdCQUFBLEdBSUo7SUFBQSw0Q0ErSkosTUFBWTtNQUN2QixLQUFLQyxRQUFMLENBQWM7UUFDVkMsSUFBSSxFQUFF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