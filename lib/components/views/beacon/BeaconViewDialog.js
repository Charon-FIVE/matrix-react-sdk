"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireWildcard(require("react"));

var _liveLocation = require("../../../../res/img/location/live-location.svg");

var _useLiveBeacons = require("../../../utils/beacon/useLiveBeacons");

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _BaseDialog = _interopRequireDefault(require("../dialogs/BaseDialog"));

var _Map = _interopRequireDefault(require("../location/Map"));

var _ZoomButtons = _interopRequireDefault(require("../location/ZoomButtons"));

var _BeaconMarker = _interopRequireDefault(require("./BeaconMarker"));

var _bounds = require("../../../utils/beacon/bounds");

var _beacon = require("../../../utils/beacon");

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _DialogSidebar = _interopRequireDefault(require("./DialogSidebar"));

var _DialogOwnBeaconStatus = _interopRequireDefault(require("./DialogOwnBeaconStatus"));

var _BeaconStatusTooltip = _interopRequireDefault(require("./BeaconStatusTooltip"));

var _MapFallback = _interopRequireDefault(require("../location/MapFallback"));

var _MapError = require("../location/MapError");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2022 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
const getBoundsCenter = bounds => {
  if (!bounds) {
    return;
  }

  return (0, _beacon.getGeoUri)({
    latitude: (bounds.north + bounds.south) / 2,
    longitude: (bounds.east + bounds.west) / 2,
    timestamp: Date.now()
  });
};

const useMapPosition = (liveBeacons, _ref) => {
  let {
    beacon,
    ts
  } = _ref;
  const [bounds, setBounds] = (0, _react.useState)((0, _bounds.getBeaconBounds)(liveBeacons));
  const [centerGeoUri, setCenterGeoUri] = (0, _react.useState)(beacon?.latestLocationState?.uri || getBoundsCenter(bounds));
  (0, _react.useEffect)(() => {
    if ( // this check ignores the first initial focused beacon state
    // as centering logic on map zooms to show everything
    // instead of focusing down
    ts !== 0 && // only set focus to a known location
    beacon?.latestLocationState?.uri) {
      // append custom `mxTs` parameter to geoUri
      // so map is triggered to refocus on this uri
      // event if it was previously the center geouri
      // but the map have moved/zoomed
      setCenterGeoUri(`${beacon?.latestLocationState?.uri};mxTs=${Date.now()}`);
      setBounds((0, _bounds.getBeaconBounds)([beacon]));
    }
  }, [beacon, ts]);
  return {
    bounds,
    centerGeoUri
  };
};
/**
 * Dialog to view live beacons maximised
 */


const BeaconViewDialog = _ref2 => {
  let {
    initialFocusedBeacon,
    roomId,
    matrixClient,
    onFinished
  } = _ref2;
  const liveBeacons = (0, _useLiveBeacons.useLiveBeacons)(roomId, matrixClient);
  const [focusedBeaconState, setFocusedBeaconState] = (0, _react.useState)({
    beacon: initialFocusedBeacon,
    ts: 0
  });
  const [isSidebarOpen, setSidebarOpen] = (0, _react.useState)(false);
  const {
    bounds,
    centerGeoUri
  } = useMapPosition(liveBeacons, focusedBeaconState);
  const [mapDisplayError, setMapDisplayError] = (0, _react.useState)(); // automatically open the sidebar if there is no map to see

  (0, _react.useEffect)(() => {
    if (mapDisplayError) {
      setSidebarOpen(true);
    }
  }, [mapDisplayError]);

  const onBeaconListItemClick = beacon => {
    setFocusedBeaconState({
      beacon,
      ts: Date.now()
    });
  };

  return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
    className: "mx_BeaconViewDialog",
    onFinished: onFinished,
    fixedWidth: false
  }, /*#__PURE__*/_react.default.createElement(_MatrixClientContext.default.Provider, {
    value: matrixClient
  }, centerGeoUri && !mapDisplayError && /*#__PURE__*/_react.default.createElement(_Map.default, {
    id: "mx_BeaconViewDialog",
    bounds: bounds,
    centerGeoUri: centerGeoUri,
    interactive: true,
    onError: setMapDisplayError,
    className: "mx_BeaconViewDialog_map"
  }, _ref3 => {
    let {
      map
    } = _ref3;
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, liveBeacons.map(beacon => /*#__PURE__*/_react.default.createElement(_BeaconMarker.default, {
      key: beacon.identifier,
      map: map,
      beacon: beacon,
      tooltip: /*#__PURE__*/_react.default.createElement(_BeaconStatusTooltip.default, {
        beacon: beacon
      })
    })), /*#__PURE__*/_react.default.createElement(_ZoomButtons.default, {
      map: map
    }));
  }), mapDisplayError && /*#__PURE__*/_react.default.createElement(_MapError.MapError, {
    error: mapDisplayError.message,
    isMinimised: true
  }), !centerGeoUri && !mapDisplayError && /*#__PURE__*/_react.default.createElement(_MapFallback.default, {
    "data-test-id": "beacon-view-dialog-map-fallback",
    className: "mx_BeaconViewDialog_map"
  }, /*#__PURE__*/_react.default.createElement("span", {
    className: "mx_BeaconViewDialog_mapFallbackMessage"
  }, (0, _languageHandler._t)('No live locations')), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    kind: "primary",
    onClick: onFinished,
    "data-test-id": "beacon-view-dialog-fallback-close"
  }, (0, _languageHandler._t)('Close'))), isSidebarOpen ? /*#__PURE__*/_react.default.createElement(_DialogSidebar.default, {
    beacons: liveBeacons,
    onBeaconClick: onBeaconListItemClick,
    requestClose: () => setSidebarOpen(false)
  }) : /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
    kind: "primary",
    onClick: () => setSidebarOpen(true),
    "data-test-id": "beacon-view-dialog-open-sidebar",
    className: "mx_BeaconViewDialog_viewListButton"
  }, /*#__PURE__*/_react.default.createElement(_liveLocation.Icon, {
    height: 12
  }), "\xA0", (0, _languageHandler._t)('View list')), /*#__PURE__*/_react.default.createElement(_DialogOwnBeaconStatus.default, {
    roomId: roomId
  })));
};

var _default = BeaconViewDialog;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRCb3VuZHNDZW50ZXIiLCJib3VuZHMiLCJnZXRHZW9VcmkiLCJsYXRpdHVkZSIsIm5vcnRoIiwic291dGgiLCJsb25naXR1ZGUiLCJlYXN0Iiwid2VzdCIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJ1c2VNYXBQb3NpdGlvbiIsImxpdmVCZWFjb25zIiwiYmVhY29uIiwidHMiLCJzZXRCb3VuZHMiLCJ1c2VTdGF0ZSIsImdldEJlYWNvbkJvdW5kcyIsImNlbnRlckdlb1VyaSIsInNldENlbnRlckdlb1VyaSIsImxhdGVzdExvY2F0aW9uU3RhdGUiLCJ1cmkiLCJ1c2VFZmZlY3QiLCJCZWFjb25WaWV3RGlhbG9nIiwiaW5pdGlhbEZvY3VzZWRCZWFjb24iLCJyb29tSWQiLCJtYXRyaXhDbGllbnQiLCJvbkZpbmlzaGVkIiwidXNlTGl2ZUJlYWNvbnMiLCJmb2N1c2VkQmVhY29uU3RhdGUiLCJzZXRGb2N1c2VkQmVhY29uU3RhdGUiLCJpc1NpZGViYXJPcGVuIiwic2V0U2lkZWJhck9wZW4iLCJtYXBEaXNwbGF5RXJyb3IiLCJzZXRNYXBEaXNwbGF5RXJyb3IiLCJvbkJlYWNvbkxpc3RJdGVtQ2xpY2siLCJtYXAiLCJpZGVudGlmaWVyIiwibWVzc2FnZSIsIl90Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvdmlld3MvYmVhY29uL0JlYWNvblZpZXdEaWFsb2cudHN4Il0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAyMiBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCwgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSAnbWF0cml4LWpzLXNkay9zcmMvY2xpZW50JztcbmltcG9ydCB7XG4gICAgQmVhY29uLFxuICAgIFJvb20sXG59IGZyb20gJ21hdHJpeC1qcy1zZGsvc3JjL21hdHJpeCc7XG5pbXBvcnQgbWFwbGlicmVnbCBmcm9tICdtYXBsaWJyZS1nbCc7XG5cbmltcG9ydCB7IEljb24gYXMgTGl2ZUxvY2F0aW9uSWNvbiB9IGZyb20gJy4uLy4uLy4uLy4uL3Jlcy9pbWcvbG9jYXRpb24vbGl2ZS1sb2NhdGlvbi5zdmcnO1xuaW1wb3J0IHsgdXNlTGl2ZUJlYWNvbnMgfSBmcm9tICcuLi8uLi8uLi91dGlscy9iZWFjb24vdXNlTGl2ZUJlYWNvbnMnO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSAnLi4vLi4vLi4vY29udGV4dHMvTWF0cml4Q2xpZW50Q29udGV4dCc7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi4vZGlhbG9ncy9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi4vZGlhbG9ncy9JRGlhbG9nUHJvcHNcIjtcbmltcG9ydCBNYXAgZnJvbSAnLi4vbG9jYXRpb24vTWFwJztcbmltcG9ydCBab29tQnV0dG9ucyBmcm9tICcuLi9sb2NhdGlvbi9ab29tQnV0dG9ucyc7XG5pbXBvcnQgQmVhY29uTWFya2VyIGZyb20gJy4vQmVhY29uTWFya2VyJztcbmltcG9ydCB7IEJvdW5kcywgZ2V0QmVhY29uQm91bmRzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvYmVhY29uL2JvdW5kcyc7XG5pbXBvcnQgeyBnZXRHZW9VcmkgfSBmcm9tICcuLi8uLi8uLi91dGlscy9iZWFjb24nO1xuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgRGlhbG9nU2lkZWJhciBmcm9tICcuL0RpYWxvZ1NpZGViYXInO1xuaW1wb3J0IERpYWxvZ093bkJlYWNvblN0YXR1cyBmcm9tICcuL0RpYWxvZ093bkJlYWNvblN0YXR1cyc7XG5pbXBvcnQgQmVhY29uU3RhdHVzVG9vbHRpcCBmcm9tICcuL0JlYWNvblN0YXR1c1Rvb2x0aXAnO1xuaW1wb3J0IE1hcEZhbGxiYWNrIGZyb20gJy4uL2xvY2F0aW9uL01hcEZhbGxiYWNrJztcbmltcG9ydCB7IE1hcEVycm9yIH0gZnJvbSAnLi4vbG9jYXRpb24vTWFwRXJyb3InO1xuaW1wb3J0IHsgTG9jYXRpb25TaGFyZUVycm9yIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvbG9jYXRpb24nO1xuXG5pbnRlcmZhY2UgSVByb3BzIGV4dGVuZHMgSURpYWxvZ1Byb3BzIHtcbiAgICByb29tSWQ6IFJvb21bJ3Jvb21JZCddO1xuICAgIG1hdHJpeENsaWVudDogTWF0cml4Q2xpZW50O1xuICAgIC8vIG9wZW4gdGhlIG1hcCBjZW50ZXJlZCBvbiB0aGlzIGJlYWNvbidzIGxvY2F0aW9uXG4gICAgaW5pdGlhbEZvY3VzZWRCZWFjb24/OiBCZWFjb247XG59XG5cbi8vIHRyYWNrIHRoZSAnZm9jdXNlZCB0aW1lJyBhcyB0c1xuLy8gdG8gbWFrZSBpdCBwb3NzaWJsZSB0byByZWZvY3VzIHRoZSBzYW1lIGJlYWNvblxuLy8gYXMgdGhlIGJlYWNvbiBsb2NhdGlvbiBtYXkgY2hhbmdlXG4vLyBvciB0aGUgbWFwIG1heSBtb3ZlIGFyb3VuZFxuaW50ZXJmYWNlIEZvY3VzZWRCZWFjb25TdGF0ZSB7XG4gICAgdHM6IG51bWJlcjtcbiAgICBiZWFjb24/OiBCZWFjb247XG59XG5cbmNvbnN0IGdldEJvdW5kc0NlbnRlciA9IChib3VuZHM6IEJvdW5kcyk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKCFib3VuZHMpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gZ2V0R2VvVXJpKHtcbiAgICAgICAgbGF0aXR1ZGU6IChib3VuZHMubm9ydGggKyBib3VuZHMuc291dGgpIC8gMixcbiAgICAgICAgbG9uZ2l0dWRlOiAoYm91bmRzLmVhc3QgKyBib3VuZHMud2VzdCkgLyAyLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgfSk7XG59O1xuXG5jb25zdCB1c2VNYXBQb3NpdGlvbiA9IChsaXZlQmVhY29uczogQmVhY29uW10sIHsgYmVhY29uLCB0cyB9OiBGb2N1c2VkQmVhY29uU3RhdGUpOiB7XG4gICAgYm91bmRzPzogQm91bmRzOyBjZW50ZXJHZW9Vcmk6IHN0cmluZztcbn0gPT4ge1xuICAgIGNvbnN0IFtib3VuZHMsIHNldEJvdW5kc10gPSB1c2VTdGF0ZTxCb3VuZHMgfCB1bmRlZmluZWQ+KGdldEJlYWNvbkJvdW5kcyhsaXZlQmVhY29ucykpO1xuICAgIGNvbnN0IFtjZW50ZXJHZW9VcmksIHNldENlbnRlckdlb1VyaV0gPSB1c2VTdGF0ZTxzdHJpbmc+KFxuICAgICAgICBiZWFjb24/LmxhdGVzdExvY2F0aW9uU3RhdGU/LnVyaSB8fFxuICAgICAgICBnZXRCb3VuZHNDZW50ZXIoYm91bmRzKSxcbiAgICApO1xuXG4gICAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgLy8gdGhpcyBjaGVjayBpZ25vcmVzIHRoZSBmaXJzdCBpbml0aWFsIGZvY3VzZWQgYmVhY29uIHN0YXRlXG4gICAgICAgICAgICAvLyBhcyBjZW50ZXJpbmcgbG9naWMgb24gbWFwIHpvb21zIHRvIHNob3cgZXZlcnl0aGluZ1xuICAgICAgICAgICAgLy8gaW5zdGVhZCBvZiBmb2N1c2luZyBkb3duXG4gICAgICAgICAgICB0cyAhPT0gMCAmJlxuICAgICAgICAgICAgLy8gb25seSBzZXQgZm9jdXMgdG8gYSBrbm93biBsb2NhdGlvblxuICAgICAgICAgICAgYmVhY29uPy5sYXRlc3RMb2NhdGlvblN0YXRlPy51cmlcbiAgICAgICAgKSB7XG4gICAgICAgICAgICAvLyBhcHBlbmQgY3VzdG9tIGBteFRzYCBwYXJhbWV0ZXIgdG8gZ2VvVXJpXG4gICAgICAgICAgICAvLyBzbyBtYXAgaXMgdHJpZ2dlcmVkIHRvIHJlZm9jdXMgb24gdGhpcyB1cmlcbiAgICAgICAgICAgIC8vIGV2ZW50IGlmIGl0IHdhcyBwcmV2aW91c2x5IHRoZSBjZW50ZXIgZ2VvdXJpXG4gICAgICAgICAgICAvLyBidXQgdGhlIG1hcCBoYXZlIG1vdmVkL3pvb21lZFxuICAgICAgICAgICAgc2V0Q2VudGVyR2VvVXJpKGAke2JlYWNvbj8ubGF0ZXN0TG9jYXRpb25TdGF0ZT8udXJpfTtteFRzPSR7RGF0ZS5ub3coKX1gKTtcbiAgICAgICAgICAgIHNldEJvdW5kcyhnZXRCZWFjb25Cb3VuZHMoW2JlYWNvbl0pKTtcbiAgICAgICAgfVxuICAgIH0sIFtiZWFjb24sIHRzXSk7XG5cbiAgICByZXR1cm4geyBib3VuZHMsIGNlbnRlckdlb1VyaSB9O1xufTtcblxuLyoqXG4gKiBEaWFsb2cgdG8gdmlldyBsaXZlIGJlYWNvbnMgbWF4aW1pc2VkXG4gKi9cbmNvbnN0IEJlYWNvblZpZXdEaWFsb2c6IFJlYWN0LkZDPElQcm9wcz4gPSAoe1xuICAgIGluaXRpYWxGb2N1c2VkQmVhY29uLFxuICAgIHJvb21JZCxcbiAgICBtYXRyaXhDbGllbnQsXG4gICAgb25GaW5pc2hlZCxcbn0pID0+IHtcbiAgICBjb25zdCBsaXZlQmVhY29ucyA9IHVzZUxpdmVCZWFjb25zKHJvb21JZCwgbWF0cml4Q2xpZW50KTtcbiAgICBjb25zdCBbZm9jdXNlZEJlYWNvblN0YXRlLCBzZXRGb2N1c2VkQmVhY29uU3RhdGVdID1cbiAgICAgICAgdXNlU3RhdGU8Rm9jdXNlZEJlYWNvblN0YXRlPih7IGJlYWNvbjogaW5pdGlhbEZvY3VzZWRCZWFjb24sIHRzOiAwIH0pO1xuXG4gICAgY29uc3QgW2lzU2lkZWJhck9wZW4sIHNldFNpZGViYXJPcGVuXSA9IHVzZVN0YXRlKGZhbHNlKTtcblxuICAgIGNvbnN0IHsgYm91bmRzLCBjZW50ZXJHZW9VcmkgfSA9IHVzZU1hcFBvc2l0aW9uKGxpdmVCZWFjb25zLCBmb2N1c2VkQmVhY29uU3RhdGUpO1xuXG4gICAgY29uc3QgW21hcERpc3BsYXlFcnJvciwgc2V0TWFwRGlzcGxheUVycm9yXSA9IHVzZVN0YXRlPEVycm9yPigpO1xuXG4gICAgLy8gYXV0b21hdGljYWxseSBvcGVuIHRoZSBzaWRlYmFyIGlmIHRoZXJlIGlzIG5vIG1hcCB0byBzZWVcbiAgICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgICBpZiAobWFwRGlzcGxheUVycm9yKSB7XG4gICAgICAgICAgICBzZXRTaWRlYmFyT3Blbih0cnVlKTtcbiAgICAgICAgfVxuICAgIH0sIFttYXBEaXNwbGF5RXJyb3JdKTtcblxuICAgIGNvbnN0IG9uQmVhY29uTGlzdEl0ZW1DbGljayA9IChiZWFjb246IEJlYWNvbikgPT4ge1xuICAgICAgICBzZXRGb2N1c2VkQmVhY29uU3RhdGUoeyBiZWFjb24sIHRzOiBEYXRlLm5vdygpIH0pO1xuICAgIH07XG5cbiAgICByZXR1cm4gKFxuICAgICAgICA8QmFzZURpYWxvZ1xuICAgICAgICAgICAgY2xhc3NOYW1lPSdteF9CZWFjb25WaWV3RGlhbG9nJ1xuICAgICAgICAgICAgb25GaW5pc2hlZD17b25GaW5pc2hlZH1cbiAgICAgICAgICAgIGZpeGVkV2lkdGg9e2ZhbHNlfVxuICAgICAgICA+XG4gICAgICAgICAgICA8TWF0cml4Q2xpZW50Q29udGV4dC5Qcm92aWRlciB2YWx1ZT17bWF0cml4Q2xpZW50fT5cbiAgICAgICAgICAgICAgICB7IChjZW50ZXJHZW9VcmkgJiYgIW1hcERpc3BsYXlFcnJvcikgJiYgPE1hcFxuICAgICAgICAgICAgICAgICAgICBpZD0nbXhfQmVhY29uVmlld0RpYWxvZydcbiAgICAgICAgICAgICAgICAgICAgYm91bmRzPXtib3VuZHN9XG4gICAgICAgICAgICAgICAgICAgIGNlbnRlckdlb1VyaT17Y2VudGVyR2VvVXJpfVxuICAgICAgICAgICAgICAgICAgICBpbnRlcmFjdGl2ZVxuICAgICAgICAgICAgICAgICAgICBvbkVycm9yPXtzZXRNYXBEaXNwbGF5RXJyb3J9XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0JlYWNvblZpZXdEaWFsb2dfbWFwXCJcbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICh7IG1hcCB9OiB7IG1hcDogbWFwbGlicmVnbC5NYXB9KSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDw+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgbGl2ZUJlYWNvbnMubWFwKGJlYWNvbiA9PiA8QmVhY29uTWFya2VyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9e2JlYWNvbi5pZGVudGlmaWVyfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwPXttYXB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWFjb249e2JlYWNvbn1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2x0aXA9ezxCZWFjb25TdGF0dXNUb29sdGlwIGJlYWNvbj17YmVhY29ufSAvPn1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLz4pIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPFpvb21CdXR0b25zIG1hcD17bWFwfSAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvPlxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgPC9NYXA+IH1cbiAgICAgICAgICAgICAgICB7IG1hcERpc3BsYXlFcnJvciAmJlxuICAgICAgICAgICAgICAgICAgICA8TWFwRXJyb3JcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yPXttYXBEaXNwbGF5RXJyb3IubWVzc2FnZSBhcyBMb2NhdGlvblNoYXJlRXJyb3J9XG4gICAgICAgICAgICAgICAgICAgICAgICBpc01pbmltaXNlZFxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB7ICFjZW50ZXJHZW9VcmkgJiYgIW1hcERpc3BsYXlFcnJvciAmJlxuICAgICAgICAgICAgICAgICAgICA8TWFwRmFsbGJhY2tcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEtdGVzdC1pZD0nYmVhY29uLXZpZXctZGlhbG9nLW1hcC1mYWxsYmFjaydcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0nbXhfQmVhY29uVmlld0RpYWxvZ19tYXAnXG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0nbXhfQmVhY29uVmlld0RpYWxvZ19tYXBGYWxsYmFja01lc3NhZ2UnPnsgX3QoJ05vIGxpdmUgbG9jYXRpb25zJykgfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZD0ncHJpbWFyeSdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtvbkZpbmlzaGVkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEtdGVzdC1pZD0nYmVhY29uLXZpZXctZGlhbG9nLWZhbGxiYWNrLWNsb3NlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgX3QoJ0Nsb3NlJykgfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9BY2Nlc3NpYmxlQnV0dG9uPlxuICAgICAgICAgICAgICAgICAgICA8L01hcEZhbGxiYWNrPlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB7IGlzU2lkZWJhck9wZW4gP1xuICAgICAgICAgICAgICAgICAgICA8RGlhbG9nU2lkZWJhciBiZWFjb25zPXtsaXZlQmVhY29uc30gb25CZWFjb25DbGljaz17b25CZWFjb25MaXN0SXRlbUNsaWNrfSByZXF1ZXN0Q2xvc2U9eygpID0+IHNldFNpZGViYXJPcGVuKGZhbHNlKX0gLz4gOlxuICAgICAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAgICAga2luZD0ncHJpbWFyeSdcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHNldFNpZGViYXJPcGVuKHRydWUpfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS10ZXN0LWlkPSdiZWFjb24tdmlldy1kaWFsb2ctb3Blbi1zaWRlYmFyJ1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSdteF9CZWFjb25WaWV3RGlhbG9nX3ZpZXdMaXN0QnV0dG9uJ1xuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICA8TGl2ZUxvY2F0aW9uSWNvbiBoZWlnaHQ9ezEyfSAvPiZuYnNwO1xuICAgICAgICAgICAgICAgICAgICAgICAgeyBfdCgnVmlldyBsaXN0JykgfVxuICAgICAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDxEaWFsb2dPd25CZWFjb25TdGF0dXMgcm9vbUlkPXtyb29tSWR9IC8+XG4gICAgICAgICAgICA8L01hdHJpeENsaWVudENvbnRleHQuUHJvdmlkZXI+XG4gICAgICAgIDwvQmFzZURpYWxvZz5cbiAgICApO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgQmVhY29uVmlld0RpYWxvZztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBZ0JBOztBQVFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUF4Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBNkNBLE1BQU1BLGVBQWUsR0FBSUMsTUFBRCxJQUF3QztFQUM1RCxJQUFJLENBQUNBLE1BQUwsRUFBYTtJQUNUO0VBQ0g7O0VBQ0QsT0FBTyxJQUFBQyxpQkFBQSxFQUFVO0lBQ2JDLFFBQVEsRUFBRSxDQUFDRixNQUFNLENBQUNHLEtBQVAsR0FBZUgsTUFBTSxDQUFDSSxLQUF2QixJQUFnQyxDQUQ3QjtJQUViQyxTQUFTLEVBQUUsQ0FBQ0wsTUFBTSxDQUFDTSxJQUFQLEdBQWNOLE1BQU0sQ0FBQ08sSUFBdEIsSUFBOEIsQ0FGNUI7SUFHYkMsU0FBUyxFQUFFQyxJQUFJLENBQUNDLEdBQUw7RUFIRSxDQUFWLENBQVA7QUFLSCxDQVREOztBQVdBLE1BQU1DLGNBQWMsR0FBRyxDQUFDQyxXQUFELFdBRWxCO0VBQUEsSUFGMEM7SUFBRUMsTUFBRjtJQUFVQztFQUFWLENBRTFDO0VBQ0QsTUFBTSxDQUFDZCxNQUFELEVBQVNlLFNBQVQsSUFB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