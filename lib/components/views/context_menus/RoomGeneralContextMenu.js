"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RoomGeneralContextMenu = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _logger = require("matrix-js-sdk/src/logger");

var _react = _interopRequireWildcard(require("react"));

var _KeyboardShortcuts = require("../../../accessibility/KeyboardShortcuts");

var _RoomListActions = _interopRequireDefault(require("../../../actions/RoomListActions"));

var _MatrixClientContext = _interopRequireDefault(require("../../../contexts/MatrixClientContext"));

var _dispatcher = _interopRequireDefault(require("../../../dispatcher/dispatcher"));

var _useEventEmitter = require("../../../hooks/useEventEmitter");

var _KeyBindingsManager = require("../../../KeyBindingsManager");

var _languageHandler = require("../../../languageHandler");

var _models = require("../../../stores/room-list/models");

var _RoomListStore = _interopRequireWildcard(require("../../../stores/room-list/RoomListStore"));

var _DMRoomMap = _interopRequireDefault(require("../../../utils/DMRoomMap"));

var _IconizedContextMenu = _interopRequireWildcard(require("../context_menus/IconizedContextMenu"));

const _excluded = ["room", "onFinished", "onPostFavoriteClick", "onPostLowPriorityClick", "onPostInviteClick", "onPostCopyLinkClick", "onPostSettingsClick", "onPostLeaveClick", "onPostForgetClick"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

const RoomGeneralContextMenu = _ref => {
  let {
    room,
    onFinished,
    onPostFavoriteClick,
    onPostLowPriorityClick,
    onPostInviteClick,
    onPostCopyLinkClick,
    onPostSettingsClick,
    onPostLeaveClick,
    onPostForgetClick
  } = _ref,
      props = (0, _objectWithoutProperties2.default)(_ref, _excluded);
  const cli = (0, _react.useContext)(_MatrixClientContext.default);
  const roomTags = (0, _useEventEmitter.useEventEmitterState)(_RoomListStore.default.instance, _RoomListStore.LISTS_UPDATE_EVENT, () => _RoomListStore.default.instance.getTagsForRoom(room));

  const isDm = _DMRoomMap.default.shared().getUserIdForRoomId(room.roomId);

  const wrapHandler = function (handler, postHandler) {
    let persistent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    return ev => {
      ev.preventDefault();
      ev.stopPropagation();
      handler(ev);
      const action = (0, _KeyBindingsManager.getKeyBindingsManager)().getAccessibilityAction(ev);

      if (!persistent || action === _KeyboardShortcuts.KeyBindingAction.Enter) {
        onFinished();
      }

      postHandler?.(ev);
    };
  };

  const onTagRoom = (ev, tagId) => {
    if (tagId === _models.DefaultTagID.Favourite || tagId === _models.DefaultTagID.LowPriority) {
      const inverseTag = tagId === _models.DefaultTagID.Favourite ? _models.DefaultTagID.LowPriority : _models.DefaultTagID.Favourite;

      const isApplied = _RoomListStore.default.instance.getTagsForRoom(room).includes(tagId);

      const removeTag = isApplied ? tagId : inverseTag;
      const addTag = isApplied ? null : tagId;

      _dispatcher.default.dispatch(_RoomListActions.default.tagRoom(cli, room, removeTag, addTag, undefined, 0));
    } else {
      _logger.logger.warn(`Unexpected tag ${tagId} applied to ${room.roomId}`);
    }
  };

  const isFavorite = roomTags.includes(_models.DefaultTagID.Favourite);

  const favoriteOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuCheckbox, {
    onClick: wrapHandler(ev => onTagRoom(ev, _models.DefaultTagID.Favourite), onPostFavoriteClick, true),
    active: isFavorite,
    label: isFavorite ? (0, _languageHandler._t)("Favourited") : (0, _languageHandler._t)("Favourite"),
    iconClassName: "mx_RoomGeneralContextMenu_iconStar"
  });

  const isLowPriority = roomTags.includes(_models.DefaultTagID.LowPriority);

  const lowPriorityOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuCheckbox, {
    onClick: wrapHandler(ev => onTagRoom(ev, _models.DefaultTagID.LowPriority), onPostLowPriorityClick, true),
    active: isLowPriority,
    label: (0, _languageHandler._t)("Low Priority"),
    iconClassName: "mx_RoomGeneralContextMenu_iconArrowDown"
  });

  let inviteOption;

  if (room.canInvite(cli.getUserId()) && !isDm) {
    inviteOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: wrapHandler(() => _dispatcher.default.dispatch({
        action: "view_invite",
        roomId: room.roomId
      }), onPostInviteClick),
      label: (0, _languageHandler._t)("Invite"),
      iconClassName: "mx_RoomGeneralContextMenu_iconInvite"
    });
  }

  let copyLinkOption;

  if (!isDm) {
    copyLinkOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: wrapHandler(() => _dispatcher.default.dispatch({
        action: "copy_room",
        room_id: room.roomId
      }), onPostCopyLinkClick),
      label: (0, _languageHandler._t)("Copy room link"),
      iconClassName: "mx_RoomGeneralContextMenu_iconCopyLink"
    });
  }

  const settingsOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
    onClick: wrapHandler(() => _dispatcher.default.dispatch({
      action: "open_room_settings",
      room_id: room.roomId
    }), onPostSettingsClick),
    label: (0, _languageHandler._t)("Settings"),
    iconClassName: "mx_RoomGeneralContextMenu_iconSettings"
  });

  let leaveOption;

  if (roomTags.includes(_models.DefaultTagID.Archived)) {
    leaveOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      iconClassName: "mx_RoomGeneralContextMenu_iconSignOut",
      label: (0, _languageHandler._t)("Forget Room"),
      className: "mx_IconizedContextMenu_option_red",
      onClick: wrapHandler(() => _dispatcher.default.dispatch({
        action: "forget_room",
        room_id: room.roomId
      }), onPostForgetClick)
    });
  } else {
    leaveOption = /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOption, {
      onClick: wrapHandler(() => _dispatcher.default.dispatch({
        action: "leave_room",
        room_id: room.roomId
      }), onPostLeaveClick),
      label: (0, _languageHandler._t)("Leave"),
      className: "mx_IconizedContextMenu_option_red",
      iconClassName: "mx_RoomGeneralContextMenu_iconSignOut"
    });
  }

  return /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.default, (0, _extends2.default)({}, props, {
    onFinished: onFinished,
    className: "mx_RoomGeneralContextMenu",
    compact: true
  }), !roomTags.includes(_models.DefaultTagID.Archived) && /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOptionList, null, favoriteOption, lowPriorityOption, inviteOption, copyLinkOption, settingsOption), /*#__PURE__*/_react.default.createElement(_IconizedContextMenu.IconizedContextMenuOptionList, {
    red: true
  }, leaveOption));
};

exports.RoomGeneralContextMenu = RoomGeneralContextMenu;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSb29tR2VuZXJhbENvbnRleHRNZW51Iiwicm9vbSIsIm9uRmluaXNoZWQiLCJvblBvc3RGYXZvcml0ZUNsaWNrIiwib25Qb3N0TG93UHJpb3JpdHlDbGljayIsIm9uUG9zdEludml0ZUNsaWNrIiwib25Qb3N0Q29weUxpbmtDbGljayIsIm9uUG9zdFNldHRpbmdzQ2xpY2siLCJvblBvc3RMZWF2ZUNsaWNrIiwib25Qb3N0Rm9yZ2V0Q2xpY2siLCJwcm9wcyIsImNsaSIsInVzZUNvbnRleHQiLCJNYXRyaXhDbGllbnRDb250ZXh0Iiwicm9vbVRhZ3MiLCJ1c2VFdmVudEVtaXR0ZXJTdGF0ZSIsIlJvb21MaXN0U3RvcmUiLCJpbnN0YW5jZSIsIkxJU1RTX1VQREFURV9FVkVOVCIsImdldFRhZ3NGb3JSb29tIiwiaXNEbSIsIkRNUm9vbU1hcCIsInNoYXJlZCIsImdldFVzZXJJZEZvclJvb21JZCIsInJvb21JZCIsIndyYXBIYW5kbGVyIiwiaGFuZGxlciIsInBvc3RIYW5kbGVyIiwicGVyc2lzdGVudCIsImV2IiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJhY3Rpb24iLCJnZXRLZXlCaW5kaW5nc01hbmFnZXIiLCJnZXRBY2Nlc3NpYmlsaXR5QWN0aW9uIiwiS2V5QmluZGluZ0FjdGlvbiIsIkVudGVyIiwib25UYWdSb29tIiwidGFnSWQiLCJEZWZhdWx0VGFnSUQiLCJGYXZvdXJpdGUiLCJMb3dQcmlvcml0eSIsImludmVyc2VUYWciLCJpc0FwcGxpZWQiLCJpbmNsdWRlcyIsInJlbW92ZVRhZyIsImFkZFRhZyIsImRpcyIsImRpc3BhdGNoIiwiUm9vbUxpc3RBY3Rpb25zIiwidGFnUm9vbSIsInVuZGVmaW5lZCIsImxvZ2dlciIsIndhcm4iLCJpc0Zhdm9yaXRlIiwiZmF2b3JpdGVPcHRpb24iLCJfdCIsImlzTG93UHJpb3JpdHkiLCJsb3dQcmlvcml0eU9wdGlvbiIsImludml0ZU9wdGlvbiIsImNhbkludml0ZSIsImdldFVzZXJJZCIsImNvcHlMaW5rT3B0aW9uIiwicm9vbV9pZCIsInNldHRpbmdzT3B0aW9uIiwibGVhdmVPcHRpb24iLCJBcmNoaXZlZCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL3ZpZXdzL2NvbnRleHRfbWVudXMvUm9vbUdlbmVyYWxDb250ZXh0TWVudS50c3giXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDIxIFRoZSBNYXRyaXgub3JnIEZvdW5kYXRpb24gQy5JLkMuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJtYXRyaXgtanMtc2RrL3NyYy9tb2RlbHMvcm9vbVwiO1xuaW1wb3J0IFJlYWN0LCB7IHVzZUNvbnRleHQgfSBmcm9tIFwicmVhY3RcIjtcblxuaW1wb3J0IHsgS2V5QmluZGluZ0FjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9hY2Nlc3NpYmlsaXR5L0tleWJvYXJkU2hvcnRjdXRzXCI7XG5pbXBvcnQgUm9vbUxpc3RBY3Rpb25zIGZyb20gXCIuLi8uLi8uLi9hY3Rpb25zL1Jvb21MaXN0QWN0aW9uc1wiO1xuaW1wb3J0IE1hdHJpeENsaWVudENvbnRleHQgZnJvbSBcIi4uLy4uLy4uL2NvbnRleHRzL01hdHJpeENsaWVudENvbnRleHRcIjtcbmltcG9ydCBkaXMgZnJvbSBcIi4uLy4uLy4uL2Rpc3BhdGNoZXIvZGlzcGF0Y2hlclwiO1xuaW1wb3J0IHsgdXNlRXZlbnRFbWl0dGVyU3RhdGUgfSBmcm9tIFwiLi4vLi4vLi4vaG9va3MvdXNlRXZlbnRFbWl0dGVyXCI7XG5pbXBvcnQgeyBnZXRLZXlCaW5kaW5nc01hbmFnZXIgfSBmcm9tIFwiLi4vLi4vLi4vS2V5QmluZGluZ3NNYW5hZ2VyXCI7XG5pbXBvcnQgeyBfdCB9IGZyb20gXCIuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXJcIjtcbmltcG9ydCB7IERlZmF1bHRUYWdJRCwgVGFnSUQgfSBmcm9tIFwiLi4vLi4vLi4vc3RvcmVzL3Jvb20tbGlzdC9tb2RlbHNcIjtcbmltcG9ydCBSb29tTGlzdFN0b3JlLCB7IExJU1RTX1VQREFURV9FVkVOVCB9IGZyb20gXCIuLi8uLi8uLi9zdG9yZXMvcm9vbS1saXN0L1Jvb21MaXN0U3RvcmVcIjtcbmltcG9ydCBETVJvb21NYXAgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL0RNUm9vbU1hcFwiO1xuaW1wb3J0IHsgSVByb3BzIGFzIElDb250ZXh0TWVudVByb3BzIH0gZnJvbSBcIi4uLy4uL3N0cnVjdHVyZXMvQ29udGV4dE1lbnVcIjtcbmltcG9ydCBJY29uaXplZENvbnRleHRNZW51LCB7XG4gICAgSWNvbml6ZWRDb250ZXh0TWVudUNoZWNrYm94LFxuICAgIEljb25pemVkQ29udGV4dE1lbnVPcHRpb24sXG4gICAgSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3QsXG59IGZyb20gXCIuLi9jb250ZXh0X21lbnVzL0ljb25pemVkQ29udGV4dE1lbnVcIjtcbmltcG9ydCB7IEJ1dHRvbkV2ZW50IH0gZnJvbSBcIi4uL2VsZW1lbnRzL0FjY2Vzc2libGVCdXR0b25cIjtcblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElDb250ZXh0TWVudVByb3BzIHtcbiAgICByb29tOiBSb29tO1xuICAgIG9uUG9zdEZhdm9yaXRlQ2xpY2s/OiAoZXZlbnQ6IEJ1dHRvbkV2ZW50KSA9PiB2b2lkO1xuICAgIG9uUG9zdExvd1ByaW9yaXR5Q2xpY2s/OiAoZXZlbnQ6IEJ1dHRvbkV2ZW50KSA9PiB2b2lkO1xuICAgIG9uUG9zdEludml0ZUNsaWNrPzogKGV2ZW50OiBCdXR0b25FdmVudCkgPT4gdm9pZDtcbiAgICBvblBvc3RDb3B5TGlua0NsaWNrPzogKGV2ZW50OiBCdXR0b25FdmVudCkgPT4gdm9pZDtcbiAgICBvblBvc3RTZXR0aW5nc0NsaWNrPzogKGV2ZW50OiBCdXR0b25FdmVudCkgPT4gdm9pZDtcbiAgICBvblBvc3RGb3JnZXRDbGljaz86IChldmVudDogQnV0dG9uRXZlbnQpID0+IHZvaWQ7XG4gICAgb25Qb3N0TGVhdmVDbGljaz86IChldmVudDogQnV0dG9uRXZlbnQpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBjb25zdCBSb29tR2VuZXJhbENvbnRleHRNZW51ID0gKHtcbiAgICByb29tLCBvbkZpbmlzaGVkLFxuICAgIG9uUG9zdEZhdm9yaXRlQ2xpY2ssIG9uUG9zdExvd1ByaW9yaXR5Q2xpY2ssIG9uUG9zdEludml0ZUNsaWNrLCBvblBvc3RDb3B5TGlua0NsaWNrLCBvblBvc3RTZXR0aW5nc0NsaWNrLFxuICAgIG9uUG9zdExlYXZlQ2xpY2ssIG9uUG9zdEZvcmdldENsaWNrLCAuLi5wcm9wc1xufTogSVByb3BzKSA9PiB7XG4gICAgY29uc3QgY2xpID0gdXNlQ29udGV4dChNYXRyaXhDbGllbnRDb250ZXh0KTtcbiAgICBjb25zdCByb29tVGFncyA9IHVzZUV2ZW50RW1pdHRlclN0YXRlKFxuICAgICAgICBSb29tTGlzdFN0b3JlLmluc3RhbmNlLFxuICAgICAgICBMSVNUU19VUERBVEVfRVZFTlQsXG4gICAgICAgICgpID0+IFJvb21MaXN0U3RvcmUuaW5zdGFuY2UuZ2V0VGFnc0ZvclJvb20ocm9vbSksXG4gICAgKTtcbiAgICBjb25zdCBpc0RtID0gRE1Sb29tTWFwLnNoYXJlZCgpLmdldFVzZXJJZEZvclJvb21JZChyb29tLnJvb21JZCk7XG4gICAgY29uc3Qgd3JhcEhhbmRsZXIgPSAoXG4gICAgICAgIGhhbmRsZXI6IChldjogQnV0dG9uRXZlbnQpID0+IHZvaWQsXG4gICAgICAgIHBvc3RIYW5kbGVyPzogKGV2OiBCdXR0b25FdmVudCkgPT4gdm9pZCxcbiAgICAgICAgcGVyc2lzdGVudCA9IGZhbHNlLFxuICAgICk6IChldjogQnV0dG9uRXZlbnQpID0+IHZvaWQgPT4ge1xuICAgICAgICByZXR1cm4gKGV2OiBCdXR0b25FdmVudCkgPT4ge1xuICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICAgICAgICBoYW5kbGVyKGV2KTtcblxuICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gZ2V0S2V5QmluZGluZ3NNYW5hZ2VyKCkuZ2V0QWNjZXNzaWJpbGl0eUFjdGlvbihldiBhcyBSZWFjdC5LZXlib2FyZEV2ZW50KTtcbiAgICAgICAgICAgIGlmICghcGVyc2lzdGVudCB8fCBhY3Rpb24gPT09IEtleUJpbmRpbmdBY3Rpb24uRW50ZXIpIHtcbiAgICAgICAgICAgICAgICBvbkZpbmlzaGVkKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwb3N0SGFuZGxlcj8uKGV2KTtcbiAgICAgICAgfTtcbiAgICB9O1xuXG4gICAgY29uc3Qgb25UYWdSb29tID0gKGV2OiBCdXR0b25FdmVudCwgdGFnSWQ6IFRhZ0lEKSA9PiB7XG4gICAgICAgIGlmICh0YWdJZCA9PT0gRGVmYXVsdFRhZ0lELkZhdm91cml0ZSB8fCB0YWdJZCA9PT0gRGVmYXVsdFRhZ0lELkxvd1ByaW9yaXR5KSB7XG4gICAgICAgICAgICBjb25zdCBpbnZlcnNlVGFnID0gdGFnSWQgPT09IERlZmF1bHRUYWdJRC5GYXZvdXJpdGUgPyBEZWZhdWx0VGFnSUQuTG93UHJpb3JpdHkgOiBEZWZhdWx0VGFnSUQuRmF2b3VyaXRlO1xuICAgICAgICAgICAgY29uc3QgaXNBcHBsaWVkID0gUm9vbUxpc3RTdG9yZS5pbnN0YW5jZS5nZXRUYWdzRm9yUm9vbShyb29tKS5pbmNsdWRlcyh0YWdJZCk7XG4gICAgICAgICAgICBjb25zdCByZW1vdmVUYWcgPSBpc0FwcGxpZWQgPyB0YWdJZCA6IGludmVyc2VUYWc7XG4gICAgICAgICAgICBjb25zdCBhZGRUYWcgPSBpc0FwcGxpZWQgPyBudWxsIDogdGFnSWQ7XG4gICAgICAgICAgICBkaXMuZGlzcGF0Y2goUm9vbUxpc3RBY3Rpb25zLnRhZ1Jvb20oY2xpLCByb29tLCByZW1vdmVUYWcsIGFkZFRhZywgdW5kZWZpbmVkLCAwKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybihgVW5leHBlY3RlZCB0YWcgJHt0YWdJZH0gYXBwbGllZCB0byAke3Jvb20ucm9vbUlkfWApO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGlzRmF2b3JpdGUgPSByb29tVGFncy5pbmNsdWRlcyhEZWZhdWx0VGFnSUQuRmF2b3VyaXRlKTtcbiAgICBjb25zdCBmYXZvcml0ZU9wdGlvbjogSlNYLkVsZW1lbnQgPSA8SWNvbml6ZWRDb250ZXh0TWVudUNoZWNrYm94XG4gICAgICAgIG9uQ2xpY2s9e3dyYXBIYW5kbGVyKChldikgPT5cbiAgICAgICAgICAgIG9uVGFnUm9vbShldiwgRGVmYXVsdFRhZ0lELkZhdm91cml0ZSksIG9uUG9zdEZhdm9yaXRlQ2xpY2ssIHRydWUpfVxuICAgICAgICBhY3RpdmU9e2lzRmF2b3JpdGV9XG4gICAgICAgIGxhYmVsPXtpc0Zhdm9yaXRlID8gX3QoXCJGYXZvdXJpdGVkXCIpIDogX3QoXCJGYXZvdXJpdGVcIil9XG4gICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tR2VuZXJhbENvbnRleHRNZW51X2ljb25TdGFyXCJcbiAgICAvPjtcblxuICAgIGNvbnN0IGlzTG93UHJpb3JpdHkgPSByb29tVGFncy5pbmNsdWRlcyhEZWZhdWx0VGFnSUQuTG93UHJpb3JpdHkpO1xuICAgIGNvbnN0IGxvd1ByaW9yaXR5T3B0aW9uOiBKU1guRWxlbWVudCA9IDxJY29uaXplZENvbnRleHRNZW51Q2hlY2tib3hcbiAgICAgICAgb25DbGljaz17d3JhcEhhbmRsZXIoKGV2KSA9PlxuICAgICAgICAgICAgb25UYWdSb29tKGV2LCBEZWZhdWx0VGFnSUQuTG93UHJpb3JpdHkpLCBvblBvc3RMb3dQcmlvcml0eUNsaWNrLCB0cnVlKX1cbiAgICAgICAgYWN0aXZlPXtpc0xvd1ByaW9yaXR5fVxuICAgICAgICBsYWJlbD17X3QoXCJMb3cgUHJpb3JpdHlcIil9XG4gICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tR2VuZXJhbENvbnRleHRNZW51X2ljb25BcnJvd0Rvd25cIlxuICAgIC8+O1xuXG4gICAgbGV0IGludml0ZU9wdGlvbjogSlNYLkVsZW1lbnQ7XG4gICAgaWYgKHJvb20uY2FuSW52aXRlKGNsaS5nZXRVc2VySWQoKSkgJiYgIWlzRG0pIHtcbiAgICAgICAgaW52aXRlT3B0aW9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgIG9uQ2xpY2s9e3dyYXBIYW5kbGVyKCgpID0+IGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiBcInZpZXdfaW52aXRlXCIsXG4gICAgICAgICAgICAgICAgcm9vbUlkOiByb29tLnJvb21JZCxcbiAgICAgICAgICAgIH0pLCBvblBvc3RJbnZpdGVDbGljayl9XG4gICAgICAgICAgICBsYWJlbD17X3QoXCJJbnZpdGVcIil9XG4gICAgICAgICAgICBpY29uQ2xhc3NOYW1lPVwibXhfUm9vbUdlbmVyYWxDb250ZXh0TWVudV9pY29uSW52aXRlXCJcbiAgICAgICAgLz47XG4gICAgfVxuXG4gICAgbGV0IGNvcHlMaW5rT3B0aW9uOiBKU1guRWxlbWVudDtcbiAgICBpZiAoIWlzRG0pIHtcbiAgICAgICAgY29weUxpbmtPcHRpb24gPSA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgb25DbGljaz17d3JhcEhhbmRsZXIoKCkgPT4gZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICBhY3Rpb246IFwiY29weV9yb29tXCIsXG4gICAgICAgICAgICAgICAgcm9vbV9pZDogcm9vbS5yb29tSWQsXG4gICAgICAgICAgICB9KSwgb25Qb3N0Q29weUxpbmtDbGljayl9XG4gICAgICAgICAgICBsYWJlbD17X3QoXCJDb3B5IHJvb20gbGlua1wiKX1cbiAgICAgICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tR2VuZXJhbENvbnRleHRNZW51X2ljb25Db3B5TGlua1wiXG4gICAgICAgIC8+O1xuICAgIH1cblxuICAgIGNvbnN0IHNldHRpbmdzT3B0aW9uOiBKU1guRWxlbWVudCA9IDxJY29uaXplZENvbnRleHRNZW51T3B0aW9uXG4gICAgICAgIG9uQ2xpY2s9e3dyYXBIYW5kbGVyKCgpID0+IGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBhY3Rpb246IFwib3Blbl9yb29tX3NldHRpbmdzXCIsXG4gICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgfSksIG9uUG9zdFNldHRpbmdzQ2xpY2spfVxuICAgICAgICBsYWJlbD17X3QoXCJTZXR0aW5nc1wiKX1cbiAgICAgICAgaWNvbkNsYXNzTmFtZT1cIm14X1Jvb21HZW5lcmFsQ29udGV4dE1lbnVfaWNvblNldHRpbmdzXCJcbiAgICAvPjtcblxuICAgIGxldCBsZWF2ZU9wdGlvbjogSlNYLkVsZW1lbnQ7XG4gICAgaWYgKHJvb21UYWdzLmluY2x1ZGVzKERlZmF1bHRUYWdJRC5BcmNoaXZlZCkpIHtcbiAgICAgICAgbGVhdmVPcHRpb24gPSA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvblxuICAgICAgICAgICAgaWNvbkNsYXNzTmFtZT1cIm14X1Jvb21HZW5lcmFsQ29udGV4dE1lbnVfaWNvblNpZ25PdXRcIlxuICAgICAgICAgICAgbGFiZWw9e190KFwiRm9yZ2V0IFJvb21cIil9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCJteF9JY29uaXplZENvbnRleHRNZW51X29wdGlvbl9yZWRcIlxuICAgICAgICAgICAgb25DbGljaz17d3JhcEhhbmRsZXIoKCkgPT4gZGlzLmRpc3BhdGNoKHtcbiAgICAgICAgICAgICAgICBhY3Rpb246IFwiZm9yZ2V0X3Jvb21cIixcbiAgICAgICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgICAgIH0pLCBvblBvc3RGb3JnZXRDbGljayl9XG4gICAgICAgIC8+O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxlYXZlT3B0aW9uID0gPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25cbiAgICAgICAgICAgIG9uQ2xpY2s9e3dyYXBIYW5kbGVyKCgpID0+IGRpcy5kaXNwYXRjaCh7XG4gICAgICAgICAgICAgICAgYWN0aW9uOiBcImxlYXZlX3Jvb21cIixcbiAgICAgICAgICAgICAgICByb29tX2lkOiByb29tLnJvb21JZCxcbiAgICAgICAgICAgIH0pLCBvblBvc3RMZWF2ZUNsaWNrKX1cbiAgICAgICAgICAgIGxhYmVsPXtfdChcIkxlYXZlXCIpfVxuICAgICAgICAgICAgY2xhc3NOYW1lPVwibXhfSWNvbml6ZWRDb250ZXh0TWVudV9vcHRpb25fcmVkXCJcbiAgICAgICAgICAgIGljb25DbGFzc05hbWU9XCJteF9Sb29tR2VuZXJhbENvbnRleHRNZW51X2ljb25TaWduT3V0XCJcbiAgICAgICAgLz47XG4gICAgfVxuXG4gICAgcmV0dXJuIDxJY29uaXplZENvbnRleHRNZW51XG4gICAgICAgIHsuLi5wcm9wc31cbiAgICAgICAgb25GaW5pc2hlZD17b25GaW5pc2hlZH1cbiAgICAgICAgY2xhc3NOYW1lPVwibXhfUm9vbUdlbmVyYWxDb250ZXh0TWVudVwiXG4gICAgICAgIGNvbXBhY3RcbiAgICA+XG4gICAgICAgIHsgIXJvb21UYWdzLmluY2x1ZGVzKERlZmF1bHRUYWdJRC5BcmNoaXZlZCkgJiYgKFxuICAgICAgICAgICAgPEljb25pemVkQ29udGV4dE1lbnVPcHRpb25MaXN0PlxuICAgICAgICAgICAgICAgIHsgZmF2b3JpdGVPcHRpb24gfVxuICAgICAgICAgICAgICAgIHsgbG93UHJpb3JpdHlPcHRpb24gfVxuICAgICAgICAgICAgICAgIHsgaW52aXRlT3B0aW9uIH1cbiAgICAgICAgICAgICAgICB7IGNvcHlMaW5rT3B0aW9uIH1cbiAgICAgICAgICAgICAgICB7IHNldHRpbmdzT3B0aW9uIH1cbiAgICAgICAgICAgIDwvSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3Q+XG4gICAgICAgICkgfVxuICAgICAgICA8SWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3QgcmVkPlxuICAgICAgICAgICAgeyBsZWF2ZU9wdGlvbiB9XG4gICAgICAgIDwvSWNvbml6ZWRDb250ZXh0TWVudU9wdGlvbkxpc3Q+XG4gICAgPC9JY29uaXplZENvbnRleHRNZW51Pjtcbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFnQkE7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7Ozs7O0FBa0JPLE1BQU1BLHNCQUFzQixHQUFHLFFBSXhCO0VBQUEsSUFKeUI7SUFDbkNDLElBRG1DO0lBQzdCQyxVQUQ2QjtJQUVuQ0MsbUJBRm1DO0lBRWRDLHNCQUZjO0lBRVVDLGlCQUZWO0lBRTZCQyxtQkFGN0I7SUFFa0RDLG1C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