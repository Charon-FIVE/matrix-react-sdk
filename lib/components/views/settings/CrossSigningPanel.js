"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _matrix = require("matrix-js-sdk/src/matrix");

var _logger = require("matrix-js-sdk/src/logger");

var _crypto = require("matrix-js-sdk/src/crypto");

var _MatrixClientPeg = require("../../../MatrixClientPeg");

var _languageHandler = require("../../../languageHandler");

var _Modal = _interopRequireDefault(require("../../../Modal"));

var _Spinner = _interopRequireDefault(require("../elements/Spinner"));

var _InteractiveAuthDialog = _interopRequireDefault(require("../dialogs/InteractiveAuthDialog"));

var _ConfirmDestroyCrossSigningDialog = _interopRequireDefault(require("../dialogs/security/ConfirmDestroyCrossSigningDialog"));

var _SetupEncryptionDialog = _interopRequireDefault(require("../dialogs/security/SetupEncryptionDialog"));

var _SecurityManager = require("../../../SecurityManager");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

/*
Copyright 2019, 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class CrossSigningPanel extends _react.default.PureComponent {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "unmounted", false);
    (0, _defineProperty2.default)(this, "onAccountData", event => {
      const type = event.getType();

      if (type.startsWith("m.cross_signing") || type.startsWith("m.secret_storage")) {
        this.getUpdatedStatus();
      }
    });
    (0, _defineProperty2.default)(this, "onBootstrapClick", () => {
      if (this.state.crossSigningPrivateKeysInStorage) {
        _Modal.default.createDialog(_SetupEncryptionDialog.default, {}, null,
        /* priority = */
        false,
        /* static = */
        true);
      } else {
        // Trigger the flow to set up secure backup, which is what this will do when in
        // the appropriate state.
        (0, _SecurityManager.accessSecretStorage)();
      }
    });
    (0, _defineProperty2.default)(this, "onStatusChanged", () => {
      this.getUpdatedStatus();
    });
    (0, _defineProperty2.default)(this, "bootstrapCrossSigning", async _ref => {
      let {
        forceReset = false
      } = _ref;
      this.setState({
        error: undefined
      });

      try {
        const cli = _MatrixClientPeg.MatrixClientPeg.get();

        await cli.bootstrapCrossSigning({
          authUploadDeviceSigningKeys: async makeRequest => {
            const {
              finished
            } = _Modal.default.createDialog(_InteractiveAuthDialog.default, {
              title: (0, _languageHandler._t)("Setting up keys"),
              matrixClient: cli,
              makeRequest
            });

            const [confirmed] = await finished;

            if (!confirmed) {
              throw new Error("Cross-signing key upload auth canceled");
            }
          },
          setupNewCrossSigning: forceReset
        });
      } catch (e) {
        this.setState({
          error: e
        });

        _logger.logger.error("Error bootstrapping cross-signing", e);
      }

      if (this.unmounted) return;
      this.getUpdatedStatus();
    });
    (0, _defineProperty2.default)(this, "resetCrossSigning", () => {
      _Modal.default.createDialog(_ConfirmDestroyCrossSigningDialog.default, {
        onFinished: act => {
          if (!act) return;
          this.bootstrapCrossSigning({
            forceReset: true
          });
        }
      });
    });
    this.state = {};
  }

  componentDidMount() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    cli.on(_matrix.ClientEvent.AccountData, this.onAccountData);
    cli.on(_crypto.CryptoEvent.UserTrustStatusChanged, this.onStatusChanged);
    cli.on(_crypto.CryptoEvent.KeysChanged, this.onStatusChanged);
    this.getUpdatedStatus();
  }

  componentWillUnmount() {
    this.unmounted = true;

    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    if (!cli) return;
    cli.removeListener(_matrix.ClientEvent.AccountData, this.onAccountData);
    cli.removeListener(_crypto.CryptoEvent.UserTrustStatusChanged, this.onStatusChanged);
    cli.removeListener(_crypto.CryptoEvent.KeysChanged, this.onStatusChanged);
  }

  async getUpdatedStatus() {
    const cli = _MatrixClientPeg.MatrixClientPeg.get();

    const pkCache = cli.getCrossSigningCacheCallbacks();
    const crossSigning = cli.crypto.crossSigningInfo;
    const secretStorage = cli.crypto.secretStorage;
    const crossSigningPublicKeysOnDevice = Boolean(crossSigning.getId());
    const crossSigningPrivateKeysInStorage = Boolean(await crossSigning.isStoredInSecretStorage(secretStorage));
    const masterPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("master")));
    const selfSigningPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("self_signing")));
    const userSigningPrivateKeyCached = !!(pkCache && (await pkCache.getCrossSigningKeyCache("user_signing")));
    const homeserverSupportsCrossSigning = await cli.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing");
    const crossSigningReady = await cli.isCrossSigningReady();
    this.setState({
      crossSigningPublicKeysOnDevice,
      crossSigningPrivateKeysInStorage,
      masterPrivateKeyCached,
      selfSigningPrivateKeyCached,
      userSigningPrivateKeyCached,
      homeserverSupportsCrossSigning,
      crossSigningReady
    });
  }
  /**
   * Bootstrapping cross-signing take one of these paths:
   * 1. Create cross-signing keys locally and store in secret storage (if it
   *    already exists on the account).
   * 2. Access existing secret storage by requesting passphrase and accessing
   *    cross-signing keys as needed.
   * 3. All keys are loaded and there's nothing to do.
   * @param {bool} [forceReset] Bootstrap again even if keys already present
   */


  render() {
    const {
      error,
      crossSigningPublicKeysOnDevice,
      crossSigningPrivateKeysInStorage,
      masterPrivateKeyCached,
      selfSigningPrivateKeyCached,
      userSigningPrivateKeyCached,
      homeserverSupportsCrossSigning,
      crossSigningReady
    } = this.state;
    let errorSection;

    if (error) {
      errorSection = /*#__PURE__*/_react.default.createElement("div", {
        className: "error"
      }, error.toString());
    }

    let summarisedStatus;

    if (homeserverSupportsCrossSigning === undefined) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement(_Spinner.default, null);
    } else if (!homeserverSupportsCrossSigning) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your homeserver does not support cross-signing."));
    } else if (crossSigningReady && crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, "\u2705 ", (0, _languageHandler._t)("Cross-signing is ready for use."));
    } else if (crossSigningReady && !crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, "\u26A0\uFE0F ", (0, _languageHandler._t)("Cross-signing is ready but keys are not backed up."));
    } else if (crossSigningPrivateKeysInStorage) {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Your account has a cross-signing identity in secret storage, " + "but it is not yet trusted by this session."));
    } else {
      summarisedStatus = /*#__PURE__*/_react.default.createElement("p", null, (0, _languageHandler._t)("Cross-signing is not set up."));
    }

    const keysExistAnywhere = crossSigningPublicKeysOnDevice || crossSigningPrivateKeysInStorage || masterPrivateKeyCached || selfSigningPrivateKeyCached || userSigningPrivateKeyCached;
    const keysExistEverywhere = crossSigningPublicKeysOnDevice && crossSigningPrivateKeysInStorage && masterPrivateKeyCached && selfSigningPrivateKeyCached && userSigningPrivateKeyCached;
    const actions = []; // TODO: determine how better to expose this to users in addition to prompts at login/toast

    if (!keysExistEverywhere && homeserverSupportsCrossSigning) {
      let buttonCaption = (0, _languageHandler._t)("Set up Secure Backup");

      if (crossSigningPrivateKeysInStorage) {
        buttonCaption = (0, _languageHandler._t)("Verify this session");
      }

      actions.push( /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        key: "setup",
        kind: "primary",
        onClick: this.onBootstrapClick
      }, buttonCaption));
    }

    if (keysExistAnywhere) {
      actions.push( /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        key: "reset",
        kind: "danger",
        onClick: this.resetCrossSigning
      }, (0, _languageHandler._t)("Reset")));
    }

    let actionRow;

    if (actions.length) {
      actionRow = /*#__PURE__*/_react.default.createElement("div", {
        className: "mx_CrossSigningPanel_buttonRow"
      }, actions);
    }

    return /*#__PURE__*/_react.default.createElement("div", null, summarisedStatus, /*#__PURE__*/_react.default.createElement("details", null, /*#__PURE__*/_react.default.createElement("summary", null, (0, _languageHandler._t)("Advanced")), /*#__PURE__*/_react.default.createElement("table", {
      className: "mx_CrossSigningPanel_statusList"
    }, /*#__PURE__*/_react.default.createElement("tbody", null, /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Cross-signing public keys:")), /*#__PURE__*/_react.default.createElement("td", null, crossSigningPublicKeysOnDevice ? (0, _languageHandler._t)("in memory") : (0, _languageHandler._t)("not found"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Cross-signing private keys:")), /*#__PURE__*/_react.default.createElement("td", null, crossSigningPrivateKeysInStorage ? (0, _languageHandler._t)("in secret storage") : (0, _languageHandler._t)("not found in storage"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Master private key:")), /*#__PURE__*/_react.default.createElement("td", null, masterPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Self signing private key:")), /*#__PURE__*/_react.default.createElement("td", null, selfSigningPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("User signing private key:")), /*#__PURE__*/_react.default.createElement("td", null, userSigningPrivateKeyCached ? (0, _languageHandler._t)("cached locally") : (0, _languageHandler._t)("not found locally"))), /*#__PURE__*/_react.default.createElement("tr", null, /*#__PURE__*/_react.default.createElement("td", null, (0, _languageHandler._t)("Homeserver feature support:")), /*#__PURE__*/_react.default.createElement("td", null, homeserverSupportsCrossSigning ? (0, _languageHandler._t)("exists") : (0, _languageHandler._t)("not found")))))), errorSection, actionRow);
  }

}

exports.default = CrossSigningPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDcm9zc1NpZ25pbmdQYW5lbCIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJldmVudCIsInR5cGUiLCJnZXRUeXBlIiwic3RhcnRzV2l0aCIsImdldFVwZGF0ZWRTdGF0dXMiLCJzdGF0ZSIsImNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlIiwiTW9kYWwiLCJjcmVhdGVEaWFsb2ciLCJTZXR1cEVuY3J5cHRpb25EaWFsb2ciLCJhY2Nlc3NTZWNyZXRTdG9yYWdlIiwiZm9yY2VSZXNldCIsInNldFN0YXRlIiwiZXJyb3IiLCJ1bmRlZmluZWQiLCJjbGkiLCJNYXRyaXhDbGllbnRQZWciLCJnZXQiLCJib290c3RyYXBDcm9zc1NpZ25pbmciLCJhdXRoVXBsb2FkRGV2aWNlU2lnbmluZ0tleXMiLCJtYWtlUmVxdWVzdCIsImZpbmlzaGVkIiwiSW50ZXJhY3RpdmVBdXRoRGlhbG9nIiwidGl0bGUiLCJfdCIsIm1hdHJpeENsaWVudCIsImNvbmZpcm1lZCIsIkVycm9yIiwic2V0dXBOZXdDcm9zc1NpZ25pbmciLCJlIiwibG9nZ2VyIiwidW5tb3VudGVkIiwiQ29uZmlybURlc3Ryb3lDcm9zc1NpZ25pbmdEaWFsb2ciLCJvbkZpbmlzaGVkIiwiYWN0IiwiY29tcG9uZW50RGlkTW91bnQiLCJvbiIsIkNsaWVudEV2ZW50IiwiQWNjb3VudERhdGEiLCJvbkFjY291bnREYXRhIiwiQ3J5cHRvRXZlbnQiLCJVc2VyVHJ1c3RTdGF0dXNDaGFuZ2VkIiwib25TdGF0dXNDaGFuZ2VkIiwiS2V5c0NoYW5nZWQiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInJlbW92ZUxpc3RlbmVyIiwicGtDYWNoZSIsImdldENyb3NzU2lnbmluZ0NhY2hlQ2FsbGJhY2tzIiwiY3Jvc3NTaWduaW5nIiwiY3J5cHRvIiwiY3Jvc3NTaWduaW5nSW5mbyIsInNlY3JldFN0b3JhZ2UiLCJjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2UiLCJCb29sZWFuIiwiZ2V0SWQiLCJpc1N0b3JlZEluU2VjcmV0U3RvcmFnZSIsIm1hc3RlclByaXZhdGVLZXlDYWNoZWQiLCJnZXRDcm9zc1NpZ25pbmdLZXlDYWNoZSIsInNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCIsInVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCIsImhvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZyIsImRvZXNTZXJ2ZXJTdXBwb3J0VW5zdGFibGVGZWF0dXJlIiwiY3Jvc3NTaWduaW5nUmVhZHkiLCJpc0Nyb3NzU2lnbmluZ1JlYWR5IiwicmVuZGVyIiwiZXJyb3JTZWN0aW9uIiwidG9TdHJpbmciLCJzdW1tYXJpc2VkU3RhdHVzIiwia2V5c0V4aXN0QW55d2hlcmUiLCJrZXlzRXhpc3RFdmVyeXdoZXJlIiwiYWN0aW9ucyIsImJ1dHRvbkNhcHRpb24iLCJwdXNoIiwib25Cb290c3RyYXBDbGljayIsInJlc2V0Q3Jvc3NTaWduaW5nIiwiYWN0aW9uUm93IiwibGVuZ3RoIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvdmlld3Mvc2V0dGluZ3MvQ3Jvc3NTaWduaW5nUGFuZWwudHN4Il0sInNvdXJjZXNDb250ZW50IjpbIi8qXG5Db3B5cmlnaHQgMjAxOSwgMjAyMCBUaGUgTWF0cml4Lm9yZyBGb3VuZGF0aW9uIEMuSS5DLlxuXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG5cbiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcblxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG5saW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiovXG5cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBDbGllbnRFdmVudCwgTWF0cml4RXZlbnQgfSBmcm9tICdtYXRyaXgtanMtc2RrL3NyYy9tYXRyaXgnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2xvZ2dlclwiO1xuaW1wb3J0IHsgQ3J5cHRvRXZlbnQgfSBmcm9tIFwibWF0cml4LWpzLXNkay9zcmMvY3J5cHRvXCI7XG5cbmltcG9ydCB7IE1hdHJpeENsaWVudFBlZyB9IGZyb20gJy4uLy4uLy4uL01hdHJpeENsaWVudFBlZyc7XG5pbXBvcnQgeyBfdCB9IGZyb20gJy4uLy4uLy4uL2xhbmd1YWdlSGFuZGxlcic7XG5pbXBvcnQgTW9kYWwgZnJvbSAnLi4vLi4vLi4vTW9kYWwnO1xuaW1wb3J0IFNwaW5uZXIgZnJvbSAnLi4vZWxlbWVudHMvU3Bpbm5lcic7XG5pbXBvcnQgSW50ZXJhY3RpdmVBdXRoRGlhbG9nIGZyb20gJy4uL2RpYWxvZ3MvSW50ZXJhY3RpdmVBdXRoRGlhbG9nJztcbmltcG9ydCBDb25maXJtRGVzdHJveUNyb3NzU2lnbmluZ0RpYWxvZyBmcm9tICcuLi9kaWFsb2dzL3NlY3VyaXR5L0NvbmZpcm1EZXN0cm95Q3Jvc3NTaWduaW5nRGlhbG9nJztcbmltcG9ydCBTZXR1cEVuY3J5cHRpb25EaWFsb2cgZnJvbSAnLi4vZGlhbG9ncy9zZWN1cml0eS9TZXR1cEVuY3J5cHRpb25EaWFsb2cnO1xuaW1wb3J0IHsgYWNjZXNzU2VjcmV0U3RvcmFnZSB9IGZyb20gJy4uLy4uLy4uL1NlY3VyaXR5TWFuYWdlcic7XG5pbXBvcnQgQWNjZXNzaWJsZUJ1dHRvbiBmcm9tIFwiLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvblwiO1xuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBlcnJvcj86IEVycm9yO1xuICAgIGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZT86IGJvb2xlYW47XG4gICAgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2U/OiBib29sZWFuO1xuICAgIG1hc3RlclByaXZhdGVLZXlDYWNoZWQ/OiBib29sZWFuO1xuICAgIHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZD86IGJvb2xlYW47XG4gICAgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkPzogYm9vbGVhbjtcbiAgICBob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmc/OiBib29sZWFuO1xuICAgIGNyb3NzU2lnbmluZ1JlYWR5PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ3Jvc3NTaWduaW5nUGFuZWwgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PHt9LCBJU3RhdGU+IHtcbiAgICBwcml2YXRlIHVubW91bnRlZCA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuXG4gICAgICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgY2xpLm9uKENsaWVudEV2ZW50LkFjY291bnREYXRhLCB0aGlzLm9uQWNjb3VudERhdGEpO1xuICAgICAgICBjbGkub24oQ3J5cHRvRXZlbnQuVXNlclRydXN0U3RhdHVzQ2hhbmdlZCwgdGhpcy5vblN0YXR1c0NoYW5nZWQpO1xuICAgICAgICBjbGkub24oQ3J5cHRvRXZlbnQuS2V5c0NoYW5nZWQsIHRoaXMub25TdGF0dXNDaGFuZ2VkKTtcbiAgICAgICAgdGhpcy5nZXRVcGRhdGVkU3RhdHVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgICB0aGlzLnVubW91bnRlZCA9IHRydWU7XG4gICAgICAgIGNvbnN0IGNsaSA9IE1hdHJpeENsaWVudFBlZy5nZXQoKTtcbiAgICAgICAgaWYgKCFjbGkpIHJldHVybjtcbiAgICAgICAgY2xpLnJlbW92ZUxpc3RlbmVyKENsaWVudEV2ZW50LkFjY291bnREYXRhLCB0aGlzLm9uQWNjb3VudERhdGEpO1xuICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoQ3J5cHRvRXZlbnQuVXNlclRydXN0U3RhdHVzQ2hhbmdlZCwgdGhpcy5vblN0YXR1c0NoYW5nZWQpO1xuICAgICAgICBjbGkucmVtb3ZlTGlzdGVuZXIoQ3J5cHRvRXZlbnQuS2V5c0NoYW5nZWQsIHRoaXMub25TdGF0dXNDaGFuZ2VkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uQWNjb3VudERhdGEgPSAoZXZlbnQ6IE1hdHJpeEV2ZW50KTogdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBldmVudC5nZXRUeXBlKCk7XG4gICAgICAgIGlmICh0eXBlLnN0YXJ0c1dpdGgoXCJtLmNyb3NzX3NpZ25pbmdcIikgfHwgdHlwZS5zdGFydHNXaXRoKFwibS5zZWNyZXRfc3RvcmFnZVwiKSkge1xuICAgICAgICAgICAgdGhpcy5nZXRVcGRhdGVkU3RhdHVzKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBvbkJvb3RzdHJhcENsaWNrID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS5jcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSkge1xuICAgICAgICAgICAgTW9kYWwuY3JlYXRlRGlhbG9nKFNldHVwRW5jcnlwdGlvbkRpYWxvZywge30sIG51bGwsIC8qIHByaW9yaXR5ID0gKi8gZmFsc2UsIC8qIHN0YXRpYyA9ICovIHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gVHJpZ2dlciB0aGUgZmxvdyB0byBzZXQgdXAgc2VjdXJlIGJhY2t1cCwgd2hpY2ggaXMgd2hhdCB0aGlzIHdpbGwgZG8gd2hlbiBpblxuICAgICAgICAgICAgLy8gdGhlIGFwcHJvcHJpYXRlIHN0YXRlLlxuICAgICAgICAgICAgYWNjZXNzU2VjcmV0U3RvcmFnZSgpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIHByaXZhdGUgb25TdGF0dXNDaGFuZ2VkID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmdldFVwZGF0ZWRTdGF0dXMoKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBhc3luYyBnZXRVcGRhdGVkU3RhdHVzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgIGNvbnN0IHBrQ2FjaGUgPSBjbGkuZ2V0Q3Jvc3NTaWduaW5nQ2FjaGVDYWxsYmFja3MoKTtcbiAgICAgICAgY29uc3QgY3Jvc3NTaWduaW5nID0gY2xpLmNyeXB0by5jcm9zc1NpZ25pbmdJbmZvO1xuICAgICAgICBjb25zdCBzZWNyZXRTdG9yYWdlID0gY2xpLmNyeXB0by5zZWNyZXRTdG9yYWdlO1xuICAgICAgICBjb25zdCBjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2UgPSBCb29sZWFuKGNyb3NzU2lnbmluZy5nZXRJZCgpKTtcbiAgICAgICAgY29uc3QgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UgPSBCb29sZWFuKGF3YWl0IGNyb3NzU2lnbmluZy5pc1N0b3JlZEluU2VjcmV0U3RvcmFnZShzZWNyZXRTdG9yYWdlKSk7XG4gICAgICAgIGNvbnN0IG1hc3RlclByaXZhdGVLZXlDYWNoZWQgPSAhIShwa0NhY2hlICYmIChhd2FpdCBwa0NhY2hlLmdldENyb3NzU2lnbmluZ0tleUNhY2hlKFwibWFzdGVyXCIpKSk7XG4gICAgICAgIGNvbnN0IHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCA9ICEhKHBrQ2FjaGUgJiYgKGF3YWl0IHBrQ2FjaGUuZ2V0Q3Jvc3NTaWduaW5nS2V5Q2FjaGUoXCJzZWxmX3NpZ25pbmdcIikpKTtcbiAgICAgICAgY29uc3QgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkID0gISEocGtDYWNoZSAmJiAoYXdhaXQgcGtDYWNoZS5nZXRDcm9zc1NpZ25pbmdLZXlDYWNoZShcInVzZXJfc2lnbmluZ1wiKSkpO1xuICAgICAgICBjb25zdCBob21lc2VydmVyU3VwcG9ydHNDcm9zc1NpZ25pbmcgPVxuICAgICAgICAgICAgYXdhaXQgY2xpLmRvZXNTZXJ2ZXJTdXBwb3J0VW5zdGFibGVGZWF0dXJlKFwib3JnLm1hdHJpeC5lMmVfY3Jvc3Nfc2lnbmluZ1wiKTtcbiAgICAgICAgY29uc3QgY3Jvc3NTaWduaW5nUmVhZHkgPSBhd2FpdCBjbGkuaXNDcm9zc1NpZ25pbmdSZWFkeSgpO1xuXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlLFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UsXG4gICAgICAgICAgICBtYXN0ZXJQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkLFxuICAgICAgICAgICAgaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nLFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUmVhZHksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEJvb3RzdHJhcHBpbmcgY3Jvc3Mtc2lnbmluZyB0YWtlIG9uZSBvZiB0aGVzZSBwYXRoczpcbiAgICAgKiAxLiBDcmVhdGUgY3Jvc3Mtc2lnbmluZyBrZXlzIGxvY2FsbHkgYW5kIHN0b3JlIGluIHNlY3JldCBzdG9yYWdlIChpZiBpdFxuICAgICAqICAgIGFscmVhZHkgZXhpc3RzIG9uIHRoZSBhY2NvdW50KS5cbiAgICAgKiAyLiBBY2Nlc3MgZXhpc3Rpbmcgc2VjcmV0IHN0b3JhZ2UgYnkgcmVxdWVzdGluZyBwYXNzcGhyYXNlIGFuZCBhY2Nlc3NpbmdcbiAgICAgKiAgICBjcm9zcy1zaWduaW5nIGtleXMgYXMgbmVlZGVkLlxuICAgICAqIDMuIEFsbCBrZXlzIGFyZSBsb2FkZWQgYW5kIHRoZXJlJ3Mgbm90aGluZyB0byBkby5cbiAgICAgKiBAcGFyYW0ge2Jvb2x9IFtmb3JjZVJlc2V0XSBCb290c3RyYXAgYWdhaW4gZXZlbiBpZiBrZXlzIGFscmVhZHkgcHJlc2VudFxuICAgICAqL1xuICAgIHByaXZhdGUgYm9vdHN0cmFwQ3Jvc3NTaWduaW5nID0gYXN5bmMgKHsgZm9yY2VSZXNldCA9IGZhbHNlIH0pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVycm9yOiB1bmRlZmluZWQgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjbGkgPSBNYXRyaXhDbGllbnRQZWcuZ2V0KCk7XG4gICAgICAgICAgICBhd2FpdCBjbGkuYm9vdHN0cmFwQ3Jvc3NTaWduaW5nKHtcbiAgICAgICAgICAgICAgICBhdXRoVXBsb2FkRGV2aWNlU2lnbmluZ0tleXM6IGFzeW5jIChtYWtlUmVxdWVzdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGZpbmlzaGVkIH0gPSBNb2RhbC5jcmVhdGVEaWFsb2coSW50ZXJhY3RpdmVBdXRoRGlhbG9nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogX3QoXCJTZXR0aW5nIHVwIGtleXNcIiksXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRyaXhDbGllbnQ6IGNsaSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VSZXF1ZXN0LFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW2NvbmZpcm1lZF0gPSBhd2FpdCBmaW5pc2hlZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maXJtZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNyb3NzLXNpZ25pbmcga2V5IHVwbG9hZCBhdXRoIGNhbmNlbGVkXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXR1cE5ld0Nyb3NzU2lnbmluZzogZm9yY2VSZXNldCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZXJyb3I6IGUgfSk7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJFcnJvciBib290c3RyYXBwaW5nIGNyb3NzLXNpZ25pbmdcIiwgZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudW5tb3VudGVkKSByZXR1cm47XG4gICAgICAgIHRoaXMuZ2V0VXBkYXRlZFN0YXR1cygpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIHJlc2V0Q3Jvc3NTaWduaW5nID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICBNb2RhbC5jcmVhdGVEaWFsb2coQ29uZmlybURlc3Ryb3lDcm9zc1NpZ25pbmdEaWFsb2csIHtcbiAgICAgICAgICAgIG9uRmluaXNoZWQ6IChhY3QpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWFjdCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHRoaXMuYm9vdHN0cmFwQ3Jvc3NTaWduaW5nKHsgZm9yY2VSZXNldDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBlcnJvcixcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlLFxuICAgICAgICAgICAgbWFzdGVyUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIHVzZXJTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCxcbiAgICAgICAgICAgIGhvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZyxcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1JlYWR5LFxuICAgICAgICB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBsZXQgZXJyb3JTZWN0aW9uO1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIGVycm9yU2VjdGlvbiA9IDxkaXYgY2xhc3NOYW1lPVwiZXJyb3JcIj57IGVycm9yLnRvU3RyaW5nKCkgfTwvZGl2PjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzdW1tYXJpc2VkU3RhdHVzO1xuICAgICAgICBpZiAoaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHN1bW1hcmlzZWRTdGF0dXMgPSA8U3Bpbm5lciAvPjtcbiAgICAgICAgfSBlbHNlIGlmICghaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nKSB7XG4gICAgICAgICAgICBzdW1tYXJpc2VkU3RhdHVzID0gPHA+eyBfdChcbiAgICAgICAgICAgICAgICBcIllvdXIgaG9tZXNlcnZlciBkb2VzIG5vdCBzdXBwb3J0IGNyb3NzLXNpZ25pbmcuXCIsXG4gICAgICAgICAgICApIH08L3A+O1xuICAgICAgICB9IGVsc2UgaWYgKGNyb3NzU2lnbmluZ1JlYWR5ICYmIGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlKSB7XG4gICAgICAgICAgICBzdW1tYXJpc2VkU3RhdHVzID0gPHA+4pyFIHsgX3QoXG4gICAgICAgICAgICAgICAgXCJDcm9zcy1zaWduaW5nIGlzIHJlYWR5IGZvciB1c2UuXCIsXG4gICAgICAgICAgICApIH08L3A+O1xuICAgICAgICB9IGVsc2UgaWYgKGNyb3NzU2lnbmluZ1JlYWR5ICYmICFjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSkge1xuICAgICAgICAgICAgc3VtbWFyaXNlZFN0YXR1cyA9IDxwPuKaoO+4jyB7IF90KFxuICAgICAgICAgICAgICAgIFwiQ3Jvc3Mtc2lnbmluZyBpcyByZWFkeSBidXQga2V5cyBhcmUgbm90IGJhY2tlZCB1cC5cIixcbiAgICAgICAgICAgICkgfTwvcD47XG4gICAgICAgIH0gZWxzZSBpZiAoY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UpIHtcbiAgICAgICAgICAgIHN1bW1hcmlzZWRTdGF0dXMgPSA8cD57IF90KFxuICAgICAgICAgICAgICAgIFwiWW91ciBhY2NvdW50IGhhcyBhIGNyb3NzLXNpZ25pbmcgaWRlbnRpdHkgaW4gc2VjcmV0IHN0b3JhZ2UsIFwiICtcbiAgICAgICAgICAgICAgICBcImJ1dCBpdCBpcyBub3QgeWV0IHRydXN0ZWQgYnkgdGhpcyBzZXNzaW9uLlwiLFxuICAgICAgICAgICAgKSB9PC9wPjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1bW1hcmlzZWRTdGF0dXMgPSA8cD57IF90KFxuICAgICAgICAgICAgICAgIFwiQ3Jvc3Mtc2lnbmluZyBpcyBub3Qgc2V0IHVwLlwiLFxuICAgICAgICAgICAgKSB9PC9wPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGtleXNFeGlzdEFueXdoZXJlID0gKFxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHVibGljS2V5c09uRGV2aWNlIHx8XG4gICAgICAgICAgICBjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSB8fFxuICAgICAgICAgICAgbWFzdGVyUHJpdmF0ZUtleUNhY2hlZCB8fFxuICAgICAgICAgICAgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkIHx8XG4gICAgICAgICAgICB1c2VyU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWRcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3Qga2V5c0V4aXN0RXZlcnl3aGVyZSA9IChcbiAgICAgICAgICAgIGNyb3NzU2lnbmluZ1B1YmxpY0tleXNPbkRldmljZSAmJlxuICAgICAgICAgICAgY3Jvc3NTaWduaW5nUHJpdmF0ZUtleXNJblN0b3JhZ2UgJiZcbiAgICAgICAgICAgIG1hc3RlclByaXZhdGVLZXlDYWNoZWQgJiZcbiAgICAgICAgICAgIHNlbGZTaWduaW5nUHJpdmF0ZUtleUNhY2hlZCAmJlxuICAgICAgICAgICAgdXNlclNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgYWN0aW9ucyA9IFtdO1xuXG4gICAgICAgIC8vIFRPRE86IGRldGVybWluZSBob3cgYmV0dGVyIHRvIGV4cG9zZSB0aGlzIHRvIHVzZXJzIGluIGFkZGl0aW9uIHRvIHByb21wdHMgYXQgbG9naW4vdG9hc3RcbiAgICAgICAgaWYgKCFrZXlzRXhpc3RFdmVyeXdoZXJlICYmIGhvbWVzZXJ2ZXJTdXBwb3J0c0Nyb3NzU2lnbmluZykge1xuICAgICAgICAgICAgbGV0IGJ1dHRvbkNhcHRpb24gPSBfdChcIlNldCB1cCBTZWN1cmUgQmFja3VwXCIpO1xuICAgICAgICAgICAgaWYgKGNyb3NzU2lnbmluZ1ByaXZhdGVLZXlzSW5TdG9yYWdlKSB7XG4gICAgICAgICAgICAgICAgYnV0dG9uQ2FwdGlvbiA9IF90KFwiVmVyaWZ5IHRoaXMgc2Vzc2lvblwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFjdGlvbnMucHVzaChcbiAgICAgICAgICAgICAgICA8QWNjZXNzaWJsZUJ1dHRvbiBrZXk9XCJzZXR1cFwiIGtpbmQ9XCJwcmltYXJ5XCIgb25DbGljaz17dGhpcy5vbkJvb3RzdHJhcENsaWNrfT5cbiAgICAgICAgICAgICAgICAgICAgeyBidXR0b25DYXB0aW9uIH1cbiAgICAgICAgICAgICAgICA8L0FjY2Vzc2libGVCdXR0b24+LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChrZXlzRXhpc3RBbnl3aGVyZSkge1xuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKFxuICAgICAgICAgICAgICAgIDxBY2Nlc3NpYmxlQnV0dG9uIGtleT1cInJlc2V0XCIga2luZD1cImRhbmdlclwiIG9uQ2xpY2s9e3RoaXMucmVzZXRDcm9zc1NpZ25pbmd9PlxuICAgICAgICAgICAgICAgICAgICB7IF90KFwiUmVzZXRcIikgfVxuICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj4sXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGFjdGlvblJvdztcbiAgICAgICAgaWYgKGFjdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICBhY3Rpb25Sb3cgPSA8ZGl2IGNsYXNzTmFtZT1cIm14X0Nyb3NzU2lnbmluZ1BhbmVsX2J1dHRvblJvd1wiPlxuICAgICAgICAgICAgICAgIHsgYWN0aW9ucyB9XG4gICAgICAgICAgICA8L2Rpdj47XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgICAgICB7IHN1bW1hcmlzZWRTdGF0dXMgfVxuICAgICAgICAgICAgICAgIDxkZXRhaWxzPlxuICAgICAgICAgICAgICAgICAgICA8c3VtbWFyeT57IF90KFwiQWR2YW5jZWRcIikgfTwvc3VtbWFyeT5cbiAgICAgICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT1cIm14X0Nyb3NzU2lnbmluZ1BhbmVsX3N0YXR1c0xpc3RcIj48dGJvZHk+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnsgX3QoXCJDcm9zcy1zaWduaW5nIHB1YmxpYyBrZXlzOlwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBjcm9zc1NpZ25pbmdQdWJsaWNLZXlzT25EZXZpY2UgPyBfdChcImluIG1lbW9yeVwiKSA6IF90KFwibm90IGZvdW5kXCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBfdChcIkNyb3NzLXNpZ25pbmcgcHJpdmF0ZSBrZXlzOlwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBjcm9zc1NpZ25pbmdQcml2YXRlS2V5c0luU3RvcmFnZSA/IF90KFwiaW4gc2VjcmV0IHN0b3JhZ2VcIikgOiBfdChcIm5vdCBmb3VuZCBpbiBzdG9yYWdlXCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBfdChcIk1hc3RlciBwcml2YXRlIGtleTpcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnsgbWFzdGVyUHJpdmF0ZUtleUNhY2hlZCA/IF90KFwiY2FjaGVkIGxvY2FsbHlcIikgOiBfdChcIm5vdCBmb3VuZCBsb2NhbGx5XCIpIH08L3RkPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cbiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyBfdChcIlNlbGYgc2lnbmluZyBwcml2YXRlIGtleTpcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnsgc2VsZlNpZ25pbmdQcml2YXRlS2V5Q2FjaGVkID8gX3QoXCJjYWNoZWQgbG9jYWxseVwiKSA6IF90KFwibm90IGZvdW5kIGxvY2FsbHlcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgICAgICAgICAgICAgPHRyPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57IF90KFwiVXNlciBzaWduaW5nIHByaXZhdGUga2V5OlwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+eyB1c2VyU2lnbmluZ1ByaXZhdGVLZXlDYWNoZWQgPyBfdChcImNhY2hlZCBsb2NhbGx5XCIpIDogX3QoXCJub3QgZm91bmQgbG9jYWxseVwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8dHI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnsgX3QoXCJIb21lc2VydmVyIGZlYXR1cmUgc3VwcG9ydDpcIikgfTwvdGQ+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnsgaG9tZXNlcnZlclN1cHBvcnRzQ3Jvc3NTaWduaW5nID8gX3QoXCJleGlzdHNcIikgOiBfdChcIm5vdCBmb3VuZFwiKSB9PC90ZD5cbiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgICAgICAgICAgIDwvdGJvZHk+PC90YWJsZT5cbiAgICAgICAgICAgICAgICA8L2RldGFpbHM+XG4gICAgICAgICAgICAgICAgeyBlcnJvclNlY3Rpb24gfVxuICAgICAgICAgICAgICAgIHsgYWN0aW9uUm93IH1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFnQkE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBN0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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