"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _languageHandler = require("../../../languageHandler");

var _AccessibleButton = _interopRequireDefault(require("../elements/AccessibleButton"));

var _InteractiveAuth = _interopRequireWildcard(require("../../structures/InteractiveAuth"));

var _InteractiveAuthEntryComponents = require("../auth/InteractiveAuthEntryComponents");

var _BaseDialog = _interopRequireDefault(require("./BaseDialog"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/*
Copyright 2016 OpenMarket Ltd
Copyright 2017 Vector Creations Ltd
Copyright 2020 The Matrix.org Foundation C.I.C.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
class InteractiveAuthDialog extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _defineProperty2.default)(this, "onAuthFinished", (success, result) => {
      if (success) {
        this.props.onFinished(true, result);
      } else {
        if (result === _InteractiveAuth.ERROR_USER_CANCELLED) {
          this.props.onFinished(false, null);
        } else {
          this.setState({
            authError: result
          });
        }
      }
    });
    (0, _defineProperty2.default)(this, "onUpdateStagePhase", (newStage, newPhase) => {
      // We copy the stage and stage phase params into state for title selection in render()
      this.setState({
        uiaStage: newStage,
        uiaStagePhase: newPhase
      });
    });
    (0, _defineProperty2.default)(this, "onDismissClick", () => {
      this.props.onFinished(false);
    });
    this.state = {
      authError: null,
      // See _onUpdateStagePhase()
      uiaStage: null,
      uiaStagePhase: null
    };
  }

  getDefaultDialogAesthetics() {
    const ssoAesthetics = {
      [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_PREAUTH]: {
        title: (0, _languageHandler._t)("Use Single Sign On to continue"),
        body: (0, _languageHandler._t)("To continue, use Single Sign On to prove your identity."),
        continueText: (0, _languageHandler._t)("Single Sign On"),
        continueKind: "primary"
      },
      [_InteractiveAuthEntryComponents.SSOAuthEntry.PHASE_POSTAUTH]: {
        title: (0, _languageHandler._t)("Confirm to continue"),
        body: (0, _languageHandler._t)("Click the button below to confirm your identity."),
        continueText: (0, _languageHandler._t)("Confirm"),
        continueKind: "primary"
      }
    };
    return {
      [_InteractiveAuthEntryComponents.SSOAuthEntry.LOGIN_TYPE]: ssoAesthetics,
      [_InteractiveAuthEntryComponents.SSOAuthEntry.UNSTABLE_LOGIN_TYPE]: ssoAesthetics
    };
  }

  render() {
    // Let's pick a title, body, and other params text that we'll show to the user. The order
    // is most specific first, so stagePhase > our props > defaults.
    let title = this.state.authError ? 'Error' : this.props.title || (0, _languageHandler._t)('Authentication');
    let body = this.state.authError ? null : this.props.body;
    let continueText = null;
    let continueKind = null;
    const dialogAesthetics = this.props.aestheticsForStagePhases || this.getDefaultDialogAesthetics();

    if (!this.state.authError && dialogAesthetics) {
      if (dialogAesthetics[this.state.uiaStage]) {
        const aesthetics = dialogAesthetics[this.state.uiaStage][this.state.uiaStagePhase];
        if (aesthetics && aesthetics.title) title = aesthetics.title;
        if (aesthetics && aesthetics.body) body = aesthetics.body;
        if (aesthetics && aesthetics.continueText) continueText = aesthetics.continueText;
        if (aesthetics && aesthetics.continueKind) continueKind = aesthetics.continueKind;
      }
    }

    let content;

    if (this.state.authError) {
      content = /*#__PURE__*/_react.default.createElement("div", {
        id: "mx_Dialog_content"
      }, /*#__PURE__*/_react.default.createElement("div", {
        role: "alert"
      }, this.state.authError.message || this.state.authError.toString()), /*#__PURE__*/_react.default.createElement("br", null), /*#__PURE__*/_react.default.createElement(_AccessibleButton.default, {
        onClick: this.onDismissClick,
        className: "mx_GeneralButton",
        autoFocus: true
      }, (0, _languageHandler._t)("Dismiss")));
    } else {
      content = /*#__PURE__*/_react.default.createElement("div", {
        id: "mx_Dialog_content"
      }, body, /*#__PURE__*/_react.default.createElement(_InteractiveAuth.default, {
        matrixClient: this.props.matrixClient,
        authData: this.props.authData,
        makeRequest: this.props.makeRequest,
        onAuthFinished: this.onAuthFinished,
        onStagePhaseChange: this.onUpdateStagePhase,
        continueText: continueText,
        continueKind: continueKind
      }));
    }

    return /*#__PURE__*/_react.default.createElement(_BaseDialog.default, {
      className: "mx_InteractiveAuthDialog",
      onFinished: this.props.onFinished,
      title: title,
      contentId: "mx_Dialog_content"
    }, content);
  }

}

exports.default = InteractiveAuthDialog;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJJbnRlcmFjdGl2ZUF1dGhEaWFsb2ciLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJzdWNjZXNzIiwicmVzdWx0Iiwib25GaW5pc2hlZCIsIkVSUk9SX1VTRVJfQ0FOQ0VMTEVEIiwic2V0U3RhdGUiLCJhdXRoRXJyb3IiLCJuZXdTdGFnZSIsIm5ld1BoYXNlIiwidWlhU3RhZ2UiLCJ1aWFTdGFnZVBoYXNlIiwic3RhdGUiLCJnZXREZWZhdWx0RGlhbG9nQWVzdGhldGljcyIsInNzb0Flc3RoZXRpY3MiLCJTU09BdXRoRW50cnkiLCJQSEFTRV9QUkVBVVRIIiwidGl0bGUiLCJfdCIsImJvZHkiLCJjb250aW51ZVRleHQiLCJjb250aW51ZUtpbmQiLCJQSEFTRV9QT1NUQVVUSCIsIkxPR0lOX1RZUEUiLCJVTlNUQUJMRV9MT0dJTl9UWVBFIiwicmVuZGVyIiwiZGlhbG9nQWVzdGhldGljcyIsImFlc3RoZXRpY3NGb3JTdGFnZVBoYXNlcyIsImFlc3RoZXRpY3MiLCJjb250ZW50IiwibWVzc2FnZSIsInRvU3RyaW5nIiwib25EaXNtaXNzQ2xpY2siLCJtYXRyaXhDbGllbnQiLCJhdXRoRGF0YSIsIm1ha2VSZXF1ZXN0Iiwib25BdXRoRmluaXNoZWQiLCJvblVwZGF0ZVN0YWdlUGhhc2UiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy92aWV3cy9kaWFsb2dzL0ludGVyYWN0aXZlQXV0aERpYWxvZy50c3giXSwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAyMDE2IE9wZW5NYXJrZXQgTHRkXG5Db3B5cmlnaHQgMjAxNyBWZWN0b3IgQ3JlYXRpb25zIEx0ZFxuQ29weXJpZ2h0IDIwMjAgVGhlIE1hdHJpeC5vcmcgRm91bmRhdGlvbiBDLkkuQy5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgTWF0cml4Q2xpZW50IH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2NsaWVudFwiO1xuaW1wb3J0IHsgSUF1dGhEYXRhIH0gZnJvbSBcIm1hdHJpeC1qcy1zZGsvc3JjL2ludGVyYWN0aXZlLWF1dGhcIjtcblxuaW1wb3J0IHsgX3QgfSBmcm9tICcuLi8uLi8uLi9sYW5ndWFnZUhhbmRsZXInO1xuaW1wb3J0IEFjY2Vzc2libGVCdXR0b24gZnJvbSAnLi4vZWxlbWVudHMvQWNjZXNzaWJsZUJ1dHRvbic7XG5pbXBvcnQgSW50ZXJhY3RpdmVBdXRoLCB7IEVSUk9SX1VTRVJfQ0FOQ0VMTEVELCBJbnRlcmFjdGl2ZUF1dGhDYWxsYmFjayB9IGZyb20gXCIuLi8uLi9zdHJ1Y3R1cmVzL0ludGVyYWN0aXZlQXV0aFwiO1xuaW1wb3J0IHsgU1NPQXV0aEVudHJ5IH0gZnJvbSBcIi4uL2F1dGgvSW50ZXJhY3RpdmVBdXRoRW50cnlDb21wb25lbnRzXCI7XG5pbXBvcnQgQmFzZURpYWxvZyBmcm9tIFwiLi9CYXNlRGlhbG9nXCI7XG5pbXBvcnQgeyBJRGlhbG9nUHJvcHMgfSBmcm9tIFwiLi9JRGlhbG9nUHJvcHNcIjtcblxuaW50ZXJmYWNlIElEaWFsb2dBZXN0aGV0aWNzIHtcbiAgICBbeDogc3RyaW5nXToge1xuICAgICAgICBbeDogbnVtYmVyXToge1xuICAgICAgICAgICAgdGl0bGU6IHN0cmluZztcbiAgICAgICAgICAgIGJvZHk6IHN0cmluZztcbiAgICAgICAgICAgIGNvbnRpbnVlVGV4dDogc3RyaW5nO1xuICAgICAgICAgICAgY29udGludWVLaW5kOiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuaW50ZXJmYWNlIElQcm9wcyBleHRlbmRzIElEaWFsb2dQcm9wcyB7XG4gICAgLy8gbWF0cml4IGNsaWVudCB0byB1c2UgZm9yIFVJIGF1dGggcmVxdWVzdHNcbiAgICBtYXRyaXhDbGllbnQ6IE1hdHJpeENsaWVudDtcblxuICAgIC8vIHJlc3BvbnNlIGZyb20gaW5pdGlhbCByZXF1ZXN0LiBJZiBub3Qgc3VwcGxpZWQsIHdpbGwgZG8gYSByZXF1ZXN0IG9uXG4gICAgLy8gbW91bnQuXG4gICAgYXV0aERhdGE/OiBJQXV0aERhdGE7XG5cbiAgICAvLyBjYWxsYmFja1xuICAgIG1ha2VSZXF1ZXN0OiAoYXV0aDogSUF1dGhEYXRhKSA9PiBQcm9taXNlPElBdXRoRGF0YT47XG5cbiAgICAvLyBPcHRpb25hbCB0aXRsZSBhbmQgYm9keSB0byBzaG93IHdoZW4gbm90IHNob3dpbmcgYSBwYXJ0aWN1bGFyIHN0YWdlXG4gICAgdGl0bGU/OiBzdHJpbmc7XG4gICAgYm9keT86IHN0cmluZztcblxuICAgIC8vIE9wdGlvbmFsIHRpdGxlIGFuZCBib2R5IHBhaXJzIGZvciBwYXJ0aWN1bGFyIHN0YWdlcyBhbmQgcGhhc2VzIHdpdGhpblxuICAgIC8vIHRob3NlIHN0YWdlcy4gT2JqZWN0IHN0cnVjdHVyZS9leGFtcGxlIGlzOlxuICAgIC8vIHtcbiAgICAvLyAgICAgXCJvcmcuZXhhbXBsZS5zdGFnZV90eXBlXCI6IHtcbiAgICAvLyAgICAgICAgIDE6IHtcbiAgICAvLyAgICAgICAgICAgICBcImJvZHlcIjogXCJUaGlzIGlzIGEgYm9keSBmb3IgcGhhc2UgMVwiIG9mIG9yZy5leGFtcGxlLnN0YWdlX3R5cGUsXG4gICAgLy8gICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlRpdGxlIGZvciBwaGFzZSAxIG9mIG9yZy5leGFtcGxlLnN0YWdlX3R5cGVcIlxuICAgIC8vICAgICAgICAgfSxcbiAgICAvLyAgICAgICAgIDI6IHtcbiAgICAvLyAgICAgICAgICAgICBcImJvZHlcIjogXCJUaGlzIGlzIGEgYm9keSBmb3IgcGhhc2UgMiBvZiBvcmcuZXhhbXBsZS5zdGFnZV90eXBlXCIsXG4gICAgLy8gICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlRpdGxlIGZvciBwaGFzZSAyIG9mIG9yZy5leGFtcGxlLnN0YWdlX3R5cGVcIlxuICAgIC8vICAgICAgICAgICAgIFwiY29udGludWVUZXh0XCI6IFwiQ29uZmlybSBpZGVudGl0eSB3aXRoIEV4YW1wbGUgQXV0aFwiLFxuICAgIC8vICAgICAgICAgICAgIFwiY29udGludWVLaW5kXCI6IFwiZGFuZ2VyXCJcbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgfVxuICAgIC8vIH1cbiAgICAvL1xuICAgIC8vIERlZmF1bHQgaXMgZGVmaW5lZCBpbiBfZ2V0RGVmYXVsdERpYWxvZ0Flc3RoZXRpY3MoKVxuICAgIGFlc3RoZXRpY3NGb3JTdGFnZVBoYXNlcz86IElEaWFsb2dBZXN0aGV0aWNzO1xufVxuXG5pbnRlcmZhY2UgSVN0YXRlIHtcbiAgICBhdXRoRXJyb3I6IEVycm9yO1xuXG4gICAgLy8gU2VlIF9vblVwZGF0ZVN0YWdlUGhhc2UoKVxuICAgIHVpYVN0YWdlOiBudW1iZXIgfCBzdHJpbmc7XG4gICAgdWlhU3RhZ2VQaGFzZTogbnVtYmVyIHwgc3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbnRlcmFjdGl2ZUF1dGhEaWFsb2cgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8SVByb3BzLCBJU3RhdGU+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogSVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgYXV0aEVycm9yOiBudWxsLFxuXG4gICAgICAgICAgICAvLyBTZWUgX29uVXBkYXRlU3RhZ2VQaGFzZSgpXG4gICAgICAgICAgICB1aWFTdGFnZTogbnVsbCxcbiAgICAgICAgICAgIHVpYVN0YWdlUGhhc2U6IG51bGwsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXREZWZhdWx0RGlhbG9nQWVzdGhldGljcygpOiBJRGlhbG9nQWVzdGhldGljcyB7XG4gICAgICAgIGNvbnN0IHNzb0Flc3RoZXRpY3MgPSB7XG4gICAgICAgICAgICBbU1NPQXV0aEVudHJ5LlBIQVNFX1BSRUFVVEhdOiB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IF90KFwiVXNlIFNpbmdsZSBTaWduIE9uIHRvIGNvbnRpbnVlXCIpLFxuICAgICAgICAgICAgICAgIGJvZHk6IF90KFwiVG8gY29udGludWUsIHVzZSBTaW5nbGUgU2lnbiBPbiB0byBwcm92ZSB5b3VyIGlkZW50aXR5LlwiKSxcbiAgICAgICAgICAgICAgICBjb250aW51ZVRleHQ6IF90KFwiU2luZ2xlIFNpZ24gT25cIiksXG4gICAgICAgICAgICAgICAgY29udGludWVLaW5kOiBcInByaW1hcnlcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBbU1NPQXV0aEVudHJ5LlBIQVNFX1BPU1RBVVRIXToge1xuICAgICAgICAgICAgICAgIHRpdGxlOiBfdChcIkNvbmZpcm0gdG8gY29udGludWVcIiksXG4gICAgICAgICAgICAgICAgYm9keTogX3QoXCJDbGljayB0aGUgYnV0dG9uIGJlbG93IHRvIGNvbmZpcm0geW91ciBpZGVudGl0eS5cIiksXG4gICAgICAgICAgICAgICAgY29udGludWVUZXh0OiBfdChcIkNvbmZpcm1cIiksXG4gICAgICAgICAgICAgICAgY29udGludWVLaW5kOiBcInByaW1hcnlcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFtTU09BdXRoRW50cnkuTE9HSU5fVFlQRV06IHNzb0Flc3RoZXRpY3MsXG4gICAgICAgICAgICBbU1NPQXV0aEVudHJ5LlVOU1RBQkxFX0xPR0lOX1RZUEVdOiBzc29BZXN0aGV0aWNzLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgb25BdXRoRmluaXNoZWQ6IEludGVyYWN0aXZlQXV0aENhbGxiYWNrID0gKHN1Y2Nlc3MsIHJlc3VsdCk6IHZvaWQgPT4ge1xuICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkZpbmlzaGVkKHRydWUsIHJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0ID09PSBFUlJPUl9VU0VSX0NBTkNFTExFRCkge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvcHMub25GaW5pc2hlZChmYWxzZSwgbnVsbCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICBhdXRoRXJyb3I6IHJlc3VsdCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBwcml2YXRlIG9uVXBkYXRlU3RhZ2VQaGFzZSA9IChuZXdTdGFnZTogc3RyaW5nIHwgbnVtYmVyLCBuZXdQaGFzZTogc3RyaW5nIHwgbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgICAgIC8vIFdlIGNvcHkgdGhlIHN0YWdlIGFuZCBzdGFnZSBwaGFzZSBwYXJhbXMgaW50byBzdGF0ZSBmb3IgdGl0bGUgc2VsZWN0aW9uIGluIHJlbmRlcigpXG4gICAgICAgIHRoaXMuc2V0U3RhdGUoeyB1aWFTdGFnZTogbmV3U3RhZ2UsIHVpYVN0YWdlUGhhc2U6IG5ld1BoYXNlIH0pO1xuICAgIH07XG5cbiAgICBwcml2YXRlIG9uRGlzbWlzc0NsaWNrID0gKCk6IHZvaWQgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uRmluaXNoZWQoZmFsc2UpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgcmVuZGVyKCk6IEpTWC5FbGVtZW50IHtcbiAgICAgICAgLy8gTGV0J3MgcGljayBhIHRpdGxlLCBib2R5LCBhbmQgb3RoZXIgcGFyYW1zIHRleHQgdGhhdCB3ZSdsbCBzaG93IHRvIHRoZSB1c2VyLiBUaGUgb3JkZXJcbiAgICAgICAgLy8gaXMgbW9zdCBzcGVjaWZpYyBmaXJzdCwgc28gc3RhZ2VQaGFzZSA+IG91ciBwcm9wcyA+IGRlZmF1bHRzLlxuXG4gICAgICAgIGxldCB0aXRsZSA9IHRoaXMuc3RhdGUuYXV0aEVycm9yID8gJ0Vycm9yJyA6ICh0aGlzLnByb3BzLnRpdGxlIHx8IF90KCdBdXRoZW50aWNhdGlvbicpKTtcbiAgICAgICAgbGV0IGJvZHkgPSB0aGlzLnN0YXRlLmF1dGhFcnJvciA/IG51bGwgOiB0aGlzLnByb3BzLmJvZHk7XG4gICAgICAgIGxldCBjb250aW51ZVRleHQgPSBudWxsO1xuICAgICAgICBsZXQgY29udGludWVLaW5kID0gbnVsbDtcbiAgICAgICAgY29uc3QgZGlhbG9nQWVzdGhldGljcyA9IHRoaXMucHJvcHMuYWVzdGhldGljc0ZvclN0YWdlUGhhc2VzIHx8IHRoaXMuZ2V0RGVmYXVsdERpYWxvZ0Flc3RoZXRpY3MoKTtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlLmF1dGhFcnJvciAmJiBkaWFsb2dBZXN0aGV0aWNzKSB7XG4gICAgICAgICAgICBpZiAoZGlhbG9nQWVzdGhldGljc1t0aGlzLnN0YXRlLnVpYVN0YWdlXSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFlc3RoZXRpY3MgPSBkaWFsb2dBZXN0aGV0aWNzW3RoaXMuc3RhdGUudWlhU3RhZ2VdW3RoaXMuc3RhdGUudWlhU3RhZ2VQaGFzZV07XG4gICAgICAgICAgICAgICAgaWYgKGFlc3RoZXRpY3MgJiYgYWVzdGhldGljcy50aXRsZSkgdGl0bGUgPSBhZXN0aGV0aWNzLnRpdGxlO1xuICAgICAgICAgICAgICAgIGlmIChhZXN0aGV0aWNzICYmIGFlc3RoZXRpY3MuYm9keSkgYm9keSA9IGFlc3RoZXRpY3MuYm9keTtcbiAgICAgICAgICAgICAgICBpZiAoYWVzdGhldGljcyAmJiBhZXN0aGV0aWNzLmNvbnRpbnVlVGV4dCkgY29udGludWVUZXh0ID0gYWVzdGhldGljcy5jb250aW51ZVRleHQ7XG4gICAgICAgICAgICAgICAgaWYgKGFlc3RoZXRpY3MgJiYgYWVzdGhldGljcy5jb250aW51ZUtpbmQpIGNvbnRpbnVlS2luZCA9IGFlc3RoZXRpY3MuY29udGludWVLaW5kO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbnRlbnQ7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmF1dGhFcnJvcikge1xuICAgICAgICAgICAgY29udGVudCA9IChcbiAgICAgICAgICAgICAgICA8ZGl2IGlkPSdteF9EaWFsb2dfY29udGVudCc+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgcm9sZT1cImFsZXJ0XCI+eyB0aGlzLnN0YXRlLmF1dGhFcnJvci5tZXNzYWdlIHx8IHRoaXMuc3RhdGUuYXV0aEVycm9yLnRvU3RyaW5nKCkgfTwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8YnIgLz5cbiAgICAgICAgICAgICAgICAgICAgPEFjY2Vzc2libGVCdXR0b24gb25DbGljaz17dGhpcy5vbkRpc21pc3NDbGlja31cbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cIm14X0dlbmVyYWxCdXR0b25cIlxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0ZvY3VzPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgICAgICB7IF90KFwiRGlzbWlzc1wiKSB9XG4gICAgICAgICAgICAgICAgICAgIDwvQWNjZXNzaWJsZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb250ZW50ID0gKFxuICAgICAgICAgICAgICAgIDxkaXYgaWQ9J214X0RpYWxvZ19jb250ZW50Jz5cbiAgICAgICAgICAgICAgICAgICAgeyBib2R5IH1cbiAgICAgICAgICAgICAgICAgICAgPEludGVyYWN0aXZlQXV0aFxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0cml4Q2xpZW50PXt0aGlzLnByb3BzLm1hdHJpeENsaWVudH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGF1dGhEYXRhPXt0aGlzLnByb3BzLmF1dGhEYXRhfVxuICAgICAgICAgICAgICAgICAgICAgICAgbWFrZVJlcXVlc3Q9e3RoaXMucHJvcHMubWFrZVJlcXVlc3R9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkF1dGhGaW5pc2hlZD17dGhpcy5vbkF1dGhGaW5pc2hlZH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uU3RhZ2VQaGFzZUNoYW5nZT17dGhpcy5vblVwZGF0ZVN0YWdlUGhhc2V9XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZVRleHQ9e2NvbnRpbnVlVGV4dH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlS2luZD17Y29udGludWVLaW5kfVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8QmFzZURpYWxvZyBjbGFzc05hbWU9XCJteF9JbnRlcmFjdGl2ZUF1dGhEaWFsb2dcIlxuICAgICAgICAgICAgICAgIG9uRmluaXNoZWQ9e3RoaXMucHJvcHMub25GaW5pc2hlZH1cbiAgICAgICAgICAgICAgICB0aXRsZT17dGl0bGV9XG4gICAgICAgICAgICAgICAgY29udGVudElkPSdteF9EaWFsb2dfY29udGVudCdcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7IGNvbnRlbnQgfVxuICAgICAgICAgICAgPC9CYXNlRGlhbG9nPlxuICAgICAgICApO1xuICAgIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFrQkE7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQTFCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBb0VlLE1BQU1BLHFCQUFOLFNBQW9DQyxjQUFBLENBQU1DLFNBQTFDLENBQW9FO0VBQy9FQyxXQUFXLENBQUNDLEtBQUQsRUFBZ0I7SUFDdkIsTUFBTUEsS0FBTjtJQUR1QixzREFrQ3VCLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUEyQjtNQUN6RSxJQUFJRCxPQUFKLEVBQWE7UUFDVCxLQUFLRCxLQUFMLENBQVdHLFVBQVgsQ0FBc0IsSUFBdEIsRUFBNEJELE1BQTVCO01BQ0gsQ0FGRCxNQUVPO1FBQ0gsSUFBSUEsTUFBTSxLQUFLRSxxQ0FBZixFQUFxQztVQUNqQyxLQUFLSixLQUFMLENBQVdHLFVBQVgsQ0FBc0IsS0FBdEIsRUFBNkIsSUFBN0I7UUFDSCxDQUZELE1BRU87VUFDSCxLQUFLRSxRQUFMLENBQWM7WUFDVkMsU0FBUyxFQUFFSjtVQURELENBQWQ7UUFHSDtNQUNKO0lBQ0osQ0E5QzBCO0lBQUEsMERBZ0RFLENBQUNLLFFBQUQsRUFBNEJDLFFBQTVCLEtBQWdFO01BQ3pGO01BQ0EsS0FBS0gsUUFBTCxDQUFjO1FBQUVJLFFBQVEsRUFBRUYsUUFBWjtRQUFzQkcsYUFBYSxFQUFFRjtNQUFyQyxDQUFkO0lBQ0gsQ0FuRDBCO0lBQUEsc0RBcURG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